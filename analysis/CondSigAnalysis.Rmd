---
title: "Condition effects and gene signatures"
output: html_notebook
---



# General Setup
Setup chunk

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8)
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_knit$get("root.dir")
```

Setup reticulate

```{r}
library(reticulate)
knitr::knit_engines$set(python = reticulate::eng_python)
py_available(initialize = FALSE)
use_python(Sys.which("python"))
py_config()
```

Load libraries

```{r}
library(Seurat)
library(ggplot2)
library(ggridges)
library(dplyr)
library(clusterProfiler)
library(ReactomePA)
```



# Load and preprocess data
Load data (from all cells)

```{r}
allcells_css = readRDS(file = "data/processed/allcells_css.RDS")
end_cells = readRDS(file = "results/zonation_cond/end_cells_zonation.RDS")
hep_cells = readRDS(file = "results/zonation_cond/hep_cells_zonation.RDS")
```

Add zonation labels. This revised metadata will also be filtered to avoid contaminaiting cells (and we'll also remove doublets)

```{r}
meta = data.frame(row.names = rownames(allcells_css@meta.data),
                  "cell_type" = as.character(allcells_css@meta.data$allcells_simp),
                  stringsAsFactors = F)

for(cond in names(hep_cells)){
  hep_zones = hep_cells[[cond]]@meta.data$zonation_int
  levels(hep_zones) = c("(-0.0688,-0.0253]" = "Hepatocytes_Z1",
                        "(-0.0253,0.018]" = "Hepatocytes_Z2",
                        "(0.018,0.0615]" = "Hepatocytes_Z3")
  hep_zones = as.character(hep_zones)
  names(hep_zones) = colnames(hep_cells[[cond]])
  meta[names(hep_zones),"cell_type"] = hep_zones
  
  end_zones = end_cells[[cond]]@meta.data$zonation_int
  levels(end_zones) = c("(-0.0194,6.47]" = "LSEC_Z1",
                        "(6.47,12.9]" = "LSEC_Z2",
                        "(12.9,19.4]" = "LSEC_Z3")
  end_zones = as.character(end_zones)
  names(end_zones) = colnames(end_cells[[cond]])
  meta[names(end_zones),"cell_type"] = end_zones
}
```

Calculate cell type markers

```{r}
# remove contaminating cells (removed in pseudotime analysis)
meta = subset(meta, !(cell_type %in% unique(meta$cell_type)[grepl("Hepatocytes (", unique(meta$cell_type), fixed = T) | 
                                                              grepl("LSEC ", unique(meta$cell_type), fixed = T)]))
allcells_css = AddMetaData(allcells_css, meta)

cell_type_mk = list()
allcells_css = SetIdent(allcells_css, value = "cell_type")
cell_type_mk[["all"]] = FindAllMarkers(allcells_css[,!is.na(allcells_css@meta.data$cell_type)], 
                                       assay = "SCT", test.use = "wilcox",
                                       pseudocount.use = 0.1, logfc.threshold = 0.2,
                                       max.cells.per.ident = 10000,
                                       min.cells.feature = 10, verbose = T)

# remove contaminating cells and interaction/doublets
meta = subset(meta, !(cell_type %in% c("Macrophage-T cell interaction",
                                       "Macrophage-Endothelial interaction",
                                       "Lymphoid-Endothelial interaction",
                                       "LSEC periportal", "LSEC pericentral",
                                       "Kupffer-Endothelial interaction",
                                       "Hepatocytes (portal/midzone)",
                                       "Hepatocytes (portal)","Hepatocytes (midzone)",
                                       "Hepatocytes (central/detox)", "Hepatocytes (central)",
                                       "Hepatocyte-T cell interaction",
                                       "Hepatocyte-Myeloid interaction",
                                       "Hepatocyte-Endothelial interaction",
                                       "Dividing cells")))
allcells_css = AddMetaData(allcells_css, meta)

cell_type_mk[["good"]] = FindAllMarkers(allcells_css[,!is.na(allcells_css@meta.data$cell_type)], 
                                        assay = "SCT", test.use = "wilcox",
                                        pseudocount.use = 0.1, logfc.threshold = 0.2,
                                        max.cells.per.ident = 10000,
                                        min.cells.feature = 10, verbose = T)

# using major labels
plot_df = data.frame(row.names = colnames(allcells_css),
                     "major_ct" = as.character(allcells_css@meta.data$allcells_major),
                     "rem" = as.character(allcells_css@meta.data$allcells_major),
                     stringsAsFactors = F)
plot_df$major_ct[plot_df$major_ct=="T cells" | 
                      plot_df$major_ct=="B cells" | 
                      plot_df$major_ct=="Macrophages" | 
                      plot_df$major_ct=="DCs"] = "Immune"
plot_df$major_ct[plot_df$major_ct=="Endothelial cells"] = "Endothelial"
plot_df$major_ct[plot_df$major_ct=="Stellate cells"] = "Mesenchymal"
plot_df = plot_df[plot_df$major_ct!="Doublets",]
plot_df = plot_df[plot_df$major_ct!="Dividing cells",]
allcells_css = AddMetaData(allcells_css, plot_df)

allcells_css = SetIdent(allcells_css, value = "major_ct")
cell_type_mk[["major"]] = FindAllMarkers(allcells_css[,!is.na(allcells_css@meta.data$major_ct)], 
                                        assay = "SCT", test.use = "wilcox",
                                        pseudocount.use = 0.1, logfc.threshold = 0.2,
                                        max.cells.per.ident = 10000,
                                        min.cells.feature = 10, verbose = T)

saveRDS(cell_type_mk, file = "results/cond_effect/cell_type_mk.RDS")
```

Save allcells_css again with the new annotations

```{r}
saveRDS(allcells_css, file = "data/processed/allcells_css_reannot.RDS")
```

Intersection of number of genes in top 250

```{r, fig.height=4, fig.width=5}
top_genes = list()
for(ct in unique(cell_type_mk$good$cluster)){
  top_genes[[ct]] = cell_type_mk$good[cell_type_mk$good$cluster==ct & 
                                       cell_type_mk$good$p_val_adj<=0.05 & 
                                       cell_type_mk$good$avg_logFC>0,]
  top_genes[[ct]] = top_genes[[ct]][order(top_genes[[ct]]$avg_logFC, decreasing = T),"gene"][1:250]
}

major_genes = list()
for(ct in unique(cell_type_mk$major$cluster)){
  major_genes[[ct]] = cell_type_mk$major[cell_type_mk$major$cluster==ct & 
                                           cell_type_mk$major$p_val_adj<=0.05 & 
                                           cell_type_mk$major$avg_logFC>0,]
  major_genes[[ct]] = major_genes[[ct]][order(major_genes[[ct]]$avg_logFC, decreasing = T),"gene"][1:250]
}

int_mat = matrix(0, nrow = length(top_genes), ncol = length(top_genes))
rownames(int_mat) = colnames(int_mat) = names(top_genes)
for(i in rownames(int_mat)){
  for(j in colnames(int_mat)){
    int_mat[i,j] = length(intersect(top_genes[[i]],top_genes[[j]]))
  }
}
pheatmap::pheatmap(int_mat, clustering_method = "average", treeheight_col = 10, treeheight_row = 10)
```

Calculate DE (only for cell types with more than 10 cells in one condition)

```{r}
comb_cond = combn(unique(allcells_css@meta.data$Condition), 2)
cond_comparison_list = list()
for(i in 1:ncol(comb_cond)){
  comp = paste0(comb_cond[1,i], "_v_", comb_cond[2,i])
  cond_comparison_list[[comp]] = list()
  for(g in c("allcells_simp","cell_type","major_ct")){
    print(g)
    tab_cond = table(allcells_css@meta.data[,g], allcells_css@meta.data$Condition)
    tab_cond = tab_cond[apply(tab_cond, 1, function(x) all(x>10)),]
    for(ct in rownames(tab_cond)){
      cat(ct)
      allcells_css = SetIdent(allcells_css, value = g)
      mk = FindMarkers(allcells_css[,!is.na(allcells_css@meta.data[,g])], 
                       ident.1 = comb_cond[1,i], ident.2 = comb_cond[2,i],
                       group.by = "Condition", subset.ident = ct, pseudocount.use = 0.1, 
                       logfc.threshold = 0, min.cells.feature = 10,
                       assay = "SCT", max.cells.per.ident = 10000)
      mk$gene = rownames(mk)
      mk$group = g
      mk$celltype = ct
      mk$condition = ifelse(mk$avg_logFC<0, comb_cond[2,i], comb_cond[1,i])
      mk = mk[,c("group", "celltype", "gene", "avg_logFC", 
                 "p_val_adj", "condition", "pct.1", "pct.2")]
      
      if(comp %in% names(cond_comparison_list)){
        cond_comparison_list[[comp]][[g]] = rbind(cond_comparison_list[[comp]][[g]], mk)
      } else{
        cond_comparison_list[[comp]][[g]] = mk
      }
    }
  }
}
saveRDS(cond_comparison_list, file = "results/cond_effect/cond_comparison_list.RDS")
```

Repeat for heaptocytes, but use downsampling

```{r}
comb_cond = combn(unique(allcells_css@meta.data$Condition), 2)
cond_comparison_hepsub = list()
for(i in 1:ncol(comb_cond)){
  comp = paste0(comb_cond[1,i], "_v_", comb_cond[2,i])
  cond_comparison_hepsub[[comp]] = list()
  for(g in c("allcells_simp","cell_type","major_ct")){
    print(g)
    tab_cond = table(allcells_css@meta.data[,g], allcells_css@meta.data$Condition)
    tab_cond = rownames(tab_cond)[apply(tab_cond, 1, function(x) all(x>10)) & 
                          grepl("Hepato", rownames(tab_cond)) &
                          !grepl("interact", rownames(tab_cond))]
    for(ct in tab_cond){
      cat(ct)
      set.seed(1)
      hep_cells = allcells_css[,allcells_css@meta.data[,g]==ct &
                                 !is.na(allcells_css@meta.data[,g])]
      
      fact = hep_cells@meta.data$nCount_SCT/min(tapply(hep_cells@meta.data$nCount_SCT, 
                                                       hep_cells@meta.data$Condition, median))
      fact = ifelse(fact<=1, 0, log2(fact))
      thinned_counts = seqgendiff::thin_lib(as.matrix(hep_cells@assays$SCT@counts), 
                                            thinlog2 = fact, relative = T)
      rownames(thinned_counts$mat) = rownames(hep_cells@assays$SCT@data)
      colnames(thinned_counts$mat) = colnames(hep_cells@assays$SCT@data)
      hep_cells@assays$SCT@counts = Matrix::Matrix(thinned_counts$mat, sparse = T)
      hep_cells@assays$SCT@data = log1p(hep_cells@assays$SCT@counts)
      
      hep_cells = SetIdent(hep_cells, value = g)
      mk = FindMarkers(hep_cells[,!is.na(hep_cells@meta.data[,g])], 
                       ident.1 = comb_cond[1,i], ident.2 = comb_cond[2,i],
                       group.by = "Condition", subset.ident = ct, pseudocount.use = 0.1, 
                       logfc.threshold = 0, min.cells.feature = 10,
                       assay = "SCT", max.cells.per.ident = 10000)
      mk$gene = rownames(mk)
      mk$group = g
      mk$celltype = ct
      mk$condition = ifelse(mk$avg_logFC<0, comb_cond[2,i], comb_cond[1,i])
      mk = mk[,c("group", "celltype", "gene", "avg_logFC", 
                 "p_val_adj", "condition", "pct.1", "pct.2")]
      
      if(comp %in% names(cond_comparison_hepsub)){
        cond_comparison_hepsub[[comp]][[g]] = rbind(cond_comparison_hepsub[[comp]][[g]], mk)
      } else{
        cond_comparison_hepsub[[comp]][[g]] = mk
      }
    }
  }
}
saveRDS(cond_comparison_hepsub, file = "results/cond_effect/cond_comparison_hepsub.RDS")
```

Add chromosome information

```{r}
chr_tab = read.csv("../../gene_refs/human/biomart_ens_gn_hgnc_chr.csv", 
                   header = T, stringsAsFactors = F)

cond_comp_chr = list()
for(n in names(cond_comparison_list)){
  cond_comp_chr[[n]] = list()
  for(i in names(cond_comparison_list[[n]])){
    cond_comp_chr[[n]][[i]] = merge(cond_comparison_list[[n]][[i]], 
                                    chr_tab[,c(2,4)], by.x = "gene", by.y = 1, all.x = T)
  }
}
saveRDS(cond_comp_chr, file = "results/cond_effect/cond_comp_chr.RDS")

cond_comp_hep_chr = list()
for(n in names(cond_comparison_hepsub)){
  cond_comp_hep_chr[[n]] = list()
  for(i in names(cond_comparison_hepsub[[n]])){
    cond_comp_hep_chr[[n]][[i]] = merge(cond_comparison_hepsub[[n]][[i]], 
                                    chr_tab[,c(2,4)], by.x = "gene", by.y = 1, all.x = T)
  }
}
saveRDS(cond_comp_hep_chr, file = "results/cond_effect/cond_comp_hep_chr.RDS")
```

Clean DE tables - remove Y chromosome genes and markers of different cell types

```{r}
filt_cond_comp_chr = list()
for(n in names(cond_comp_chr)){
  df_cond_de = cond_comp_chr[[n]]$cell_type
  for(ct in names(top_genes)){
    okgenes = df_cond_de[df_cond_de$celltype==ct,"gene"]
    okgenes = okgenes[!(okgenes %in% unlist(top_genes[-which(names(top_genes)==ct)]) &
                          !(okgenes %in% top_genes[[ct]]))]
    df_cond_de = df_cond_de[df_cond_de$celltype!=ct | (df_cond_de$celltype==ct &
                                                         df_cond_de$gene %in% okgenes),]
  }
  df_cond_de = df_cond_de[!grepl("CHR_", df_cond_de$Chromosome.scaffold.name) & 
                            !(df_cond_de$Chromosome.scaffold.name %in% c("Y","KI270734.1")),]
  df_cond_de = df_cond_de[df_cond_de$celltype %in% names(top_genes),]
  filt_cond_comp_chr[[n]] = df_cond_de
}

major_cond_comp_chr = list()
for(n in names(cond_comp_chr)){
  df_cond_de = cond_comp_chr[[n]]$major_ct
  for(ct in names(major_genes)){
    okgenes = df_cond_de[df_cond_de$celltype==ct,"gene"]
    okgenes = okgenes[!(okgenes %in% unlist(major_genes[-which(names(major_genes)==ct)]) &
                          !(okgenes %in% major_genes[[ct]]))]
    df_cond_de = df_cond_de[df_cond_de$celltype!=ct | (df_cond_de$celltype==ct &
                                                         df_cond_de$gene %in% okgenes),]
  }
  df_cond_de = df_cond_de[!grepl("CHR_", df_cond_de$Chromosome.scaffold.name) & 
                            !(df_cond_de$Chromosome.scaffold.name %in% c("Y","KI270734.1")),]
  df_cond_de = df_cond_de[df_cond_de$celltype %in% names(major_genes),]
  major_cond_comp_chr[[n]] = df_cond_de
}

filt_cond_comp_hep = list()
for(n in names(cond_comp_hep_chr)){
  df_cond_de = cond_comp_hep_chr[[n]]$cell_type
  for(ct in names(top_genes)){
    okgenes = df_cond_de[df_cond_de$celltype==ct,"gene"]
    okgenes = okgenes[!(okgenes %in% unlist(top_genes[-which(names(top_genes)==ct)]) &
                          !(okgenes %in% top_genes[[ct]]))]
    df_cond_de = df_cond_de[df_cond_de$celltype!=ct | (df_cond_de$celltype==ct &
                                                         df_cond_de$gene %in% okgenes),]
  }
  df_cond_de = df_cond_de[!grepl("CHR_", df_cond_de$Chromosome.scaffold.name) & 
                            !(df_cond_de$Chromosome.scaffold.name %in% c("Y","KI270734.1")),]
  df_cond_de = df_cond_de[df_cond_de$celltype %in% names(top_genes),]
  filt_cond_comp_hep[[n]] = df_cond_de
}

major_cond_comp_hep = list()
for(n in names(cond_comp_hep_chr)){
  df_cond_de = cond_comp_hep_chr[[n]]$major_ct
  for(ct in names(major_genes)){
    okgenes = df_cond_de[df_cond_de$celltype==ct,"gene"]
    okgenes = okgenes[!(okgenes %in% unlist(major_genes[-which(names(major_genes)==ct)]) &
                          !(okgenes %in% major_genes[[ct]]))]
    df_cond_de = df_cond_de[df_cond_de$celltype!=ct | (df_cond_de$celltype==ct &
                                                         df_cond_de$gene %in% okgenes),]
  }
  df_cond_de = df_cond_de[!grepl("CHR_", df_cond_de$Chromosome.scaffold.name) & 
                            !(df_cond_de$Chromosome.scaffold.name %in% c("Y","KI270734.1")),]
  df_cond_de = df_cond_de[df_cond_de$celltype %in% names(major_genes),]
  major_cond_comp_hep[[n]] = df_cond_de
}

filt_comps = list("major_ct" = major_cond_comp_chr, "cell_type" = filt_cond_comp_chr,
                  "major_ct_hep" = major_cond_comp_hep, "cell_type_hep" = filt_cond_comp_hep)

saveRDS(filt_comps, file = "results/cond_effect/all_filt_comps.RDS")
```

Filter pathways with ribosomal genes

```{r}
rpfilter = function(x){
  return(!grepl("^RPL", x$geneID) & !grepl("^RPS", x$geneID) & 
           !grepl("/RPL", x$geneID, fixed = T) & !grepl("/RPS", x$geneID, fixed = T))
}
```

Get GO Term enrichment

```{r}
fc = 0.3
go_enr_list = list()
for(gr in names(filt_comps)){
  filt_cond_comp_chr = filt_comps[[gr]]
  gr_g = ifelse(endsWith(gr, "hep"), paste0(strsplit(gr, "_")[[1]][1:2], collapse="_"), gr)
  allcells_ct = allcells_css[,!is.na(allcells_css@meta.data[,gr_g])]
  go_enr_list[[gr]] = list()
  for(comp in names(filt_cond_comp_chr)){
    testdf = filt_cond_comp_chr[[comp]][filt_cond_comp_chr[[comp]]$p_val_adj<=0.05,]
    
    ncond = strsplit(comp, "_v_")[[1]]
    go_enr_list[[gr]][[comp]] = list()
    for(ct in unique(testdf$celltype)){
      subtestdf = unique(testdf[testdf$celltype==ct, c("avg_logFC","gene")])
      
      # get DE tested genes
      cells = allcells_ct@meta.data[,gr_g]==ct
      genes = Matrix::rowSums(allcells_ct[,cells]@assays$SCT@data>0)
      genes = genes[genes>(0.1*sum(cells))] # might not include all, but very close
      genes = replace(genes, genes>0, 0)
      genes[subtestdf$gene] = subtestdf$avg_logFC
      
      # GO enrichment
      for(cond in ncond){
        fsel = if(cond==ncond[[1]]){
          function(x) return(x>fc)
          } else{
            function(x) return(x<(-fc))
          }
        
        if(length(names(genes)[fsel(genes)])>2){
          eg = clusterProfiler::bitr(names(genes)[fsel(genes)], fromType="SYMBOL", 
                                     toType="ENTREZID", OrgDb="org.Hs.eg.db")
          eg_all = clusterProfiler::bitr(names(genes), fromType="SYMBOL", 
                                         toType="ENTREZID", OrgDb="org.Hs.eg.db")
          
          # enrichment
          reac = ReactomePA::enrichPathway(gene=eg$ENTREZID,pvalueCutoff=0.05, 
                                           readable=T, universe = eg_all$ENTREZID)
          got = clusterProfiler::enrichGO(gene = eg$ENTREZID, universe = eg_all$ENTREZID, 
                                          OrgDb = org.Hs.eg.db, ont = "BP", pvalueCutoff  = 0.01,
                                          qvalueCutoff  = 0.05, 
                                          pAdjustMethod = "BH", readable = T)
          
          all_terms = rbind(as.data.frame(reac), as.data.frame(got))
          if(nrow(all_terms)>0){
            all_terms$DB = c(rep("Reactome", nrow(as.data.frame(reac))), 
                             rep("GO Term", nrow(as.data.frame(got))))
            all_terms = all_terms[all_terms$qvalue<=0.05,]
            all_terms$cond = cond
            
            if(is.null(go_enr_list[[gr]][[comp]][[ct]])){
              go_enr_list[[gr]][[comp]][[ct]] = all_terms
            } else{
              go_enr_list[[gr]][[comp]][[ct]] = rbind(go_enr_list[[gr]][[comp]][[ct]], all_terms)
            }
          }
        }
      }
    }
  }
}
saveRDS(go_enr_list, file = "results/cond_effect/go_enr_list.RDS")
```

Tables for sending

```{r}
for(g in names(filt_comps)){
  for(comp in names(filt_comps[[g]])){
    subdir = file.path("to_send", g)
    dir.create(subdir)
    write.table(filt_comps[[g]][[comp]], file = paste0(subdir, "/DEconditions_", comp, "_", g, ".csv"), col.names = T, row.names = F, quote = F, sep = "\t")
  }
}

for(g in names(gomf_enr_list)){
  for(comp in names(gomf_enr_list[[g]])){
    for(ct in names(gomf_enr_list[[g]][[comp]])){
      subdir = file.path("to_send", paste0(g, "/GO_", ct))
      dir.create(subdir)
      write.table(gomf_enr_list[[g]][[comp]][[ct]], file = paste0(subdir, "/GOTermMF_", comp, "_", ct, "_", g, ".csv"), col.names = T, row.names = F, quote = F, sep = "\t")
    }
  }
}

for(g in names(go_enr_list)){
  for(comp in names(go_enr_list[[g]])){
    for(ct in names(go_enr_list[[g]][[comp]])){
      subdir = file.path("to_send/", paste0(g, "/GO_", ct))
      dir.create(subdir)
      write.table(go_enr_list[[g]][[comp]][[ct]], file = paste0(subdir, "/GOTermBP_", comp, "_", ct, "_", g, ".csv"), col.names = T, row.names = F, quote = F, sep = "\t")
    }
  }
}
```



```{r}
tfdb = read.table("../../gene_refs/human/Homo_sapiens_TF_AnimalTFDB3.txt", sep = "\t", header = T, stringsAsFactors = F)

ct = "Hepatocytes"
g = "major_ct_hep"
plt_reg = filt_comps[[g]]$healthy_v_regenerating[,c(1,3,4,5)]
plt_reg = unique(plt_reg[plt_reg$celltype==ct,])
plt_emb = filt_comps[[g]]$healthy_v_embolised[,c(1,3,4,5)]
plt_emb = unique(plt_emb[plt_emb$celltype==ct,])
rownames(plt_reg) = plt_reg$gene
rownames(plt_emb) = plt_emb$gene

plt_df = merge(plt_emb, plt_reg, by = 0, all = T)
rownames(plt_df) = plt_df[,1]
plt_df = plt_df[,-c(1,3,6,7)]
colnames(plt_df) = c("gene", "FC_emb", "pval_emb", "FC_reg", "pval_reg")
plt_df$gene = rownames(plt_df)
plt_df$FC_emb[is.na(plt_df$FC_emb)] = 0
plt_df$FC_reg[is.na(plt_df$FC_reg)] = 0
plt_df$pval_emb[is.na(plt_df$pval_emb)] = 1
plt_df$pval_reg[is.na(plt_df$pval_reg)] = 1

plot(plt_df[,"FC_emb"], plt_df[,"FC_reg"], pch = 20, cex = 0.01)
filt_txt = ((abs(plt_df$FC_reg)>0.3 & plt_df$pval_reg<=0.05) | 
  (abs(plt_df$FC_reg)>0.3 & plt_df$pval_emb<=0.05)) & plt_df$gene %in% tfdb$Symbol
text(plt_df$gene[filt_txt], x = plt_df$FC_emb[filt_txt], 
     y = plt_df$FC_reg[filt_txt], cex = 0.85, col = "red", face = "bold")
abline(0,100000000000)
abline(0,0)

View(plt_df[filt_txt,])
```



```{r}
#setup matrix with all genes
all_g = rownames(hep_cells_ds)
mat = matrix(0, nrow = length(all_g), ncol = 3)
colnames(mat) = unique(hep_cells_ds@meta.data$Condition)
rownames(mat) = all_g

# downsample counts
set.seed(1)
hep_cells_ds = allcells_css[,allcells_css@meta.data$major_ct=="Hepatocytes" &
                              !is.na(allcells_css@meta.data$major_ct)]

fact = hep_cells_ds@meta.data$nCount_SCT/min(tapply(hep_cells_ds@meta.data$nCount_SCT,
                                                    hep_cells_ds@meta.data$Condition, median))
fact = ifelse(fact<=1, 0, log2(fact))
thinned_counts = seqgendiff::thin_lib(as.matrix(hep_cells_ds@assays$SCT@counts), 
                                      thinlog2 = fact, relative = T)
rownames(thinned_counts$mat) = rownames(hep_cells_ds@assays$SCT@data)
colnames(thinned_counts$mat) = colnames(hep_cells_ds@assays$SCT@data)
hep_cells_ds@assays$SCT@counts = Matrix::Matrix(thinned_counts$mat, sparse = T)
hep_cells_ds@assays$SCT@data = log1p(hep_cells_ds@assays$SCT@counts)

# calculate score
for(n in unique(hep_cells_ds@meta.data$Condition)){
  cells = hep_cells_ds@meta.data$Condition==n
  sub_dat = hep_cells_ds@assays$SCT@data[,cells]
  gene_exp = apply(sub_dat, 1, function(x){
    sx = sum(x>0)
    return(ifelse(sx>1, sx*sum(colSums(sub_dat[,x>0])), 
                  ifelse(sx>0, sx*sum(sub_dat[,x>0]), 0)))
  })
  sc = gene_exp/(sum(cells)*sum(colSums(sub_dat)))
  mat[names(sc),n] = sc
}
mat[is.na(mat)] = 0
maxmat = apply(mat, 2, function(x) x/max(x))
```











```{r}
# Hep: H v R - no diff; H v E - H is more metab active
he = filt_comps$major_ct$healthy_v_embolised
hr = filt_comps$major_ct$healthy_v_regenerating
er = filt_comps$major_ct$embolised_v_regenerating

he = he[he$celltype=="Hepatocytes",c("gene", "avg_logFC")]
hr = hr[hr$celltype=="Hepatocytes",c("gene", "avg_logFC")]
er = er[er$celltype=="Hepatocytes",c("gene", "avg_logFC")]

plot_df = merge(merge(he, hr, by = "gene", all = T), er, by = "gene", all = T)
plot_df$avg_logFC.x[is.na(plot_df$avg_logFC.x)] = 0
plot_df$avg_logFC[is.na(plot_df$avg_logFC)] = 0
plot_df$avg_logFC.y[is.na(plot_df$avg_logFC.y)] = 0
colnames(plot_df) = c("gene", "he", "hr", "er")

plot(plot_df$he, plot_df$hr)
```

Subsampling Hepatocytes

```{r}
set.seed(1)
hep_cells = allcells_css[,allcells_css@meta.data$major_ct=="Hepatocytes" &
                           !is.na(allcells_css@meta.data$major_ct)]

fact = hep_cells@meta.data$nCount_SCT/min(tapply(hep_cells@meta.data$nCount_SCT, 
                                                 hep_cells@meta.data$Condition, median))
fact = ifelse(fact<=1, 0, log2(fact))
thinned_counts = seqgendiff::thin_lib(as.matrix(hep_cells@assays$SCT@counts), 
                                      thinlog2 = fact, relative = T)
rownames(thinned_counts$mat) = rownames(hep_cells@assays$SCT@data)
colnames(thinned_counts$mat) = colnames(hep_cells@assays$SCT@data)
hep_cells@assays$SCT@counts = Matrix::Matrix(thinned_counts$mat, sparse = T)
hep_cells@assays$SCT@data = log1p(hep_cells@assays$SCT@counts)

comb_cond = combn(unique(hep_cells@meta.data$Condition), 2)
ds_hep_de = list()
hep_cells = SetIdent(hep_cells, value = "Condition")
for(i in 1:ncol(comb_cond)){
  comp = paste0(comb_cond[1,i], "_v_", comb_cond[2,i])
  ds_hep_de[[comp]] = FindMarkers(hep_cells, ident.1 = comb_cond[1,i], ident.2 = comb_cond[2,i],
                          pseudocount.use = 0.1, logfc.threshold = 0, min.cells.feature = 1,
                          assay = "SCT", max.cells.per.ident = 10000)
}

boxplot(colSums(hep_cells@assays$SCT@counts)~hep_cells@meta.data$Condition)
boxplot(hep_cells@meta.data$nCount_SCT~hep_cells@meta.data$Condition)
```



```{r}
# Hep: H v R - no diff; H v E - H is more metab active
he = ds_hep_de$healthy_v_embolised
he$gene = rownames(he)
hr = ds_hep_de$healthy_v_regenerating
hr$gene = rownames(hr)
er = ds_hep_de$embolised_v_regenerating
er$gene = rownames(er)

he = he[,c("gene", "avg_logFC", "p_val_adj")]
hr = hr[,c("gene", "avg_logFC", "p_val_adj")]
er = er[,c("gene", "avg_logFC", "p_val_adj")]

plot_df = merge(merge(he, hr, by = "gene", all = T), er, by = "gene", all = T)
plot_df$avg_logFC.x[is.na(plot_df$avg_logFC.x)] = 0
plot_df$avg_logFC[is.na(plot_df$avg_logFC)] = 0
plot_df$avg_logFC.y[is.na(plot_df$avg_logFC.y)] = 0
plot_df = plot_df[plot_df$p_val_adj.x<=0.05 | 
                    plot_df$p_val_adj.y<=0.05 | 
                    plot_df$p_val_adj<=0.05,c(1,2,4,6)]
colnames(plot_df) = c("gene", "he", "hr", "er")

plot(plot_df$he, -plot_df$er)
```











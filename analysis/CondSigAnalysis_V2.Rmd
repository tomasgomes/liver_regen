---
title: "Condition effects and gene signatures"
output: html_notebook
---
 


# General Setup
Setup chunk

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8)
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_knit$get("root.dir")
```

Setup reticulate

```{r}
library(reticulate)
knitr::knit_engines$set(python = reticulate::eng_python)
py_available(initialize = FALSE)
use_python(Sys.which("python"))
py_config()
```

Load libraries

```{r}
library(Seurat)
library(ggplot2)
library(ggrepel)
library(ggridges)
library(dplyr)
library(seqgendiff)
library(clusterProfiler)
library(ReactomePA)
library(org.Hs.eg.db)
```

Other functions

```{r}
# downsample taking the minimum median of UMI counts as a reference
dsSeurat = function(srat, variable, assay = "SCT", numis = "nCount_SCT", seed = 1){
  # input Seurat object and variable to do the downsample based on
  # return Seurat object
  
  set.seed(seed)
  
  # downsample taking the minimum median of UMI counts as a reference
  fact = srat@meta.data[,numis]/min(tapply(srat@meta.data[,numis], srat@meta.data[,variable], median))
  fact = ifelse(fact<=1, 0, log2(fact))
  thinned_counts = seqgendiff::thin_lib(as.matrix(srat@assays[[assay]]@counts), 
                                        thinlog2 = fact, relative = T)
  rownames(thinned_counts$mat) = rownames(srat@assays[[assay]]@data)
  colnames(thinned_counts$mat) = colnames(srat@assays[[assay]]@data)
  srat@assays$SCT@counts = Matrix::Matrix(thinned_counts$mat, sparse = T)
  srat@assays$SCT@data = log1p(srat@assays[[assay]]@counts)
  
  return(srat)
}

rpfilter = function(x){
  return(!grepl("^RPL", x$geneID) & !grepl("^RPS", x$geneID) & 
           !grepl("/RPL", x$geneID, fixed = T) & !grepl("/RPS", x$geneID, fixed = T))
}
```



# Load and preprocess data
Load data (from all cells)

```{r}
allcells_css = readRDS(file = "data/processed/allcells_css.RDS")
end_cells = readRDS(file = "results/endothelial/only_end_cells_zon.RDS")
hep_cells = readRDS(file = "results/zonation_cond/hep_cells_zonation_rank.RDS")
imm_cells = readRDS(file = "results/immune/all_imm_cells.RDS")
```

Load chromosome information (important to add to tables)

```{r}
chr_tab = read.csv("../../gene_refs/human/biomart_ens_gn_hgnc_chr.csv", 
                   header = T, stringsAsFactors = F)
```

Prepare a global object with all necessary metadata

```{r}
endpop_df = data.frame(row.names = colnames(end_cells),
                       "subpops" = end_cells@meta.data$endo_simp)
immpop_df = data.frame(row.names = colnames(imm_cells),
                       "subpops" = imm_cells@meta.data$immune_annot)
heppop_df = lapply(hep_cells, function(x) cbind(colnames(x), as.character(x$zonation_int)))
heppop_df = Reduce(rbind, heppop_df)
heppop_df = data.frame(row.names = heppop_df[,1],
                       subpops = factor(heppop_df[,2]))
levels(heppop_df$subpops) = c("(-0.00099,0.333]" = "Hepatocytes_Z1",
                              "(0.333,0.667]" = "Hepatocytes_Z2",
                              "(0.667,1]" = "Hepatocytes_Z3")
heppop_df$subpops = as.character(heppop_df$subpops)

subpop_df = rbind(endpop_df, immpop_df, heppop_df)
subpop_df$subpops[subpop_df$subpops=="Cycling cells"] = "Dividing endothelial cells"

# add subpop metadata
allcells_css = AddMetaData(allcells_css, subpop_df)
allcells_css$subpops[is.na(allcells_css$subpops)] = allcells_css$allcells_major[is.na(allcells_css$subpops)]
allcells_css$subpops[allcells_css$subpops=="Hepatocyte-Monocyte interaction"] = "Doublets"

# the cells in this object named "Hepatocytes", "Endothelial cells", and "Doublets" have to be removed
## the first two are cells that didn't pass the hep and end analysis
sub_allcells_css = allcells_css[,!(allcells_css$subpops %in% c("Hepatocytes", "Endothelial cells",
                                                               "Doublets"))]

# add simplified column - merge some populations, don't include cycling pops and stressed T cells
sub_allcells_css$subpops_simp = sub_allcells_css$subpops
sub_allcells_css$subpops_simp[grepl("MAIT", sub_allcells_css$subpops_simp)] = "MAIT cells"
sub_allcells_css$subpops_simp[grepl("NK cells ", sub_allcells_css$subpops_simp)] = "NK cells"
sub_allcells_css$subpops_simp[grepl("LSEC (high MT", sub_allcells_css$subpops_simp, 
                                    fixed = T)] = "LSEC (high MT)"
sub_allcells_css$subpops_simp[grepl("CD8 ab-T ", sub_allcells_css$subpops_simp, 
                                    fixed = T)] = "CD8 ab-T cells"
simp_allcells_css = sub_allcells_css[,!(sub_allcells_css$subpops_simp %in% c("ab-T cells (stress)", "Dividing cDCs", "Dividing endothelial cells","Dividing T/NK cells"))]
```



# Cell Type markers
Plot markers for all cell types

```{r}
# tables used: T cell markers, 
allmk = c("EPCAM", "KRT17", "CD24", # Cholangiocytes 
          "LILRA4", "IRF7", "GZMB", # pDCs
          "IL1RL1", "JUN", "TNFAIP3", # LSEC (stress) 
          "VWF", "INMT", "RSPO3", # EC non-LSEC 
          "CTGF", "ANGPT2", "IGFBP3", # LSEC (remodelling) 
          "FRZB", "CLEC1B", "CLEC4G", # Pericentral LSEC 
          "MT-ATP6", "FEZ1", "KDR", # LSEC (high MT 2) 
          "EDNRB", "ABCG2", "EFNB1", # Midzonal LSEC 
          "MT-CO3", "MT-ND1", "BCO2", # LSEC (high MT 1) 
          "CXCL11", "ISG15", "IFIT3", # LSEC (interferon) 
          "SUCNR1", "CCL8", "IFI27", # Kupffer cells (SUCNR1+) 
          "CD5L", "MARCO", "VCAM1", # Kupffer cells 
          "CCL3L3", "CCL4", "IL1B", # Monocytes (secretory) 
          "MGP", "AQP1", "CLEC14A", # Periportal LSEC 
          "IGFBP2", "ITIH3", "SMIM24", # Hepatocytes_Z2 
          "SAA2", "HAMP", "FGB", # Hepatocytes_Z1 
          "CYP2E1", "CYP3A4", "HULC", # Hepatocytes_Z3 
          "TREM2", "CD9", "FABP4", # Monocytes (TREM2+ CD9+) 
          "FCER1A", "FCGR2B", "CD1C", # cDC2 
          "S100A8", "S100A9", "LYZ", # Macrophages 
          "IGSF21", "GPR34", "ID3", # Monocytes (IGSF21+ GPR34+)" 
          "MS4A1", "CD74", "CD19", # B cells
          "CLEC9A", "XCR1", "IRF8", # cDC1 
          "CD86", "IDO1", "CD80", # activated DCs 
          "TYMS", "UBE2C", "CDK1", # Dividing cDCs 
          "IGHA1", "IGHM", "MZB1", # IgA+ Plasma cells 
          "IGHG1", "IGKC", "PRDX4", # IgG+ Plasma cells 
          "ICOS", "MT1X", "CREM", # ab-T cells (stress) 
          "PLVAP", "RGCC", "RBP7", # LSEC (fenestr.) 
          "XCL1", "CCL3", "TIGIT", # NK cells 3 
          "KLRF1", "NKG7", "TOX2", # NK cells 2 
          "PTGDS", "CX3CR1", "PRF1", # Infiltrating NK cells 
          "TRDC", "CD3E", "KLRC2", # gd-T cells 
          "STMN1", "MKI67", "TOP2A", # Dividing T/NK cells 
          "CXCR6", "CCR6", "CCR5", # MAIT cells 1 
          "SELL", "CCR7", "CD4", # Naive CD4+ T cells 
          "ITGA1", "THEMIS", "LGALS3", # TRM cells 
          "LMNA", "CD44", "ANXA1", # CD8 ab-T cells 3 
          "CD8B", "GZMK", "TRAC", # CD8 ab-T cells 2 
          "RORC", "ZBTB16", "CXCR4", # MAIT cells 2 
          "PROX1", "CCL21", "TFF3", # Lymphatic EC 
          "FOXP3", "CTLA4", "BATF", # Treg 
          "CD8A", "TNF", "RGS2", # CD8 ab-T cells 1 
          "IL2RB", "PLCG2", "FCER1G", # NK cells 1 
          "DCN", "COLEC11", "ACTA2", # Stellate cells 
          "HES4", "CXCL10", "CD52", # Macrophages (HES4+) 
          "PCNA", "NUSAP1", "PRC1", # Dividing endothelial cells 
          "KIT", "SOX4", "AHR" # ILC3 
)

avg_exp_mk = AverageExpression(sub_allcells_css, assays = "SCT", 
                               features = allmk, group.by = "subpops")$SCT

saveRDS(avg_exp_mk, file = "results/cond_effect_v2/avg_exp_mk_more.RDS")

pheatmap::pheatmap(t(avg_exp_mk), scale = "column", clustering_method = "ward.D", treeheight_row = 30,
                   treeheight_col = 0, fontsize_row = 7, fontsize_col = 7.2, cutree_rows = 17)
```

Calculate cell type markers

```{r}
cell_type_mk = list()
sub_allcells_css = SetIdent(sub_allcells_css, value = "subpops")
cell_type_mk[["all"]] = FindAllMarkers(sub_allcells_css, 
                                        assay = "SCT", test.use = "wilcox",
                                        pseudocount.use = 0.1, logfc.threshold = 0.2,
                                        max.cells.per.ident = 10000,
                                        min.cells.feature = 10, verbose = T)

simp_allcells_css = SetIdent(simp_allcells_css, value = "subpops_simp")
cell_type_mk[["simp"]] = FindAllMarkers(simp_allcells_css, 
                                        assay = "SCT", test.use = "wilcox",
                                        pseudocount.use = 0.1, logfc.threshold = 0.2,
                                        max.cells.per.ident = 10000,
                                        min.cells.feature = 10, verbose = T)

saveRDS(cell_type_mk, file = "results/cond_effect_v2/cell_type_mk_more.RDS")
```

Getting all relevant marker gene tables in one place

```{r}
write.csv(cell_type_mk$all[cell_type_mk$all$p_val_adj<=0.05,],
          "results/cond_effect_v2/cell_type_mk_all.csv", col.names = T, row.names = T, quote = F)

mkend = readRDS(file = "results/endothelial/clust_markers_endo_only.RDS")
end_annot = c("0" = "Midzonal LSEC", "1" = "Pericentral LSEC", "2" = "LSEC (stress)",
              "3" = "Periportal LSEC", "4" = "EC non-LSEC", "5" = "LSEC (interferon)",
              "6" = "LSEC (remodelling)", "7" = "LSEC (high MT 1)", "8" = "LSEC (high MT 2)",
              "9" = "LSEC (fenestr.)", "10" = "Lymphatic EC", "11" = "Cycling cells",
              "12" = "Periportal LSEC")
mkend$cluster = end_annot[as.character(mkend$cluster)]
write.csv(mkend[mkend$p_val_adj<=0.05,], 
          file = "results/cond_effect_v2/cell_type_mk_endothelial.csv", row.names = T, quote = F)

mk_lcells = read.csv("results/immune/markers_lymphoid_subpop_all.csv", header = T, row.names = 1)
new_l_labs = c("0" = "ab-T cells 1", "1" = "NK/gd-T cells", "2" = "ab-T cells 2",
               "3" = "Infiltrating NK cells", "4" = "IgA+ Plasma cells", "5" = "B cells", 
               "6" = "IgG+ Plasma cells", "7" = "Dividing NK cells", "8" = "ab-T cells (stress)")
mk_lcells$cluster = new_l_labs[as.character(mk_lcells$cluster)]
write.csv(mk_lcells[mk_lcells$p_val_adj<=0.05,], 
          file = "results/cond_effect_v2/cell_type_mk_lymphoid.csv", row.names = T, quote = F)

mk_tcells = readRDS("./results/immune/clust_markers_t.RDS")
new_t_labs = c("0" = "NK cells 1", "1" = "TRM cells", "2" = "MAIT cells 2", "3" = "NK cells 2",
               "4" = "NK cells 3", "5" = "CD8 ab-T cells 2", "6" = "MAIT cells 1", 
               "7" = "Infiltrating NK cells", "8" = "Naive CD4+ T cells", "9" = "gd-T cells", 
               "10" = "CD8 ab-T cells 3", "11" = "CD8 ab-T cells 1", "12" = "Treg", "13" = "ILC3")
mk_tcells$cluster = new_t_labs[as.character(mk_tcells$cluster)]
write.csv(mk_tcells[mk_tcells$p_val_adj<=0.05,], 
          file = "results/cond_effect_v2/cell_type_mk_tnk.csv", row.names = T, quote = F)

mk_mon = readRDS("./results/immune/clust_markers_mon.RDS")
new_m_labs = c("0" = "Kupffer cells", "1" = "cDC2", "2" = "Monocytes (IGSF21+ GPR34+)", 
               "3" = "Macrophages (HES4+)", "4" = "Kupffer cells (SUCNR1+)", "5" = "Macrophages",
               "6" = "Monocytes (TREM2+ CD9+)", "7" = "cDC2", "8" = "cDC1", 
               "9" = "Monocytes (secretory)", "10" = "activated DCs")
mk_mon$cluster = new_m_labs[as.character(mk_mon$cluster)]
write.csv(mk_mon[mk_mon$p_val_adj<=0.05,], 
          file = "results/cond_effect_v2/cell_type_mk_myeloid.csv", row.names = T, quote = F)
```



```{r}
abtab = read.csv("data/other/AB_summary.csv", header = T)[,1:4]
abtab$TARGET = toupper(abtab$TARGET)
ct_ab = cell_type_mk$all[cell_type_mk$all$p_val_adj<=0.05,]
ct_ab$hasAB = ct_ab$gene %in% abtab$TARGET


mrks_q = SoupX::quickMarkers(sub_allcells_css@assays$SCT@counts,
                             sub_allcells_css$subpops, N = 10)
```



```{r}
ct_df = unique(sub_allcells_css@meta.data[,c("subpops", "allcells_major")])
tab_ctCond = table(sub_allcells_css$subpops, sub_allcells_css$Condition)
tab_ctCond_imm = tab_ctCond[!(grepl("LSEC", rownames(tab_ctCond)) | 
                                grepl("Hepa", rownames(tab_ctCond)) |
                                grepl("Stella", rownames(tab_ctCond)) | 
                                grepl("Cholan", rownames(tab_ctCond)) | 
                                grepl("endoth", rownames(tab_ctCond)) | 
                                grepl("EC", rownames(tab_ctCond))),]
t(t(tab_ctCond_imm)/colSums(tab_ctCond_imm))*100
```


```{r}
tab_ctCond = table(sub_allcells_css$subpops, sub_allcells_css$Condition)
tab_ctCond_imm = tab_ctCond[!(grepl("LSEC", rownames(tab_ctCond)) | 
                                grepl("Hepa", rownames(tab_ctCond)) |
                                grepl("Stella", rownames(tab_ctCond)) | 
                                grepl("Cholan", rownames(tab_ctCond)) | 
                                grepl("endoth", rownames(tab_ctCond)) | 
                                grepl("EC", rownames(tab_ctCond))),]
t(t(tab_ctCond_imm)/colSums(tab_ctCond_imm))*100

ct_df = unique(sub_allcells_css@meta.data[,c("subpops", "allcells_major")])
don_cond_df = unique(sub_allcells_css@meta.data[,c("Name", "Donor", "Condition")])
tab_ctCond = table(sub_allcells_css$subpops, sub_allcells_css$Name)
tab_ctCond_imm = tab_ctCond[!(grepl("LSEC", rownames(tab_ctCond)) | 
                                grepl("Hepa", rownames(tab_ctCond)) |
                                grepl("Stella", rownames(tab_ctCond)) | 
                                grepl("Cholan", rownames(tab_ctCond)) | 
                                grepl("endoth", rownames(tab_ctCond)) | 
                                grepl("EC", rownames(tab_ctCond))),]
imm_props = t(t(tab_ctCond_imm)/colSums(tab_ctCond_imm))*100
imm_props = merge(data.frame(imm_props), don_cond_df, by.x = 2, by.y = 1)

ggplot(imm_props, aes(x = Condition, y = Freq, group = Condition, colour = Condition))+
  facet_wrap(~Var1, scales = "free")+
  geom_jitter(position = position_jitterdodge(jitter.width = 0.3, dodge.width = 1))+
  stat_summary(fun.data = mean_se, position = position_dodge(width = 1), 
               alpha = 0.35, colour = "black")+
  theme(legend.position = "none")
```

Load interactions data

```{r}
reform_list = readRDS("results/cell_comm/updt/reform_list.RDS")
net_names_l = readRDS("results/cell_comm/updt/count_net_list.RDS")
dec_l = readRDS("results/cell_comm/updt/deconvoluted_list.RDS")
lr_annot = read.csv("../../gene_refs/human/CellPhoneDB/protein_input.csv")
prot_g = read.csv("../../gene_refs/human/CellPhoneDB/gene_input.csv")

notsec = lr_annot$uniprot[lr_annot$secreted=="False"]
notsec_genes = unique(prot_g$gene_name[prot_g$uniprot %in% notsec])

colcond = c("healthy" = "orange", "regenerating" = "salmon", 
            "embolised" = "darkred", "embolized" = "darkred")
```

Count only non-secreted interactions

```{r}
reform_list_int = list()
for(n in names(reform_list)[1:3]){
  reform_list_int[[n]] = reform_list[[n]][reform_list[[n]]$lr1 %in% notsec_genes &
                                            reform_list[[n]]$lr2 %in% notsec_genes,]
  reform_list_int[[n]] = reform_list_int[[n]][!duplicated(reform_list_int[[n]][,1:3]),1:3]
}

# count interactions
infer_df = data.frame(expand.grid(unique(reform_list_int$healthy$ct1), 
                                  unique(reform_list_int$healthy$ct1)))
nr = nrow(infer_df)
infer_df = rbind(infer_df, infer_df, infer_df)
infer_df$count = 0
infer_df$cond = rep(names(reform_list)[1:3], each = nr)
colnames(infer_df)[1:2] = c("SOURCE", "TARGET")
for(i in 1:nrow(infer_df)){
  tmp = reform_list_int[[infer_df[i,4]]]
  infer_df[i,3] = dim(tmp[(tmp$ct1==infer_df[i,1] & tmp$ct2==infer_df[i,2]) |
                            (tmp$ct2==infer_df[i,1] & tmp$ct1==infer_df[i,2]),])[1]
}

hmat = reshape2::dcast(infer_df[infer_df$cond=="healthy",1:3], formula = SOURCE~TARGET, 
                       value.var = "count")
rownames(hmat) = hmat[,1]
hmat = hmat[,-1]
emat = reshape2::dcast(infer_df[infer_df$cond=="embolised",1:3], formula = SOURCE~TARGET, 
                       value.var = "count")
rownames(emat) = emat[,1]
emat = emat[,-1]
rmat = reshape2::dcast(infer_df[infer_df$cond=="regenerating",1:3], formula = SOURCE~TARGET, 
                       value.var = "count")
rownames(rmat) = rmat[,1]
rmat = rmat[,-1]

pheatmap::pheatmap(rmat-hmat, clustering_method = "ward.D", fontsize = 8, 
                   treeheight_col = 28, treeheight_row = 28, main = "regen-healthy")
pheatmap::pheatmap(emat-hmat, clustering_method = "ward.D", fontsize = 8, 
                   treeheight_col = 28, treeheight_row = 28, main = "emb-healthy")
```

Add info on AB available (for lr1 and lr2), contact interaction, unique to condition

```{r}
reform_info = list()
for(n in names(reform_list)[1:3]){
  reform_info[[n]] = reform_list[[n]][,-7]
  reform_info[[n]]$condition = n
}

# is the interaction condition-specific?
for(n in names(reform_info)){
  other_cond = names(reform_info)[names(reform_info)!=n]
  reform_info[[n]]$condition_specific = !(reform_info[[n]]$id_cp_interaction %in% reform_info[[other_cond[1]]]$id_cp_interaction | reform_info[[n]]$id_cp_interaction %in% reform_info[[other_cond[2]]]$id_cp_interaction)
}

# how many times does the interaction appear in that condition
for(n in names(reform_info)){
  tmp = unique(reform_info[[n]][,1:3])
  reform_info[[n]] = merge(reform_info[[n]], data.frame(table(tmp$id_cp_interaction)), by = 1)
  colnames(reform_info[[n]])[colnames(reform_info[[n]])=="Freq"] = "n_interaction_condition"
}

# add gene names
complex_ref = unique(rbind(dec_l$healthy[dec_l$healthy$is_complex=="True",c(1,5)], 
                           dec_l$embolised[dec_l$embolised$is_complex=="True",c(1,5)],
                           dec_l$regenerating[dec_l$regenerating$is_complex=="True",c(1,5)],
                           dec_l$healthy_simp[dec_l$healthy_simp$is_complex=="True",c(1,5)],
                           dec_l$embolised_simp[dec_l$embolised_simp$is_complex=="True",c(1,5)],
                           dec_l$regenerating_simp[dec_l$regenerating_simp$is_complex=="True",c(1,5)]))

for(n in names(reform_info)){
  tmp = merge(reform_info[[n]], complex_ref, by.x = 4, by.y = 2, all.x = T)[,c(2,3,4,1,10,5:9)]
  reform_info[[n]] = merge(tmp, complex_ref, by.x = 6, by.y = 2, all.x = T)[,c(2:6,1,11,7:10)]
  reform_info[[n]]$gene_name.x[is.na(reform_info[[n]]$gene_name.x)] = reform_info[[n]]$lr1[is.na(reform_info[[n]]$gene_name.x)]
  reform_info[[n]]$gene_name.y[is.na(reform_info[[n]]$gene_name.y)] = reform_info[[n]]$lr2[is.na(reform_info[[n]]$gene_name.y)]
  colnames(reform_info[[n]])[c(5,7)] = c("gn1", "gn2")
}

# AB availability and is contact interaction
for(n in names(reform_info)){
  reform_info[[n]]$AB_gn1 = reform_info[[n]]$gn1 %in% abtab$TARGET
  reform_info[[n]]$AB_gn2 = reform_info[[n]]$gn2 %in% abtab$TARGET
  reform_info[[n]]$isContact = reform_info[[n]]$gn1 %in% notsec_genes &
    reform_info[[n]]$gn2 %in% notsec_genes
}

# number of interactions by that cell type pair in that condition (non-directional)
## total
## contact only
for(n in names(reform_info)){
  tmp = unique(reform_info[[n]][,1:3])
  tabct = table(tmp$ct1, tmp$ct2)
  tmp = unique(reform_info[[n]][reform_info[[n]]$isContact,1:3])
  tabcon = table(tmp$ct1, tmp$ct2)
  
  n_interact = c()
  n_contact = c()
  ctpair = c()
  for(i in 1:nrow(reform_info[[n]])){
    ct1 = reform_info[[n]]$ct1[i]
    ct2 = reform_info[[n]]$ct2[i]
    nint = tabct[ct1,ct2]+tabct[ct2,ct1]
    n_interact = c(n_interact, nint)
    ncon = tabcon[ct1,ct2]+tabcon[ct2,ct1]
    n_contact = c(n_contact, ncon)
    ctpair = c(ctpair, paste(sort(c(ct1, ct2)), collapse = ".."))
  }
  reform_info[[n]]$ctpair = ctpair
  reform_info[[n]]$n_interact = n_interact
  reform_info[[n]]$n_contact = n_contact
}

interactions_info_df = Reduce(rbind, reform_info)

write.csv(interactions_info_df, 
          file = "results/cond_effect_v2/info_all_interactions.csv", row.names = F, quote = F)
```

Difference in number of interactions

```{r}
ninterdf = unique(interactions_info_df[,c(9,15:17)])
ninterdf = ninterdf[order(ninterdf$ctpair),]
ninterdf$ct1 = unlist(lapply(strsplit(ninterdf$ctpair, "..", fixed = T), function(x) x[1]))
ninterdf$ct2 = unlist(lapply(strsplit(ninterdf$ctpair, "..", fixed = T), function(x) x[2]))

# pairs of cell types with increased contacts in any condition
ninterdf_diffs = ninterdf[ninterdf$condition=="healthy",c(2,5:6)]

## calculate difference in interactions
ninterdf_diffs$hr_inter = ninterdf[ninterdf$condition=="regenerating",3]-ninterdf[ninterdf$condition=="healthy",3]
ninterdf_diffs$he_inter = ninterdf[ninterdf$condition=="embolised",3]-ninterdf[ninterdf$condition=="healthy",3]

## calculate difference in contacts
ninterdf_diffs$hr_contact = ninterdf[ninterdf$condition=="regenerating",4]-ninterdf[ninterdf$condition=="healthy",4]
ninterdf_diffs$he_contact = ninterdf[ninterdf$condition=="embolised",4]-ninterdf[ninterdf$condition=="healthy",4]

write.csv(ninterdf, 
          file = "results/cond_effect_v2/number_interactions_and_contacts.csv", 
          row.names = F, quote = F)
write.csv(ninterdf_diffs, 
          file = "results/cond_effect_v2/difference_in_interactions_and_contacts.csv", 
          row.names = F, quote = F)
```

HVI

```{r}
int_mat_vals = list()
mat_l = list()
for(n in names(reform_list)[1:3]){
  tmp = unique(reform_list[[n]][,c(2:6)])
  tmp = tmp[tmp$ct1!=tmp$ct2,]
  tmp$ctpair = paste0(tmp$ct1, "..", tmp$ct2)
  tmp$lrpair = paste0(tmp$lr1, "..", tmp$lr2)
  
  mat = reshape2::dcast(tmp, ctpair~lrpair, value.var = "value")
  mat_l[[n]] = mat
  mat_l[[n]][,1] = paste0(mat_l[[n]][,1] , ";", n)
  rownames(mat_l[[n]]) = mat_l[[n]][,1]
  mat_l[[n]] = mat_l[[n]][,-1]
  mat_l[[n]] = t(mat_l[[n]])
  
  rownames(mat) = mat$ctpair
  mat = mat[,-1]
  mat[is.na(mat)] = 0
  varfeat = Seurat:::FindVariableFeatures.default(t(mat))
  varfeat$pair_perc = apply(mat, 2, function(x) sum(x>0)/length(x))
  varfeat$pair_n = apply(mat, 2, function(x) sum(x>0))
  varfeat$lrpair = colnames(mat)
  
  int_mat_vals[[n]] = varfeat
}
mat_all = merge(mat_l$healthy, mat_l$embolised, by = 0, all = T)
mat_all = merge(mat_all, mat_l$regenerating, by.x = 1, by.y = 0, all = T)
rownames(mat_all) = mat_all[,1]
mat_all = mat_all[,-1]
mat_all[is.na(mat_all)] = 0

varfeat = Seurat:::FindVariableFeatures.default(mat_all)
varfeat$pair_perc = apply(mat_all, 1, function(x) sum(x>0)/length(x))
varfeat$pair_n = apply(mat_all, 1, function(x) sum(x>0))
varfeat$lrpair = rownames(mat_all)

toy = RVenn::Venn(lapply(int_mat_vals, function(x) x$lrpair))

uniqueint = c(RVenn::discern(toy, 1), RVenn::discern(toy, 2), RVenn::discern(toy, 3))
pairs_unique = lapply(uniqueint, function(x) colnames(mat_all)[mat_all[x,]>0])
names(pairs_unique) = uniqueint
unique_interactions = merge(reshape2::melt(pairs_unique),
                            data.frame(table(reshape2::melt(pairs_unique)[,2])), 
                            by.x = 2, by.y = 1)
write.csv(unique_interactions, 
          file = "results/cond_effect_v2/unique_interactions.csv", 
          row.names = F, quote = F)

sharedint = RVenn::overlap(toy)
notsharedint = rownames(mat_all)[!(rownames(mat_all) %in% sharedint)]
pairs_notshared = lapply(notsharedint, function(x) colnames(mat_all)[mat_all[x,]>0])
names(pairs_notshared) = notsharedint
notshared_interactions = merge(reshape2::melt(pairs_notshared),
                               data.frame(table(reshape2::melt(pairs_notshared)[,2])), 
                               by.x = 2, by.y = 1)
conds = tapply(notshared_interactions$value, notshared_interactions$L1, 
               function(x) paste0(unique(unlist(lapply(strsplit(x,";"), 
                                                       function(y) y[length(y)]))), collapse = ", "))
notshared_interactions = merge(notshared_interactions, data.frame(conds), by.x = 1, by.y = 0, all = T)
write.csv(notshared_interactions, 
          file = "results/cond_effect_v2/notshared_interactions.csv", 
          row.names = F, quote = F)

xxx = lapply(int_mat_vals, function(x) x$lrpair[x$pair_n<=2])
ints = unique(unlist(xxx))
yyy = varfeat$lrpair[varfeat$pair_n<=5]
ints = intersect(ints, yyy)
dat = mat_all[(rownames(mat_all) %in% uniqueint),apply(mat_all[(rownames(mat_all) %in% uniqueint),], 2, function(x) any(x>0))]
pheatmap::pheatmap(log2(dat+0.01), show_rownames = T, clustering_method = "ward.D", fontsize_row = 7.5, fontsize_col = 7.5)
```









```{r}
vals_hr = sort(unique(ninterdf_diffs$hr_contact))
vals_hr = vals_hr[c(1:4, (length(vals_hr)-3):(length(vals_hr)))]

ct_target = unique(c(ninterdf_diffs$ct1[ninterdf_diffs$hr_contact %in% vals_hr],
                     ninterdf_diffs$ct2[ninterdf_diffs$hr_contact %in% vals_hr]))

interactions_info_df[interactions_info_df$ct1 %in% ct_target & 
                       interactions_info_df$ct2 %in% ct_target &
                       interactions_info_df$ct1!=interactions_info_df$ct2,]
```




```{r}
# pairs of cell types with increased contacts in any condition
ninterdf_diffs = ninterdf[ninterdf$condition=="healthy",c(2,5:6)]

## calculate difference in interactions
ninterdf_diffs$hr_inter = ninterdf[ninterdf$condition=="regenerating",3]-ninterdf[ninterdf$condition=="healthy",3]
ninterdf_diffs$he_inter = ninterdf[ninterdf$condition=="embolised",3]-ninterdf[ninterdf$condition=="healthy",3]

## calculate difference in contacts
ninterdf_diffs$hr_contact = ninterdf[ninterdf$condition=="regenerating",4]-ninterdf[ninterdf$condition=="healthy",4]
ninterdf_diffs$he_contact = ninterdf[ninterdf$condition=="embolised",4]-ninterdf[ninterdf$condition=="healthy",4]

## calculate difference in contacts
ninterdf_diffs$hr_other = (ninterdf[ninterdf$condition=="regenerating",3]-ninterdf[ninterdf$condition=="regenerating",4])-(ninterdf[ninterdf$condition=="healthy",3]-ninterdf[ninterdf$condition=="healthy",4])
ninterdf_diffs$he_other = (ninterdf[ninterdf$condition=="embolised",3]-ninterdf[ninterdf$condition=="embolised",4])-(ninterdf[ninterdf$condition=="healthy",3]-ninterdf[ninterdf$condition=="healthy",4])

ninterdf_diffs$r_other = (ninterdf[ninterdf$condition=="regenerating",4]-(ninterdf[ninterdf$condition=="regenerating",3]-ninterdf[ninterdf$condition=="regenerating",4]))/ninterdf[ninterdf$condition=="regenerating",3]


## calculate proportion of contacts in interactions
ninterdf_diffs$p_h = ninterdf[ninterdf$condition=="healthy",4]/ninterdf[ninterdf$condition=="healthy",3]
ninterdf_diffs$p_r = ninterdf[ninterdf$condition=="regenerating",4]/ninterdf[ninterdf$condition=="regenerating",3]
ninterdf_diffs$p_e = ninterdf[ninterdf$condition=="embolised",4]/ninterdf[ninterdf$condition=="embolised",3]

## number of interactions per condition
ninterdf_diffs$n_h = ninterdf[ninterdf$condition=="healthy",3]
ninterdf_diffs$n_r = ninterdf[ninterdf$condition=="regenerating",3]
ninterdf_diffs$n_e = ninterdf[ninterdf$condition=="embolised",3]

## % of diff contacts from diff interactions
ninterdf_diffs$hr_p = ninterdf_diffs$p_r-ninterdf_diffs$p_h
ninterdf_diffs$he_p = ninterdf_diffs$p_e-ninterdf_diffs$p_h


```










```{r}
reform_list_int = list()
for(n in names(reform_list)[1:3]){
  reform_list_int[[n]] = reform_list[[n]]
  reform_list_int[[n]] = reform_list_int[[n]][!duplicated(reform_list_int[[n]][,1:3]),1:3]
}

# count interactions
infer_df = data.frame(expand.grid(unique(reform_list_int$healthy$ct1), 
                                  unique(reform_list_int$healthy$ct1)))
nr = nrow(infer_df)
infer_df = rbind(infer_df, infer_df, infer_df)
infer_df$count = 0
infer_df$cond = rep(names(reform_list)[1:3], each = nr)
colnames(infer_df)[1:2] = c("SOURCE", "TARGET")
for(i in 1:nrow(infer_df)){
  tmp = reform_list_int[[infer_df[i,4]]]
  infer_df[i,3] = dim(tmp[(tmp$ct1==infer_df[i,1] & tmp$ct2==infer_df[i,2]) |
                            (tmp$ct2==infer_df[i,1] & tmp$ct1==infer_df[i,2]),])[1]
}
## make one to count over all
infer_all = data.frame(expand.grid(unique(reform_list_int$healthy$ct1), 
                                   unique(reform_list_int$healthy$ct1)))
infer_all$count = 0
colnames(infer_all)[1:2] = c("SOURCE", "TARGET")
reform_all_int = unique(Reduce(rbind, reform_list_int))
for(i in 1:nrow(infer_all)){
  infer_all[i,3] = infer_all[i,3]+dim(tmp[(reform_all_int$ct1==infer_all[i,1] & reform_all_int$ct2==infer_all[i,2]) |
                                            (reform_all_int$ct2==infer_all[i,1] & reform_all_int$ct1==infer_all[i,2]),])[1]
}

infer_df_list = list(healthy = infer_df[infer_df$cond=="healthy",],
                     embolised = infer_df[infer_df$cond=="embolised",],
                     regenerating = infer_df[infer_df$cond=="regenerating",],
                     all = infer_all)

net_names_all = t(Reduce(rbind, lapply(infer_df_list[1:3], function(x) tapply(x$count, x$SOURCE, sum))))
colnames(net_names_all) = names(net_names_l)[1:3]
net_names_all = reshape2::melt(net_names_all)
net_names_all$Var1 = factor(net_names_all$Var1, 
                            levels = net_names_all[net_names_all$Var2=="healthy","Var1"][order(net_names_all[net_names_all$Var2=="healthy","value"], decreasing = F)])

total_unique = data.frame(t(t(Reduce(rbind, lapply(infer_df_list[4], 
                                                   function(x) tapply(x$count, x$SOURCE, sum))))))
total_unique$Var1 = rownames(total_unique)
colnames(total_unique)[1] = "value"
total_unique$Var2 = "total unique"

net_names_all$Var1 = factor(net_names_all$Var1, levels = total_unique$Var1[order(total_unique$value, decreasing = F)])
plt_counts = ggplot(net_names_all, aes(x = Var1, y = value))+
  geom_point(mapping = aes(colour = Var2), size = 1.6)+
  geom_point(data = total_unique, mapping = aes(shape = Var2), size = 1.6)+
  coord_flip()+
  scale_colour_manual(values = colcond)+
  scale_shape_manual(values = c(4))+
  scale_y_continuous(expand = c(0,0), limits = c(0,6680))+
  labs(y = "Total interactions", x = "Cell Type", colour = "Condition")+
  guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2, title = NULL))+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1),
        axis.text = element_text(colour = "black"),
        axis.title.x = element_text(size = 8),
        legend.margin = margin(1, 1, 1, 1),
        legend.spacing.x = unit(0.05, "cm"),
        legend.direction = "horizontal",legend.box = "horizontal")
leg = cowplot::get_legend(plt_counts)

perc_df = data.frame("Var1" = net_names_all$Var1,
                     "Var2" = net_names_all$Var2,
                     "perc" = c(rep(0, length(unique(net_names_all$Var1))),
                                (net_names_all$value[net_names_all$Var2=="embolised"]-net_names_all$value[net_names_all$Var2=="healthy"])/net_names_all$value[net_names_all$Var2=="healthy"],
                                (net_names_all$value[net_names_all$Var2=="regenerating"]-net_names_all$value[net_names_all$Var2=="healthy"])/net_names_all$value[net_names_all$Var2=="healthy"])*100)
perc_df$col = ifelse(perc_df$perc>0, "green", "red")
perc_df = perc_df[perc_df$Var2!="healthy",]

perc_plt_emb = ggplot(perc_df[perc_df$Var2=="embolised",], aes(x = Var1, y = perc, fill = col))+
  geom_col()+
  scale_fill_manual(values = c("deepskyblue1", "red1"))+
  scale_y_continuous(expand = c(0,0), limits = c(min(perc_df[,"perc"])-3,
                                                 max(perc_df[,"perc"])+3))+
  coord_flip()+
  labs(y = "% change\nembolised vs healthy", x = "Cell Type")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1, colour = "black"),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none")
perc_plt_reg = ggplot(perc_df[perc_df$Var2=="regenerating",], aes(x = Var1, y = perc, fill = col))+
  geom_col()+
  scale_fill_manual(values = c("deepskyblue1", "red1"))+
  scale_y_continuous(expand = c(0,0), limits = c(min(perc_df[,"perc"])-3,
                                                 max(perc_df[,"perc"])+3))+
  coord_flip()+
  labs(y = "% change\nregenerating vs healthy", x = "Cell Type")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1, colour = "black"),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none")

cowplot::plot_grid(cowplot::plot_grid(plt_counts+theme(legend.position = "none"), 
                                      perc_plt_emb, perc_plt_reg, 
                                      ncol = 3, align = "h", axis = "r", rel_widths = c(1,0.5,0.5)),
                   leg, nrow = 2, rel_heights = c(1, 0.1))

cowplot::plot_grid(cowplot::plot_grid(plt_counts+theme(legend.position = "none"), 
                                      perc_plt_reg, perc_plt_emb, 
                                      ncol = 3, align = "h", axis = "r", rel_widths = c(1,0.4,0.4)),
                   leg, nrow = 2, rel_heights = c(1, 0.1))
```



```{r}
allct = unique(reform_list$regenerating$ct1)
immct = allct[!(grepl("LSEC", allct) | grepl("Hepa",allct) |
                grepl("Stella", allct) | grepl("Cholan", allct) | 
                grepl("endoth", allct) | grepl("EC", allct))]
nonimmct = allct[grepl("LSEC", allct) | grepl("Hepa", allct) |
                grepl("Stella", allct) | grepl("Cholan", allct) | 
                grepl("endoth", allct) | grepl("EC", allct)]

reform_list_int = list()
for(n in names(reform_list)[1:3]){
  cond = (reform_list[[n]]$ct1 %in% immct & reform_list[[n]]$ct2 %in% nonimmct) | 
    (reform_list[[n]]$ct1 %in% nonimmct & reform_list[[n]]$ct2 %in% immct)
  reform_list_int[[n]] = reform_list[[n]][cond,]
  reform_list_int[[n]] = reform_list_int[[n]][reform_list_int[[n]]$lr1 %in% notsec_genes &
                                                reform_list_int[[n]]$lr2 %in% notsec_genes,]
  reform_list_int[[n]] = reform_list_int[[n]][!duplicated(reform_list_int[[n]][,1:3]),1:3]
}

# count interactions
infer_df = data.frame(expand.grid(unique(reform_list_int$healthy$ct1), 
                                  unique(reform_list_int$healthy$ct1)))
nr = nrow(infer_df)
infer_df = rbind(infer_df, infer_df, infer_df)
infer_df$count = 0
infer_df$cond = rep(names(reform_list)[1:3], each = nr)
colnames(infer_df)[1:2] = c("SOURCE", "TARGET")
for(i in 1:nrow(infer_df)){
  tmp = reform_list_int[[infer_df[i,4]]]
  infer_df[i,3] = dim(tmp[(tmp$ct1==infer_df[i,1] & tmp$ct2==infer_df[i,2]) |
                            (tmp$ct2==infer_df[i,1] & tmp$ct1==infer_df[i,2]),])[1]
}

#infer_df = infer_df[infer_df$count>0,]
for(i in 1:nrow(infer_df)){
  if(infer_df[i,1] %in% immct){
    tmp = infer_df[i,2]
    infer_df[i,2] = infer_df[i,1]
    infer_df[i,1] = tmp
  }
}
infer_df = infer_df[!duplicated(infer_df),]
infer_df = infer_df[infer_df$SOURCE %in% nonimmct & infer_df$TARGET %in% immct,]

hmat = reshape2::dcast(infer_df[infer_df$cond=="healthy",1:3], formula = SOURCE~TARGET, 
                       value.var = "count")
rownames(hmat) = hmat[,1]
hmat = hmat[,-1]
emat = reshape2::dcast(infer_df[infer_df$cond=="embolised",1:3], formula = SOURCE~TARGET, 
                       value.var = "count")
rownames(emat) = emat[,1]
emat = emat[,-1]
rmat = reshape2::dcast(infer_df[infer_df$cond=="regenerating",1:3], formula = SOURCE~TARGET, 
                       value.var = "count")
rownames(rmat) = rmat[,1]
rmat = rmat[,-1]

pheatmap::pheatmap(rmat-hmat)


```



```{r}
grid_cts = data.frame(expand.grid(unique(reform_list_int$healthy$ct1), 
                                  unique(reform_list_int$healthy$ct1)))

pair_df_list = list()
for(i in 1:nrow(grid_cts)){
  ct_pairs = grid_cts[i,]
  list_pairs = list()
  for(n in names(reform_list[1:3])){
    cond = reform_list[[n]]$ct1==ct_pairs[1] & reform_list[[n]]$ct2==ct_pairs[2]
    if(sum(cond)>0){
      list_pairs[[n]] = reform_list[[n]][cond,-7]
      list_pairs[[n]]$cond = n
      list_pairs[[n]]$contact_interaction = list_pairs[[n]]$lr1 %in% notsec_genes & 
        list_pairs[[n]]$lr2 %in% notsec_genes
    }
  }
  pair_df = Reduce(rbind, list_pairs)
  intcond = table(pair_df$id_cp_interaction, pair_df$cond)
  useint = rownames(intcond)[rowSums(intcond)==1]
  pair_df$unique_cond = pair_df$id_cp_interaction %in% useint
  pair_df_list[[i]] = pair_df
}
inter_info_df = Reduce(rbind, pair_df_list)



cond_l = list()
for(n in names(reform_list[1:3])){
  u_int = table(reform_list[[n]]$id_cp_interaction)
  u_int = names(u_int)[u_int==1]
  cond_l[[n]] = reform_list[[n]][,-7]
  cond_l[[n]]$condition = n
  cond_l[[n]]$contact_interaction = cond_l[[n]]$lr1 %in% notsec_genes & 
    cond_l[[n]]$lr2 %in% notsec_genes
  cond_l[[n]]$unique_ct = cond_l[[n]]$id_cp_interaction %in% u_int
}
inter_info_df = Reduce(rbind, cond_l)
intcond = table(inter_info_df$id_cp_interaction, inter_info_df$condition)
inter_info_df$unique_cond = inter_info_df$id_cp_interaction %in% rownames(intcond)[rowSums(intcond)==1]
```



```{r}
# select cell type pairs
# for each, get LR pairs that are unique to that condition
ct_pairs = list(c("gd-T cells", "Stellate cells"), c("cDC2", "Stellate cells"), 
                c("Dividing endothelial cells", "Kupffer cells"), c("cDC2", "Hepatocytes_Z2"),
                c("Periportal LSEC", "pDCs"), c("EC non-LSEC", "Kupffer cells"),
                c("pDCs", "LSEC (interferon)"))

pair_df_list = list()
for(i in 1:length(ct_pairs)){
  list_pairs = list()
  for(n in names(reform_list[1:3])){
    cond = reform_list[[n]]$ct1==ct_pairs[[i]][1] & reform_list[[n]]$ct2==ct_pairs[[i]][2] |
      reform_list[[n]]$ct2==ct_pairs[[i]][1] & reform_list[[n]]$ct1==ct_pairs[[i]][2]
    list_pairs[[n]] = reform_list[[n]][cond,]
    list_pairs[[n]]$cond = n
  }
  pair_df = Reduce(rbind, list_pairs)
  intcond = table(pair_df$id_cp_interaction, pair_df$cond)
  useint = rownames(intcond)[rowSums(intcond)==1]
  pair_df = pair_df[pair_df$id_cp_interaction %in% useint,]
  pair_df_list[[i]] = pair_df
}

```



















Intersection of number of genes in top 250

```{r, fig.height=4, fig.width=5}
top_genes = list()
for(n in names(cell_type_mk)){
  top_genes[[n]] = list()
  for(ct in unique(cell_type_mk[[n]]$cluster)){
    top_genes[[n]][[ct]] = cell_type_mk[[n]][cell_type_mk[[n]]$cluster==ct & 
                                               cell_type_mk[[n]]$p_val_adj<=0.05 & 
                                               cell_type_mk[[n]]$avg_logFC>0,]
    top_genes[[n]][[ct]] = top_genes[[n]][[ct]][order(top_genes[[n]][[ct]]$avg_logFC, 
                                                      decreasing = T),"gene"][1:250]
  }
}
names(top_genes) = c("cell_type","major_ct")

saveRDS(top_genes, file = "results/cond_effect/top_genes_mk.RDS")
```

Save allcells_css again with the new annotations

```{r}
saveRDS(allcells_css, file = "data/processed/allcells_css_reannot.RDS")
```



# DE per cell type
## Condition DE per cell type
Calculate DE (only for cell types with more than 10 cells in one condition)

```{r}
comb_cond = combn(unique(allcells_css@meta.data$Condition), 2)
cond_comparison_list = list()
for(i in 1:ncol(comb_cond)){
  comp = paste0(comb_cond[1,i], "_v_", comb_cond[2,i])
  cond_comparison_list[[comp]] = list()
  for(g in c("cell_type", "major_ct")){
    print(g)
    tab_cond = table(allcells_css@meta.data[,g], allcells_css@meta.data$Condition)
    tab_cond = tab_cond[apply(tab_cond, 1, function(x) all(x>10)),]
    for(ct in rownames(tab_cond)){
      cat(ct)
      allcells_css = SetIdent(allcells_css, value = g)
      mk = FindMarkers(allcells_css[,!is.na(allcells_css@meta.data[,g])], 
                       ident.1 = comb_cond[1,i], ident.2 = comb_cond[2,i],
                       group.by = "Condition", subset.ident = ct, pseudocount.use = 0.1, 
                       logfc.threshold = 0, min.cells.feature = 10,
                       assay = "SCT", max.cells.per.ident = 10000)
      mk$gene = rownames(mk)
      mk$group = g
      mk$celltype = ct
      mk$condition = ifelse(mk$avg_logFC<0, comb_cond[2,i], comb_cond[1,i])
      mk = mk[,c("group", "celltype", "gene", "avg_logFC", 
                 "p_val_adj", "condition", "pct.1", "pct.2")]
      
      if(comp %in% names(cond_comparison_list)){
        cond_comparison_list[[comp]][[g]] = rbind(cond_comparison_list[[comp]][[g]], mk)
      } else{
        cond_comparison_list[[comp]][[g]] = mk
      }
    }
    # add chromosome infor
    cond_comparison_list[[comp]][[g]] = merge(cond_comparison_list[[comp]][[g]], 
                                              chr_tab[,c(2,4)], by.x = "gene", by.y = 1, all.x = T)
  }
}
saveRDS(cond_comparison_list, file = "results/cond_effect/cond_comparison_list.RDS")
```

Repeat for heaptocytes, but use downsampling

```{r}
comb_cond = combn(unique(allcells_css@meta.data$Condition), 2)
cond_comparison_hepsub = list()
for(i in 1:ncol(comb_cond)){
  comp = paste0(comb_cond[1,i], "_v_", comb_cond[2,i])
  cond_comparison_hepsub[[comp]] = list()
  for(g in c("cell_type", "major_ct")){
    print(g)
    tab_cond = table(allcells_css@meta.data[,g], allcells_css@meta.data$Condition)
    tab_cond = rownames(tab_cond)[apply(tab_cond, 1, function(x) all(x>10)) & 
                          grepl("Hepato", rownames(tab_cond)) &
                          !grepl("interact", rownames(tab_cond))]
    for(ct in tab_cond){
      cat(ct)
      hep_cells = allcells_css[,allcells_css@meta.data[,g]==ct &
                                 !is.na(allcells_css@meta.data[,g])]
      
      hep_cells = dsSeurat(hep_cells, "Condition")
      
      hep_cells = SetIdent(hep_cells, value = g)
      mk = FindMarkers(hep_cells[,!is.na(hep_cells@meta.data[,g])], 
                       ident.1 = comb_cond[1,i], ident.2 = comb_cond[2,i],
                       group.by = "Condition", subset.ident = ct, pseudocount.use = 0.1, 
                       logfc.threshold = 0, min.cells.feature = 10,
                       assay = "SCT", max.cells.per.ident = 10000)
      mk$gene = rownames(mk)
      mk$group = g
      mk$celltype = ct
      mk$condition = ifelse(mk$avg_logFC<0, comb_cond[2,i], comb_cond[1,i])
      mk = mk[,c("group", "celltype", "gene", "avg_logFC", 
                 "p_val_adj", "condition", "pct.1", "pct.2")]
      
      if(comp %in% names(cond_comparison_hepsub)){
        cond_comparison_hepsub[[comp]][[g]] = rbind(cond_comparison_hepsub[[comp]][[g]], mk)
      } else{
        cond_comparison_hepsub[[comp]][[g]] = mk
      }
    }
    # add chromosome infor
    cond_comparison_hepsub[[comp]][[g]] = merge(cond_comparison_hepsub[[comp]][[g]] , 
                                                chr_tab[,c(2,4)], by.x = "gene", by.y = 1, all.x = T)
  }
}
saveRDS(cond_comparison_hepsub, file = "results/cond_effect/cond_comparison_hepsub.RDS")
```

Add chromosome information

```{r}
chr_tab = read.csv("../../gene_refs/human/biomart_ens_gn_hgnc_chr.csv", 
                   header = T, stringsAsFactors = F)

cond_comp_chr = list()
for(n in names(cond_comparison_list)){
  cond_comp_chr[[n]] = list()
  for(i in names(cond_comparison_list[[n]])){
    cond_comp_chr[[n]][[i]] = merge(cond_comparison_list[[n]][[i]], 
                                    chr_tab[,c(2,4)], by.x = "gene", by.y = 1, all.x = T)
  }
}
saveRDS(cond_comp_chr, file = "results/cond_effect/cond_comp_chr.RDS")

cond_comp_hep_chr = list()
for(n in names(cond_comparison_hepsub)){
  cond_comp_hep_chr[[n]] = list()
  for(i in names(cond_comparison_hepsub[[n]])){
    cond_comp_hep_chr[[n]][[i]] = merge(cond_comparison_hepsub[[n]][[i]], 
                                    chr_tab[,c(2,4)], by.x = "gene", by.y = 1, all.x = T)
  }
}
saveRDS(cond_comp_hep_chr, file = "results/cond_effect/cond_comp_hep_chr.RDS")
```

Clean DE tables - remove Y chromosome genes and markers of different cell types

```{r}
cond_comparison_list_filt = list()
for(g in names(cond_comparison_list[[1]])){
  cond_comparison_list_filt[[g]] = list()
  for(n in names(cond_comparison_list)){
    tg = top_genes[[g]]
    df_cond_de = cond_comparison_list[[n]][[g]]
    for(ct in names(tg)){
      okgenes = df_cond_de[df_cond_de$celltype==ct,"gene"]
      okgenes = okgenes[!(okgenes %in% unlist(tg[-which(names(tg)==ct)]) &
                            !(okgenes %in% tg[[ct]]))]
      df_cond_de = df_cond_de[df_cond_de$celltype!=ct | 
                                (df_cond_de$celltype==ct &
                                   df_cond_de$gene %in% okgenes),]
    }
    df_cond_de = df_cond_de[!grepl("CHR_", df_cond_de$Chromosome.scaffold.name) & 
                              !(df_cond_de$Chromosome.scaffold.name %in% c("Y","KI270734.1")),]
    df_cond_de = df_cond_de[df_cond_de$celltype %in% names(tg),]
    cond_comparison_list_filt[[g]][[n]] = df_cond_de
  }
}

cond_comparison_hepsub_filt = list()
for(g in names(cond_comparison_hepsub[[1]])){
  cond_comparison_hepsub_filt[[g]] = list()
  for(n in names(cond_comparison_hepsub)){
    tg = top_genes[[g]]
    df_cond_de = cond_comparison_hepsub[[n]][[g]]
    for(ct in names(tg)){
      okgenes = df_cond_de[df_cond_de$celltype==ct,"gene"]
      okgenes = okgenes[!(okgenes %in% unlist(tg[-which(names(tg)==ct)]) &
                            !(okgenes %in% tg[[ct]]))]
      df_cond_de = df_cond_de[df_cond_de$celltype!=ct | 
                                (df_cond_de$celltype==ct &
                                   df_cond_de$gene %in% okgenes),]
    }
    df_cond_de = df_cond_de[!grepl("CHR_", df_cond_de$Chromosome.scaffold.name) & 
                              !(df_cond_de$Chromosome.scaffold.name %in% c("Y","KI270734.1")),]
    df_cond_de = df_cond_de[df_cond_de$celltype %in% names(tg),]
    cond_comparison_hepsub_filt[[g]][[n]] = df_cond_de
  }
}

filt_comps = list("cell_type" = cond_comparison_list_filt$cell_type, 
                  "major_ct" = cond_comparison_list_filt$major_ct, 
                  "cell_type_hep" = cond_comparison_hepsub_filt$cell_type,
                  "major_ct_hep" = cond_comparison_hepsub_filt$major_ct)

saveRDS(filt_comps, file = "results/cond_effect/all_filt_cond_comps.RDS")
```



# Explore results
Reload data

```{r}
allcells_css = readRDS(file = "data/processed/allcells_css_reannot.RDS")
filt_comps = readRDS(file = "results/cond_effect/all_filt_cond_comps.RDS")
```

Get GO Term enrichment

```{r}
fc = 0.3
go_enr_list = list()
for(gr in names(filt_comps)){
  filt_cond_comp_chr = filt_comps[[gr]]
  gr_g = ifelse(endsWith(gr, "hep"), paste0(strsplit(gr, "_")[[1]][1:2], collapse="_"), gr)
  allcells_ct = allcells_css[,!is.na(allcells_css@meta.data[,gr_g])]
  go_enr_list[[gr]] = list()
  for(comp in names(filt_cond_comp_chr)){
    testdf = filt_cond_comp_chr[[comp]][filt_cond_comp_chr[[comp]]$p_val_adj<=0.05,]
    
    ncond = strsplit(comp, "_v_")[[1]]
    go_enr_list[[gr]][[comp]] = list()
    for(ct in unique(testdf$celltype)){
      subtestdf = unique(testdf[testdf$celltype==ct, c("avg_logFC","gene")])
      
      # get DE tested genes
      cells = allcells_ct@meta.data[,gr_g]==ct
      genes = Matrix::rowSums(allcells_ct[,cells]@assays$SCT@data>0)
      genes = genes[genes>(0.1*sum(cells))] # might not include all, but very close
      genes = replace(genes, genes>0, 0)
      genes[subtestdf$gene] = subtestdf$avg_logFC
      
      eg_all = bitr(names(genes), fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
      
      # GO enrichment
      for(cond in ncond){
        fsel = if(cond==ncond[[1]]){
          function(x) return(x>fc)
          } else{
            function(x) return(x<(-fc))
          }
        
        if(length(names(genes)[fsel(genes)])>2){
          eg = bitr(names(genes)[fsel(genes)], fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
          
          # enrichment
          reac = enrichPathway(gene=eg$ENTREZID,pvalueCutoff=0.05, readable=T, universe = eg_all$ENTREZID)
          got = enrichGO(gene = eg$ENTREZID, universe = eg_all$ENTREZID, OrgDb = org.Hs.eg.db, readable = T,
                         ont = "BP", pvalueCutoff  = 1, qvalueCutoff  = 1, pAdjustMethod = "BH")
          hf = "/links/groups/treutlein/USERS/tomasgomes/gene_refs/human/h.all.v7.2.entrez.gmt"
          egmt = enricher(gene = eg$ENTREZID, universe = eg_all$ENTREZID, TERM2GENE=read.gmt(hf),
                          pvalueCutoff = 1, qvalueCutoff = 1, pAdjustMethod = "BH",
                          minGSSize = 0, maxGSSize = 1000000)
          if(!is.null(egmt)){
            egmt = egmt@result
            egmt$geneID = lapply(egmt$geneID, 
                                 function(x) unlist(paste0(bitr(unlist(strsplit(x, "/")),
                                                                fromType="ENTREZID", toType="SYMBOL",
                                                                OrgDb="org.Hs.eg.db")[,2],
                                                           collapse = "/")))
          }
          else{
            egmt = data.frame()
          }
          
          all_terms = rbind(as.data.frame(reac), as.data.frame(got), egmt)
          if(nrow(all_terms)>0){
            all_terms$DB = c(rep("Reactome", nrow(as.data.frame(reac))), 
                             rep("GO Term", nrow(as.data.frame(got))),
                             rep("Hallmark", nrow(egmt)))
            #all_terms = all_terms[all_terms$qvalue<=0.05,]
            all_terms$cond = cond
            
            if(is.null(go_enr_list[[gr]][[comp]][[ct]])){
              go_enr_list[[gr]][[comp]][[ct]] = all_terms
            } else{
              go_enr_list[[gr]][[comp]][[ct]] = rbind(go_enr_list[[gr]][[comp]][[ct]], all_terms)
            }
          }
        }
      }
    }
  }
  print(names(go_enr_list))
  print(names(go_enr_list[[gr]]))
  print(names(go_enr_list[[gr]][[comp]]))
}
saveRDS(go_enr_list, file = "results/cond_effect/go_enr_list.RDS")
```

Tables of DE genes

```{r}
for(g in names(filt_comps)){
  for(comp in names(filt_comps[[g]])){
    subdir = file.path("to_send", g)
    dir.create(subdir)
    write.table(filt_comps[[g]][[comp]], 
                file = paste0(subdir, "/DEconditions_", comp, "_", g, ".csv"), 
                col.names = T, row.names = F, quote = F, sep = "\t")
  }
}

for(g in names(go_enr_list)){
  for(comp in names(go_enr_list[[g]])){
    for(ct in names(go_enr_list[[g]][[comp]])){
      subdir = file.path("to_send/", paste0(g, "/GO_", ct))
      dir.create(subdir)
      write.table(go_enr_list[[g]][[comp]][[ct]], 
                  file = paste0(subdir, "/GOTermBP_", comp, "_", ct, "_", g, ".csv"), 
                  col.names = T, row.names = F, quote = F, sep = "\t")
    }
  }
}
```

Exploring transcription factors and GO Terms

```{r}
tfdb = read.table("../../gene_refs/human/Homo_sapiens_TF_AnimalTFDB3.txt", 
                  sep = "\t", header = T, stringsAsFactors = F)

genes_to_plot = list("Hepatocytes" = c("HAMP", "SAA1", "FGA", "G0S2", "TNFRSF1A",
                                       "CYP3A7", "MT1A", "DDX21", "IL1RAP", "MT1X",
                                       "MGLL", "MFSD2A", "APOA4", "IRF7", "CEBPA"), 
                      "Immune" = c("S100A9", "CD81", "FCGR1A", "GBP5", "RUNX3", 
                                   "CD300E", "MNDA", "IL18BP", "IL4I1", "WDFY4",
                                   "TRDC", "TRBC1", "IFNG", "CD160", "IFITM1"), 
                      "Cholangiocytes" = c("CCL2", "IRF1", "KRT19", "CCL20", "ICAM1",
                                           "MAP3K12", "EPSTI1", "P4HA1", "PEAK1", "SEC24A",
                                           "LCN2", "RAMP1", "ITGB4", "BIK", "CCL28"), 
                      "Mesenchymal" = c(), 
                      "Endothelial" = c("SOX18", "PLCG2", "TFPI2", "KLF2", "STC1",
                                        "CXXC5", "NPR3", "CDK6", "ADGRG6", "PDGFB",
                                        "RFPL1", "ITGB3", "ADAMTS4", "KLF13", "GPR182"))

plt_list_cond = list()
df_list_cond = list()
for(ct in unique(filt_comps$major_ct$healthy_v_embolised$celltype)){
  g = if(ct=="Hepatocytes") "major_ct_hep" else "major_ct"
  
  plt_reg = filt_comps[[g]]$healthy_v_regenerating[,c(1,3,4,5)]
  plt_reg = unique(plt_reg[plt_reg$celltype==ct,])
  plt_emb = filt_comps[[g]]$healthy_v_embolised[,c(1,3,4,5)]
  plt_emb = unique(plt_emb[plt_emb$celltype==ct,])
  rownames(plt_reg) = plt_reg$gene
  rownames(plt_emb) = plt_emb$gene
  
  plt_df = merge(plt_emb, plt_reg, by = 0, all = T)
  rownames(plt_df) = plt_df[,1]
  plt_df = plt_df[,-c(1,3,6,7)]
  colnames(plt_df) = c("gene", "FC_emb", "pval_emb", "FC_reg", "pval_reg")
  plt_df$gene = rownames(plt_df)
  plt_df$FC_emb[is.na(plt_df$FC_emb)] = 0
  plt_df$FC_reg[is.na(plt_df$FC_reg)] = 0
  plt_df$pval_emb[is.na(plt_df$pval_emb)] = 1
  plt_df$pval_reg[is.na(plt_df$pval_reg)] = 1
  
  # condition labels
  plt_df$cond = ifelse(plt_df$FC_emb<=(-0.2) & plt_df$pval_emb<=0.05 & plt_df$FC_reg>=0, "embolised",
                       ifelse(plt_df$FC_reg<=(-0.2) & plt_df$pval_reg<=0.05 & plt_df$FC_emb>=0, "regenerating",
                              ifelse(plt_df$FC_reg<=(-0.2) & plt_df$pval_reg<=0.05 & plt_df$FC_emb<=(-0.2) &
                                       plt_df$pval_emb<=0.05, "both","other")))
  plt_df$cond = factor(plt_df$cond, levels = c("both", "embolised", "regenerating", "other"))
  plt_df = plt_df[order(plt_df$cond, decreasing = T),]
  
  # genes from GO
  if(!is.null(go_enr_list[[g]]$healthy_v_embolised[[ct]])){
    t_emb = go_enr_list[[g]]$healthy_v_embolised[[ct]]
    t_emb = t_emb[rpfilter(t_emb) & t_emb$cond=="embolised" & t_emb$DB=="GO Term",]
    t_emb_genes = strsplit(as.character(t_emb$geneID), "/")
    names(t_emb_genes) = t_emb$Description
    t_emb_genes = reshape2::melt(t_emb_genes)
    emb_ug = rownames(plt_df)[plt_df$FC_emb<=(-0.2) & plt_df$pval_emb<=0.05 & plt_df$FC_reg>=0]
    emb_genes_go = unique(t_emb_genes[t_emb_genes$value %in% emb_ug,1])
    
    t_reg = go_enr_list[[g]]$healthy_v_regenerating[[ct]]
    t_reg = t_reg[rpfilter(t_reg) & t_reg$cond=="regenerating" & t_reg$DB=="GO Term",]
    t_reg_genes = strsplit(as.character(t_reg$geneID), "/")
    names(t_reg_genes) = t_reg$Description
    t_reg_genes = reshape2::melt(t_reg_genes)
    reg_ug = rownames(plt_df)[plt_df$FC_reg<=(-0.2) & plt_df$pval_reg<=0.05 & plt_df$FC_emb>=0]
    reg_genes_go = unique(t_reg_genes[t_reg_genes$value %in% reg_ug,1])
    
    t_both = rbind(t_emb, t_reg)
    t_both_genes = strsplit(as.character(t_both$geneID), "/")
    names(t_both_genes) = t_both$Description
    t_both_genes = reshape2::melt(t_both_genes)
    both_ug = rownames(plt_df)[plt_df$FC_reg<0 & plt_df$pval_reg<=0.05 & 
                                 plt_df$FC_emb<0 & plt_df$pval_emb<=0.05]
    both_genes_go = unique(t_both_genes[t_both_genes$value %in% both_ug,1])
    
      plt_df$cond_go = ifelse(plt_df$gene %in% emb_genes_go, "embolised", 
                           ifelse(plt_df$gene %in% reg_genes_go, "regenerating", 
                                  ifelse(plt_df$gene %in% both_genes_go, "both", "other")))
      plt_df$cond_go = factor(plt_df$cond_go, levels = c("both", "embolised", "regenerating", "other"))
  }
  
  plt_df$isTF = plt_df$gene %in% tfdb$Symbol
  
  emb_g_plt =  plt_df$gene[order(plt_df$FC_emb, decreasing = F)][plt_df$cond[order(plt_df$FC_emb, decreasing = F)]=="embolised"][1:5]
  reg_g_plt = plt_df$gene[order(plt_df$FC_reg, decreasing = F)][plt_df$cond[order(plt_df$FC_reg, decreasing = F)]=="regenerating"][1:5]
  b_g_plt = plt_df$gene[order(plt_df$FC_reg+plt_df$FC_emb, decreasing = F)][plt_df$cond[order(plt_df$FC_reg+plt_df$FC_emb, decreasing = F)]=="both"][1:5]
  
  cols = c("both" = "#C54635", "regenerating" = "salmon", "embolised" = "darkred", "other" = "grey85")
  plt = ggplot(plt_df, aes(x = FC_emb, y = FC_reg, colour = cond))+
    geom_vline(xintercept = 0)+
    geom_hline(yintercept = 0)+
    geom_point()+
    geom_label_repel(data = plt_df[plt_df$gene %in% c(emb_g_plt, reg_g_plt, b_g_plt),], 
                     mapping = aes(label = gene), show.legend = F)+
    scale_colour_manual(values = cols)+
    labs(title = ct, x = "logFC(healthy vs embolised)", 
         y = "logFC(healthy vs regenerating)")+
    theme_bw()
  
  plt_list_cond[[ct]] = plt
  df_list_cond[[ct]] = plt_df
  
  write.csv(plt_df, file = paste0("to_send/FC_condVShealthy_", ct, ".csv"), 
            col.names = T, row.names = F, quote = F)
}

terms_list = c("liver regeneration" = "GO:0097421", "regeneration" = "GO:0031099", 
               "tissue regeneration" = "GO:0042246", "liver development" = "GO:0001889",
               "cell migration" = "GO:0016477", "lipid metabolic process" = "GO:0006629", 
               "monocarboxylic acid metabolic process" = "GO:0032787", 
               "xenobiotic metabolic process" = "GO:0006805", "complement activation" = "GO:0006956")
g_path = mget(terms_list,org.Hs.egGO2ALLEGS)
refsymbol = org.Hs.egSYMBOL
g_path = lapply(g_path, function(x) unlist(as.list(refsymbol[x])))
names(g_path) = names(terms_list)

g_path_df = data.frame("gene" = unlist(g_path[-c(1,3)]),
                       "terms" = unlist(lapply(names(g_path[-c(1,3)]), function(x) rep(x, length(g_path[[x]])))),
                       stringsAsFactors = F)
g_path_df = g_path_df[!duplicated(g_path_df$gene),]

plt_df = merge(plt_df, g_path_df, by = "gene", all.x = T)
plt_df$terms[is.na(plt_df$terms)] = "other"
plt_df$terms = factor(plt_df$terms, levels = c(unique(g_path_df$terms), "other"))
plt_df = plt_df[order(plt_df$terms, decreasing = T),]
```





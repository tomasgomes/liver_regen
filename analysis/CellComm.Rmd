---
title: "Cell communication analysis"
output: html_notebook
---



# General Setup
Setup chunk

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8)
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_knit$get("root.dir")
```

Setup reticulate

```{r}
library(reticulate)
knitr::knit_engines$set(python = reticulate::eng_python)
py_available(initialize = FALSE)
use_python(Sys.which("python"))
py_config()
```

Load libraries

```{r}
library(Seurat)
library(ggplot2)
library(ggridges)
library(dplyr)
```



# Healthy
Load data

```{r}
hcells_rpca = readRDS("data/processed/hcells_rpca.RDS")
hep_hcells = readRDS("data/processed/hep_hcells_zon.RDS")
```

Save the data to run the analysis  
"Doublet" clusters are removed, as well as some contaminaiting non-hepatocytes

```{r}
cpdb_path = "results/cell_comm_healthy/CellPhoneDB_runs"

# remove doublet cells
hcells_filt = hcells_rpca[,!grepl("interaction", hcells_rpca@meta.data$names_clusters)]

# remove contaminating hepatocytes
hcells_filt = hcells_filt[,colnames(hcells_filt) %in% colnames(hep_hcells) |
                            !grepl("Hepat", hcells_filt@meta.data$names_clusters)]

dat = cbind(rownames(hcells_filt@assays$SCT@data),
            Matrix::as.matrix(hcells_filt@assays$SCT@data))
colnames(dat)[1] = "Gene"
write.table(dat, file = paste0(cpdb_path, "/hcells_rpca_norm.txt"), 
            sep = "\t", col.names = T, row.names = F, quote = F)

meta = data.frame("Cell" = rownames(hcells_filt@meta.data), 
                  "cell_type" = as.character(hcells_filt@meta.data$names_clusters),
                  stringsAsFactors = F)
write.table(meta, file = paste0(cpdb_path, "/hcells_rpca_meta_names_clusters.txt"), 
            sep = "\t", col.names = T, row.names = F, quote = F)

# define 3 zones for hepatocytes
hep_zones = cut(hep_hcells@meta.data$healthy_hep_zon_dc1, 3)
levels(hep_zones) = c("(-0.06,-0.0165]" = "Hepatocytes_Z1",
                     "(-0.0165,0.0268]" = "Hepatocytes_Z2",
                     "(0.0268,0.0702]" = "Hepatocytes_Z3")
hep_zones = as.character(hep_zones)
names(hep_zones) = rownames(hep_hcells@meta.data)
meta$cell_type = ifelse(meta$cell_type %in% c("gd-T cells_1", "gd-T cells_2"), 
                        "gd-T cells", meta$cell_type)
meta$cell_type = ifelse(meta$Cell %in% names(hep_zones)[grepl("Z1", hep_zones)],
                        "Hepatocytes_Z1", meta$cell_type)
meta$cell_type = ifelse(meta$Cell %in% names(hep_zones)[grepl("Z2", hep_zones)],
                        "Hepatocytes_Z2", meta$cell_type)
meta$cell_type = ifelse(meta$Cell %in% names(hep_zones)[grepl("Z3", hep_zones)],
                        "Hepatocytes_Z3", meta$cell_type)
write.table(meta, file = paste0(cpdb_path, "/hcells_rpca_meta_names_simp.txt"), 
            sep = "\t", col.names = T, row.names = F, quote = F)
```


## Running CellPhoneDB
Commands for runnin CellPhoneDB will be written here. Results are output to the `local1` disk to avoid I/O issues, but the output folders should then be copied to: `results/cell_comm_healthy/CellPhoneDB_runs`.  
  
Running for the defined cluster names: `cellphonedb method statistical_analysis results/cell_comm_healthy/CellPhoneDB_runs/hcells_rpca_meta_names_clusters.txt results/cell_comm_healthy/CellPhoneDB_runs/hcells_rpca_norm.txt --threads=6 --output-path=/local1/USERS/tomasgomes/liver/CellPhoneDB_res --project-name healthy_names_clusters --counts-data gene_name`  
Copy files: `cp -r /local1/USERS/tomasgomes/liver/CellPhoneDB_res/healthy_names_clusters results/cell_comm_healthy/CellPhoneDB_runs/`  
Run to get heatmaps and interaction counts: `cellphonedb plot heatmap_plot --pvalues-path ./results/cell_comm_healthy/CellPhoneDB_runs/healthy_names_clusters/pvalues.txt --output-path ./results/cell_comm_healthy/CellPhoneDB_runs/healthy_names_clusters/ --count-name counts_heat.pdf --count-network-name count_net.txt --interaction-count-name count_inter.txt ./results/cell_comm_healthy/CellPhoneDB_runs/hcells_rpca_meta_names_clusters.txt`  

Running for simplified cluster names: `cellphonedb method statistical_analysis results/cell_comm_healthy/CellPhoneDB_runs/hcells_rpca_meta_names_simp.txt results/cell_comm_healthy/CellPhoneDB_runs/hcells_rpca_norm.txt --threads=6 --output-path=/local1/USERS/tomasgomes/liver/CellPhoneDB_res --project-name healthy_names_simp --counts-data gene_name`  
Copy files: `cp -r /local1/USERS/tomasgomes/liver/CellPhoneDB_res/healthy_names_simp results/cell_comm_healthy/CellPhoneDB_runs/`  
Run to get heatmaps and interaction counts: `cellphonedb plot heatmap_plot --pvalues-path ./results/cell_comm_healthy/CellPhoneDB_runs/healthy_names_simp/pvalues.txt --output-path ./results/cell_comm_healthy/CellPhoneDB_runs/healthy_names_simp/ --count-name counts_heat.pdf --count-network-name count_net.txt --interaction-count-name count_inter.txt ./results/cell_comm_healthy/CellPhoneDB_runs/hcells_rpca_meta_names_simp.txt`  


## Examine results
Load results

```{r}
cpdb_path = "results/cell_comm_healthy/CellPhoneDB_runs"

# all clusters
sig_means_names_clusters = read.table(paste0(cpdb_path,
                                             "/healthy_names_clusters/significant_means.txt"),
                                      header = T, sep = "\t", stringsAsFactors = F)

dec_cl = read.table(paste0(cpdb_path, "/healthy_names_clusters/deconvoluted.txt"),
                    header = T, sep = "\t")
colnames(dec_cl) = gsub(".", " ", colnames(dec_cl), fixed = T)
colnames(dec_cl)[colnames(dec_cl)=="gd T cells_1"] = "gd-T cells_1"
colnames(dec_cl)[colnames(dec_cl)=="gd T cells_2"] = "gd-T cells_2"
colnames(dec_cl)[colnames(dec_cl)=="ab T cells"] = "ab-T cells"

net_names_cl = read.table(paste0(cpdb_path, "/healthy_names_clusters/count_net.txt"),
                            header = T, sep = "\t", stringsAsFactors = F)

meta_cl = read.table(paste0(cpdb_path, "/hcells_rpca_meta_names_clusters.txt"),
                     header = T, sep = "\t")


# simplified clusters
sig_means_names_simp = read.table(paste0(cpdb_path,
                                         "/healthy_names_simp/significant_means.txt"),
                                  header = T, sep = "\t", stringsAsFactors = F)

dec_simp = read.table(paste0(cpdb_path, "/healthy_names_simp/deconvoluted.txt"),
                      header = T, sep = "\t")
colnames(dec_simp) = gsub(".", " ", colnames(dec_simp), fixed = T)
colnames(dec_simp)[colnames(dec_simp)=="gd T cells"] = "gd-T cells"
colnames(dec_simp)[colnames(dec_simp)=="ab T cells"] = "ab-T cells"

net_names_simp = read.table(paste0(cpdb_path, "/healthy_names_simp/count_net.txt"),
                            header = T, sep = "\t", stringsAsFactors = F)

meta_simp = read.table(paste0(cpdb_path, "/hcells_rpca_meta_names_simp.txt"),
                     header = T, sep = "\t")
```

Reformat significant means matrix - clusters

```{r}
cl_reform = reshape2::melt(sig_means_names_clusters[,c(1:4, 7:9,
                                                         13:ncol(sig_means_names_clusters))])
cl_reform = cl_reform[complete.cases(cl_reform),]

lr1 = c()
lr2 = c()
for(i in 1:nrow(cl_reform)){
  if(grepl("complex", cl_reform$partner_a[i])){
    lr1 = c(lr1, substr(cl_reform$partner_a[i], 9,100))
  } else{
    lr1 = c(lr1, strsplit(cl_reform$interacting_pair[i], "_")[[1]][1])
  }
  if(grepl("complex", cl_reform$partner_b[i])){
    lr2 = c(lr2, substr(cl_reform$partner_b[i], 9,100))
  } else{
    spltlen = length(strsplit(cl_reform$interacting_pair[i], "_")[[1]])
    lr2 = c(lr2, strsplit(cl_reform$interacting_pair[i], "_")[[1]][spltlen])
  }
}
cl_reform$lr1 = lr1
cl_reform$lr2 = lr2

cl_reform$ct1 = NA
cl_reform$ct2 = NA
for(ct in unique(meta_cl$cell_type)){
  ct_mod = gsub("-", " ", ct, fixed = T)
  st = grepl(paste0("^",ct_mod), gsub(".", " ", cl_reform$variable, fixed = T), fixed = F)
  en = grepl(paste0(ct_mod,"$"), gsub(".", " ", cl_reform$variable, fixed = T), fixed = F)
  cl_reform$ct1[st] = ct
  cl_reform$ct2[en] = ct
}

# direction: receptors activate internal signal - that is the direction of the signalling
## if both are true, the "net signal" is 0
cl_reform$dir = ifelse(cl_reform$receptor_a==cl_reform$receptor_b, 0, 
                         ifelse(cl_reform$receptor_a=="True" & 
                                  cl_reform$receptor_b=="False", -1,
                                ifelse(cl_reform$receptor_a=="False" &
                                         cl_reform$receptor_b=="True", 1, NA)))

cl_reform = cl_reform[,c("id_cp_interaction", "ct1", "ct2", "lr1", "lr2", "value", "dir")]

for(i in 1:nrow(cl_reform)){
  if(cl_reform[i,"dir"]==-1){
    tmp = cl_reform[i,"ct2"]
    cl_reform[i,"ct2"] = cl_reform[i,"ct1"]
    cl_reform[i,"ct1"] = tmp
    
    tmp = cl_reform[i,"lr2"]
    cl_reform[i,"lr2"] = cl_reform[i,"lr1"]
    cl_reform[i,"lr1"] = tmp
    
    cl_reform[i,"dir"]=1
  }
}

write.table(cl_reform, file = paste0(cpdb_path, "/healthy_names_simp/cl_reform_tab.txt"),
            sep = "\t", col.names = T, row.names = T, quote = F)
```

Reformat significant means matrix - simplified clusters

```{r}
simp_reform = reshape2::melt(sig_means_names_simp[,c(1:4, 7:9, 13:ncol(sig_means_names_simp))])
simp_reform = simp_reform[complete.cases(simp_reform),]

lr1 = c()
lr2 = c()
for(i in 1:nrow(simp_reform)){
  if(grepl("complex", simp_reform$partner_a[i])){
    lr1 = c(lr1, substr(simp_reform$partner_a[i], 9,100))
  } else{
    lr1 = c(lr1, strsplit(simp_reform$interacting_pair[i], "_")[[1]][1])
  }
  if(grepl("complex", simp_reform$partner_b[i])){
    lr2 = c(lr2, substr(simp_reform$partner_b[i], 9,100))
  } else{
    spltlen = length(strsplit(simp_reform$interacting_pair[i], "_")[[1]])
    lr2 = c(lr2, strsplit(simp_reform$interacting_pair[i], "_")[[1]][spltlen])
  }
}
simp_reform$lr1 = lr1
simp_reform$lr2 = lr2

simp_reform$ct1 = NA
simp_reform$ct2 = NA
for(ct in unique(meta_simp$cell_type)){
  ct_mod = gsub("-", " ", ct, fixed = T)
  st = grepl(paste0("^",ct_mod), gsub(".", " ", simp_reform$variable, fixed = T), fixed = F)
  en = grepl(paste0(ct_mod,"$"), gsub(".", " ", simp_reform$variable, fixed = T), fixed = F)
  simp_reform$ct1[st] = ct
  simp_reform$ct2[en] = ct
}

# direction: receptors activate internal signal - that is the direction of the signalling
## if both are true, the "net signal" is 0
simp_reform$dir = ifelse(simp_reform$receptor_a==simp_reform$receptor_b, 0, 
                         ifelse(simp_reform$receptor_a=="True" & 
                                  simp_reform$receptor_b=="False", -1,
                                ifelse(simp_reform$receptor_a=="False" &
                                         simp_reform$receptor_b=="True", 1, NA)))

simp_reform = simp_reform[,c("id_cp_interaction", "ct1", "ct2", "lr1", "lr2", "value", "dir")]

for(i in 1:nrow(simp_reform)){
  if(simp_reform[i,"dir"]==-1){
    tmp = simp_reform[i,"ct2"]
    simp_reform[i,"ct2"] = simp_reform[i,"ct1"]
    simp_reform[i,"ct1"] = tmp
    
    tmp = simp_reform[i,"lr2"]
    simp_reform[i,"lr2"] = simp_reform[i,"lr1"]
    simp_reform[i,"lr1"] = tmp
    
    simp_reform[i,"dir"]=1
  }
}

write.table(simp_reform, file = paste0(cpdb_path, "/healthy_names_simp/simp_reform_tab.txt"),
            sep = "\t", col.names = T, row.names = T, quote = F)
```

Plot interaction counts

```{r}
inter_counts_cl = reshape2::dcast(data = net_names_cl, formula = SOURCE~TARGET,
                                    value.var = "count")
rownames(inter_counts_cl) = inter_counts_cl[,1]
inter_counts_cl = inter_counts_cl[,-1]

inter_counts_simp = reshape2::dcast(data = net_names_simp, formula = SOURCE~TARGET,
                                    value.var = "count")
rownames(inter_counts_simp) = inter_counts_simp[,1]
inter_counts_simp = inter_counts_simp[,-1]

pdf("results/cell_comm_healthy/number_of_interactions.pdf", useDingbats = F, 
    height = 6, width = 7)
pheatmap::pheatmap(inter_counts_cl, clustering_method = "ward.D2", main = "All clusters")
pheatmap::pheatmap(inter_counts_simp, clustering_method = "ward.D2", 
                   main = "Simplified clusters")
dev.off()
```

Making two cell type by interaction matrices: one has the ligand mean, another the receptor mean
All clusters

```{r}
mat_lig_cl = data.frame(matrix(NA, nrow = length(unique(cl_reform$id_cp_interaction)), 
                 ncol = length(unique(cl_reform$ct1))))
mat_rec_cl = data.frame(matrix(NA, nrow = length(unique(cl_reform$id_cp_interaction)), 
                 ncol = length(unique(cl_reform$ct1))))
colnames(mat_lig_cl) = colnames(mat_rec_cl) = unique(cl_reform$ct1)
rownames(mat_lig_cl) = rownames(mat_rec_cl) = unique(cl_reform$id_cp_interaction)
for(i in 1:nrow(cl_reform)){
  g1 = cl_reform[i,"lr1"]
  g2 = cl_reform[i,"lr2"]
  
  c1 = cl_reform[i,"ct1"]
  c2 = cl_reform[i,"ct2"]
  
  int = as.character(cl_reform[i,1])
  
  m1 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,1]==g1,c1], na.rm = T)
  if(is.na(m1)) m1 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,5]==g1,c1], 
                          na.rm = T)
  mat_lig_cl[int, c1] = m1
  
  m2 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,1]==g2,c2], na.rm = T)
  if(is.na(m2)) m2 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,5]==g2,c2],
                          na.rm = T)
  if(is.na(m1) | is.na(m2)) print(int)
  mat_rec_cl[int, c2] = m2
}

# ligand vs receptor correlation
cor_mat_each_cl = cor(mat_lig_cl, mat_rec_cl, use="pairwise.complete.obs", method = "sp")

# sum(lig, reg) correlation
mat_lig_cl[is.na(mat_lig_cl)] = 0
mat_rec_cl[is.na(mat_rec_cl)] = 0
mat_both_cl = mat_lig_cl+mat_rec_cl
mat_both_cl[mat_both_cl==0] = NA
cor_mat_both_cl = cor(mat_both_cl, use="pairwise.complete.obs", method = "sp")
```

Simplified clusters

```{r}
mat_lig_simp = data.frame(matrix(NA, nrow = length(unique(simp_reform$id_cp_interaction)), 
                 ncol = length(unique(simp_reform$ct1))))
mat_rec_simp = data.frame(matrix(NA, nrow = length(unique(simp_reform$id_cp_interaction)), 
                 ncol = length(unique(simp_reform$ct1))))
colnames(mat_lig_simp) = colnames(mat_rec_simp) = unique(simp_reform$ct1)
rownames(mat_lig_simp) = rownames(mat_rec_simp) = unique(simp_reform$id_cp_interaction)
for(i in 1:nrow(simp_reform)){
  g1 = simp_reform[i,"lr1"]
  g2 = simp_reform[i,"lr2"]
  
  c1 = simp_reform[i,"ct1"]
  c2 = simp_reform[i,"ct2"]
  
  int = as.character(simp_reform[i,1])
  
  m1 = mean(dec_simp[dec_simp$id_cp_interaction==int & dec_simp[,1]==g1,c1], na.rm = T)
  if(is.na(m1)) m1 = mean(dec_simp[dec_simp$id_cp_interaction==int & dec_simp[,5]==g1,c1], 
                          na.rm = T)
  mat_lig_simp[int, c1] = m1
  
  m2 = mean(dec_simp[dec_simp$id_cp_interaction==int & dec_simp[,1]==g2,c2], na.rm = T)
  if(is.na(m2)) m2 = mean(dec_simp[dec_simp$id_cp_interaction==int & dec_simp[,5]==g2,c2],
                          na.rm = T)
  if(is.na(m1) | is.na(m2)) print(int)
  mat_rec_simp[int, c2] = m2
}

# ligand vs receptor correlation
cor_mat_each_simp = cor(mat_lig_simp, mat_rec_simp, use="pairwise.complete.obs", method = "sp")

# sum(lig, reg) correlation
mat_lig_simp[is.na(mat_lig_simp)] = 0
mat_rec_simp[is.na(mat_rec_simp)] = 0
mat_both_simp = mat_lig_simp+mat_rec_simp
mat_both_simp[mat_both_simp==0] = NA
cor_mat_both_simp = cor(mat_both_simp, use="pairwise.complete.obs", method = "sp")
```

Score number of interactions by correlation - clusters

```{r}
pdf("results/cell_comm_healthy/interactions_score_cl.pdf")
cor_mat_mod = cor_mat_both_cl
inter_counts_mod = inter_counts_cl

xx = inter_counts_mod*cor_mat_mod[rownames(inter_counts_mod),colnames(inter_counts_mod)]
xx[xx<0] = 0
pheatmap::pheatmap(xx, clustering_method = "ward.D2", main = "Ligands and receptors")

xx$ct = rownames(xx)
df_net = reshape2::melt(xx)
write.table(df_net, file = "results/cell_comm_healthy/df_net_corboth_healthy_cl.txt", 
            sep = "\t", col.names = T, row.names = F, quote = F)

cor_mat_mod = cor_mat_each_cl
inter_counts_mod = inter_counts_cl

xx = inter_counts_mod*cor_mat_mod[rownames(inter_counts_mod),colnames(inter_counts_mod)]
xx[xx<0] = 0
pheatmap::pheatmap(xx, clustering_method = "ward.D2", main = "Ligands vs receptors")

xx$ct = rownames(xx)
df_net = reshape2::melt(xx)
write.table(df_net, file = "results/cell_comm_healthy/df_net_coreach_healthy_cl.txt", 
            sep = "\t", col.names = T, row.names = F, quote = F)
dev.off()
```

Score number of interactions by correlation - simplified

```{r}
pdf("results/cell_comm_healthy/interactions_score_simp.pdf")
cor_mat_mod = cor_mat_both_simp
inter_counts_mod = inter_counts_simp

xx = inter_counts_mod*cor_mat_mod[rownames(inter_counts_mod),colnames(inter_counts_mod)]
xx[xx<0] = 0
pheatmap::pheatmap(xx, clustering_method = "ward.D2", main = "Ligands and receptors")

xx$ct = rownames(xx)
df_net = reshape2::melt(xx)
write.table(df_net, file = "results/cell_comm_healthy/df_net_corboth_healthy_simp.txt", 
            sep = "\t", col.names = T, row.names = F, quote = F)

cor_mat_mod = cor_mat_each_simp
inter_counts_mod = inter_counts_simp

xx = inter_counts_mod*cor_mat_mod[rownames(inter_counts_mod),colnames(inter_counts_mod)]
xx[xx<0] = 0
pheatmap::pheatmap(xx, clustering_method = "ward.D2", main = "Ligands vs receptors")

xx$ct = rownames(xx)
df_net = reshape2::melt(xx)
write.table(df_net, file = "results/cell_comm_healthy/df_net_coreach_healthy_simp.txt", 
            sep = "\t", col.names = T, row.names = F, quote = F)
dev.off()
```







# Embolised/Regenerating
Load data

```{r}

```




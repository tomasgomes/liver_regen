---
title: "Cell communication analysis"
output: html_notebook
---



# General Setup
Setup chunk

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8)
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_knit$get("root.dir")
```

Setup reticulate

```{r}
library(reticulate)
knitr::knit_engines$set(python = reticulate::eng_python)
py_available(initialize = FALSE)
use_python(Sys.which("python"))
py_config()
```

Load libraries

```{r}
library(Seurat)
library(ggplot2)
library(ggridges)
library(dplyr)
library(data.table)
```



# Load and preprocess data
Load data (from all cells)

```{r}
allcells_css = readRDS(file = "data/processed/allcells_css.RDS")
end_cells = readRDS(file = "results/zonation_cond/end_cells_zonation_rank.RDS")
hep_cells = readRDS(file = "results/zonation_cond/hep_cells_zonation_rank.RDS")
```

Subset and process each condition

```{r}
cpdb_path = "results/cell_comm/CellPhoneDB_runs"

cond_cells = list()
for(cond in unique(allcells_css@meta.data$Condition)){
  print(cond)
  cond_cells[[cond]] = allcells_css[,allcells_css@meta.data$Condition==cond]
  
  # remove doublet cells
  cond_cells[[cond]] = cond_cells[[cond]][,cond_cells[[cond]]@meta.data$allcells_major!="Doublets"]
  cond_cells[[cond]] = cond_cells[[cond]][,cond_cells[[cond]]@meta.data$allcells_simp!="Dividing cells"]
  
  # remove contaminating hepatocytes
  cond_cells[[cond]] = cond_cells[[cond]][,colnames(cond_cells[[cond]]) %in% colnames(hep_cells[[cond]]) | cond_cells[[cond]]@meta.data$allcells_major!="Hepatocytes"]
  
  # remove contaminating endothelial cells
  cond_cells[[cond]] = cond_cells[[cond]][,colnames(cond_cells[[cond]]) %in% colnames(end_cells[[cond]]) | !startsWith(cond_cells[[cond]]@meta.data$allcells_simp,"LSEC")]
  
  # add zonation labels
  meta = data.frame(row.names = rownames(cond_cells[[cond]]@meta.data),
                    "Cell" = rownames(cond_cells[[cond]]@meta.data), 
                    "cell_type" = as.character(cond_cells[[cond]]@meta.data$allcells_simp),
                    stringsAsFactors = F)
  
  hep_zones = hep_cells[[cond]]@meta.data$zonation_int
  levels(hep_zones) = c("(-0.00099,0.333]" = "Hepatocytes_Z1",
                        "(0.333,0.667]" = "Hepatocytes_Z2",
                        "(0.667,1]" = "Hepatocytes_Z3")
  hep_zones = as.character(hep_zones)
  names(hep_zones) = colnames(hep_cells[[cond]])
  meta[names(hep_zones),"cell_type"] = hep_zones
  
  end_zones = end_cells[[cond]]@meta.data$zonation_int
  levels(end_zones) = c("(-0.00099,0.333]" = "LSEC_Z1",
                        "(0.333,0.667]" = "LSEC_Z2",
                        "(0.667,1]" = "LSEC_Z3")
  end_zones = as.character(end_zones)
  names(end_zones) = colnames(end_cells[[cond]])
  meta[names(end_zones),"cell_type"] = end_zones
  
  write.table(meta, file = paste0(cpdb_path, "/", cond, "_meta_names_simp.txt"), 
            sep = "\t", col.names = T, row.names = F, quote = F)
  
  # more bins for zonation
  # define the intervals based on healthy
  df_h = data.table("zonation_pt" = hep_cells$healthy$zonation_pt)
  df_h$zonation_int10 = cut(df_h$zonation_pt, 10)
  
  df_e = data.table("zonation_pt" = hep_cells$embolised$zonation_pt)
  df_e = df_h[df_e, on="zonation_pt", roll=Inf, rollends = T]
  
  df_r = data.table("zonation_pt" = hep_cells$regenerating$zonation_pt)
  df_r = df_h[df_r, on="zonation_pt", roll=Inf, rollends = T]
  
  hep_list_z = list("healthy" = df_h, "embolised" = df_e, "regenerating" = df_r)
  
  # define the intervals based on healthy
  df_h = data.table("zonation_pt" = end_cells$healthy$zonation_pt)
  df_h$zonation_int10 = cut(df_h$zonation_pt, 10)
  
  df_e = data.table("zonation_pt" = end_cells$embolised$zonation_pt)
  df_e = df_h[df_e, on="zonation_pt", roll=Inf, rollends = T]
  
  df_r = data.table("zonation_pt" = end_cells$regenerating$zonation_pt)
  df_r = df_h[df_r, on="zonation_pt", roll=Inf, rollends = T]
  
  end_list_z = list("healthy" = df_h, "embolised" = df_e, "regenerating" = df_r)
  
  hep_zones = hep_list_z[[cond]]$zonation_int10
  levels(hep_zones) = paste0("Hepatocytes_Z", 1:10)
  hep_zones = as.character(hep_zones)
  names(hep_zones) = colnames(hep_cells[[cond]])
  meta[names(hep_zones),"cell_type"] = hep_zones
  
  end_zones = end_list_z[[cond]]$zonation_int10
  levels(end_zones) = paste0("LSEC_Z", 1:10)
  end_zones = as.character(end_zones)
  names(end_zones) = colnames(end_cells[[cond]])
  meta[names(end_zones),"cell_type"] = end_zones
  
  write.table(meta, file = paste0(cpdb_path, "/", cond, "_meta_names_bins.txt"), 
            sep = "\t", col.names = T, row.names = F, quote = F)
  
  # normalise and save
  cond_cells[[cond]] = suppressWarnings(SCTransform(cond_cells[[cond]], do.correct.umi = T, 
                                                   verbose = F, 
                                                   vars.to.regress=c("unique_name",
                                                                     "nCount_RNA"),
                                                   variable.features.rv.th = 1, seed.use = 1,
                                                   return.only.var.genes = F, 
                                                   variable.features.n = NULL))
  
  dat = cbind(rownames(cond_cells[[cond]]@assays$SCT@data),
              Matrix::as.matrix(cond_cells[[cond]]@assays$SCT@data))
  colnames(dat)[1] = "Gene"
  write.table(dat, file = paste0(cpdb_path, "/", cond, "_exp_norm.txt"), 
              sep = "\t", col.names = T, row.names = F, quote = F)
}
```

## Running CellPhoneDB
Commands for runnin CellPhoneDB will be written here. Results are output to the `local1` disk to avoid I/O issues, but the output folders should then be copied to: `results/cell_comm_healthy/CellPhoneDB_runs`.  
NOTE: for some reason I'm getting a SegFault when trying to run the heatmap_plot command. This was run on the Euler server instead.

```{r}
for(n in names(cond_cells)){
  comm1 = paste0("cellphonedb method statistical_analysis results/cell_comm/CellPhoneDB_runs/", n, "_meta_names_simp.txt results/cell_comm/CellPhoneDB_runs/", n, "_exp_norm.txt --threads=8 --output-path=/local1/USERS/tomasgomes/liver/CellPhoneDB_res --project-name ", n, " --counts-data gene_name")
  comm2 = paste0("cp -r /local1/USERS/tomasgomes/liver/CellPhoneDB_res/", n, " results/cell_comm/CellPhoneDB_runs/")
  comm3 = paste0("cellphonedb plot heatmap_plot --pvalues-path ./results/cell_comm/CellPhoneDB_runs/", n, "/pvalues.txt --output-path ./results/cell_comm/CellPhoneDB_runs/", n, "/ --count-name counts_heat.pdf --count-network-name count_net.txt --interaction-count-name count_inter.txt ./results/cell_comm/CellPhoneDB_runs/", n, "_meta_names_simp.txt")
  
  print(n)
  print(comm1)
  print(comm2)
  print(comm3)
  print(".")
}
```

```{r}
for(n in names(cond_cells)){
  comm1 = paste0("cellphonedb method statistical_analysis results/cell_comm/CellPhoneDB_runs/", n, "_meta_names_bins.txt results/cell_comm/CellPhoneDB_runs/", n, "_exp_norm.txt --threads=8 --output-path=/local1/USERS/tomasgomes/liver/CellPhoneDB_res --project-name ", n, "_bins --counts-data gene_name")
  comm2 = paste0("cp -r /local1/USERS/tomasgomes/liver/CellPhoneDB_res/", n, "_bins results/cell_comm/CellPhoneDB_runs/")
  comm3 = paste0("cellphonedb plot heatmap_plot --pvalues-path ./results/cell_comm/CellPhoneDB_runs/", n, "_bins/pvalues.txt --output-path ./results/cell_comm/CellPhoneDB_runs/", n, "_bins/ --count-name counts_heat.pdf --count-network-name count_net.txt --interaction-count-name count_inter.txt ./results/cell_comm/CellPhoneDB_runs/", n, "_meta_names_bins.txt")
  
  print(n)
  print(comm1)
  print(comm2)
  print(comm3)
  print(".")
}
```


# Process results
Load results

```{r}
cpdb_path = "results/cell_comm/CellPhoneDB_runs"

sig_means_names_l = list()
dec_l = list()
net_names_l = list()
meta_l = list()
conds = unique(allcells_css@meta.data$Condition)
for(n in c(conds, paste0(conds, "_bins"))){
  sig_means_names_l[[n]] = read.table(paste0(cpdb_path, "/", n, "/significant_means.txt"),
                                      header = T, sep = "\t", stringsAsFactors = F)
  dec_l[[n]] = read.table(paste0(cpdb_path, "/", n, "/deconvoluted.txt"),
                          header = T, sep = "\t")
  colnames(dec_l[[n]]) = gsub(".", " ", colnames(dec_l[[n]]), fixed = T)
  colnames(dec_l[[n]])[colnames(dec_l[[n]])=="gd T cells"] = "gd-T cells"
  colnames(dec_l[[n]])[colnames(dec_l[[n]])=="ab T cells"] = "ab-T cells"
  colnames(dec_l[[n]])[colnames(dec_l[[n]])=="Endothelial cells  non LSEC "] = "Endothelial cells (non-LSEC)"
  net_names_l[[n]] = read.table(paste0(cpdb_path, "/", n, "/count_net.txt"),
                                header = T, sep = "\t", stringsAsFactors = F)
  ns = strsplit(n, "_")[[1]][1]
  meta_l[[n]] = if(!grepl("bins", n)){
    read.table(paste0(cpdb_path, "/", n, "_meta_names_simp.txt"),header = T,sep = "\t")
  } else{
    read.table(paste0(cpdb_path, "/", ns, "_meta_names_bins.txt"),header = T,sep = "\t")
  }
}
saveRDS(dec_l, file = "results/cell_comm/deconvoluted_list.RDS")
saveRDS(net_names_l, file = "results/cell_comm/count_net_list.RDS")
```

Reformat significant means matrix

```{r}
reform_list = list()
for(n in names(meta_l)){
  simp_reform = reshape2::melt(sig_means_names_l[[n]][,c(1:4,7:9,13:ncol(sig_means_names_l[[n]]))])
  simp_reform = simp_reform[complete.cases(simp_reform),]
  
  lr1 = c()
  lr2 = c()
  for(i in 1:nrow(simp_reform)){
    if(grepl("complex", simp_reform$partner_a[i])){
      lr1 = c(lr1, substr(simp_reform$partner_a[i], 9,100))
    } else{
      lr1 = c(lr1, strsplit(simp_reform$interacting_pair[i], "_")[[1]][1])
    }
    if(grepl("complex", simp_reform$partner_b[i])){
      lr2 = c(lr2, substr(simp_reform$partner_b[i], 9,100))
    } else{
      spltlen = length(strsplit(simp_reform$interacting_pair[i], "_")[[1]])
      lr2 = c(lr2, strsplit(simp_reform$interacting_pair[i], "_")[[1]][spltlen])
    }
  }
  simp_reform$lr1 = lr1
  simp_reform$lr2 = lr2
  
  simp_reform$ct1 = NA
  simp_reform$ct2 = NA
  for(ct in unique(meta_l[[n]]$cell_type)){
    ct_mod = gsub("-", " ", ct, fixed = T)
    ct_mod = gsub("(", " ", ct_mod, fixed = T)
    ct_mod = gsub(")", " ", ct_mod, fixed = T)
    st = grepl(paste0("^",ct_mod, " "), gsub(".", " ", simp_reform$variable, fixed = T), fixed = F)
    en = grepl(paste0(" ",ct_mod,"$"), gsub(".", " ", simp_reform$variable, fixed = T), fixed = F)
    simp_reform$ct1[st] = ct
    simp_reform$ct2[en] = ct
  }
  
  # direction: receptors activate internal signal - that is the direction of the signalling
  ## if both are true, the "net signal" is 0
  simp_reform$dir = ifelse(simp_reform$receptor_a==simp_reform$receptor_b, 0, 
                           ifelse(simp_reform$receptor_a=="True" & 
                                    simp_reform$receptor_b=="False", -1,
                                  ifelse(simp_reform$receptor_a=="False" &
                                           simp_reform$receptor_b=="True", 1, NA)))
  
  simp_reform = simp_reform[,c("id_cp_interaction", "ct1", "ct2", "lr1", "lr2", 
                               "value", "dir")]
  
  for(i in 1:nrow(simp_reform)){
    if(simp_reform[i,"dir"]==-1){
      tmp = simp_reform[i,"ct2"]
      simp_reform[i,"ct2"] = simp_reform[i,"ct1"]
      simp_reform[i,"ct1"] = tmp
      
      tmp = simp_reform[i,"lr2"]
      simp_reform[i,"lr2"] = simp_reform[i,"lr1"]
      simp_reform[i,"lr1"] = tmp
      
      simp_reform[i,"dir"]=1
    }
  }
  
 reform_list[[n]] = simp_reform
}
saveRDS(reform_list, file = "results/cell_comm/reform_list.RDS")
```

Plot interaction counts

```{r}
inter_counts_l = list()
for(n in names(net_names_l)){
  inter_counts = reshape2::dcast(data = net_names_l[[n]], 
                                 formula = SOURCE~TARGET, value.var = "count")
  rownames(inter_counts) = inter_counts[,1]
  inter_counts = inter_counts[,-1]
  
  pdf(paste0("results/cell_comm/", n, "_number_of_interactions.pdf"), useDingbats = F, 
      height = 6, width = 7)
  pheatmap::pheatmap(inter_counts, clustering_method = "ward.D2", main = "All clusters")
  dev.off()
  inter_counts_l[[n]] = inter_counts
}
```

Making two cell type by interaction matrices: one has the ligand mean, another the receptor mean

```{r}
scoring_mats = list()
for(n in names(reform_list)){
  cl_reform = reform_list[[n]]
  # add reversed non-directed interactions, to consider them in both directions
  cl_reform0 = cl_reform[cl_reform$dir==0,]
  cl_reform0 = cl_reform0[,c(1,3,2,5,4,6,7)]
  colnames(cl_reform0) = colnames(cl_reform)
  cl_reform = rbind(cl_reform, cl_reform0)
  
  dec_cl = dec_l[[n]]
  
  mat_lig_cl = data.frame(matrix(NA, nrow = length(unique(cl_reform$id_cp_interaction)), 
                   ncol = length(unique(cl_reform$ct1))))
  mat_rec_cl = data.frame(matrix(NA, nrow = length(unique(cl_reform$id_cp_interaction)), 
                   ncol = length(unique(cl_reform$ct1))))
  colnames(mat_lig_cl) = colnames(mat_rec_cl) = unique(cl_reform$ct1)
  rownames(mat_lig_cl) = rownames(mat_rec_cl) = unique(cl_reform$id_cp_interaction)
  for(i in 1:nrow(cl_reform)){
    g1 = cl_reform[i,"lr1"]
    g2 = cl_reform[i,"lr2"]
    
    c1 = cl_reform[i,"ct1"]
    c2 = cl_reform[i,"ct2"]
    
    int = as.character(cl_reform[i,1])
    
    m1 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,1]==g1,c1], na.rm = T)
    if(is.na(m1)) m1 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,5]==g1,c1], 
                            na.rm = T)
    mat_lig_cl[int, c1] = m1
    
    m2 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,1]==g2,c2], na.rm = T)
    if(is.na(m2)) m2 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,5]==g2,c2],
                            na.rm = T)
    if(is.na(m1) | is.na(m2)) print(int)
    mat_rec_cl[int, c2] = m2
  }
  
  # ligand vs receptor correlation
  cor_mat_each_cl = cor(mat_lig_cl, mat_rec_cl, use="pairwise.complete.obs", method = "sp")
  
  scoring_mats[[n]] = list("mat_lig_ct" = mat_lig_cl, "mat_rec_ct" = mat_rec_cl,
                           "cor_mat_each" = cor_mat_each_cl)
  
  # sum(lig, reg) correlation
  mat_lig_cl[is.na(mat_lig_cl)] = 0
  mat_rec_cl[is.na(mat_rec_cl)] = 0
  mat_both_cl = mat_lig_cl+mat_rec_cl
  mat_both_cl[mat_both_cl==0] = NA
  cor_mat_both_cl = cor(mat_both_cl, use="pairwise.complete.obs", method = "sp")
  
  scoring_mats[[n]]$cor_mat_both = cor_mat_both_cl
}
saveRDS(scoring_mats, file = "results/cell_comm/scoring_mats.RDS")
```

Making two cell type by interaction matrices: one has the ligand mean, another the receptor mean (here only directional)

```{r}
scoring_mats_dir = list()
for(n in names(reform_list)){
  cl_reform = reform_list[[n]]
  # add reversed non-directed interactions, to consider them in both directions
  cl_reform0 = cl_reform[cl_reform$dir==0,]
  cl_reform0 = cl_reform0[,c(1,3,2,5,4,6,7)]
  colnames(cl_reform0) = colnames(cl_reform)
  cl_reform = rbind(cl_reform, cl_reform0)
  
  cl_reform = cl_reform[cl_reform$dir==1,]
  
  dec_cl = dec_l[[n]]
  
  mat_lig_cl = data.frame(matrix(NA, nrow = length(unique(cl_reform$id_cp_interaction)), 
                   ncol = length(unique(cl_reform$ct1))))
  mat_rec_cl = data.frame(matrix(NA, nrow = length(unique(cl_reform$id_cp_interaction)), 
                   ncol = length(unique(cl_reform$ct1))))
  colnames(mat_lig_cl) = colnames(mat_rec_cl) = unique(cl_reform$ct1)
  rownames(mat_lig_cl) = rownames(mat_rec_cl) = unique(cl_reform$id_cp_interaction)
  for(i in 1:nrow(cl_reform)){
    g1 = cl_reform[i,"lr1"]
    g2 = cl_reform[i,"lr2"]
    
    c1 = cl_reform[i,"ct1"]
    c2 = cl_reform[i,"ct2"]
    
    int = as.character(cl_reform[i,1])
    
    m1 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,1]==g1,c1], na.rm = T)
    if(is.na(m1)) m1 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,5]==g1,c1], 
                            na.rm = T)
    mat_lig_cl[int, c1] = m1
    
    m2 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,1]==g2,c2], na.rm = T)
    if(is.na(m2)) m2 = mean(dec_cl[dec_cl$id_cp_interaction==int & dec_cl[,5]==g2,c2],
                            na.rm = T)
    if(is.na(m1) | is.na(m2)) print(int)
    mat_rec_cl[int, c2] = m2
  }
  
  # ligand vs receptor correlation
  cor_mat_each_cl = cor(mat_lig_cl, mat_rec_cl, use="pairwise.complete.obs", method = "sp")
  
  scoring_mats_dir[[n]] = list("mat_lig_ct" = mat_lig_cl, "mat_rec_ct" = mat_rec_cl,
                               "cor_mat_each" = cor_mat_each_cl)
  
  # sum(lig, reg) correlation
  mat_lig_cl[is.na(mat_lig_cl)] = 0
  mat_rec_cl[is.na(mat_rec_cl)] = 0
  mat_both_cl = mat_lig_cl+mat_rec_cl
  mat_both_cl[mat_both_cl==0] = NA
  cor_mat_both_cl = cor(mat_both_cl, use="pairwise.complete.obs", method = "sp")
  
  scoring_mats_dir[[n]]$cor_mat_both = cor_mat_both_cl
}
saveRDS(scoring_mats_dir, file = "results/cell_comm/scoring_mats_dir.RDS")
```

Count interactions of each type

```{r}
inter_counts_dir = list()
for(n in names(reform_list)){
  inter_counts_dir[[n]] = list()
  for(i in c(0,1)){
    cl_reform = reform_list[[n]]
    cl_reform = cl_reform[cl_reform$dir==i,]
    
    n_dir_int = matrix(0, nrow = length(unique(cl_reform$ct1)),
                       ncol = length(unique(cl_reform$ct1)))
    rownames(n_dir_int) = colnames(n_dir_int) = unique(cl_reform$ct1)
    for(c1 in unique(cl_reform$ct1)){
      for(c2 in unique(cl_reform$ct1)){
        n_dir_int[c1,c2] = nrow(cl_reform[cl_reform$ct1==c1 & cl_reform$ct2==c2,])
        if(i==0){
          n_dir_int[c1,c2] = n_dir_int[c1,c2]+nrow(cl_reform[cl_reform$ct1==c2 &
                                                               cl_reform$ct2==c1,])
        }
      }
    }
    inter_counts_dir[[n]][[as.character(i)]] = n_dir_int
  }
}
saveRDS(inter_counts_dir, file = "results/cell_comm/inter_counts_dir.RDS")
```



# Interaction analysis in conditions
Compare interactions with DE genes

```{r}
cond_comparison_list = readRDS(file = "results/cond_effect/all_filt_cond_comps.RDS")[c(1,3)]
# add corrected Hep, remove uncorrected
cond_comparison_list$cell_type = lapply(cond_comparison_list$cell_type, 
                                        function(x) x[x$celltype!="Hepatocytes",])
for(n in names(cond_comparison_list$cell_type)){
  cond_comparison_list$cell_type[[n]] = rbind(cond_comparison_list$cell_type[[n]],
                                              cond_comparison_list$cell_type_hep[[n]])
}

# add genes from complexes
complex_ref = unique(rbind(dec_l$healthy[dec_l$healthy$is_complex=="True",c(1,5)], 
                           dec_l$embolised[dec_l$regenerating$is_complex=="True",c(1,5)],
                           dec_l$regenerating[dec_l$regenerating$is_complex=="True",c(1,5)]))
inter_df = list()
conds = c("healthy", "embolised", "regenerating")
for(n in conds){
  tmp = merge(reform_list[[n]], complex_ref, by.x = 4, by.y = 2, all.x = T)[,c(2,3,4,1,5,8,6,7)]
  inter_df[[n]] = merge(tmp, complex_ref, by.x = 5, by.y = 2, all.x = T)[,c(2,3,4,5,6,1,9,7,8)]
  inter_df[[n]]$gene_name.x[is.na(inter_df[[n]]$gene_name.x)] = inter_df[[n]]$lr1[is.na(inter_df[[n]]$gene_name.x)]
  inter_df[[n]]$gene_name.y[is.na(inter_df[[n]]$gene_name.y)] = inter_df[[n]]$lr2[is.na(inter_df[[n]]$gene_name.y)]
  colnames(inter_df[[n]])[c(5,7)] = c("gn1", "gn2")
}

# add info on DE genes
for(n in names(cond_comparison_list$cell_type)){
  print(n)
  cond_comp = strsplit(n, "_v_")[[1]]
  for(cc in cond_comp){
    print(cc)
    gn1_isDE = c()
    gn2_isDE = c()
    mod = ifelse(cc==cond_comp[1], 1, -1)
    for(i in 1:nrow(inter_df[[cc]])){
      ct1cond = grepl(paste0("^",strsplit(inter_df[[cc]]$ct1[i], "_")[[1]][1]),
                      cond_comparison_list$cell_type[[n]]$celltype)
      ct2cond = grepl(paste0("^",strsplit(inter_df[[cc]]$ct2[i], "_")[[1]][1]),
                      cond_comparison_list$cell_type[[n]]$celltype)
      gn1cond = cond_comparison_list$cell_type[[n]]$gene==as.character(inter_df[[cc]]$gn1[i])
      gn2cond = cond_comparison_list$cell_type[[n]]$gene==as.character(inter_df[[cc]]$gn2[i])
      
      if(sum(ct1cond & gn1cond)>0){
        gn1_isDE = c(gn1_isDE, any(cond_comparison_list$cell_type[[n]]$avg_logFC[ct1cond & gn1cond]*mod>0))
      } else{
        gn1_isDE = c(gn1_isDE, FALSE)
      }
      if(sum(ct2cond & gn2cond)>0){
        gn2_isDE = c(gn2_isDE, any(cond_comparison_list$cell_type[[n]]$avg_logFC[ct2cond & gn2cond]*mod>0))
      } else{
        gn2_isDE = c(gn2_isDE, FALSE)
      }
    }
    inter_df[[cc]][,paste0("gn1_DEv",cond_comp[cond_comp!=cc])] = gn1_isDE
    inter_df[[cc]][,paste0("gn2_DEv",cond_comp[cond_comp!=cc])] = gn2_isDE
  }
}
for(cc in names(inter_df)){
  # interaction unique in condition
  unique_inter = setdiff(unique(inter_df[[cc]]$id_cp_interaction),
                         unique(c(inter_df[[names(inter_df)[names(inter_df)!=cc][1]]]$id_cp_interaction,
                                  inter_df[[names(inter_df)[names(inter_df)!=cc][2]]]$id_cp_interaction)))
  inter_df[[cc]]$cpdb_unique = inter_df[[cc]]$id_cp_interaction %in% unique_inter
  
  # lr1 unique in condition
  unique_lr1 = setdiff(unique(inter_df[[cc]]$lr1),
                         unique(c(inter_df[[names(inter_df)[names(inter_df)!=cc][1]]]$lr1,
                                  inter_df[[names(inter_df)[names(inter_df)!=cc][2]]]$lr1)))
  inter_df[[cc]]$cpdb_unique_lr1 = inter_df[[cc]]$lr1 %in% unique_lr1
  
  # lr2 unique in condition
  unique_lr2 = setdiff(unique(inter_df[[cc]]$lr2),
                         unique(c(inter_df[[names(inter_df)[names(inter_df)!=cc][1]]]$lr2,
                                  inter_df[[names(inter_df)[names(inter_df)!=cc][2]]]$lr2)))
  inter_df[[cc]]$cpdb_unique_lr2 = inter_df[[cc]]$lr2 %in% unique_lr2
}
for(cc in names(inter_df)){
  oc1 = names(inter_df)[names(inter_df)!=cc][1]
  oc2 = names(inter_df)[names(inter_df)!=cc][2]
  int1 = paste0(inter_df[[cc]]$id_cp_interaction,inter_df[[cc]]$ct1,inter_df[[cc]]$ct2)
  int2 = unique(paste0(inter_df[[oc1]]$id_cp_interaction,inter_df[[oc1]]$ct1,inter_df[[oc1]]$ct2))
  int3 = unique(paste0(inter_df[[oc2]]$id_cp_interaction,inter_df[[oc2]]$ct1,inter_df[[oc2]]$ct2))
  unique_inter = setdiff(unique(int1), unique(c(int2, int3)))
  inter_df[[cc]]$cpdb_unique_ct = int1 %in% unique_inter
}
for(n in names(inter_df)){
  df = inter_df[[n]]
  
  df$ct1[grepl("LSEC_", df$ct1)] = "LSEC"
  df$ct2[grepl("LSEC_", df$ct2)] = "LSEC"
  df$ct1[grepl("Hep", df$ct1)] = "Hepatocytes"
  df$ct2[grepl("Hep", df$ct2)] = "Hepatocytes"
  df = unique(df[,c(1:3,14)])
  
  ints_un_ct = rowSums(table(df$id_cp_interaction, df$ct1)>0)<4 | 
    rowSums(table(df$id_cp_interaction, df$ct2)>0)<4
  
  inter_df[[n]]$inter_ct_spec = inter_df[[n]]$id_cp_interaction %in% names(ints_un_ct)[ints_un_ct]
}
for(n in names(inter_df)){
  xxx = data.frame(ct = c(inter_df[[n]][,2], inter_df[[n]][,3]), 
                   lr = c(inter_df[[n]][,4], inter_df[[n]][,6]))
  xxx = unique(xxx)
  tab_lr = (table(xxx$lr, xxx$ct)>0)*1
  tab_lr = rowSums(tab_lr)
  
  inter_df[[n]]$lr1_nct = tab_lr[inter_df[[n]]$lr1]
  inter_df[[n]]$lr2_nct = tab_lr[inter_df[[n]]$lr2]
}
saveRDS(inter_df, file = "results/cell_comm/cond_diff_interact_DE.RDS")
```

Plot interaction heatmap - total and filtered

```{r}
int_counts_total = list()
int_counts_filt = list()
for(n in names(inter_df)){
  subdfct = unique(inter_df[[n]][,1:3])
  subdfct$ct1[grepl("LSEC_", subdfct$ct1)] = "LSEC"
  subdfct$ct2[grepl("LSEC_", subdfct$ct2)] = "LSEC"
  subdfct$ct1[grepl("Hepat", subdfct$ct1)] = "Hepatocytes"
  subdfct$ct2[grepl("Hepat", subdfct$ct2)] = "Hepatocytes"
  subdfct = unique(subdfct)
  dfct = data.frame("ct1" = c(subdfct$ct1, subdfct$ct2),
                    "ct2" = c(subdfct$ct2, subdfct$ct1))
  int_counts_total[[n]] = dfct
  pheatmap::pheatmap(table(dfct$ct1, dfct$ct2), main = n)
  
  keep = inter_df[[n]]$lr1_nct<=1 | inter_df[[n]]$lr2_nct<=1
  subdfct = unique(inter_df[[n]][keep,c(1:3, 19,20)])
  subdfct$ct1[grepl("LSEC_", subdfct$ct1)] = "LSEC"
  subdfct$ct2[grepl("LSEC_", subdfct$ct2)] = "LSEC"
  subdfct$ct1[grepl("Hepat", subdfct$ct1)] = "Hepatocytes"
  subdfct$ct2[grepl("Hepat", subdfct$ct2)] = "Hepatocytes"
  swp = subdfct[,5]==1
  tmp = subdfct$ct2[swp]
  subdfct$ct2[swp] = subdfct$ct1[swp]
  subdfct$ct1[swp] = tmp
  tmp = subdfct$lr2_nct[swp]
  subdfct$lr2_nct[swp] = subdfct$lr1_nct[swp]
  subdfct$lr1_nct[swp] = tmp
  dup = subdfct[subdfct$lr1_nct==1 & subdfct$lr2_nct==1,]
  tmp = dup$ct2
  dup$ct2 = dup$ct1
  dup$ct1 = tmp
  subdfct = rbind(subdfct, dup)
  subdfct = unique(subdfct[,1:3])
  int_counts_filt[[n]] = dfct
  pheatmap::pheatmap(table(subdfct$ct1, subdfct$ct2), main = n)
}
saveRDS(int_counts_total, file = "results/cell_comm/int_counts_total.RDS")
saveRDS(int_counts_filt, file = "results/cell_comm/int_counts_filt.RDS")
```

Get non-ubiquitous interactions

```{r}
inter_nonss = setdiff(unique(c(inter_df$embolised$id_cp_interaction,
                               inter_df$regenerating$id_cp_interaction)),
                      unique(inter_df$healthy$id_cp_interaction))
inter_nonemb = setdiff(unique(c(inter_df$healthy$id_cp_interaction,
                               inter_df$regenerating$id_cp_interaction)),
                      unique(inter_df$embolised$id_cp_interaction))
inter_nonreg = setdiff(unique(c(inter_df$embolised$id_cp_interaction,
                               inter_df$healthy$id_cp_interaction)),
                      unique(inter_df$regenerating$id_cp_interaction))

ct_g_cond = list()
for(n in names(inter_df)){
  df = inter_df[[n]][inter_df[[n]]$cpdb_unique | 
                       inter_df[[n]]$id_cp_interaction %in% c(inter_nonss, inter_nonemb, inter_nonreg),]
  #df = df[df$lr1_nct<=1 | df$lr2_nct<=1,]
  
  cts = unique(c(df$ct1, df$ct2))
  ct_g_list = list()
  for(ct in cts){
    ct_g_list[[ct]] = data.frame("interact" = c(as.character(df$id_cp_interaction[df$ct1==ct]),
                                                as.character(df$id_cp_interaction[df$ct2==ct])),
                                 "gene" = c(as.character(df$gn1[df$ct1==ct]),
                                            as.character(df$gn2[df$ct2==ct])),
                                 "gene_target" = c(as.character(df$gn2[df$ct1==ct]),
                                                   as.character(df$gn1[df$ct2==ct])),
                                 "ct" = ct,
                                 "ct_target" = c(as.character(df$ct2[df$ct1==ct]),
                                                as.character(df$ct1[df$ct2==ct])),
                                 "cond" = n, stringsAsFactors = F)
    ct_g_list[[ct]]$ct[grepl("LSEC_", ct_g_list[[ct]]$ct)] = "LSEC"
    ct_g_list[[ct]]$ct[grepl("Hepat", ct_g_list[[ct]]$ct)] = "Hepatocytes"
    ct_g_list[[ct]]$ct_target[grepl("LSEC_", ct_g_list[[ct]]$ct_target)] = "LSEC"
    ct_g_list[[ct]]$ct_target[grepl("Hepat", ct_g_list[[ct]]$ct_target)] = "Hepatocytes"
  }
  ct_g_cond[[n]] = unique(Reduce(rbind, ct_g_list))
}
ct_g_cond = Reduce(rbind, ct_g_cond)
dim(ct_g_cond)
length(unique(ct_g_cond$interact))
```

Annotate interactions

```{r}
#xxx = merge(unique(ct_g_cond[,1:3]), unique(inter_annot[,c(1,4)]), by = 1, all.x = T)
#write.csv(xxx, file = "inter_unique3.csv", row.names = F, col.names = T, quote = F)

inter_annot = read.csv("results/cell_comm/inter_unique.csv", header = T, stringsAsFactors = F)
inter_annot = unique(inter_annot[,c(1,4)])

description = strsplit(inter_annot$description, ";")
inter_des = lapply(1:length(description), 
                   function(x) rep(inter_annot$interact[x], length(description[[x]])))
inter_annot = data.frame("interact" = unlist(inter_des),
                         "description" = unlist(description))

inter_annot$description[inter_annot$description=="intercellular adhesion"] = "adhesion"
inter_annot$description[inter_annot$description=="antibody regulation"] = "immune regulation"
inter_annot$description[inter_annot$description=="antigen presentation"] = "immune activity"

ct_g_cond_ann = merge(ct_g_cond, inter_annot, by = 1, all = T)
ct_g_cond_ann = unique(ct_g_cond_ann[,c(1,4,5,6,7)])

ct_g_cond_ann = data.frame("interactions" = rep(as.character(ct_g_cond_ann$interact),2),
                           "celltypes" = c(as.character(ct_g_cond_ann$ct),
                                           as.character(ct_g_cond_ann$ct_target)),
                           "condition" = rep(as.character(ct_g_cond_ann$cond),2),
                           "description" = rep(as.character(ct_g_cond_ann$description),2))
ct_g_cond_ann$condition = factor(ct_g_cond_ann$condition, levels = c("healthy", "embolised", "regenerating"))

ggplot(ct_g_cond_ann, aes(x = condition, fill = condition))+
  facet_grid(description~celltypes, scales = "free_y")+
  geom_bar()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = "none")

saveRDS(ct_g_cond_ann, file = "results/cell_comm/ct_g_cond_ann.RDS")
```

Get expression for each interaction in each condition

```{r}
exp_list = list()
for(n in names(sig_means_names_l)[1:3]){
  df = sig_means_names_l[[n]][,c(1,5:6,13:301)]
  colnames(df) = gsub("Endothelial.cells..non.LSEC.", "Endothelial cells (non-LSEC)", colnames(df))
  colnames(df) = gsub("B.cells", "B cells", colnames(df))
  colnames(df) = gsub("Stellate.cells", "Stellate cells", colnames(df))
  colnames(df) = gsub("ab.T.cells", "ab-T cells", colnames(df))
  colnames(df) = gsub("gd.T.cells", "gd-T cells", colnames(df))
  colnames(df) = gsub("Kupffer.cells", "Kupffer cells", colnames(df))
  
  df = reshape2::melt(df, id.vars = 1:3)
  df$value[is.na(df$value)] = 0
  df$variable = gsub("Hepatocytes_Z1", "Hepatocytes", df$variable)
  df$variable = gsub("Hepatocytes_Z2", "Hepatocytes", df$variable)
  df$variable = gsub("Hepatocytes_Z3", "Hepatocytes", df$variable)
  df$variable = gsub("LSEC_Z1", "LSEC", df$variable)
  df$variable = gsub("LSEC_Z2", "LSEC", df$variable)
  df$variable = gsub("LSEC_Z3", "LSEC", df$variable)
  df = df %>%
   group_by(id_cp_interaction, gene_a, gene_b, variable) %>%
   summarise(value=(mean(value)))
  df = as.data.frame(df)
  
  sub_df = df[df$id_cp_interaction %in% ct_g_cond_ann$interactions,]
  sub_df = merge(ct_g_cond, sub_df, all.y = T, by = 1)
  keep = sapply(1:nrow(sub_df), 
                function(x) (sub_df$ct[x]==strsplit(sub_df$variable[x], ".", fixed = T)[[1]][1] &
                               sub_df$ct_target[x]==strsplit(sub_df$variable[x], ".", fixed = T)[[1]][2]) |
                  (sub_df$ct[x]==strsplit(sub_df$variable[x], ".", fixed = T)[[1]][2] &
                               sub_df$ct_target[x]==strsplit(sub_df$variable[x], ".", fixed = T)[[1]][1]))
  sub_df = sub_df[keep,c(1:6,10)]
  exp_list[[n]] = sub_df
}
ct_int_exp = cbind(exp_list$healthy, exp_list$embolised$value, exp_list$regenerating$value)
colnames(ct_int_exp)[7:9] = c("healthy_exp", "embolised_exp", "regenerating_exp")
ct_int_exp = ct_int_exp[ct_int_exp$healthy_exp>0 | 
                          ct_int_exp$embolised_exp>0 | 
                          ct_int_exp$regenerating_exp>0,]

tup_list = list()
keep_row = c()
for(i in 1:nrow(ct_int_exp)){
  tup1 = paste(c(ct_int_exp$gene[i], ct_int_exp$gene_target[i], ct_int_exp$ct[i], 
                 ct_int_exp$ct_target[i], ct_int_exp$cond[i]), collapse = " ")
  tup2 = paste(c(ct_int_exp$gene_target[i], ct_int_exp$gene[i], ct_int_exp$ct_target[i], 
                 ct_int_exp$ct[i], ct_int_exp$cond[i]), collapse = " ")
  if(!(tup1 %in% tup_list) & !(tup2 %in% tup_list)){
    tup_list = c(tup_list, tup1, tup2)
    keep_row = c(keep_row, T)
  } else{
    keep_row = c(keep_row, F)
  }
}
ct_int_exp = ct_int_exp[keep_row,]

ct_int_exp = merge(ct_int_exp, unique(ct_g_cond_ann[,c(1,4)]), by = 1, all = T)

saveRDS(ct_int_exp, file = "results/cell_comm/interact_celltype_exp_group.RDS")
```

Important tables

```{r}
for(n in names(inter_df)){
  write.csv(inter_df[[n]], col.names = T, row.names = F, quote = F,
            file = paste0("results/cell_comm/tables/Interact_", n, "_celltypes_cond.csv"))
}
write.csv(ct_int_exp, col.names = T, row.names = F, quote = F, 
          file = "results/cell_comm/tables/interact_celltype_exp_group.csv")
```



# Interaction analysis in zonation
Number of interactions per bin, per condition, in Hep and LSEC - only with other cell types!

```{r}
ninter_zon = list()
df_inter_zon = list()
matct_zon_list = list()
ints_list = list()
for(zon in c("LSEC_", "Hepa")){
  for(n in names(reform_list)[4:6]){
    id = paste0(n,"_",substr(zon,1,4))
    ints = unique(reform_list[[n]][grepl(zon, reform_list[[n]]$ct1) | grepl(zon, reform_list[[n]]$ct2),1:3])
    for(i in 1:nrow(ints)){
      if(!grepl(zon, ints[i,"ct2"])){
        tmp = ints[i,"ct2"]
        ints[i,"ct2"] = ints[i,"ct1"]
        ints[i,"ct1"] = tmp
      }
    }
    ints$ct2 = factor(ints$ct2, levels = paste0(strsplit(ints$ct2[1], "_")[[1]][1],"_Z",1:10))
    ints$ct1[grepl("Hepa", ints$ct1)] = "Hepatocytes"
    ints$ct1[grepl("LSEC_", ints$ct1)] = "LSEC"
    ints_list[[id]] = unique(ints)
      
    matct_zon_list[[id]] = reshape2::dcast(ints_list[[id]], formula = ct1~ct2)
    rownames(matct_zon_list[[id]]) = matct_zon_list[[id]][,1]
    matct_zon_list[[id]] = matct_zon_list[[id]][,-1]
    ninter_zon[[id]] = colSums(matct_zon_list[[id]])
  }
  df = data.frame(cbind(ninter_zon[[paste0("healthy_bins_", substr(zon, 1, 4))]],
                        ninter_zon[[paste0("embolised_bins_", substr(zon, 1, 4))]],
                        ninter_zon[[paste0("regenerating_bins_", substr(zon, 1, 4))]]))
  colnames(df) = c("healthy", "embolised", "regenerating")
  df$zon = factor(rownames(df), levels = rownames(df))
  df_inter_zon[[substr(zon,1,4)]] = reshape2::melt(df)

  ncells = data.frame("healthy" = table(meta_l$healthy_bins$cell_type),
                      "embolised" = table(meta_l$embolised_bins$cell_type),
                      "regenerating" = table(meta_l$regenerating_bins$cell_type))[,c(1,2,4,6)]
  colnames(ncells) = c("celltype", "healthy", "embolised", "regenerating")
  ncells = reshape2::melt(ncells)
  df_inter_zon[[substr(zon,1,4)]] = merge(df_inter_zon[[substr(zon,1,4)]], ncells, by = c(1,2))
  colnames(df_inter_zon[[substr(zon,1,4)]]) = c("zon", "cond", "n_inter", "n_cells")
}
ggplot(df_inter_zon$Hepa, aes(x = zon, y = n_inter, colour = cond, group = cond))+
  geom_point(mapping = aes(size = n_cells))+
  geom_line()+
  scale_x_discrete(labels = 1:10)+
  labs(title = "Hepatocytes", x = "Zonation (10 bins)", y = "# interactions")+
  theme_classic()
ggplot(df_inter_zon$LSEC, aes(x = zon, y = n_inter, colour = cond, group = cond))+
  geom_point(mapping = aes(size = n_cells))+
  geom_line()+
  scale_x_discrete(labels = 1:10)+
  labs(title = "LSEC", x = "Zonation (10 bins)", y = "# interactions")+
  theme_classic()

saveRDS(df_inter_zon, file = "results/cell_comm/number_interactions_zonation.RDS")
saveRDS(matct_zon_list, file = "results/cell_comm/zonation_interactions_celltype.RDS")
saveRDS(ints_list, file = "results/cell_comm/interactions_zonation_list.RDS")
```



```{r}
intsplot = c("CPI-SS0241A1F57", "CPI-SC0530C27A8", "CPI-SS087E0E3FB", 
             "CPI-SC0F8D27FBC", "CPI-SC095A2C115", "CPI-SC0E1037D03")

namesdf = unique(ct_int_exp[ct_int_exp$interact %in% intsplot & 
                              (ct_int_exp$ct=="LSEC" | ct_int_exp$ct_target=="LSEC"), 1:5])
fulln = c()
for(i in 1:nrow(namesdf)){
  newn = if(namesdf$ct[i]=="LSEC"){
    paste0(namesdf$gene[i], "-", namesdf$gene_target[i])
  } else{
    paste0(namesdf$gene_target[i], "-", namesdf$gene[i])
  }
  fulln = c(fulln, newn)
}
namesdf$full = fulln

namesdf = namesdf[!duplicated(namesdf$interact),]
namesdf = data.frame(row.names = namesdf$interact, name = namesdf$full)

for(n in names(ints_list)[1:3]){
  pltdf = table(unique(ints_list[[n]])$id_cp_interaction, unique(ints_list[[n]])$ct2)
  plot_df = pltdf[intsplot[intsplot %in% rownames(pltdf)],]
  if(is.table(plot_df)){
    rownames(plot_df) = namesdf[rownames(plot_df),1]
    print(pheatmap::pheatmap(plot_df, cluster_cols = F, main = n))
  }
}
```




```{r}
pltdf_groups = list()
pltdf_ct = list()
for(n in names(ints_list)){
  df = merge(ints_list[[n]], ct_int_exp, by = 1)
  df = unique(df[,c(1:3,12)])
  
  if(grepl("LSEC", n)){
    subdf = df[df$ct1!="LSEC",]
  } else{
    subdf = df[df$ct1!="Hepatocytes",]
  }
  tabdf = table(subdf$description, subdf$ct2)
  pltdf_groups[[n]] = data.frame(tabdf[rowSums(tabdf)>0,])
  pltdf_groups[[n]] = pltdf_groups[[n]][order(pltdf_groups[[n]]$Var2),]
  pltdf_groups[[n]]$norm = unlist(tapply(pltdf_groups[[n]]$Freq, pltdf_groups[[n]]$Var2, 
                                         function(x) x/sum(x)))
  
  tabdf = table(subdf$ct1, subdf$ct2)
  pltdf_ct[[n]] = data.frame(tabdf[rowSums(tabdf)>0,])
  pltdf_ct[[n]] = pltdf_ct[[n]][order(pltdf_ct[[n]]$Var2),]
  pltdf_ct[[n]]$norm = unlist(tapply(pltdf_ct[[n]]$Freq, pltdf_ct[[n]]$Var2, 
                                     function(x) x/sum(x)))
}
lsec_zon_int_groups = Reduce(rbind, pltdf_groups[1:3])
lsec_zon_int_groups$cond = c(rep("healthy", nrow(pltdf_groups$healthy_bins_LSEC)),
                             rep("embolised", nrow(pltdf_groups$embolised_bins_LSEC)),
                             rep("regenerating", nrow(pltdf_groups$regenerating_bins_LSEC)))
hep_zon_int_groups = Reduce(rbind, pltdf_groups[4:6])
hep_zon_int_groups$cond = c(rep("healthy", nrow(pltdf_groups$healthy_bins_Hepa)),
                            rep("embolised", nrow(pltdf_groups$embolised_bins_Hepa)),
                            rep("regenerating", nrow(pltdf_groups$regenerating_bins_Hepa)))

lsec_zon_int_ct = Reduce(rbind, pltdf_ct[1:3])
lsec_zon_int_ct$cond = c(rep("healthy", nrow(pltdf_ct$healthy_bins_LSEC)),
                         rep("embolised", nrow(pltdf_ct$embolised_bins_LSEC)),
                         rep("regenerating", nrow(pltdf_ct$regenerating_bins_LSEC)))
hep_zon_int_ct = Reduce(rbind, pltdf_ct[4:6])
hep_zon_int_ct$cond = c(rep("healthy", nrow(pltdf_ct$healthy_bins_Hepa)),
                        rep("embolised", nrow(pltdf_ct$embolised_bins_Hepa)),
                        rep("regenerating", nrow(pltdf_ct$regenerating_bins_Hepa)))



ggplot(lsec_zon_int_groups, 
       aes(x = Var2, y = Freq, colour = cond, group = cond))+
  facet_wrap(~Var1)+
  geom_point()+geom_line()+
  theme_bw()
ggplot(hep_zon_int_groups, 
       aes(x = Var2, y = Freq, colour = cond, group = cond))+
  facet_wrap(~Var1)+
  geom_point()+geom_line()+
  theme_bw()

ggplot(lsec_zon_int_ct, 
       aes(x = Var2, y = Freq, colour = cond, group = cond))+
  facet_wrap(~Var1)+
  geom_point()+geom_line()+
  theme_bw()
ggplot(hep_zon_int_ct, 
       aes(x = Var2, y = Freq, colour = cond, group = cond))+
  facet_wrap(~Var1)+
  geom_point()+geom_line()+
  theme_bw()

ggplot(pltdf_groups$regenerating_bins_LSEC, aes(x = Var2, y = Freq, colour = Var1, group = Var1))+
  geom_point()+geom_line()+
  labs(title = "regenerating_bins_LSEC")+
  theme_bw()
ggplot(pltdf_groups$regenerating_bins_LSEC, aes(x = Var2, y = Freq, fill = Var1, group = Var1))+
  geom_area(position = "stack")+
  labs(title = "regenerating_bins_LSEC")+
  theme_bw()
ggplot(pltdf_groups$healthy_bins_LSEC, aes(x = Var2, y = Freq, fill = Var1, group = Var1))+
  geom_area(position = "stack")+
  labs(title = "healthy_bins_LSEC")+
  theme_bw()
ggplot(pltdf_groups$regenerating_bins_LSEC, aes(x = Var2, y = norm, fill = Var1, group = Var1))+
  geom_area(position = "stack")+
  labs(title = "regenerating_bins_LSEC")+
  theme_bw()
ggplot(pltdf_groups$healthy_bins_LSEC, aes(x = Var2, y = norm, fill = Var1, group = Var1))+
  geom_area(position = "stack")+
  labs(title = "healthy_bins_LSEC")+
  theme_bw()
```

Number of interactions each cell type has with each bin

```{r}
#```{r, fig.width=10, fig.height=4.2}
pheatmap::pheatmap(matct_zon_list$healthy_bins_Hepa, cluster_cols = F,scale = "row",
                   clustering_method = "ward.D", main = "Hep healthy")
pheatmap::pheatmap(matct_zon_list$embolised_bins_Hepa[,-10], cluster_cols = F,scale = "row",
                   clustering_method = "ward.D", main = "Hep embolised")
pheatmap::pheatmap(matct_zon_list$regenerating_bins_Hepa, cluster_cols = F,scale = "row",
                   clustering_method = "ward.D", main = "Hep regenerating")

pheatmap::pheatmap(matct_zon_list$healthy_bins_LSEC, cluster_cols = F,scale = "row",
                   clustering_method = "ward.D", main = "LSEC healthy")
pheatmap::pheatmap(matct_zon_list$embolised_bins_LSEC, cluster_cols = F,scale = "row",
                   clustering_method = "ward.D", main = "LSEC embolised")
pheatmap::pheatmap(matct_zon_list$regenerating_bins_LSEC, cluster_cols = F,scale = "row",
                   clustering_method = "ward.D", main = "LSEC regenerating")


pheatmap::pheatmap(cbind(t(apply(matct_zon_list$healthy_bins_Hepa, 1, function(x) x/sum(x))), 
                         t(apply(matct_zon_list$embolised_bins_Hepa[,-10], 1, function(x) x/sum(x))), 
                         t(apply(matct_zon_list$regenerating_bins_Hepa, 1, function(x) x/sum(x)))), 
                   cluster_cols = F, gaps_col = c(10,10, 19,19),
                   clustering_method = "ward.D", main = "Hepatocytes")
pheatmap::pheatmap(cbind(t(apply(matct_zon_list$healthy_bins_LSEC, 1, function(x) x/sum(x))), 
                         t(apply(matct_zon_list$embolised_bins_LSEC, 1, function(x) x/sum(x))), 
                         t(apply(matct_zon_list$regenerating_bins_LSEC, 1, function(x) x/sum(x)))), 
                   cluster_cols = F, gaps_col = c(10,10, 20,20),
                   clustering_method = "ward.D", main = "LSEC")
```

Important tables

```{r}
write.csv(lsec_interact, file = "results/cell_comm/tables/Interact_LSEC_regions.csv", 
          col.names = T, row.names = F, quote = F)
write.csv(hepa_interact, file = "results/cell_comm/tables/Interact_Hep_regions.csv", 
          col.names = T, row.names = F, quote = F)

for(n in names(matict_zon_list)){
  write.csv(matict_zon_list[[n]], col.names = T, row.names = F, quote = F,
            file = paste0("results/cell_comm/tables/Interact_", n, "_regions_detail.csv"))
}
```
























Counting interactions

```{r}
ninter_all = lapply(inter_counts_l, function(x) data.frame("interactions" = rowSums(x)))
ninter_send = lapply(inter_counts_dir, function(x) data.frame("interactions" = rowSums(x$`1`)))
ninter_recv = lapply(inter_counts_dir, function(x) data.frame("interactions" = colSums(x$`1`)))
```

Heatmaps for total interactions

```{r}
# interaction scores
## healthy
tmp = mut_info_list$healthy
tmp$score = tmp$mi*mut_info_list$healthy$n
mm = reshape2::dcast(tmp, source~target, value.var = "score")
rownames(mm) = mm[,1]
mm = mm[,-1]
pdf("results/cell_comm/healthy_total_interaction_scores.pdf", useDingbats = F, width = 6.2, height = 6)
pheatmap::pheatmap(mm, clustering_method = "ward.D2", color = colorRampPalette(RColorBrewer::brewer.pal(n = 9, name = "PuBuGn"))(100),
                   annotation_col = ninter_all$healthy)
dev.off()

## regenerating
tmp = mut_info_list$regenerating
tmp$score = tmp$mi*mut_info_list$regenerating$n
mr = reshape2::dcast(tmp, source~target, value.var = "score")
rownames(mr) = mr[,1]
mr = mr[,-1]
pdf("results/cell_comm/regenerating_total_interaction_scores.pdf", useDingbats = F, width = 6.2, height = 6)
pheatmap::pheatmap(mr, clustering_method = "ward.D2", 
                   color = colorRampPalette(RColorBrewer::brewer.pal(n = 9, name = "PuBuGn"))(100),
                   annotation_col = ninter_all$regenerating)
dev.off()

cols = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, name = "RdBu")))(100)
## difference between scores
yy = mm-mr
yy[yy>6] = 6
yy[yy<(-10)] = -10
cols_n = colorRampPalette(RColorBrewer::brewer.pal(n = 9, name = "OrRd"))(100)
lims_cols_h = c(round(min(ninter_all$healthy$interactions)*1/min(ninter_all$regenerating$interactions), 0),
                round(max(ninter_all$healthy$interactions)*100/max(ninter_all$regenerating$interactions), 0))
cols_h = cols_n[(lims_cols_h[1]):(lims_cols_h[2])]
pdf("results/cell_comm/HvR_total_interaction_scores.pdf", useDingbats = F, 
    width = 6.2, height = 6)
pheatmap::pheatmap(yy, color = cols, 
                   breaks = rev(c(seq(max(yy), 0, length.out = 50), 
                                  seq(-0.001, min(yy), length.out = 50))),
                   clustering_method = "ward.D2", 
                   annotation_col = data.frame(row.names = rownames(ninter_all$healthy),
                                               "H" = ninter_all$healthy$interactions, 
                                               "R" = ninter_all$regenerating$interactions),
                   annotation_colors = list("H" = cols_h,
                                            "R" = cols_n))
dev.off()

# number of interactions
pdf("results/cell_comm/healthy_total_interaction_number.pdf", useDingbats = F, 
    width = 6.2, height = 6)
pheatmap::pheatmap(inter_counts_l$healthy, clustering_method = "ward.D2", 
                   color = colorRampPalette(RColorBrewer::brewer.pal(n = 9, name = "PuBuGn"))(100),
                   annotation_col = ninter_all$healthy)
dev.off()
pdf("results/cell_comm/regenerating_total_interaction_number.pdf", useDingbats = F, 
    width = 6.2, height = 6)
pheatmap::pheatmap(inter_counts_l$regenerating, clustering_method = "ward.D2", 
                   color = colorRampPalette(RColorBrewer::brewer.pal(n = 9, name = "PuBuGn"))(100),
                   annotation_col = ninter_all$regenerating)
dev.off()

## difference between number of interactins
x = inter_counts_l$healthy-inter_counts_l$regenerating
brks =  seq(-max(abs(x)), max(abs(x)), length.out = 100)
brks2 = brks[(max(x)-brks)>=0]
pdf("results/cell_comm/HvR_total_interaction_number.pdf", useDingbats = F, 
    width = 6.2, height = 6)
pheatmap::pheatmap(x, color = cols, breaks = rev(c(seq(max(x), 0, length.out = 50), 
                                                   seq(-0.001, min(x), length.out = 50))), 
                   clustering_method = "ward.D2", 
                   annotation_col = data.frame(row.names = rownames(ninter_all$healthy),
                                               "H" = ninter_all$healthy$interactions, 
                                               "R" = ninter_all$regenerating$interactions),
                   annotation_colors = list("H" = cols_h,
                                            "R" = cols_n))
dev.off()
```

Heatmaps for directed interactions

```{r}
# interaction scores
## healthy
tmp = mut_info_dir_list$healthy
tmp$score = tmp$mi*mut_info_dir_list$healthy$n
mm = reshape2::dcast(tmp, source~target, value.var = "score")
rownames(mm) = mm[,1]
mm = mm[,-1]
pdf("results/cell_comm/healthy_directed_interaction_scores.pdf", useDingbats = F, width = 6.2, height = 6)
pheatmap::pheatmap(mm, clustering_method = "ward.D2", color = colorRampPalette(RColorBrewer::brewer.pal(n = 9, name = "PuBuGn"))(100),
                   annotation_row = ninter_send$healthy, annotation_col = ninter_recv$healthy)
dev.off()

## regenerating
tmp = mut_info_dir_list$regenerating
tmp$score = tmp$mi*mut_info_dir_list$regenerating$n
mr = reshape2::dcast(tmp, source~target, value.var = "score")
rownames(mr) = mr[,1]
mr = mr[,-1]
pdf("results/cell_comm/regenerating_directed_interaction_scores.pdf", useDingbats = F, width = 6.2, height = 6)
pheatmap::pheatmap(mr, clustering_method = "ward.D2", color = colorRampPalette(RColorBrewer::brewer.pal(n = 9, name = "PuBuGn"))(100),
                   annotation_row = ninter_send$regenerating, annotation_col = ninter_recv$regenerating)
dev.off()

cols = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, name = "RdBu")))(100)
## difference between scores
yy = mm-mr
yy[yy>3] = 3
yy[yy<(-2)] = -2
cols_n = colorRampPalette(RColorBrewer::brewer.pal(n = 9, name = "Purples"))(100)
lims_cols_h = c(round(min(ninter_recv$healthy$interactions)*1/min(ninter_recv$regenerating$interactions), 0),
                round(max(ninter_recv$healthy$interactions)*100/max(ninter_recv$regenerating$interactions), 0))
cols_hr = cols_n[(lims_cols_h[1]):(lims_cols_h[2])]
pdf("results/cell_comm/HvR_directed_interaction_scores.pdf", useDingbats = F, width = 6.2, height = 6)
pheatmap::pheatmap(yy, color = cols, breaks = rev(c(seq(max(yy), 0, length.out = 50), 
                                                    seq(-0.001, min(yy), length.out = 50))), 
                   clustering_method = "ward.D2", 
                   annotation_col = data.frame(row.names = rownames(ninter_recv$healthy),
                                               "H" = ninter_recv$healthy$interactions, 
                                               "R" = ninter_recv$regenerating$interactions),
                   annotation_row = data.frame(row.names = rownames(ninter_send$healthy),
                                               "H" = ninter_send$healthy$interactions, 
                                               "R" = ninter_send$regenerating$interactions),
                   annotation_colors = list("H" = cols_hr,
                                            "R" = cols_n))
dev.off()

# number of interactions
pdf("results/cell_comm/healthy_directed_interaction_number.pdf", useDingbats = F, width = 6.2, height = 6)
pheatmap::pheatmap(inter_counts_dir$healthy$`1`, clustering_method = "ward.D2", 
                   color = colorRampPalette(RColorBrewer::brewer.pal(n = 9, 
                                                                     name = "PuBuGn"))(100),
                   annotation_col = ninter_recv$healthy, annotation_row = ninter_send$healthy)
dev.off()
pdf("results/cell_comm/regenerating_directed_interaction_number.pdf", useDingbats = F, 
    width = 6.2, height = 6)
pheatmap::pheatmap(inter_counts_dir$regenerating$`1`, clustering_method = "ward.D2", 
                   color = colorRampPalette(RColorBrewer::brewer.pal(n = 9, 
                                                                     name = "PuBuGn"))(100),
                   annotation_col = ninter_recv$regenerating, annotation_row = ninter_send$regenerating)
dev.off()

## difference between scores
x = inter_counts_dir$healthy$`1`-inter_counts_dir$regenerating$`1`
cols = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, name = "RdBu")))(100)
brks =  seq(-max(abs(x)), max(abs(x)), length.out = 100)
brks2 = brks[(max(x)-brks)>=0]
pdf("results/cell_comm/HvR_directed_interaction_number.pdf", useDingbats = F, 
    width = 6.2, height = 6)
pheatmap::pheatmap(x, color = cols, breaks = rev(c(seq(max(x), 0, length.out = 50), 
                                                   seq(-0.001, min(x), length.out = 50))), 
                   clustering_method = "ward.D2",
                   annotation_col = data.frame(row.names = rownames(ninter_recv$healthy),
                                               "H" = ninter_recv$healthy$interactions, 
                                               "R" = ninter_recv$regenerating$interactions),
                   annotation_row = data.frame(row.names = rownames(ninter_send$healthy),
                                               "H" = ninter_send$healthy$interactions, 
                                               "R" = ninter_send$regenerating$interactions),
                   annotation_colors = list("H" = cols_hr,
                                            "R" = cols_n))
dev.off()
```

Compare detected interactions with condition DE genes (include: gene name of complex, if interaction is unique to condition, if elements of interaction are DE in that cell type) 

```{r}
cond_comparison_list = readRDS(file = "results/cond_effect/all_filt_cond_comps.RDS")

# get unique interactions
ints_regen = setdiff(unique(reform_list$regenerating[,"id_cp_interaction"]),
                     unique(reform_list$healthy[,"id_cp_interaction"]))
ints_healthy = setdiff(unique(reform_list$healthy[,"id_cp_interaction"]),
                       unique(reform_list$regenerating[,"id_cp_interaction"]))

# add genes from complexes
complex_ref = unique(rbind(dec_l$healthy[dec_l$healthy$is_complex=="True",c(1,5)], 
                             dec_l$regenerating[dec_l$regenerating$is_complex=="True",c(1,5)]))
inter_df = list()
for(n in c("healthy", "regenerating")){
  tmp = merge(reform_list[[n]], complex_ref, by.x = 4, by.y = 2, all.x = T)[,c(2,3,4,1,5,8,6,7)]
  inter_df[[n]] = merge(tmp, complex_ref, by.x = 5, by.y = 2, all.x = T)[,c(2,3,4,5,6,1,9,7,8)]
  inter_df[[n]]$gene_name.x[is.na(inter_df[[n]]$gene_name.x)] = inter_df[[n]]$lr1[is.na(inter_df[[n]]$gene_name.x)]
  inter_df[[n]]$gene_name.y[is.na(inter_df[[n]]$gene_name.y)] = inter_df[[n]]$lr2[is.na(inter_df[[n]]$gene_name.y)]
  colnames(inter_df[[n]])[c(5,7)] = c("gn1", "gn2")
}

# add info on DE genes
for(n in names(inter_df)){
  gn1_isDE = c()
  gn2_isDE = c()
  mod = ifelse(n=="healthy", 1, -1)
  for(i in 1:nrow(inter_df[[n]])){
    ct1cond = cond_comparison_list$healthy_v_regenerating$cell_type$celltype==inter_df[[n]]$ct1[i]
    ct2cond = cond_comparison_list$healthy_v_regenerating$cell_type$celltype==inter_df[[n]]$ct2[i]
    gn1cond = cond_comparison_list$healthy_v_regenerating$cell_type$gene==as.character(inter_df[[n]]$gn1[i])
    gn2cond = cond_comparison_list$healthy_v_regenerating$cell_type$gene==as.character(inter_df[[n]]$gn2[i])
    
    if(sum(ct1cond & gn1cond)>0){
      gn1_isDE = c(gn1_isDE, cond_comparison_list$healthy_v_regenerating$cell_type$avg_logFC[ct1cond & gn1cond]*mod>0)
    } else{
      gn1_isDE = c(gn1_isDE, FALSE)
    }
    if(sum(ct2cond & gn2cond)>0){
      gn2_isDE = c(gn2_isDE, cond_comparison_list$healthy_v_regenerating$cell_type$avg_logFC[ct2cond & gn2cond]*mod>0)
    } else{
      gn2_isDE = c(gn2_isDE, FALSE)
    }
  }
  inter_df[[n]]$gn1_isDE = gn1_isDE
  inter_df[[n]]$gn2_isDE = gn2_isDE
}

# add info on unique interactions
inter_df$healthy$isUnique = inter_df$healthy$id_cp_interaction %in% ints_healthy
inter_df$regenerating$isUnique = inter_df$regenerating$id_cp_interaction %in% ints_regen

saveRDS(inter_df, file = "results/cell_comm/interaction_de_unique_HvR.RDS")
```



```{r}
xxx = inter_df$healthy[(inter_df$healthy$gn1_isDE | inter_df$healthy$gn2_isDE) & inter_df$healthy$dir==1,c(1,2,3)]
xxx = unique(xxx)
pheatmap::pheatmap(table(xxx$ct1, xxx$ct2))
xxx = inter_df$regenerating[(inter_df$regenerating$gn1_isDE | inter_df$regenerating$gn2_isDE) & inter_df$regenerating$dir==1,c(1,2,3)]
xxx = unique(xxx)
pheatmap::pheatmap(table(xxx$ct1, xxx$ct2))


xxx = inter_df$healthy[inter_df$healthy$isUnique & inter_df$healthy$dir==1,c(1,2,3)]
xxx = unique(xxx)
pheatmap::pheatmap(table(xxx$ct1, xxx$ct2))
xxx = inter_df$regenerating[inter_df$regenerating$isUnique & inter_df$regenerating$dir==1,c(1,2,3)]
xxx = unique(xxx)
pheatmap::pheatmap(table(xxx$ct1, xxx$ct2))
```



## Zonation Analysis
Load zonation-varying genes

```{r}
reform_list = readRDS(file = "results/cell_comm/reform_list.RDS")
dec_l = readRDS(file = "results/cell_comm/deconvoluted_list.RDS")

# add genes from complexes
complex_ref = unique(rbind(dec_l$healthy[dec_l$healthy$is_complex=="True",c(1,5)], 
                             dec_l$regenerating[dec_l$regenerating$is_complex=="True",c(1,5)]))
inter_df = list()
for(n in c("healthy", "embolised", "regenerating")){
  tmp = merge(reform_list[[n]], complex_ref, by.x = 4, by.y = 2, all.x = T)[,c(2,3,4,1,5,8,6,7)]
  inter_df[[n]] = merge(tmp, complex_ref, by.x = 5, by.y = 2, all.x = T)[,c(2,3,4,5,6,1,9,7,8)]
  inter_df[[n]]$gene_name.x[is.na(inter_df[[n]]$gene_name.x)] = inter_df[[n]]$lr1[is.na(inter_df[[n]]$gene_name.x)]
  inter_df[[n]]$gene_name.y[is.na(inter_df[[n]]$gene_name.y)] = inter_df[[n]]$lr2[is.na(inter_df[[n]]$gene_name.y)]
  colnames(inter_df[[n]])[c(5,7)] = c("gn1", "gn2")
}
```

Load and prepare hepatocyte data

```{r}
load("results/zonation_cond/hep_binned_traj_qval_fits.RData")
hep_fits = fits_b_list
hep_traj = traj_list
hep_qvals = qvals_b_list

nbins = 100
df_h = data.table("zonation_pt" = hep_traj$healthy)
df_h$zonation_int = cut(df_h$zonation_pt, nbins)

df_e = data.table("zonation_pt" = hep_traj$embolised)
df_e = df_h[df_e, on="zonation_pt", roll=Inf, rollends = T]

df_r = data.table("zonation_pt" = hep_traj$regenerating)
df_r = df_h[df_r, on="zonation_pt", roll=Inf, rollends = T]

mean_bins_h = apply(hep_cells$healthy@assays$SCT@data, 1, 
                    function(x) tapply(x, df_h$zonation_int, mean))
mean_bins_e = apply(hep_cells$embolised@assays$SCT@data, 1, 
                    function(x) tapply(x, df_e$zonation_int, mean))
mean_bins_r = apply(hep_cells$regenerating@assays$SCT@data, 1, 
                    function(x) tapply(x, df_r$zonation_int, mean))

hep_h_max = apply(hep_fits$healthy, 2, function(x) mean(order(x, decreasing = T)[1:10]))
hep_e_max = apply(hep_fits$embolised, 2, function(x) mean(order(x, decreasing = T)[1:10]))
hep_r_max = apply(hep_fits$regenerating, 2, function(x) mean(order(x, decreasing = T)[1:10]))
std <- function(x) sd(x)/sqrt(length(x))
hep_h_sdmax = apply(hep_fits$healthy, 2, function(x) std(order(x, decreasing = T)[1:10]))
hep_e_sdmax = apply(hep_fits$embolised, 2, function(x) std(order(x, decreasing = T)[1:10]))
hep_r_sdmax = apply(hep_fits$regenerating, 2, function(x) std(order(x, decreasing = T)[1:10]))
```

Load and prepare LSEC data

```{r}
load("results/zonation_cond/end_binned_traj_qval_fits.RData")
end_fits = fits_b_list
end_traj = traj_list
end_qvals = qvals_b_list

nbins = 100
df_h = data.table("zonation_pt" = end_traj$healthy)
df_h$zonation_int = cut(df_h$zonation_pt, nbins)

df_e = data.table("zonation_pt" = end_traj$embolised)
df_e = df_h[df_e, on="zonation_pt", roll=Inf, rollends = T]

df_r = data.table("zonation_pt" = end_traj$regenerating)
df_r = df_h[df_r, on="zonation_pt", roll=Inf, rollends = T]

mean_bins_h = apply(end_cells$healthy@assays$SCT@data, 1, 
                    function(x) tapply(x, df_h$zonation_int, mean))
mean_bins_e = apply(end_cells$embolised@assays$SCT@data, 1, 
                    function(x) tapply(x, df_e$zonation_int, mean))
mean_bins_r = apply(end_cells$regenerating@assays$SCT@data, 1, 
                    function(x) tapply(x, df_r$zonation_int, mean))

end_h_max = apply(end_fits$healthy, 2, function(x) mean(order(x, decreasing = T)[1:10]))
end_e_max = apply(end_fits$embolised, 2, function(x) mean(order(x, decreasing = T)[1:10]))
end_r_max = apply(end_fits$regenerating, 2, function(x) mean(order(x, decreasing = T)[1:10]))
std <- function(x) sd(x)/sqrt(length(x))
end_h_sdmax = apply(end_fits$healthy, 2, function(x) std(order(x, decreasing = T)[1:10]))
end_e_sdmax = apply(end_fits$embolised, 2, function(x) std(order(x, decreasing = T)[1:10]))
end_r_sdmax = apply(end_fits$regenerating, 2, function(x) std(order(x, decreasing = T)[1:10]))
```

Get interactions mapped to the zonation

```{r}
zonation_alldat = list()
zonation_filt = list()
zon_ct = c("Hepatocytes" = "Hepa", "LSEC" = "LSEC_")
for(n in names(zon_ct)){
  zonation_alldat[[n]] = list()
  zonation_filt[[n]] = list()
  genes_list = lapply(inter_df, function(x) unique(c(as.character(x$gn1[grepl(zon_ct[n], x$ct1)]), 
                                                       as.character(x$gn2[grepl(zon_ct[n], x$ct2)]))))
  for(cc in names(hep_qvals)){
    # select all interactions involving hepatocytes or LSEC
    dfinterzon = data.frame("cell_type" = c(inter_df[[cc]]$ct1[grepl(zon_ct[n], inter_df[[cc]]$ct2) & 
                                                                   inter_df[[cc]]$gn2 %in% genes_list[[cc]]], 
                                            inter_df[[cc]]$ct2[grepl(zon_ct[n], inter_df[[cc]]$ct1) & 
                                                                   inter_df[[cc]]$gn1 %in% genes_list[[cc]]]),
                            "gene_ct" = c(as.character(inter_df[[cc]]$gn1[grepl(zon_ct[n], inter_df[[cc]]$ct2) &
                                                                              inter_df[[cc]]$gn2 %in% genes_list[[cc]]]), 
                                          as.character(inter_df[[cc]]$gn2[grepl(zon_ct[n], inter_df[[cc]]$ct1) & 
                                                                              inter_df[[cc]]$gn1 %in% genes_list[[cc]]])),
                            "gene_zon" = c(as.character(inter_df[[cc]]$gn2[grepl(zon_ct[n], inter_df[[cc]]$ct2) & 
                                                                               inter_df[[cc]]$gn2 %in% genes_list[[cc]]]), 
                                           as.character(inter_df[[cc]]$gn1[grepl(zon_ct[n], inter_df[[cc]]$ct1) & 
                                                                               inter_df[[cc]]$gn1 %in% genes_list[[cc]]])),
                            "interact" = c(as.character(inter_df[[cc]]$id_cp_interaction[grepl(zon_ct[n], inter_df[[cc]]$ct2) & 
                                                                                             inter_df[[cc]]$gn2 %in% genes_list[[cc]]]), 
                                           as.character(inter_df[[cc]]$id_cp_interaction[grepl(zon_ct[n], inter_df[[cc]]$ct1) & 
                                                                                             inter_df[[cc]]$gn1 %in% genes_list[[cc]]])),
                            "dir" = c(as.character(inter_df[[cc]]$dir[grepl(zon_ct[n], inter_df[[cc]]$ct2) & 
                                                                          inter_df[[cc]]$gn2 %in% genes_list[[cc]]]),
                                      as.character(inter_df[[cc]]$dir[grepl(zon_ct[n], inter_df[[cc]]$ct1) & 
                                                                          inter_df[[cc]]$gn1 %in% genes_list[[cc]]])))
    
     # only genes varying along pseudospace
    if(n=="Hepatocytes"){
      var_genes = names(hep_qvals[[cc]])[hep_qvals[[cc]]<=0.05]
      dfinterzon = merge(dfinterzon, data.frame(hep_h_max), by.x = 3, by.y = 0, all.x = T) # add maximums
      dfinterzon = merge(dfinterzon, data.frame(hep_h_sdmax), by.x = 1, by.y = 0, all.x = T) # add se
      dfinterzon = merge(dfinterzon, data.frame("range" = apply(hep_fits[[cc]], 2, function(x) diff(range(x)))), 
                         by.x = 1, by.y = 0, all.x = T) # add expression range
    } else{
      var_genes = names(end_qvals[[cc]])[end_qvals[[cc]]<=0.05]
      dfinterzon = merge(dfinterzon, data.frame(end_h_max), by.x = 3, by.y = 0, all.x = T) # add maximums
      dfinterzon = merge(dfinterzon, data.frame(end_h_sdmax), by.x = 1, by.y = 0, all.x = T) # add se
      dfinterzon = merge(dfinterzon, data.frame("range" = apply(end_fits[[cc]], 2, function(x) diff(range(x)))), 
                         by.x = 1, by.y = 0, all.x = T) # add expression range
    }
    colnames(dfinterzon)[6:7] = c("max_zon", "max_se")
    
    # only keep genes that
    ## are not in hepatocytes (i.e. are the genes in the other cell type)
    ## have a low se for the max (meaning the maximum is well defined)
    ## have an expression range of at least 0.1 (excludes lowly expressed, barely varying genes)
    ## the genes in the hepatocytes have to be varying
    ## additionally we only count each interaction once, because of the complexes
    plot_df = unique(dfinterzon[!grepl(zon_ct[n], dfinterzon$cell_type) & dfinterzon$max_se<=5 & 
                                  dfinterzon$range>=0.1 & dfinterzon$gene_zon %in% var_genes,-c(1,3)])
    plot_df$cell_type = factor(plot_df$cell_type, levels = unique(plot_df$cell_type)[order(unique(plot_df$cell_type), decreasing = F)])
    
    zonation_alldat[[n]][[cc]] = dfinterzon
    zonation_filt[[n]][[cc]] = plot_df
  }
}
```



```{r}
allcond_hep_zon = Reduce(function(x,y) merge(x,y, by = c(1,2), all = T), 
                         lapply(zonation_filt$Hepatocytes, function(x) x[,c(1,2,4)]))
allcond_hep_zon_cc = allcond_hep_zon[complete.cases(allcond_hep_zon),]
ggplot(allcond_hep_zon_cc, aes(x = max_zon.x, y = max_zon, colour = cell_type))+
  geom_jitter(width = 2, height = 2)+
  labs(x = "interactions in healthy zonation", y = "interactions in regen zonation")+
  theme_bw()

allcond_lsec_zon = Reduce(function(x,y) merge(x,y, by = c(1,2), all = T), 
                         lapply(zonation_filt$LSEC, function(x) x[,c(1,2,4)]))
allcond_lsec_zon_cc = allcond_lsec_zon[complete.cases(allcond_lsec_zon),]
allcond_lsec_zon_cc$hr = allcond_lsec_zon_cc$max_zon.x-allcond_lsec_zon_cc$max_zon
allcond_lsec_zon_cc$he = allcond_lsec_zon_cc$max_zon.x-allcond_lsec_zon_cc$max_zon.y

ggplot(allcond_lsec_zon_cc, aes(x = max_zon.x, y = max_zon, colour = cell_type))+
  geom_jitter(width = 2, height = 2)+
  labs(x = "interactions in healthy zonation", y = "interactions in regen zonation")+
  theme_bw()
```



```{r}
all_inter = unique(rbind(inter_df$healthy[,c(1,4:7)],inter_df$embolised[,c(1,4:7)],inter_df$regenerating[,c(1,4:7)]))


```




```{r, fig.height=2, fig.width=3.5}
plt_list = list()
count_pos_lists = list()
for(n in names(zonation_filt)){
  count_pos_list = list()
  for(cc in unique(names(zonation_filt[[n]]))){
    count_pos = Reduce(cbind, tapply(as.factor(zonation_filt[[n]][[cc]]$max_zon), 
                                     zonation_filt[[n]][[cc]]$cell_type, 
                                     function(x) data.frame(table(x))))
    rownames(count_pos) = count_pos[,1]
    count_pos = count_pos[,-seq(3,29,2)]
    colnames(count_pos) = c("max_pos", levels(zonation_filt[[n]][[cc]]$cell_type))
    count_pos = count_pos[,c(1, hclust(dist(t(count_pos[,-1])), method="ward.D2")$order+1)]
    count_pos = reshape2::melt(count_pos)
    count_pos$max_pos = as.numeric(as.character(count_pos$max_pos))
    count_pos$cond = cc
    count_pos_list[[cc]] = count_pos
  }
  count_pos_all = Reduce(rbind, count_pos_list)
  
  count_pos_lists[[n]] = count_pos_list
  
  for(cc in names(count_pos_list)){
    plt_list[[paste0(n, "_", cc)]] = ggplot(count_pos_list[[cc]], 
                                            aes(x = max_pos, y = variable, size = value, colour = value))+
      geom_point()+
      #scale_colour_continuous(breaks = c(0,5,10,15,20), limits = c(0,20))+
      #scale_size_continuous(breaks = c(0,5,10,15,20), limits = c(0,20))+
      guides(colour = guide_legend(reverse = T), size = guide_legend(reverse = T))+
      labs(x = "zonation", y = "Cell Type", 
           colour = "# interactions", size = "# interactions")+
      theme_bw()
  }
}
```



```{r}
plt = ggplot(zonation_filt$Hepatocytes$healthy, aes(x = max_zon, y = cell_type, fill = cell_type))+
  geom_density_ridges(alpha = 0.2)+
  scale_x_continuous(limits = c(0,100))+
  theme_bw()+
  theme(legend.position = "none")


abc = reshape2::acast(formula=cell_type~interact, data = plot_df)
abcd = (abc>0) %*% t(abc>0)

plot(mean_bins_h[,"VEGFA"], pch = 19, cex = 0.85)
plot(hep_fits$healthy[,"PROS1"], pch = 19, cex = 0.85)
```



```{r}
plt = ggplot(plot_df, aes(x = end_h_max, colour = cell_type))+
  geom_density()+
  scale_x_continuous(limits = c(0,100))+
  theme_bw()

ggplot(plot_df, aes(x = cell_type, y = end_h_max, colour = cell_type))+
     ggbeeswarm::geom_beeswarm()+
     scale_y_continuous(limits = c(0,100))+
     theme_bw()


abc = reshape2::acast(formula=cell_type~interact, data = plot_df)
abcd = (abc>0) %*% t(abc>0)

par(mfrow = c(2,2))
plot(end_fits$healthy[,"FLT1"], pch = 19, cex = 0.85)
plot(mean_bins_h[,"FLT1"], pch = 19, cex = 0.85)
plot(end_cells$healthy$zonation_pt,end_cells$healthy@assays$SCT@data["FLT1",])
plot(density(end_cells$healthy$zonation_pt[end_cells$healthy@assays$SCT@data["FLT1",]==0]))
```














```{r}
inter_df = readRDS(file = "results/cell_comm/interaction_de_unique_HvR.RDS")
inter_hr = rbind(inter_df$healthy[,1:9], inter_df$regenerating[,1:9])
inter_hr$cond = c(rep("healthy", nrow(inter_df$healthy)),
                  rep("regenerating", nrow(inter_df$regenerating)))
inter_hr = inter_hr[grepl("LSEC_", inter_hr$ct1) | grepl("Hepa", inter_hr$ct1) |
                      grepl("LSEC_", inter_hr$ct2) | grepl("Hepa", inter_hr$ct2), ]

inter_diff = inter_hr[inter_hr$ct1!=inter_hr$ct2,]
```


```{r, fig.height=5, fig.width=5.2}
hep_genes_h_0 = unique(c(as.character(inter_diff$gn1)[grepl("Hepa", inter_diff$ct1) &
                                                      inter_diff$cond=="healthy"],
                         as.character(inter_diff$gn2)[grepl("Hepa", inter_diff$ct2) &
                                                      inter_diff$cond=="healthy"]))
hep_genes_r_0 = unique(c(as.character(inter_diff$gn1)[grepl("Hepa", inter_diff$ct1) &
                                                      inter_diff$cond=="regenerating"],
                         as.character(inter_diff$gn2)[grepl("Hepa", inter_diff$ct2) &
                                                      inter_diff$cond=="regenerating"]))

nbins = 100
df_h = data.table("zonation_pt" = hep_traj$healthy)
df_h$zonation_int = cut(df_h$zonation_pt, nbins)

df_r = data.table("zonation_pt" = hep_traj$regenerating)
df_r = df_h[df_r, on="zonation_pt", roll=Inf, rollends = T]

mean_bins_h = apply(hep_cells$healthy@assays$SCT@data, 1, 
                    function(x) tapply(x, df_h$zonation_int, mean))
mean_bins_r = apply(hep_cells$regenerating@assays$SCT@data, 1, 
                    function(x) tapply(x, df_r$zonation_int, mean))

hep_h_max = apply(mean_bins_h, 2, function(x) mean(order(x, decreasing = T)[1:10]))
hep_r_max = apply(mean_bins_r, 2, function(x) mean(order(x, decreasing = T)[1:10]))

xxx = data.frame(row.names = hep_genes_h_0, "h" = hep_h_max[hep_genes_h_0], 
                 "r" = hep_r_max[hep_genes_h_0])
xxx = xxx[complete.cases(xxx),]
ggplot(xxx, aes(x = h, y = r))+geom_hex()+theme_bw()+theme(aspect.ratio = 1)
cor(xxx)

par(mfrow = c(2,2))
plot(mean_bins_h[,"COL18A1"], pch = 19, cex = 0.85)
plot(mean_bins_r[,"COL18A1"], pch = 19, cex = 0.85)
plot(hep_fits$healthy[,"COL18A1"], pch = 19, cex = 0.85)
plot(hep_fits$regenerating[,"COL18A1"], pch = 19, cex = 0.85)
```

```{r, fig.height=5, fig.width=5.2}
end_genes_h = unique(c(as.character(inter_diff$gn1)[grepl("LSEC_", inter_diff$ct1) &
                                                        inter_hr$cond=="healthy"],
                         as.character(inter_diff$gn2)[grepl("LSEC_", inter_diff$ct2) &
                                                        inter_diff$cond=="healthy"]))
end_genes_r = unique(c(as.character(inter_diff$gn1)[grepl("LSEC_", inter_diff$ct1) &
                                                      inter_hr$cond=="regenerating"],
                       as.character(inter_diff$gn2)[grepl("LSEC_", inter_diff$ct2) &
                                                      inter_diff$cond=="regenerating"]))

nbins = 100
df_h = data.table("zonation_pt" = end_traj$healthy)
df_h$zonation_int = cut(df_h$zonation_pt, nbins)

df_r = data.table("zonation_pt" = end_traj$regenerating)
df_r = df_h[df_r, on="zonation_pt", roll=Inf, rollends = T]

end_mean_bins_h = apply(end_cells$healthy@assays$SCT@data, 1, 
                    function(x) tapply(x, df_h$zonation_int, mean))
end_mean_bins_r = apply(end_cells$regenerating@assays$SCT@data, 1, 
                    function(x) tapply(x, df_r$zonation_int, mean))

end_h_max = apply(end_mean_bins_h, 2, function(x) mean(order(x, decreasing = T)[1:10]))
end_r_max = apply(end_mean_bins_r, 2, function(x) mean(order(x, decreasing = T)[1:10]))

xxx = data.frame(row.names = end_genes_h, "h" = end_h_max[end_genes_h], 
                 "r" = end_r_max[end_genes_h])
xxx = xxx[complete.cases(xxx),]
ggplot(xxx, aes(x = h, y = r))+geom_hex()+theme_bw()+theme(aspect.ratio = 1)
cor(xxx)

par(mfrow = c(2,2))
plot(end_mean_bins_h[,"PECAM1"], pch = 19, cex = 0.85)
plot(end_mean_bins_r[,"PECAM1"], pch = 19, cex = 0.85)
plot(end_fits$healthy[,"PECAM1"], pch = 19, cex = 0.85)
plot(end_fits$regenerating[,"PECAM1"], pch = 19, cex = 0.85)
```



```{r}
ct1 = inter_diff[grepl("Hepa", inter_diff$ct1),
                 c("gn1", "ct2")]
ct2 = inter_diff[grepl("Hepa", inter_diff$ct2),
                 c("gn2", "ct1")]
ct = unique(rbind(as.matrix(ct1), as.matrix(ct2)))

ctg = merge(xxx, ct, by.x = 0, by.y = 1)

ggplot(ctg, aes(x = h, y = r))+geom_hex()+theme_bw()+theme(aspect.ratio = 1)
ggplot(ctg, aes(x = ct2, y = h, fill = ct2))+
  geom_boxplot()+
  theme_bw()+theme(aspect.ratio = 1)


ct1 = inter_diff[grepl("LSEC_", inter_diff$ct1),
                 c("gn1", "ct2")]
ct2 = inter_diff[grepl("LSEC_", inter_diff$ct2),
                 c("gn2", "ct1")]
ct = unique(rbind(as.matrix(ct1), as.matrix(ct2)))

ctg = merge(xxx, ct, by.x = 0, by.y = 1)

ggplot(ctg, aes(x = h, y = r))+geom_hex()+theme_bw()+theme(aspect.ratio = 1)
ggplot(ctg, aes(x = ct2, y = h, fill = ct2))+
  geom_boxplot()+
  theme_bw()+theme(aspect.ratio = 1)
```



```{r}
library(org.Hs.eg.db)
terms_list = c("extracellular matrix" = "GO:0031012", "chemokine activity" = "GO:0008009", 
               "cytokine activity" = "GO:0005125", "multicellular organism development" = "GO:0007275")
g_path = mget(terms_list, org.Hs.egGO2ALLEGS)
refsymbol = org.Hs.egSYMBOL
g_path = lapply(g_path, function(x) unlist(as.list(refsymbol[x])))
names(g_path) = names(terms_list)

g_path_df = data.frame("gene" = unlist(g_path),
                       "terms" = unlist(lapply(names(g_path), 
                                               function(x) rep(x, length(g_path[[x]])))),
                       stringsAsFactors = F)
g_path_df = g_path_df[!duplicated(g_path_df$gene),]
xxx = merge(inter_df$healthy, g_path_df, by.x = "gn1", by.y = "gene", all.x = T)
xxx = merge(xxx, g_path_df, by.x = "gn2", by.y = "gene", all.x = T)[,c(3:6,2,7,1,8:17)]
```



Calculate mutual information for total interactions

```{r, fig.height=6, fig.width=6.2}
mut_info_list = list()
for(n in names(scoring_mats)){
  mi_mat = matrix(0, nrow = ncol(scoring_mats[[n]]$mat_lig_ct), ncol = ncol(scoring_mats[[n]]$mat_rec_ct))
  rownames(mi_mat) = colnames(mi_mat) = colnames(scoring_mats[[n]]$mat_lig_ct)
  for(ct1 in colnames(scoring_mats[[n]]$mat_lig_ct)){
    for(ct2 in colnames(scoring_mats[[n]]$mat_rec_ct)){
      df = cbind(scoring_mats[[n]]$mat_lig_ct[,ct1], scoring_mats[[n]]$mat_rec_ct[,ct2])
      df = df[complete.cases(df),]
      norm_mi = mpmi::cmi(df)$mi[1,2] / sqrt(entropy::entropy(df[,1]) * entropy::entropy(df[,2]))
      mi_mat[ct1, ct2] = norm_mi
    }
  }
  m = data.frame(inter_counts_l[[n]], check.names = F)
  m$r = rownames(m)
  m = reshape2::melt(m)
  mi_mat = reshape2::melt(mi_mat)
  
  mut_info_list[[n]] = merge(mi_mat, m, by = c(1,2))
  colnames(mut_info_list[[n]]) = c("source", "target", "mi", "n")
}
saveRDS(mut_info_list, file = "results/cell_comm/mut_info_list.RDS")
```

Calculate mutual information for directed interactions

```{r, fig.height=6, fig.width=6.2}
mut_info_dir_list = list()
for(n in names(scoring_mats_dir)){
  mi_mat = matrix(0, nrow = ncol(scoring_mats_dir[[n]]$mat_lig_ct), 
                  ncol = ncol(scoring_mats_dir[[n]]$mat_rec_ct))
  rownames(mi_mat) = colnames(mi_mat) = colnames(scoring_mats_dir[[n]]$mat_lig_ct)
  for(ct1 in colnames(scoring_mats_dir[[n]]$mat_lig_ct)){
    for(ct2 in colnames(scoring_mats_dir[[n]]$mat_rec_ct)){
      df = cbind(scoring_mats_dir[[n]]$mat_lig_ct[,ct1], scoring_mats_dir[[n]]$mat_rec_ct[,ct2])
      df = df[complete.cases(df),]
      if(nrow(df)==0){
        mi_mat[ct1, ct2] = 0
        next
      }
      norm_mi = mpmi::cmi(df)$mi[1,2] / sqrt(entropy::entropy(df[,1]) * entropy::entropy(df[,2]))
      mi_mat[ct1, ct2] = norm_mi
    }
  }
  mi_mat[mi_mat<0] = 0 # some values are negative because of the adjustment
  
  mut_info_dir_list[[n]] = mi_mat
  
  m = data.frame(inter_counts_dir[[n]]$`1`, check.names = F)
  m$r = rownames(m)
  m = reshape2::melt(m)
  mi_mat = reshape2::melt(mi_mat)
  
  mut_info_dir_list[[n]] = merge(mi_mat, m, by = c(1,2))
  colnames(mut_info_dir_list[[n]]) = c("source", "target", "mi", "n")
}
saveRDS(mut_info_dir_list, file = "results/cell_comm/mut_info_dir_list.RDS")
```


Counting the proportion of cell types per condition

```{r}
for(n in names(meta_l)){
  meta_l[[n]]$Donor = allcells_css@meta.data[as.character(meta_l[[n]]$Cell), "Donor"]
  meta_l[[n]]$Condition = allcells_css@meta.data[as.character(meta_l[[n]]$Cell), "Condition"]
}
meta_all = Reduce(rbind, meta_l[1:3])

counts_cond = list()
for(cc in c("healthy", "embolised", "regenerating")){
  counts_cond[[cc]] = table(meta_all$cell_type[meta_all$Condition==cc],
                      meta_all$Donor[meta_all$Condition==cc])
  counts_cond[[cc]] = reshape2::melt(data.frame("cell_type" = rownames(counts_cond[[cc]]),
                           apply(counts_cond[[cc]], 2, function(x) x/sum(x))))
}
counts_cond = Reduce(rbind, counts_cond)
counts_cond$cond = c(rep("healthy", 54), rep(c("embolised", "regenerating"), each = 108))
counts_cond$cond = factor(counts_cond$cond, levels = c("healthy", "embolised", "regenerating"))

ggplot(counts_cond, aes(x = cond, y = value))+
  facet_wrap(~cell_type, scale = "free")+
  geom_line(mapping = aes(group = variable), colour = "grey85")+
  geom_point()+
  stat_summary(mapping = aes(group = cond, colour = cond), fun.data = "mean_se")+
  labs(x = "Condition", y = "Cell Type frequency")+
  theme_bw()
```

---
title: "Data Integration"
output: html_notebook
---



# General Setup
Setup chunk

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8)
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_knit$get("root.dir")
```

Setup reticulate

```{r}
library(reticulate)
knitr::knit_engines$set(python = reticulate::eng_python)
py_available(initialize = FALSE)
use_python(Sys.which("python"))
py_config()
```

Load libraries

```{r}
library(Seurat)
library(ggplot2)
library(ggridges)
library(mixtools)
library(dplyr)
library(SoupX)
library(harmony)
```



# Load data
Load prepared Seurat objects

```{r}
load(file = "data/processed/healthy_srat.RData")
load(file = "data/processed/cond_srat.RData")
load(file = "data/processed/frozen_srat.RData")
```



# Individual analysis
Analysing each dataset individually is important to understand what each contains  
Re-run scTransform, PCA, and nearest-neighbours on filtered data

```{r}
basicSeurat2 = function(obj, npcs = 60){
  # normalise and PCA-UMAP
  obj = suppressWarnings(SCTransform(obj, do.correct.umi = T, verbose = F,
                                     vars.to.regress = "nCount_RNA",
                                     variable.features.rv.th = 1, 
                                     return.only.var.genes = F,
                                     variable.features.n = NULL, seed.use = 1))
  obj = RunPCA(obj, npcs = npcs, verbose = F)
  return(obj)
}

healthy_srat = lapply(healthy_srat, basicSeurat2)
cond_srat = lapply(cond_srat, basicSeurat2)
frozen_srat = lapply(frozen_srat, basicSeurat2)

healthy_elb = lapply(names(healthy_srat), 
                     function(x) ElbowPlot(healthy_srat[[x]], ndims = 50)+labs(title=x))
cond_elb = lapply(names(cond_srat), 
                     function(x) ElbowPlot(cond_srat[[x]], ndims = 50)+labs(title=x))
frozen_elb = lapply(names(frozen_srat), 
                     function(x) ElbowPlot(frozen_srat[[x]], ndims = 50)+labs(title=x))

pdf("results/clust_indiv/healthy_elbowplot.pdf", 
    height = 10, width = 8, useDingbats = F)
cowplot::plot_grid(plotlist = healthy_elb, nrow = 4, ncol = 2)
dev.off()

pdf("results/clust_indiv/cond_elbowplot.pdf", 
    height = 16, width = 16, useDingbats = F)
cowplot::plot_grid(plotlist = cond_elb, nrow = 7, ncol = 4)
dev.off()

pdf("results/clust_indiv/frozen_elbowplot.pdf", 
    height = 6, width = 6, useDingbats = F)
cowplot::plot_grid(plotlist = frozen_elb, nrow = 2, ncol = 2)
dev.off()
```

Check association of number of UMI and genes with PCA

```{r}
getPCcor = function(l){
  df_cor = data.frame("PC" = "A", "sample" = "A", "cor_gene" = 0, "cor_umi" = 0)
  for(n in names(l)){
    cor_gene = cor(l[[n]]$nFeature_RNA,
                   l[[n]]@reductions$pca@cell.embeddings)
    cor_umi = cor(l[[n]]$nCount_RNA,
                  l[[n]]@reductions$pca@cell.embeddings)
    df_cor = rbind(df_cor, data.frame("PC" = colnames(cor_gene),
                                      "sample" = n,
                                      "cor_gene" = cor_gene[1,],
                                      "cor_umi" = cor_umi[1,]))
  }
  df_cor = df_cor[-1,]
  df_cor$PC = factor(df_cor$PC, levels = paste0("PC_", 1:60))
  
  return(df_cor)
}
plotCors = function(df, var = "cor_gene", ncol = 7){
  plt = ggplot(df[df$PC %in% paste0("PC_", 1:50),], 
               aes_string(x = "PC", y = var))+
    facet_wrap(~sample, ncol = ncol)+
    geom_point(size = 0.8)+
    scale_y_continuous(labels = round(seq(-.6,.6,.2), 1), breaks = seq(-.6,.6,.2),
                       limits = c(-.65, .65))+
    theme_bw()+
    theme(axis.text.x = element_blank())
  
  return(plt)
}

df_cor_healthy = getPCcor(healthy_srat)
df_cor_cond = getPCcor(cond_srat)
df_cor_frozen = getPCcor(frozen_srat)

pdf("results/clust_indiv/healthy_pc_corNgenes.pdf", 
    height = 4, width = 7, useDingbats = F)
plotCors(df_cor_healthy, ncol = 4)
dev.off()

pdf("results/clust_indiv/cond_pc_corNgenes.pdf", 
    height = 9, width = 15, useDingbats = F)
plotCors(df_cor_cond)
dev.off()

pdf("results/clust_indiv/frozen_pc_corNgenes.pdf", 
    height = 2.5, width = 6, useDingbats = F)
plotCors(df_cor_frozen, ncol = 3)
dev.off()
```

Define number of PCs for each dataset (based on the elbow plot and data exploration)

```{r}
healthy_npcs = ifelse(grepl("hep", tolower(names(healthy_srat))), 15, 25)
names(healthy_npcs) = names(healthy_srat)

cond_npcs = c("sc_E1.HEP.Exp2" = 25, "sc_R1.HEP.Exp2" = 20, "sc_E5.HEP.Exp1" = 15,
              "sc_R5.HEP.Exp1" = 22, "sc_E5.NPC.Exp1" = 25, "sc_R5.NPC.Exp1" = 30,
              "sc_E6.HEP.Exp1" = 15, "sc_R6.HEP.Exp1" = 25, "sc_E6.NPC.Exp1" = 25,
              "sc_R6.NPC.Exp1" = 20, "sc_E7.HEP.Exp1" = 15, "sc_R7.HEP.Exp1" = 15,
              "sc_E7.NPC.Exp1" = 25, "sc_R7.NPC.Exp1" = 25, "sc_E1.HEP.Exp1" = 15, 
              "sc_R1.HEP.Exp1" = 20, "sc_E3.HEP.Exp1" = 15,
              "sc_E2.HEP.Exp1" = 20, "sc_R2.HEP.Exp1" = 20, "sc_R3.HEP.Exp1" = 15, 
              "sc_E3.NPC.Exp1" = 20, "sc_E2.NPC.Exp1" = 25, "sc_R2.NPC.Exp1" = 25,
              "sc_R3.NPC.Exp1" = 25, "sc_E1.NPC.Exp1" = 25, "sc_R1.NPC.Exp1" = 25)

frozen_npcs = rep(20, 3)
names(frozen_npcs) = names(frozen_srat)
```

Run FindNeighbors, UMAP, and FindClusters

```{r}
runSeuratClust = function(obj, npcs){
  obj = FindNeighbors(obj, dims = 1:npcs, force.recalc = T, verbose = F)
  obj = RunUMAP(obj, dims = 1:npcs, verbose = F)
  # resolution 10 is included to update the "very fine" clustering done in QC
  obj = FindClusters(obj, algorithm = 2, verbose = F, 
                     resolution = c(0.2, 0.5, seq(0.7, 1.1, 0.1), 1.5, 2, 10))
  
  return(obj)
}

for(n in names(healthy_srat)){
  healthy_srat[[n]] = runSeuratClust(healthy_srat[[n]], healthy_npcs[n])
}
for(n in names(cond_srat)){
  cond_srat[[n]] = runSeuratClust(cond_srat[[n]], cond_npcs[n])
}
for(n in names(frozen_srat)){
  frozen_srat[[n]] = runSeuratClust(frozen_srat[[n]], frozen_npcs[n])
}
```

Plot all resolutions on UMAP

```{r}
plotUMAPDim = function(obj, s){
  plt_list = list()
  cl_names = colnames(obj@meta.data)[grepl("SCT_snn", colnames(obj@meta.data))][-1]
  # doesn't include res = 10
  for(cl in cl_names){
  plt_list[[cl]] = DimPlot(object = obj, reduction = "umap",
                           group.by = cl, pt.size = 0.7)+
    labs(title = s, subtitle = cl)+
    theme(aspect.ratio = 1,
          title = element_text(size = 9),
          legend.position = "right")
  }
  
  plt = cowplot::plot_grid(plotlist = plt_list, ncol = 3, nrow = 3)
  return(plt)
}

for(n in names(healthy_srat)){
  pdf(paste0("results/clust_indiv/clustExp_UMAP/healthy_", n, "_clustExp_UMAP.pdf"), 
      height = 15, width = 16, useDingbats = F)
  print(plotUMAPDim(healthy_srat[[n]], n))
  dev.off()
}

for(n in names(cond_srat)){
  pdf(paste0("results/clust_indiv/clustExp_UMAP/cond_", n, "_clustExp_UMAP.pdf"), 
      height = 15, width = 16, useDingbats = F)
  print(plotUMAPDim(cond_srat[[n]], n))
  dev.off()
}

for(n in names(frozen_srat)){
  pdf(paste0("results/clust_indiv/clustExp_UMAP/frozen_", n, "_clustExp_UMAP.pdf"), 
      height = 15, width = 16, useDingbats = F)
  print(plotUMAPDim(frozen_srat[[n]], n))
  dev.off()
}
```

Choose the best resolution for each sample

```{r}
healthy_cl_use = c("sc_H1.EKS.Exp1" = 0.7, "sc_H2.HEP.Exp1" = 0.7, "sc_H3.HEP.Exp1" = 0.5,
                   "sc_H1.HEP.Exp1" = 0.5,"sc_H2.NPC.Exp1" = 0.7, "sc_H3.NPC.Exp1" = 0.5,
                   "sc_H1.NPC.Exp1" = 0.7)
cond_cl_use = c("sc_E5.HEP.Exp1" = 0.5, "sc_R5.HEP.Exp1" = 0.5, "sc_E5.NPC.Exp1" = 0.7,
                "sc_R5.NPC.Exp1" = 0.5, "sc_E6.HEP.Exp1" = 0.7, "sc_R6.HEP.Exp1" = 0.5,
                "sc_E6.NPC.Exp1" = 0.7, "sc_R6.NPC.Exp1" = 0.5, "sc_E7.HEP.Exp1" = 0.5,
                "sc_R7.HEP.Exp1" = 0.5, "sc_E7.NPC.Exp1" = 0.8, "sc_R7.NPC.Exp1" = 0.5,
                "sc_E1.HEP.Exp1" = 0.5, "sc_R1.HEP.Exp1" = 0.5, "sc_E3.HEP.Exp1" = 0.5,
                "sc_E2.HEP.Exp1" = 0.5, "sc_R2.HEP.Exp1" = 0.5, "sc_R3.HEP.Exp1" = 0.5,
                "sc_E3.NPC.Exp1" = 0.9, "sc_E2.NPC.Exp1" = 0.5, "sc_R2.NPC.Exp1" = 0.5,
                "sc_R3.NPC.Exp1" = 0.5, "sc_E1.NPC.Exp1" = 0.5, "sc_R1.NPC.Exp1" = 0.7,
                "sc_E1.HEP.Exp2" = 0.5, "sc_R1.HEP.Exp2" = 0.5)
frozen_cl_use = c("sn_H1.all.Exp1" = 0.8, "sn_H3.all.Exp1" = 0.9, "sn_H4.all.Exp1" = 0.7)
```

Get markers for those clusters. Will also be comparing FindMarkers with quickMarkers
(this whole block takes approx. 10h)

```{r}
getMarkersComp = function(l, v_cl){
  for(n in names(v_cl)){
    cat(paste0(n, " "))
    name_cl = paste0("SCT_snn_res.", v_cl[n])
    l[[n]] = SetIdent(l[[n]], value = name_cl)
    
    seurat_mk = FindAllMarkers(l[[n]], test.use = "wilcox", 
                               pseudocount.use = 0.1, logfc.threshold = 0.2, verbose = F)
    write.csv(seurat_mk, file = paste0("results/clust_indiv/clustExp_markers/", 
                                       n, "_", name_cl, "_wilcoxMarkers.csv"), 
              col.names = T, row.names = T, quote = F)
    
    soupx_mk = quickMarkers(l[[n]]@assays$SCT@counts,
                            l[[n]]@meta.data[,name_cl],
                            N = 300, FDR = 0.05)
    write.csv(soupx_mk, file = paste0("results/clust_indiv/clustExp_markers/", 
                                       n, "_", name_cl, "_tfidfMarkers.csv"), 
              col.names = T, row.names = T, quote = F)
  }
}

getMarkersComp(healthy_srat, healthy_cl_use)
getMarkersComp(cond_srat, cond_cl_use)
getMarkersComp(frozen_srat, frozen_cl_use)
```

## Saving final objects
Save objects

```{r}
save(healthy_srat, file = "data/processed/healthy_srat_indivclust.RData")
save(cond_srat, file = "data/processed/cond_srat_indivclust.RData")
save(frozen_srat, file = "data/processed/frozen_srat_indivclust.RData")
```



# Integrate datasets
Integration of large sets of data will be done in batch jobs given the time it takes to run. 

## Integrate healthy datasets
Integrate all cell datasets using different methods, using batch scripts 

Seurat Anchors rPCA
  - Script: `run_SeuratIntegrationRPCA_allhealthy.R`
  - Output: `data/processed/scripts_out/SeuratIntegrRPCA_allhealthy.RDS`
  
Harmony
  - Script: `run_HarmonyIntegration_allhealthy.R`
  - Output: `data/processed/scripts_out/HarmIntegr_allhealthy.RDS`



### Examine Harmony output
Load data

```{r}
hcells_harm = readRDS("data/processed/scripts_out/HarmIntegr_allhealthy.RDS")
```

Checking how using different numbers of dimensions affects UMAP structure

```{r}
plt10 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:10")
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:20, verbose = F)
plt20 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:20")
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:25, verbose = F)
plt25 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:25")
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:30, verbose = F)
plt30 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:30")
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:40, verbose = F)
plt40 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:40")
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:50, verbose = F)
plt50 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:50")

png("results/integr_healthy/harmony_umap_dims.png", width = 1200, height = 600)
cowplot::plot_grid(plt10, plt20, plt25, plt30, plt40, plt50, ncol = 3, nrow = 2, align = "h")
dev.off()
```

Run UMAP with chosen number of dimensions

```{r}
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:25, verbose = F)
DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, group.by = "Fraction")
```

How do the different fractions and donors split in the UMAP

```{r}
png("results/integr_healthy/harmony_umap50_FracDonor.png", width = 900, height = 300)
DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
        split = "Fraction", group.by = "Name")
dev.off()
```

Plotting general markers

```{r}
png("results/integr_healthy/harmony_umap50_genMarkers.png", width = 960, height = 900)
FeaturePlot(hcells_harm, reduction = "umap", pt.size = 0.2,
            features = c("FGA", "PTPRC", "ANXA4", "CD34", "EPCAM", "C1QB",
                         "JCHAIN", "APOA1", "nFeature_RNA"))
dev.off()
```

Cluster harmony results

```{r}
hcells_harm = FindNeighbors(hcells_harm, reduction = "harmony", dims = 1:25, force.recalc = T)
hcells_harm = FindClusters(hcells_harm, algorithm = 2, verbose = F,
                           resolution = seq(0.2, 1.1, 0.1))
DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, label = T,
        group.by = "SCT_snn_res.0.9")
```

Harmony seems to put a lot more cells from the HEP fractions together with the NPC fractions. To understand where these cells come from, and whether the same effect can be seen in the Seurat integration, we'll be checking the individual samples and take note which ones would be originally hepatocytes
Load data (if necessary)

```{r}
load(file = "data/processed/healthy_srat_indivclust.RData")
```

For HEP samples, identify cells belonging to the hepatocyte cluster. This is important to understand the merging between fractions

```{r}
healthy_cl_use = c("sc_H1.EKS.Exp1" = 0.7, "sc_H2.HEP.Exp1" = 0.7, "sc_H3.HEP.Exp1" = 0.5,
                   "sc_H1.HEP.Exp1" = 0.5,"sc_H2.NPC.Exp1" = 0.7, "sc_H3.NPC.Exp1" = 0.5,
                   "sc_H1.NPC.Exp1" = 0.7)
cl_hep = list(c(3), c(0:7), c(0:5), c(0:5, 8, 10), c(8), c(6), c(8))
names(cl_hep) = names(healthy_cl_use)

DimPlot(healthy_srat$sc_H2.HEP.Exp1, reduction = "umap", 
        group.by = "SCT_snn_res.0.7", label = T)
#FeaturePlot(healthy_srat$sc_H1.NPC.Exp1, reduction = "umap", features = "FGA")

cells_nothep = list()
for(n in names(cl_hep)){
  cl = paste0("SCT_snn_res.", healthy_cl_use[n])
  ishep = healthy_srat[[n]]@meta.data[,cl] %in% cl_hep[[n]]
  cells_nothep[[n]] = paste0(n, "_", rownames(healthy_srat[[n]]@meta.data)[!ishep])
}
```

Check where non-hepatocytes are

```{r}
df_nothep = data.frame(row.names = colnames(hcells_harm),
                       "nothep" = colnames(hcells_harm) %in% unlist(cells_nothep))

hcells_harm = AddMetaData(hcells_harm, df_nothep)

DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, label = F,
        group.by = "nothep", split = "Fraction")+geom_hline(yintercept = 3, linetype = "dashed")
```

Lets now examine the cells that are not grouped with the large hepatocyte cluster

```{r}
lower_cells = rownames(hcells_harm@reductions$umap@cell.embeddings)[hcells_harm@reductions$umap@cell.embeddings[,2]<3]

df_lower = data.frame(row.names = colnames(hcells_harm),
                      "lowercells" = colnames(hcells_harm) %in% lower_cells)
df_lower$ds = unlist(lapply(strsplit(rownames(df_lower), "_", fixed = T), 
                            function(x) paste0(x[1:2], collapse = "_")))
n = "sc_H2.HEP.Exp1"
df_lower = df_lower[df_lower$ds==n,]
rownames(df_lower) = unlist(lapply(strsplit(rownames(df_lower), "_"), function(x) x[3]))
test = AddMetaData(healthy_srat[[n]], df_lower)
DimPlot(test, reduction = "umap", pt.size = 0.2, label = F,
        group.by = "lowercells")
```

As can be seen, these cells still come from the hepatocyte cluster. A look at the markers from the corresponding clusters also revealed hepatocyte genes. In sum, this means that harmony is failing at least some of the integration  
Lets see if the same effect can be seen with the Seurat integration. Load data

```{r}
hcells_rpca = readRDS("data/processed/scripts_out/SeuratIntegrRPCA_allhealthy.RDS")
```

Look at fraction distribution

```{r}
DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
        split = "Fraction", group.by = "Name")
```

Look at how the hepatocytes are distributed

```{r}
cc = unlist(cells_nothep)
for(x in 1:length(cc)){
  nn = paste0(unlist(strsplit(cc[x], "_", fixed = T))[1:2], collapse = "_")
  cell = unlist(strsplit(cc[x], "_", fixed = T))[3]
  cc[x] = paste0(cell, "_", which(names(healthy_srat)==nn))
}
df_nothep = data.frame(row.names = colnames(hcells_rpca),
                       "nothep" = colnames(hcells_rpca) %in% cc)

hcells_rpca = AddMetaData(hcells_rpca, df_nothep)

DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, label = F,
        group.by = "nothep", split = "Fraction")
```

And the non-hepatocyte cells in the harmony integration

```{r}
cc = unlist(lower_cells)
for(x in 1:length(cc)){
  nn = paste0(unlist(strsplit(cc[x], "_", fixed = T))[1:2], collapse = "_")
  cell = unlist(strsplit(cc[x], "_", fixed = T))[3]
  cc[x] = paste0(cell, "_", which(names(healthy_srat)==nn))
}
df_nothep = data.frame(row.names = colnames(hcells_rpca),
                       "lowercells" = colnames(hcells_rpca) %in% cc)

hcells_rpca = AddMetaData(hcells_rpca, df_nothep)

DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, label = F,
        group.by = "lowercells", split = "Fraction")
```

So we can see that those cells are separate, but still close to the large hepatocyte cluster, which should make this a better integration.



### Examine Seurat output
Load data

```{r}
hcells_rpca = readRDS("data/processed/scripts_out/SeuratIntegrRPCA_allhealthy.RDS")
```

Checking how using different numbers of dimensions affects UMAP structure

```{r}
hcells_rpca = RunUMAP(hcells_rpca, dims = 1:30, verbose = F)
plt30 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:30")

hcells_rpca = RunUMAP(hcells_rpca, dims = 1:20, verbose = F)
plt20 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:20")

hcells_rpca = RunUMAP(hcells_rpca, dims = 1:25, verbose = F)
plt25 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:25")

hcells_rpca = RunUMAP(hcells_rpca, dims = 1:10, verbose = F)
plt10 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:10")

hcells_rpca = RunUMAP(hcells_rpca, dims = 1:40, verbose = F)
plt40 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:40")

hcells_rpca = RunUMAP(hcells_rpca, dims = 1:50, verbose = F)
plt50 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:50")

png("results/integr_healthy/seurat_umap_dims.png", width = 1200, height = 600)
cowplot::plot_grid(plt10, plt20, plt25, plt30, plt40, plt50, ncol = 3, nrow = 2, align = "h")
dev.off()
```

Checking how using different numbers of dimensions affects t-SNE structure

```{r}
hcells_rpca = RunTSNE(hcells_rpca, dims = 1:30, verbose = F, perplexity = 25)
plt30 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:30")

hcells_rpca = RunTSNE(hcells_rpca, dims = 1:20, verbose = F, perplexity = 25)
plt20 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:20")

hcells_rpca = RunTSNE(hcells_rpca, dims = 1:25, verbose = F, perplexity = 25)
plt25 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:25")

hcells_rpca = RunTSNE(hcells_rpca, dims = 1:10, verbose = F, perplexity = 25)
plt10 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:10")

hcells_rpca = RunTSNE(hcells_rpca, dims = 1:40, verbose = F, perplexity = 25)
plt40 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:40")

hcells_rpca = RunTSNE(hcells_rpca, dims = 1:50, verbose = F, perplexity = 25)
plt50 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:50")

png("results/integr_healthy/seurat_tsne_dims.png", width = 1200, height = 600)
cowplot::plot_grid(plt10, plt20, plt25, plt30, plt40, plt50, ncol = 3, nrow = 2, align = "h")
dev.off()
```

Choose final dimensions

```{r}
hcells_rpca = RunUMAP(hcells_rpca, dims = 1:40, verbose = F)
hcells_rpca = RunTSNE(hcells_rpca, dims = 1:40, verbose = F, perplexity = 25)
```

Plot fractions and donors

```{r}
png("results/integr_healthy/seurat_umap50_FracDonor.png", width = 900, height = 300)
DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
        split = "Fraction", group.by = "Name")
dev.off()
```

Cluster Seurat results

```{r}
hcells_rpca = FindNeighbors(hcells_rpca, reduction = "pca", dims = 1:40, 
                            force.recalc = T, graph.name = "pc40")
hcells_rpca = FindClusters(hcells_rpca, algorithm = 2, verbose = F, graph.name = "pc40",
                           resolution = seq(0.1, 1.1, 0.1))

hcells_rpca = FindNeighbors(hcells_rpca, reduction = "pca", dims = 1:25, 
                            force.recalc = T, graph.name = "pc25")
hcells_rpca = FindClusters(hcells_rpca, algorithm = 2, verbose = F, graph.name = "pc25",
                           resolution = seq(0.1, 1.1, 0.1))

umap_list = list()
tsne_list = list()
for(i in seq(0.3, 0.9, 0.1)){
  n = paste0("res.",i)
  umap_list[[n]] = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                           label = T, group.by = paste0("pc40_", n)) + labs(title = n)
  tsne_list[[n]] = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                           label = T, group.by = paste0("pc40_", n)) + labs(title = n)
}
umap_list[["phase"]] = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                               label = T, group.by = "Phase") + labs(title = "CC phase")
tsne_list[["phase"]] = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                               label = T, group.by = "Phase") + labs(title = "CC phase")


png("results/integr_healthy/seurat_tsne_cluster.png", width = 1600, height = 700)
cowplot::plot_grid(plotlist = tsne_list, ncol = 4, nrow = 2, align = "hv")
dev.off()
png("results/integr_healthy/seurat_umap_cluster.png", width = 1600, height = 700)
cowplot::plot_grid(plotlist = umap_list, ncol = 4, nrow = 2, align = "hv")
dev.off()
```

Get markers for some clusters. We'll be using SCT-normalised data rather than integrated, given that the latter does not include all genes.  
THIS IS VERY SLOW (1 day)

```{r}
markers_sct_list = list()
for(i in seq(0.3, 0.9, 0.1)){
  n = paste0("res_", i)
  print(n)
  hcells_rpca = SetIdent(hcells_rpca, value = paste0("pc40_res.", i))
  markers_sct_list[[n]] = FindAllMarkers(hcells_rpca, assay = "SCT", test.use = "wilcox",
                                         pseudocount.use = 0.1, logfc.threshold = 0.2, 
                                         verbose = F)
}
saveRDS(markers_sct_list, file = "results/integr_healthy/mrk_sct_list.RDS")
```

Specific one on one comparisons

```{r}
hcells_rpca = SetIdent(hcells_rpca, value = "pc40_res.0.7")
markers_1v1_list = list()

cl_comb = combn(c("14", "20", "21"), 2)
for(i in 1:ncol(cl_comb)){
  n = paste0(cl_comb[1,i], "vs", cl_comb[2,i])
  markers_1v1_list[[n]] = FindMarkers(hcells_rpca, assay = "SCT", test.use = "wilcox",
                                      ident.1 = cl_comb[1,i], ident.2 = cl_comb[2,i], 
                                      pseudocount.use = 0.1, logfc.threshold = 0.2, 
                                      verbose = F)
}

cl_comb = combn(c("2", "12", "13", "16"), 2)
for(i in 1:ncol(cl_comb)){
  n = paste0(cl_comb[1,i], "vs", cl_comb[2,i])
  markers_1v1_list[[n]] = FindMarkers(hcells_rpca, assay = "SCT", test.use = "wilcox",
                                      ident.1 = cl_comb[1,i], ident.2 = cl_comb[2,i], 
                                      pseudocount.use = 0.1, logfc.threshold = 0.2, 
                                      verbose = F)
}

cl_comb = combn(c("16", "17", "19"), 2)
for(i in 1:ncol(cl_comb)){
  n = paste0(cl_comb[1,i], "vs", cl_comb[2,i])
  markers_1v1_list[[n]] = FindMarkers(hcells_rpca, assay = "SCT", test.use = "wilcox",
                                      ident.1 = cl_comb[1,i], ident.2 = cl_comb[2,i], 
                                      pseudocount.use = 0.1, logfc.threshold = 0.2, 
                                      verbose = F)
}
```

We will also do some subclustering.  
Cluster 13 can be split into two clusters - one of actual endothelial cells, and another of T cell-endothelial cell doublets. 

```{r}
# subcluster 13
cl = "13"
sub_srat = hcells_rpca[,hcells_rpca@meta.data$pc40_res.0.7==cl]
sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, dims = 1:20, verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "pca", dims = 1:20, 
                         force.recalc = T, graph.name = "c13pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "c13pc10",
                        resolution = seq(0.1, 0.5, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "c13pc10_res.0.3")

png("results/integr_healthy/seurat_umap_cluster13_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "c13pc10_res.0.3")
DefaultAssay(sub_srat) = "SCT"
mk_sub13 = FindMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                     ident.1 = "0", ident.2 = "1", 
                     pseudocount.use = 0.1, logfc.threshold = 0.2, 
                     verbose = T)
mk_sub13 = mk_sub13[mk_sub13$p_val_adj<=0.05,]
write.csv(x = cbind(rownames(mk_sub13), mk_sub13), col.names = T, row.names = T, quote = F,
          file = "results/integr_healthy/cluster13_sub_markers.csv")

# create new labels (required for next step)
cl13_endo = rownames(sub_srat@meta.data)[sub_srat@meta.data$c13pc10_res.0.3=="0"]
cl13_t = rownames(sub_srat@meta.data)[sub_srat@meta.data$c13pc10_res.0.3=="1"]
healthy_cl = as.character(hcells_rpca@meta.data$pc40_res.0.7)
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl13_endo] = "13_endo"
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl13_t] = "13_t"
```

Cluster 14 can be subclustered into ab T cells and gd T cells.

```{r}
# subcluster 14
cl = "14"
sub_srat = hcells_rpca[,healthy_cl==cl]
sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, dims = 1:20, verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "pca", dims = 1:20, 
                         force.recalc = T, graph.name = "c14pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "c14pc10",
                        resolution = seq(0.1, 0.5, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "c14pc10_res.0.3")
png("results/integr_healthy/seurat_umap_cluster14_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "c14pc10_res.0.3")
DefaultAssay(sub_srat) = "SCT"
mk_sub14 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                          pseudocount.use = 0.1, logfc.threshold = 0.2, 
                          verbose = T)
mk_sub14 = mk_sub14[mk_sub14$p_val_adj<=0.05,]
write.csv(x = mk_sub14, col.names = T, row.names = T, quote = F,
          file = "results/integr_healthy/cluster14_sub_markers.csv")

cl14_ab = rownames(sub_srat@meta.data)[sub_srat@meta.data$c14pc10_res.0.3=="0"]
cl14_gd = rownames(sub_srat@meta.data)[sub_srat@meta.data$c14pc10_res.0.3=="1"]
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl14_ab] = "14_abTcell"
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl14_gd] = "14_gdTcell"
```

Cluster 20 - we can observe dividing monocytes and T cells

```{r}
# subcluster 20
cl = "20"
sub_srat = hcells_rpca[,healthy_cl==cl]
sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, dims = 1:10, verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "pca", dims = 1:10, 
                         force.recalc = T, graph.name = "c20pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "c20pc10",
                        resolution = seq(0.1, 0.5, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "c20pc10_res.0.3")
png("results/integr_healthy/seurat_umap_cluster20_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "c20pc10_res.0.3")
DefaultAssay(sub_srat) = "SCT"
mk_sub20 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                          pseudocount.use = 0.1, logfc.threshold = 0.2, 
                          verbose = T)
mk_sub20 = mk_sub20[mk_sub20$p_val_adj<=0.05,]
write.csv(x = mk_sub20, col.names = T, row.names = T, quote = F,
          file = "results/integr_healthy/cluster20_sub_markers.csv")

cl20_t = rownames(sub_srat@meta.data)[sub_srat@meta.data$c20pc10_res.0.3=="0"]
cl20_m = rownames(sub_srat@meta.data)[sub_srat@meta.data$c20pc10_res.0.3=="1"]
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl20_t] = "20_Tcell"
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl20_m] = "20_mono"
```

Add new clusters to metadata along with their names add names

```{r}
names_clusters = ifelse(healthy_cl=="0", "Cholangiocytes", 
                        ifelse(healthy_cl=="1", "Hepatocytes_1", 
                        ifelse(healthy_cl=="2", "LSEC central vein", 
                        ifelse(healthy_cl=="3", "Hepatocytes_2", 
                        ifelse(healthy_cl=="4", "cDCs", 
                        ifelse(healthy_cl=="5", "Kupffer cells", 
                        ifelse(healthy_cl=="6", "Hepatocytes_3", 
                        ifelse(healthy_cl=="7", "Hepatocytes_4", 
                        ifelse(healthy_cl=="8", "Hepatocytes_5", 
                        ifelse(healthy_cl=="9", "Hepatocytes_6", 
                        ifelse(healthy_cl=="10", "Hepatocytes_7", 
                        ifelse(healthy_cl=="11", "Hepatocytes_8", 
                        ifelse(healthy_cl=="12", "Periportal LSEC", 
                        ifelse(healthy_cl=="13_endo", "Portal Endothelial cells", 
                        ifelse(healthy_cl=="13_t", "T cell-Endothelial interaction", 
                        ifelse(healthy_cl=="14_abTcell", "ab-T cells", 
                        ifelse(healthy_cl=="14_gdTcell", "gd-T cells_1", 
                        ifelse(healthy_cl=="15", "Hepatocytes_9", 
                        ifelse(healthy_cl=="16", "Macrophage-Endothelial interaction", 
                        ifelse(healthy_cl=="17", "Macrophages", 
                        ifelse(healthy_cl=="18", "Plasmablasts", 
                        ifelse(healthy_cl=="19", "pDCs", 
                        ifelse(healthy_cl=="20_Tcell", "Dividing T cells",
                        ifelse(healthy_cl=="20_mono", "Dividing monocytes",
                        ifelse(healthy_cl=="21", "gd-T cells_2", 
                        ifelse(healthy_cl=="22", "Stellate cells", "ERROR"
                        ))))))))))))))))))))))))))

names_major = ifelse(healthy_cl=="0", "Cholangiocytes", 
                      ifelse(healthy_cl=="1", "Hepatocytes", 
                      ifelse(healthy_cl=="2", "Endothelial cells", 
                      ifelse(healthy_cl=="3", "Hepatocytes", 
                      ifelse(healthy_cl=="4", "Dendritic cells", 
                      ifelse(healthy_cl=="5", "Myeloid cells", 
                      ifelse(healthy_cl=="6", "Hepatocytes", 
                      ifelse(healthy_cl=="7", "Hepatocytes", 
                      ifelse(healthy_cl=="8", "Hepatocytes", 
                      ifelse(healthy_cl=="9", "Hepatocytes", 
                      ifelse(healthy_cl=="10", "Hepatocytes", 
                      ifelse(healthy_cl=="11", "Hepatocytes", 
                      ifelse(healthy_cl=="12", "Endothelial cells", 
                      ifelse(healthy_cl=="13_endo", "Endothelial cells", 
                      ifelse(healthy_cl=="13_t", "Doublets", 
                      ifelse(healthy_cl=="14_abTcell", "Lymphocytes", 
                      ifelse(healthy_cl=="14_gdTcell", "Lymphocytes", 
                      ifelse(healthy_cl=="15", "Hepatocytes", 
                      ifelse(healthy_cl=="16", "Doublets", 
                      ifelse(healthy_cl=="17", "Myeloid cells", 
                      ifelse(healthy_cl=="18", "Lymphocytes", 
                      ifelse(healthy_cl=="19", "Dendritic cells", 
                      ifelse(healthy_cl=="20_Tcell", "Dividing cells",
                      ifelse(healthy_cl=="20_mono", "Dividing cells",
                      ifelse(healthy_cl=="21", "Lymphocytes", 
                      ifelse(healthy_cl=="22", "Stellate cells", "ERROR"
                      ))))))))))))))))))))))))))

newmeta = data.frame(row.names = rownames(hcells_rpca@meta.data),
                     "clusters" = healthy_cl,
                     "names_clusters" = names_clusters,
                     "names_major" = names_major)

hcells_rpca = AddMetaData(hcells_rpca, metadata = newmeta)
```

Plot distribution of cell types by the different samples

```{r}
for(n in c("names_clusters", "names_major")){
  pdf(paste0("results/integr_healthy/", n, "_distribution_samples.pdf"), useDingbats = F,
      height = 6, width = 10)
  
  ct_dat = table(hcells_rpca@meta.data[,n])
  ct_dat = data.frame(row.names = names(ct_dat),
                      counts = as.numeric(ct_dat))
  s_dat = unique(hcells_rpca@meta.data[,c("unique_name", "Fraction", "Name")])
  rownames(s_dat) = s_dat[,1]
  s_dat = s_dat[,-1]
  
  plot_df = t(table(hcells_rpca@meta.data$unique_name,
                  hcells_rpca@meta.data[,n]))
  plot_df = plot_df/rowSums(plot_df)
  
  pheatmap::pheatmap(t(plot_df), clustering_method = "ward.D2", 
                     display_numbers = round(t(plot_df), 3), fontsize_number = 6.5,
                     annotation_col = ct_dat, annotation_row = s_dat)
  
  plot_df = table(hcells_rpca@meta.data$unique_name,
                  hcells_rpca@meta.data[,n])
  plot_df = plot_df/rowSums(plot_df)
  
  pheatmap::pheatmap(t(plot_df), clustering_method = "ward.D2", 
                     display_numbers = round(t(plot_df), 3), fontsize_number = 6.5,
                     annotation_row = ct_dat, annotation_col = s_dat)
  dev.off()
}
```

Check labels in UMAP

```{r}
plt1 = DimPlot(hcells_rpca, reduction = "umap", group.by = "names_clusters", 
               label = T)+theme(legend.position = "none")
plt2 = DimPlot(hcells_rpca, reduction = "umap", group.by = "names_major", 
               label = T)+theme(legend.position = "none")
cowplot::plot_grid(plt1, plt2, ncol = 2, align = "h")
```

Save markers

```{r}
write.csv(markers_sct_list$res_0.7, 
          file = "results/integr_healthy/clusters_res0.7_markers.csv", 
          col.names = T, row.names = T, quote = F)
```

Save seurat object with new labels

```{r}
saveRDS(hcells_rpca, file = "data/processed/hcells_rpca.RDS")
```


### Examine CSS output
Load data

```{r}
hcells_css = readRDS("data/processed/scripts_out/CSSIntegr_allhealthy.RDS")
```

Cluster CSS results

```{r}
hcells_css = FindNeighbors(hcells_css, reduction = "css", 
                           dims = 1:ncol(Embeddings(hcells_css,"css")), 
                           force.recalc = T, graph.name = "cssAll")
hcells_css = FindClusters(hcells_css, algorithm = 2, verbose = F, graph.name = "cssAll",
                           resolution = seq(0.2, 1.5, 0.1))

umap_list = list()
for(i in seq(0.5, 1.5, 0.1)){
  n = paste0("res.",i)
  umap_list[[n]] = DimPlot(hcells_css, reduction = "umap_css", pt.size = 0.2, 
                           label = T, group.by = paste0("cssAll_", n)) + labs(title = n)
}
umap_list[["phase"]] = DimPlot(hcells_css, reduction = "umap_css", pt.size = 0.2, 
                               label = T, group.by = "Phase") + labs(title = "CC phase")

png("results/integr_healthy/css_umap_cluster.png", width = 1600, height = 700)
cowplot::plot_grid(plotlist = umap_list, ncol = 4, nrow = 3, align = "hv")
dev.off()
```

Get markers for some clusters. We'll be using SCT-normalised data rather than integrated, given that the latter does not include all genes.  
THIS IS VERY SLOW (1 day)

```{r}
css_markers_sct_list = list()
for(i in c(0.5, 0.9, 1.5)){
  n = paste0("res_", i)
  print(n)
  hcells_css = SetIdent(hcells_css, value = paste0("cssAll_res.", i))
  css_markers_sct_list[[n]] = FindAllMarkers(hcells_css, assay = "SCT", test.use = "wilcox",
                                             pseudocount.use = 0.1, logfc.threshold = 0.2, 
                                             verbose = T)
}
saveRDS(css_markers_sct_list, file = "results/integr_healthy/css_mrk_sct_list.RDS")
```

Subclustering the endothelial cells

```{r}
cl = c(9)
sub_srat = hcells_css[,hcells_css@meta.data$cssAll_res.0.9 %in% cl]
sub_srat = ScaleData(sub_srat, use.umi = T, vars.to.regress = c("nCount_SCT", "Donor"),
                     do.scale = F, verbose = FALSE)
sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, reduction = "pca", dims = 1:10, verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "pca", dims = 1:10, prune.SNN = 1/5,
                         force.recalc = T, graph.name = "endo_pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "endo_pc10",
                        resolution = seq(0.1, 1, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "endo_pc10_res.0.1")

png("results/integr_healthy/css_umap_cluster4_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub9 = data.frame(row.names = colnames(sub_srat),
                  "sub9_cl" = ifelse(sub_srat@reductions$umap@cell.embeddings[,1]<(-5.2),
                                     "sub9_stell",
                                     ifelse(sub_srat@meta.data$endo_pc10_res.0.1==1,
                                            "sub9_1", "sub9_0")))
sub_srat = AddMetaData(sub_srat, metadata = sub9)

sub_srat = SetIdent(sub_srat, value = "sub9_cl")
DefaultAssay(sub_srat) = "SCT"
mk_sub9 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                     pseudocount.use = 0.1, logfc.threshold = 0.2, 
                     verbose = T)
mk_sub9 = mk_sub9[mk_sub9$p_val_adj<=0.05,]
write.csv(x = mk_sub9, col.names = T, row.names = T, quote = F,
          file = "results/integr_healthy/css_cluster4_sub_markers.csv")

# create new labels (required for next step)
cl9_stell = rownames(sub_srat@meta.data)[sub_srat@meta.data$sub9_cl=="sub9_stell"]
cl9_0 = rownames(sub_srat@meta.data)[sub_srat@meta.data$sub9_cl=="sub9_0"]
cl9_1 = rownames(sub_srat@meta.data)[sub_srat@meta.data$sub9_cl=="sub9_1"]
healthy_cl = as.character(hcells_css@meta.data$cssAll_res.0.9)
healthy_cl[rownames(hcells_css@meta.data) %in% cl9_stell] = "sub9_stell"
healthy_cl[rownames(hcells_css@meta.data) %in% cl9_0] = "sub9_0"
healthy_cl[rownames(hcells_css@meta.data) %in% cl9_1] = "sub9_1"

# save data
saveRDS(sub_srat, file = "data/processed/sub_healthy_css_endo_srat.RDS")
```

Subclustering the T cells

```{r}
cl = c(12)
sub_srat = hcells_css[,hcells_css@meta.data$cssAll_res.0.9 %in% cl]
sub_srat = ScaleData(sub_srat, use.umi = T, vars.to.regress = c("nCount_SCT", "Donor"),
                     do.scale = F, verbose = FALSE)
sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, reduction = "pca", dims = 1:10, verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "pca", dims = 1:10, prune.SNN = 1/5,
                         force.recalc = T, graph.name = "t_pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "t_pc10",
                        resolution = seq(0.1, 1, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "t_pc10_res.0.2")

png("results/integr_healthy/css_umap_cluster12_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "t_pc10_res.0.1")
DefaultAssay(sub_srat) = "SCT"
mk_sub12 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                     pseudocount.use = 0.1, logfc.threshold = 0.2, 
                     verbose = T)
mk_sub12 = mk_sub12[mk_sub12$p_val_adj<=0.05,]
write.csv(x = mk_sub12, col.names = T, row.names = T, quote = F,
          file = "results/integr_healthy/css_cluster12_sub_markers.csv")

# create new labels (required for next step)
cl12_0 = rownames(sub_srat@meta.data)[sub_srat@meta.data$t_pc10_res.0.1==0]
cl12_1 = rownames(sub_srat@meta.data)[sub_srat@meta.data$t_pc10_res.0.1==1]
healthy_cl[rownames(hcells_css@meta.data) %in% cl12_0] = "sub12_0"
healthy_cl[rownames(hcells_css@meta.data) %in% cl12_1] = "sub12_1"

# save data
saveRDS(sub_srat, file = "data/processed/sub_healthy_css_tcell_srat.RDS")
```

Subclustering the Kupffer-T cell mix

```{r}
cl = c(16)
sub_srat = hcells_css[,hcells_css@meta.data$cssAll_res.0.9 %in% cl]
sub_srat = ScaleData(sub_srat, use.umi = T, vars.to.regress = c("nCount_SCT", "Donor"),
                     do.scale = F, verbose = FALSE)
sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, reduction = "pca", dims = 1:10, verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "pca", dims = 1:10, prune.SNN = 1/5,
                         force.recalc = T, graph.name = "kt_pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "kt_pc10",
                        resolution = seq(0.1, 1, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "kt_pc10_res.0.1")

png("results/integr_healthy/css_umap_cluster16_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "kt_pc10_res.0.1")
DefaultAssay(sub_srat) = "SCT"
mk_sub16 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                     pseudocount.use = 0.1, logfc.threshold = 0.2, 
                     verbose = T)
mk_sub16 = mk_sub16[mk_sub16$p_val_adj<=0.05,]
write.csv(x = mk_sub16, col.names = T, row.names = T, quote = F,
          file = "results/integr_healthy/css_cluster16_sub_markers.csv")

# this section just proves that these are not interacting cells, but rather a mix
```

Subcluster pDCs

```{r}
cl = c(19)
sub_srat = hcells_css[,hcells_css@meta.data$cssAll_res.0.9 %in% cl]
sub_srat = ScaleData(sub_srat, use.umi = T, vars.to.regress = c("nCount_SCT", "Donor"),
                     do.scale = F, verbose = FALSE)
sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, reduction = "pca", dims = 1:10, verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "pca", dims = 1:10, prune.SNN = 1/5,
                         force.recalc = T, graph.name = "pdc_pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "pdc_pc10",
                        resolution = seq(0.1, 1, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "pdc_pc10_res.0.1")

png("results/integr_healthy/css_umap_cluster19_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "pdc_pc10_res.0.1")
DefaultAssay(sub_srat) = "SCT"
mk_sub19 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                     pseudocount.use = 0.1, logfc.threshold = 0.2, 
                     verbose = T)
mk_sub19 = mk_sub19[mk_sub19$p_val_adj<=0.05,]
write.csv(x = mk_sub19, col.names = T, row.names = T, quote = F,
          file = "results/integr_healthy/css_cluster19_sub_markers.csv")

# create new labels (required for next step)
cl19_0 = rownames(sub_srat@meta.data)[sub_srat@meta.data$pdc_pc10_res.0.1==0]
cl19_1 = rownames(sub_srat@meta.data)[sub_srat@meta.data$pdc_pc10_res.0.1==1]
healthy_cl[rownames(hcells_css@meta.data) %in% cl19_0] = "sub19_pdc"
healthy_cl[rownames(hcells_css@meta.data) %in% cl19_1] = "sub19_b"

# save data
saveRDS(sub_srat, file = "data/processed/sub_healthy_css_pdc_srat.RDS")
```

Now we're organising the new labels. These will be as follows: hepatocytes and cholangiocytes using res 0.5, remaining using 0.9, also include subclusters from endothelial and T cells

```{r}
# replace labels for hepatocytes and cholangiocytes
r5_cl3 = rownames(hcells_css@meta.data)[hcells_css@meta.data$cssAll_res.0.5==3]
r5_cl0 = rownames(hcells_css@meta.data)[hcells_css@meta.data$cssAll_res.0.5==0]
r5_cl12 = rownames(hcells_css@meta.data)[hcells_css@meta.data$cssAll_res.0.5==12]
r5_cl1 = rownames(hcells_css@meta.data)[hcells_css@meta.data$cssAll_res.0.5==1]
r5_cl6 = rownames(hcells_css@meta.data)[hcells_css@meta.data$cssAll_res.0.5==6]
r5_cl4 = rownames(hcells_css@meta.data)[hcells_css@meta.data$cssAll_res.0.5==4]
healthy_cl[rownames(hcells_css@meta.data) %in% r5_cl3] = "r5_cl3"
healthy_cl[rownames(hcells_css@meta.data) %in% r5_cl0] = "r5_cl0"
healthy_cl[rownames(hcells_css@meta.data) %in% r5_cl12] = "r5_cl12"
healthy_cl[rownames(hcells_css@meta.data) %in% r5_cl1] = "r5_cl1"
healthy_cl[rownames(hcells_css@meta.data) %in% r5_cl6] = "r5_cl6"
healthy_cl[rownames(hcells_css@meta.data) %in% r5_cl4] = "r5_cl4"
healthy_cl[healthy_cl==3] = "r5_cl1"

# add metadata
df_meta = data.frame(row.names = colnames(hcells_css),
                     "healthy_cl" = healthy_cl, stringsAsFactors = F)
hcells_css = AddMetaData(hcells_css, df_meta)
```

Now renaming

```{r}
names_clusters = ifelse(healthy_cl=="r5_cl3", "Cholangiocytes", 
                        ifelse(healthy_cl=="r5_cl0", "Hepatocytes (central)", 
                        ifelse(healthy_cl=="r5_cl12", "Hepatocytes (unknown 2)", 
                        ifelse(healthy_cl=="r5_cl1", "Hepatocytes (midzone)", 
                        ifelse(healthy_cl=="r5_cl6", "Hepatocytes (portal)", 
                        ifelse(healthy_cl=="r5_cl4", "Hepatocytes (unknown 1)", 
                        ifelse(healthy_cl=="sub12_0", "ab-T cells", 
                        ifelse(healthy_cl=="sub12_1", "gd-T cells", 
                        ifelse(healthy_cl=="sub9_stell", "Stellate cells", 
                        ifelse(healthy_cl=="sub9_0", "LSEC portal vein", 
                        ifelse(healthy_cl=="sub9_1", "Endothelial cells (non-LSEC)", 
                        ifelse(healthy_cl=="10", "Hepatocytes (central-mid, low counts)", 
                        ifelse(healthy_cl=="13", "Macrophage-Endothelial interaction", 
                        ifelse(healthy_cl=="14", "T cell-Endothelial interaction", 
                        ifelse(healthy_cl=="16", "Kupffer-T cell mix", 
                        ifelse(healthy_cl=="17", "Plasmablasts", 
                        ifelse(healthy_cl=="18", "Macrophages", 
                        ifelse(healthy_cl=="sub19_pdc", "pDCs", 
                        ifelse(healthy_cl=="sub19_b", "B cells", 
                        ifelse(healthy_cl=="4", "LSEC central vein", 
                        ifelse(healthy_cl=="6", "cDCs", 
                        ifelse(healthy_cl=="8", "Kupffer cells", "ERROR"
                        ))))))))))))))))))))))

names_major = ifelse(healthy_cl=="r5_cl3", "Cholangiocytes", 
                     ifelse(healthy_cl=="r5_cl0", "Hepatocytes", 
                     ifelse(healthy_cl=="r5_cl12", "Hepatocytes", 
                     ifelse(healthy_cl=="r5_cl1", "Hepatocytes", 
                     ifelse(healthy_cl=="r5_cl6", "Hepatocytes", 
                     ifelse(healthy_cl=="r5_cl4", "Hepatocytes", 
                     ifelse(healthy_cl=="sub12_0", "T cells", 
                     ifelse(healthy_cl=="sub12_1", "T cells", 
                     ifelse(healthy_cl=="sub9_stell", "Stellate cells", 
                     ifelse(healthy_cl=="sub9_0", "Endothelial cells", 
                     ifelse(healthy_cl=="sub9_1", "Endothelial cells", 
                     ifelse(healthy_cl=="10", "Hepatocytes", 
                     ifelse(healthy_cl=="13", "Doublets", 
                     ifelse(healthy_cl=="14", "Doublets", 
                     ifelse(healthy_cl=="16", "Doublets", 
                     ifelse(healthy_cl=="17", "B cells", 
                     ifelse(healthy_cl=="18", "Macrophages", 
                     ifelse(healthy_cl=="sub19_pdc", "DCs", 
                     ifelse(healthy_cl=="sub19_b", "B cells", 
                     ifelse(healthy_cl=="4", "Endothelial cells", 
                     ifelse(healthy_cl=="6", "DCs", 
                     ifelse(healthy_cl=="8", "Macrophages", "ERROR"
                     ))))))))))))))))))))))

newmeta = data.frame(row.names = rownames(hcells_css@meta.data),
                     "clusters" = healthy_cl,
                     "names_clusters" = names_clusters,
                     "names_major" = names_major)

hcells_css = AddMetaData(hcells_css, metadata = newmeta)

# get markers for these clusters
hcells_css = SetIdent(hcells_css, value = "names_clusters")
mk_healthy_cl = FindAllMarkers(hcells_css, assay = "SCT", test.use = "wilcox",
                               pseudocount.use = 0.1, logfc.threshold = 0.2, verbose = T)
write.csv(x = mk_healthy_cl, col.names = T, row.names = T, quote = F,
          file = "results/integr_healthy/css_allPops_markers.csv")
```

Plot markers for these populations

```{r}
mk_list = list("Cholangiocytes" = c("KRT7", "ANXA4", "EPCAM", "KRT19"), 
               "Hepatocytes (central)" = c("CYP1A2", "CYP2E1", "APOH", "CYP3A4"), 
               "Hepatocytes (unknown 2)" = c("CYP1A2", "DEPDC7", "PCOLCE2", "F13B"), 
               "Hepatocytes (midzone)" = c("HAMP", "PLA2G2A", "NNMT", "HP"), 
               "Hepatocytes (portal)" = c("C3", "SAA1", "CYP2A6", "C1R"), 
               "Hepatocytes (unknown 1)" = c("HULC", "AR", "CYP4F3", "APOA2"), 
               "ab-T cells" = c("CD8A", "CD3E", "TRAC", "TRBC1"), 
               "gd-T cells" = c("TRDC", "GZMB", "CCL3", "MKI67"), 
               "Stellate cells" = c("ACTA2", "DCN", "COLEC11", "SPARC"), 
               "LSEC portal vein" = c("MGP", "CLEC14A", "PECAM1", "VWF"), 
               "Endothelial cells (non-LSEC)" = c("INMT", "RAMP3", "ENG", "ICAM1"), 
               "Hepatocytes (central-mid, low counts)" = c("GSTA2", "ANXA10", "FBP1", "SAA2"), 
               "Macrophage-Endothelial interaction" = c("S100A8", "LYZ", "SPARC", "LYVE1"), 
               "T cell-Endothelial interaction" = c("CD3D", "TRBC1", "CLEC4G", "LYVE1"), 
               "Kupffer-T cell mix" = c("MARCO", "CD5L", "TRBC1", "NKG7"), 
               "Plasmablasts" = c("IGLC3", "IGHA1", "CD79A", "CD27"), 
               "Macrophages" = c("S100A8", "CD68", "LYZ", "IL1B"), 
               "pDCs" = c("GZMB", "LILRA4", "IRF7", "TLR7"),
               "B cells" = c("IGHG1", "CD79A", "CD79B", "CD19"),
               "LSEC central vein" = c("CLEC4G", "CD68", "PECAM1", "F8"), 
               "cDCs" = c("HLA-DQB1", "CD1C", "FCER1A", "CLEC10A"), 
               "Kupffer cells" = c("CD5L", "MARCO", "C1QB", "IL10"))

plt_list = list()
plt_list[["all_clusters"]] = DimPlot(hcells_css, reduction = "umap_css", label = T,
                                     group.by = "names_clusters")+
  labs(title = "All clusters")+
  theme(legend.position = "none")
plt_list[["major_clusters"]] = DimPlot(hcells_css, reduction = "umap_css", label = T,
                                       group.by = "names_major")+
  labs(title = "Major clusters")+
  theme(legend.position = "none")

for(n in names(mk_list)){
  plt_list[[n]] = FeaturePlot(hcells_css, reduction = "umap_css", features = mk_list[[n]])
}

for(n in names(plt_list)){
  png(paste0("results/integr_healthy/css_markers_plots/", n, "_umap.png"), 
      height = 1200, width = 1300)
  print(plt_list[[n]])
  dev.off()
}
```

And plot for the subclusters as well

```{r}
srat_tcell = readRDS("data/processed/sub_healthy_css_tcell_srat.RDS")
plt_list = list()
for(n in names(mk_list)[c(7,8)]){
  plt_list[[n]] = FeaturePlot(srat_tcell, reduction = "umap", features = mk_list[[n]])
}
for(n in names(plt_list)){
  png(paste0("results/integr_healthy/css_markers_plots/tcell_", n, "_umap.png"), 
      height = 1200, width = 1300)
  print(plt_list[[n]])
  dev.off()
}

srat_endo = readRDS("data/processed/sub_healthy_css_endo_srat.RDS")
plt_list = list()
for(n in names(mk_list)[c(9,10,11)]){
  plt_list[[n]] = FeaturePlot(srat_endo, reduction = "umap", features = mk_list[[n]])
}
for(n in names(plt_list)){
  png(paste0("results/integr_healthy/css_markers_plots/endothelial_", n, "_umap.png"), 
      height = 1200, width = 1300)
  print(plt_list[[n]])
  dev.off()
}

srat_endo = readRDS("data/processed/sub_healthy_css_pdc_srat.RDS")
plt_list = list()
for(n in names(mk_list)[c(18,19)]){
  plt_list[[n]] = FeaturePlot(srat_endo, reduction = "umap", features = mk_list[[n]])
}
for(n in names(plt_list)){
  png(paste0("results/integr_healthy/css_markers_plots/pdc_", n, "_umap.png"), 
      height = 1200, width = 1300)
  print(plt_list[[n]])
  dev.off()
}
```

Proportion of clusters per sample

```{r}
# healthy clusters representation
tab_cl = table(hcells_css@meta.data$names_clusters, hcells_css@meta.data$unique_name)
class(tab_cl) = "matrix"
tab_cl = t(t(tab_cl)/colSums(tab_cl))
annot_df = unique(allcells_css@meta.data[,c("unique_name", "Condition", "Fraction", "Donor")])
rownames(annot_df) = annot_df[,1]
annot_df = annot_df[,-1]
png(paste0("results/integr_healthy/css_markers_plots/names_vs_samples.png"), 
        height = 600, width = 1100)
pheatmap::pheatmap(t(tab_cl), display_numbers = T, clustering_method = "ward.D2", 
                   fontsize_number = 9, treeheight_row = 20, treeheight_col = 20,
                   annotation_row = annot_df, 
                   annotation_colors = list("Condition" = c("embolised" = "red", 
                                                           "regenerating" = "orange",  
                                                           "healthy" = "blue")))
dev.off()
```

Save Seurat object

```{r}
saveRDS(hcells_css, file = "data/processed/hcells_css.RDS")
```



## Integrate all datasets
Integrate all cell datasets using different methods, using batch scripts  

Seurat Anchors CCA
  - Script: `run_SeuratIntegration_allcells.R`
  - Output: `data/processed/scripts_out/SeuratIntegr_allcells.RDS`
  - Note: This did not work, likely because of too many cells
  
Seurat Anchors rPCA
  - Script: `run_SeuratIntegrationRPCA_allcells.R`
  - Output: `data/processed/scripts_out/SeuratIntegrRPCA_allcells.RDS`
  
Harmony
  - Script: `run_HarmonyIntegration_allcells.R`
  - Output: `data/processed/scripts_out/HarmIntegr_allcells.RDS`


### Examine Harmony output
Load data

```{r}
allcells_harm = readRDS("data/processed/scripts_out/HarmIntegr_allcells.RDS")
```

Checking how using different numbers of dimensions affects UMAP structure

```{r}
plt10 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:10")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:20)
plt20 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:20")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:25)
plt25 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:25")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:30)
plt30 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:30")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:40)
plt40 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:40")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:50)
plt50 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:50")

png("results/integr_allcells/harmony_umap_dims.png", width = 1200, height = 600)
cowplot::plot_grid(plt10, plt20, plt25, plt30, plt40, plt50, ncol = 3, nrow = 2, align = "h")
dev.off()
```

How do the different fractions and conditions split in the UMAP (50 dims)

```{r}
DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
        split = "Fraction", group.by = "Condition")
```

Plotting general markers

```{r}
FeaturePlot(allcells_harm, reduction = "umap", pt.size = 0.2,
            features = c("FGA", "PTPRC", "ANXA4", "CD34", "EPCAM", "C1QB",
                         "JCHAIN", "APOA1", "nFeature_RNA"))
```

As explained in the healthy section, there are some issues with Harmony, so we will proceed with the Seurat integration


### Examine Seurat output
Load data

```{r}
allcells_rpca = readRDS("data/processed/scripts_out/SeuratIntegrRPCA_allcells_v2.RDS")
allcells_rpca = RunPCA(allcells_rpca, verbose = F, npcs = 80)
# load healthy data, which now contains annotations and can help here
hcells_rpca = readRDS("data/processed/hcells_rpca.RDS")
```

Checking how using different numbers of dimensions affects UMAP structure

```{r}
allcells_rpca = RunUMAP(allcells_rpca, dims = 1:30, verbose = F)
plt30 = DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:30")

allcells_rpca = RunUMAP(allcells_rpca, dims = 1:20, verbose = F)
plt20 = DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:20")

allcells_rpca = RunUMAP(allcells_rpca, dims = 1:25, verbose = F)
plt25 = DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:25")

allcells_rpca = RunUMAP(allcells_rpca, dims = 1:10, verbose = F)
plt10 = DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:10")

allcells_rpca = RunUMAP(allcells_rpca, dims = 1:40, verbose = F)
plt40 = DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:40")

allcells_rpca = RunUMAP(allcells_rpca, dims = 1:50, verbose = F)
plt50 = DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:50")

allcells_rpca = RunUMAP(allcells_rpca, dims = 1:60, verbose = F)
plt60 = DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:60")

allcells_rpca = RunUMAP(allcells_rpca, dims = 1:70, verbose = F)
plt70 = DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:70")

allcells_rpca = RunUMAP(allcells_rpca, dims = 1:80, verbose = F)
plt80 = DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:80")

png("results/integr_allcells/seurat_umap_dims.png", width = 1400, height = 1200)
cowplot::plot_grid(plt10, plt20, plt25, plt30, plt40, plt50, plt60, plt70, plt80, ncol = 3, nrow = 3, align = "h")
dev.off()
```

Checking how using different numbers of dimensions affects t-SNE structure

```{r}
allcells_rpca = RunTSNE(allcells_rpca, dims = 1:30, verbose = F, perplexity = 25)
plt30 = DimPlot(allcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:30")

allcells_rpca = RunTSNE(allcells_rpca, dims = 1:20, verbose = F, perplexity = 25)
plt20 = DimPlot(allcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:20")

allcells_rpca = RunTSNE(allcells_rpca, dims = 1:25, verbose = F, perplexity = 25)
plt25 = DimPlot(allcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:25")

allcells_rpca = RunTSNE(allcells_rpca, dims = 1:10, verbose = F, perplexity = 25)
plt10 = DimPlot(allcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:10")

allcells_rpca = RunTSNE(allcells_rpca, dims = 1:40, verbose = F, perplexity = 25)
plt40 = DimPlot(allcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:40")

allcells_rpca = RunTSNE(allcells_rpca, dims = 1:50, verbose = F, perplexity = 25)
plt50 = DimPlot(allcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:50")

allcells_rpca = RunTSNE(allcells_rpca, dims = 1:60, verbose = F, perplexity = 25)
plt60 = DimPlot(allcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:60")

allcells_rpca = RunTSNE(allcells_rpca, dims = 1:70, verbose = F, perplexity = 25)
plt70 = DimPlot(allcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:70")

allcells_rpca = RunTSNE(allcells_rpca, dims = 1:80, verbose = F, perplexity = 25)
plt80 = DimPlot(allcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:80")

png("results/integr_allcells/seurat_tsne_dims.png", width = 1400, height = 1200)
cowplot::plot_grid(plt10, plt20, plt25, plt30, plt40, plt50, plt60, plt70, plt80, ncol = 3, nrow = 3, align = "h")
dev.off()
```

Choose final dimensions

```{r}
allcells_rpca = RunUMAP(allcells_rpca, dims = 1:60, verbose = F)
allcells_rpca = RunTSNE(allcells_rpca, dims = 1:60, verbose = F, perplexity = 25)
```

Plot fractions and donors and condition

```{r}
png("results/integr_allcells/seurat_umap50_FracDonor.png", width = 900, height = 300)
DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
        split = "Fraction", group.by = "Name")
dev.off()
png("results/integr_allcells/seurat_umap50_CondDonor.png", width = 900, height = 300)
DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
        split = "Condition", group.by = "Name")
dev.off()
```

Add existing labels from healthy

```{r}
merge_umap = merge(allcells_rpca@reductions$umap@cell.embeddings, 
                   hcells_rpca@meta.data[,c("names_clusters", "names_major")], 
                   by = 0, all = T)
merge_umap$names_clusters = as.character(merge_umap$names_clusters)
merge_umap$names_clusters[is.na(merge_umap$names_clusters)] = "No annot"
merge_umap$names_clusters = factor(merge_umap$names_clusters, 
                                   levels = c(levels(hcells_rpca@meta.data$names_clusters),
                                              "No annot"))
merge_umap = merge_umap[order(merge_umap$names_clusters, decreasing = T),]

merge_umap$names_major = as.character(merge_umap$names_major)
merge_umap$names_major[is.na(merge_umap$names_major)] = "No annot"
merge_umap$names_major = factor(merge_umap$names_major, 
                                   levels = c(levels(hcells_rpca@meta.data$names_major),
                                              "No annot"))
merge_umap = merge_umap[order(merge_umap$names_major, decreasing = T),]

png("results/integr_allcells/umap_allcells_healthy_clusters.png", width = 650, height = 400)
ggplot(merge_umap, aes(x = UMAP_1, y = UMAP_2, colour = names_clusters))+
  geom_point(size = 0.25)+
  guides(colour = guide_legend(override.aes = list(size = 4)))+
  theme_classic()+
  theme(legend.position = "right")
dev.off()

png("results/integr_allcells/umap_allcells_healthy_major.png", width = 510, height = 400)
ggplot(merge_umap, aes(x = UMAP_1, y = UMAP_2, colour = names_major))+
  geom_point(size = 0.25)+
  guides(colour = guide_legend(override.aes = list(size = 4)))+
  theme_classic()+
  theme(legend.position = "right")
dev.off()

rownames(merge_umap) = merge_umap$Row.names
allcells_rpca = AddMetaData(allcells_rpca, merge_umap[,c("names_clusters", "names_major")])
```

Cluster Seurat results - clustering here is veeeery slow (~6h)

```{r}
allcells_rpca = FindNeighbors(allcells_rpca, reduction = "pca", dims = 1:60, 
                              force.recalc = T, graph.name = "pc60", prune.SNN = 1/10)
allcells_rpca = FindClusters(allcells_rpca, algorithm = 2, verbose = F, graph.name = "pc60",
                           resolution = seq(0.1, 1.1, 0.1))

umap_list = list()
tsne_list = list()
for(i in seq(0.3, 1.0, 0.1)){
  n = paste0("res.",i)
  umap_list[[n]] = DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
                           label = T, group.by = paste0("pc60_", n)) + labs(title = n)
  tsne_list[[n]] = DimPlot(allcells_rpca, reduction = "tsne", pt.size = 0.2, 
                           label = T, group.by = paste0("pc60_", n)) + labs(title = n)
}


png("results/integr_allcells/seurat_tsne_cluster.png", width = 1600, height = 700)
cowplot::plot_grid(plotlist = tsne_list, ncol = 4, nrow = 2, align = "hv")
dev.off()
png("results/integr_allcells/seurat_umap_cluster.png", width = 1600, height = 700)
cowplot::plot_grid(plotlist = umap_list, ncol = 4, nrow = 2, align = "hv")
dev.off()

# save data at this point 
saveRDS(allcells_rpca, file = "data/processed/allcells_rpca_cl_mix.RDS")
```

This will be followed by: separating hepatocytes, reprocessing (correct for donor), clustering, add non-hepatocyte clusters to non-hepatocyte fraction, reprocessing (correct for donor), clustering, put everything together (UMAP with all those clusters), then do marker detection  

We start by separating what appear to be hepatocytes and non-hepatocytes

```{r}
cls ="pc60_res.0.6"
nonhep_cl = c(6,7,8,9,10,11,14,16,18,19,20,29)

allcells_hep = allcells_rpca[,!(allcells_rpca@meta.data[,cls] %in% nonhep_cl)]
cells_nhep = rownames(allcells_rpca@meta.data)[allcells_rpca@meta.data[,cls] %in% nonhep_cl]
```

We now reprocess both of these fractions for clustering. First, hep

```{r}
allcells_hep = suppressWarnings(SCTransform(allcells_hep, do.correct.umi = T, verbose = F, 
                                            vars.to.regress = c("unique_name","nCount_RNA"),
                                            variable.features.rv.th = 1, seed.use = 1,
                                            return.only.var.genes = F, 
                                            variable.features.n = NULL))
allcells_hep = RunPCA(allcells_hep, verbose = F)
allcells_hep = RunUMAP(allcells_hep, dims = 1:25, verbose = F)
DimPlot(allcells_hep, reduction = "umap", group.by = "Fraction", split.by = "Condition")

allcells_hep = FindNeighbors(allcells_hep, reduction = "pca", dims = 1:25, 
                             force.recalc = T, graph.name = "pc25", prune.SNN = 1/10)
allcells_hep = FindClusters(allcells_hep, algorithm = 2, verbose = F, graph.name = "pc25",
                            resolution = seq(0.3, 0.8, 0.1))

allcells_hep = SetIdent(allcells_hep, value = "pc25_res.0.8")
mk_hep = FindAllMarkers(allcells_hep, assay = "SCT", logfc.threshold = 0.2)
write.csv(mk_hep, file = "results/integr_allcells/hep_markers_res.0.8.csv", 
          col.names = T, row.names = T, quote = F)

plt = DimPlot(allcells_hep, reduction = "umap", group.by = "pc25_res.0.8", label = T)
for(g in c("SAA1", "FGA", "CYP2E1", "NNMT", "IGFBP1", "FABP1", "HBB")){
  vln = VlnPlot(allcells_hep, features = c(g), 
                group.by = "pc25_res.0.8", sort = T)+theme(legend.position = "none")
  png(paste0("results/integr_allcells/hep_group_cl_", g, ".png"), width = 1300, height = 600)
  print(cowplot::plot_grid(plt, vln, ncol = 2))
  dev.off()
}

nonhep_hepcl = c(17,8,15,24,20,30)
#nonhep_hepcl = c(16, 12, 18, 22, 27, 26, 21, 28, 17, 23, 15, 30, 8, 24, 14, 25, 13, 22, 20)
nonhep_hepcells = rownames(allcells_hep@meta.data)[allcells_hep@meta.data$pc25_res.0.8 %in% nonhep_hepcl]

# save data at this point 
saveRDS(allcells_hep, file = "data/processed/allcells_hep.RDS")
```

And now, non-hep

```{r}
nhep_cells = c(nonhep_hepcells, cells_nhep)
allcells_nhep = allcells_rpca[,nhep_cells]

# we remove this object here to avoid making RStudio lag
rm(allcells_rpca)

allcells_nhep = suppressWarnings(SCTransform(allcells_nhep, do.correct.umi = T,
                                             verbose = F, 
                                             vars.to.regress = c("unique_name","nCount_RNA"),
                                            variable.features.rv.th = 1, 
                                            seed.use = 1,
                                            return.only.var.genes = F, 
                                            variable.features.n = NULL))
allcells_nhep = RunPCA(allcells_nhep, verbose = F)
allcells_nhep = RunUMAP(allcells_nhep, dims = 1:25, verbose = F)
DimPlot(allcells_nhep, reduction = "umap", group.by = "names_major")

allcells_nhep = FindNeighbors(allcells_nhep, reduction = "pca", dims = 1:25, 
                              force.recalc = T, graph.name = "pc25", 
                              prune.SNN = 1/10)
allcells_nhep = FindClusters(allcells_nhep, algorithm = 2, verbose = F, 
                             graph.name = "pc25", resolution = seq(0.3, 0.8, 0.1))

allcells_nhep = SetIdent(allcells_nhep, value = "pc25_res.0.6")
mk_nhep = FindAllMarkers(allcells_nhep, assay = "SCT", logfc.threshold = 0.2)
write.csv(mk_nhep, file = "results/integr_allcells/nhep_markers_res.0.6.csv", 
          col.names = T, row.names = T, quote = F)

plt = DimPlot(allcells_nhep, reduction = "umap", group.by = "pc25_res.0.6", label = T)
for(g in c("SAA1", "FGA", "CYP2E1", "NNMT", "IGFBP1", "FABP1", "HBB")){
  vln = VlnPlot(allcells_nhep, features = c(g), 
                group.by = "pc25_res.0.6", sort = T)+theme(legend.position = "none")
  png(paste0("results/integr_allcells/nhep_group_cl_", g, ".png"), width = 1300, height = 600)
  print(cowplot::plot_grid(plt, vln, ncol = 2))
  dev.off()
}

hep_nhepcl = c(13, 18, 20) # 20 is likely Kupffer-hep
hep_nhepcells = rownames(allcells_nhep@meta.data)[allcells_nhep@meta.data$pc25_res.0.6 %in% hep_nhepcl]

# save data at this point 
saveRDS(allcells_nhep, file = "data/processed/allcells_nhep.RDS")
```

Having established hepatocyte and non-hepatocyte clusters, we will re-analyse the data

```{r}
hep_hepcells = rownames(allcells_hep@meta.data)[!(allcells_hep@meta.data$pc25_res.0.8 %in% nonhep_hepcl)]
allcells_hep = merge(allcells_hep[,hep_hepcells], allcells_nhep[,hep_nhepcells])

allcells_hep = suppressWarnings(SCTransform(allcells_hep, do.correct.umi = T, verbose = F, 
                                            vars.to.regress = c("unique_name","nCount_RNA"),
                                            variable.features.rv.th = 1, seed.use = 1,
                                            return.only.var.genes = F, 
                                            variable.features.n = NULL))
allcells_hep = RunPCA(allcells_hep, verbose = F)
allcells_hep = RunUMAP(allcells_hep, dims = 1:15, verbose = F)
DimPlot(allcells_hep, reduction = "umap", group.by = "Condition", split.by = "Donor", ncol = 3)
FeaturePlot(allcells_hep, features = c("FGA", "SAA1", "HAMP", "CYP2E1","LYVE1","HLA-DRA"))

allcells_hep = FindNeighbors(allcells_hep, reduction = "pca", dims = 1:15, 
                             force.recalc = T, graph.name = "pc15", prune.SNN = 1/10)
allcells_hep = FindClusters(allcells_hep, algorithm = 2, verbose = F, graph.name = "pc15",
                            resolution = seq(0.3, 0.8, 0.1))

allcells_hep = SetIdent(allcells_hep, value = "pc15_res.0.5")
mk_hep = FindAllMarkers(allcells_hep, assay = "SCT", logfc.threshold = 0.2)

# remove "doublets"
allcells_hep_filt = allcells_hep[,!(allcells_hep@meta.data$pc15_res.0.5 %in% c(12,13,16,11,14))]
allcells_hep_filt = suppressWarnings(SCTransform(allcells_hep_filt, do.correct.umi = T, 
                                                 verbose = F, seed.use = 1,
                                                 vars.to.regress = c("unique_name","nCount_RNA"),
                                                 variable.features.n = 1500, 
                                                 return.only.var.genes = F))
allcells_hep_filt = RunPCA(allcells_hep_filt, verbose = F)
allcells_hep_filt = RunUMAP(allcells_hep_filt, dims = 1:10, verbose = F)

DimPlot(allcells_hep_filt, reduction = "umap", group.by = "pc15_res.0.5", label = T)

allcells_hep = FindNeighbors(allcells_hep, reduction = "pca", dims = 1:10, 
                             force.recalc = T, graph.name = "pc15", prune.SNN = 1/10)
allcells_hep = FindClusters(allcells_hep, algorithm = 2, verbose = F, graph.name = "pc10",
                            resolution = seq(0.3, 0.8, 0.1))

DimPlot(allcells_hep_filt, reduction = "umap", group.by = "pc15_res.0.5", label = T)




tab_cl_hep = table(allcells_hep@meta.data$Condition, allcells_hep@meta.data$pc15_res.0.5)
pheatmap::pheatmap(tab_cl_hep, scale = "column")

hep_donor_list = lapply(unique(allcells_hep_filt@meta.data$unique_name), 
                        function(x) allcells_hep_filt[,allcells_hep_filt@meta.data$unique_name==x])
names(hep_donor_list) = unique(allcells_hep_filt@meta.data$unique_name)

save(hep_donor_list, file = "data/processed/hep_donor_list.RData")
```



### Examine CSS output
Load data

```{r}
allcells_css = readRDS("data/processed/scripts_out/CSSIntegr_allcells_pc50_cssmk.RDS")

# load healthy data, which now contains annotations and can help here
hcells_css = readRDS("data/processed/hcells_css.RDS")
```

Add existing labels from healthy

```{r}
hmeta = hcells_css@meta.data[,c("names_clusters", "names_major", "unique_name")]
merge_umap = merge(allcells_css@reductions$umap_css@cell.embeddings, hmeta, 
                   by = 0, all = T)
print(dim(merge_umap))
merge_umap$names_clusters = as.character(merge_umap$names_clusters)
merge_umap$names_clusters[is.na(merge_umap$names_clusters)] = "No annot"
merge_umap$names_clusters = factor(merge_umap$names_clusters, 
                                   levels = c(levels(hcells_css@meta.data$names_clusters),
                                              "No annot"))
merge_umap = merge_umap[order(merge_umap$names_clusters, decreasing = T),]

merge_umap$names_major = as.character(merge_umap$names_major)
merge_umap$names_major[is.na(merge_umap$names_major)] = "No annot"
merge_umap$names_major = factor(merge_umap$names_major, 
                                   levels = c(levels(hcells_css@meta.data$names_major),
                                              "No annot"))
merge_umap = merge_umap[order(merge_umap$names_major, decreasing = T),]

png("results/integr_allcells/umap_allcells_css_healthy_clusters.png", 
    width = 650, height = 400)
ggplot(merge_umap, aes(x = UMAPCSS_1, y = UMAPCSS_2, colour = names_clusters))+
  geom_point(size = 0.25)+
  guides(colour = guide_legend(override.aes = list(size = 4), ncol = 1))+
  theme_classic()+
  theme(legend.position = "right")
dev.off()

png("results/integr_allcells/umap_allcells_css_healthy_major.png", 
    width = 510, height = 400)
ggplot(merge_umap, aes(x = UMAPCSS_1, y = UMAPCSS_2, colour = names_major))+
  geom_point(size = 0.25)+
  guides(colour = guide_legend(override.aes = list(size = 4), ncol = 1))+
  theme_classic()+
  theme(legend.position = "right")
dev.off()

rownames(merge_umap) = merge_umap$Row.names
allcells_css = AddMetaData(allcells_css, merge_umap[,c("names_clusters", "names_major")])
rm(hcells_css)
```

Cluster CSS results

```{r}
allcells_css = FindNeighbors(allcells_css, reduction = "css", 
                             dims = 1:ncol(Embeddings(allcells_css,"css")), 
                             force.recalc = T, graph.name = "cssAll")
allcells_css = FindClusters(allcells_css, algorithm = 2, verbose = F, graph.name = "cssAll",
                            resolution = seq(0.2, 1.5, 0.1))

umap_list = list()
for(i in seq(0.5, 1.5, 0.1)){
  n = paste0("res.",i)
  umap_list[[n]] = DimPlot(allcells_css, reduction = "umap_css", pt.size = 0.2, 
                           label = T, group.by = paste0("cssAll_", n)) + labs(title = n)
}
umap_list[["phase"]] = DimPlot(allcells_css, reduction = "umap_css", pt.size = 0.2, 
                               label = T, group.by = "Phase") + labs(title = "CC phase")

png("results/integr_allcells/css_umap_cluster.png", width = 1750, height = 850)
cowplot::plot_grid(plotlist = umap_list, ncol = 4, nrow = 3, align = "hv")
dev.off()
```

Check for annotated cells representation in clusters

```{r}
tab_cl = table(allcells_css@meta.data$cssAll_res.1.1, allcells_css@meta.data$names_clusters)
class(tab_cl) = "matrix"
tab_cl = t(t(tab_cl)/colSums(tab_cl))
pheatmap::pheatmap(tab_cl[,-ncol(tab_cl)], display_numbers = T)
```

Get markers for some clusters. We'll be using SCT-normalised data rather than integrated, given that the latter does not include all genes.  
THIS IS VERY SLOW (1 day)

```{r}
css_markers_sct_list = list()
for(i in c(0.6, 1.1)){
  n = paste0("res_", i)
  print(n)
  allcells_css = SetIdent(allcells_css, value = paste0("cssAll_res.", i))
  css_markers_sct_list[[n]] = FindAllMarkers(allcells_css, assay = "SCT", 
                                             test.use = "wilcox",
                                             pseudocount.use = 0.1, logfc.threshold = 0.2,
                                             max.cells.per.ident = 10000,
                                             min.cells.feature = 10,
                                             verbose = T)
}
saveRDS(css_markers_sct_list, file = "results/integr_allcells/css_mrk_sct_list.RDS")
```

Subclustering the LSEC

```{r}
cl = c(5)
sub_srat = allcells_css[,allcells_css@meta.data$cssAll_res.1.1 %in% cl]
#sub_srat = ScaleData(sub_srat, use.umi = T, vars.to.regress = c("nCount_SCT", "Donor"),
#                     do.scale = F, verbose = FALSE)
#sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, reduction = "css", 
                   dims = 1:ncol(Embeddings(sub_srat, "css")), verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "css", 
                         dims = 1:ncol(Embeddings(sub_srat, "css")), prune.SNN = 1/5,
                         force.recalc = T, graph.name = "endo_pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "endo_pc10",
                        resolution = seq(0.1, 1, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "endo_pc10_res.0.1")

png("results/integr_allcells/css_umap_cluster5_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "endo_pc10_res.0.1")
DefaultAssay(sub_srat) = "SCT"
mk_cl5 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                     pseudocount.use = 0.1, logfc.threshold = 0.2, 
                     verbose = T)
mk_cl5 = mk_cl5[mk_cl5$p_val_adj<=0.05,]
write.csv(x = mk_cl5, col.names = T, row.names = T, quote = F,
          file = "results/integr_allcells/css_cluster5_sub_markers.csv")

# create new labels (required for next step)
cl5_central = rownames(sub_srat@meta.data)[sub_srat@meta.data$endo_pc10_res.0.1==0]
cl5_portal = rownames(sub_srat@meta.data)[sub_srat@meta.data$endo_pc10_res.0.1==1]
allcell_cl = as.character(allcells_css@meta.data$cssAll_res.1.1)
allcell_cl[rownames(allcells_css@meta.data) %in% cl5_central] = "5_central"
allcell_cl[rownames(allcells_css@meta.data) %in% cl5_portal] = "5_portal"

# save data
saveRDS(sub_srat, file = "data/processed/sub_allcells_css_endo_srat.RDS")
```

Subclustering clusters 6, 22, and 26 (Lymphocytes)

```{r}
cl = c(6, 22, 26)
sub_srat = allcells_css[,allcells_css@meta.data$cssAll_res.1.1 %in% cl]
#sub_srat = ScaleData(sub_srat, use.umi = T, vars.to.regress = c("nCount_SCT", "Donor"),
#                     do.scale = F, verbose = FALSE)
#sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, reduction = "css", 
                   dims = 1:ncol(Embeddings(sub_srat, "css")), verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "css", 
                         dims = 1:ncol(Embeddings(sub_srat, "css")), prune.SNN = 1/5,
                         force.recalc = T, graph.name = "cl6_pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "cl6_pc10",
                        resolution = seq(0.1, 1, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "cl6_pc10_res.0.5")

png("results/integr_allcells/css_umap_cluster6_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "cl6_pc10_res.0.5")
DefaultAssay(sub_srat) = "SCT"
mk_cl6 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                     pseudocount.use = 0.1, logfc.threshold = 0.2, 
                     verbose = T)
mk_cl6 = mk_cl6[mk_cl6$p_val_adj<=0.05,]
write.csv(x = mk_cl6, col.names = T, row.names = T, quote = F,
          file = "results/integr_allcells/css_cluster6_sub_markers.csv")

# create new labels (required for next step)
cl6_abT = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl6_pc10_res.0.5 %in% c(0,2)]
cl6_gdT = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl6_pc10_res.0.5 %in% c(1,3)]
cl6_div = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl6_pc10_res.0.5 %in% c(7)]
cl6_B = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl6_pc10_res.0.5 %in% c(6)]
cl6_hepDou = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl6_pc10_res.0.5 %in% c(5,8)]
cl6_mac = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl6_pc10_res.0.5 %in% c(4)]

allcell_cl[rownames(allcells_css@meta.data) %in% cl6_abT] = "6_abT"
allcell_cl[rownames(allcells_css@meta.data) %in% cl6_gdT] = "6_gdT"
allcell_cl[rownames(allcells_css@meta.data) %in% cl6_div] = "6_div"
allcell_cl[rownames(allcells_css@meta.data) %in% cl6_B] = "6_B"
allcell_cl[rownames(allcells_css@meta.data) %in% cl6_hepDou] = "6_hepDou"
allcell_cl[rownames(allcells_css@meta.data) %in% cl6_mac] = "6_mac"

# save data
saveRDS(sub_srat, file = "data/processed/sub_allcells_css_cl6_srat.RDS")
```

Subclustering cluster 19

```{r}
cl = c(19)
sub_srat = allcells_css[,allcells_css@meta.data$cssAll_res.1.1 %in% cl]
#sub_srat = ScaleData(sub_srat, use.umi = T, vars.to.regress = c("nCount_SCT", "Donor"),
#                     do.scale = F, verbose = FALSE)
#sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, reduction = "css", 
                   dims = 1:ncol(Embeddings(sub_srat, "css")), verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "css", 
                         dims = 1:ncol(Embeddings(sub_srat, "css")), prune.SNN = 1/5,
                         force.recalc = T, graph.name = "cl19_pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "cl19_pc10",
                        resolution = seq(0.1, 1, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "cl19_pc10_res.0.2")

png("results/integr_allcells/css_umap_cluster19_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "cl19_pc10_res.0.2")
DefaultAssay(sub_srat) = "SCT"
mk_cl19 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                     pseudocount.use = 0.1, logfc.threshold = 0.2, 
                     verbose = T)
mk_cl19 = mk_cl19[mk_cl19$p_val_adj<=0.05,]
write.csv(x = mk_cl19, col.names = T, row.names = T, quote = F,
          file = "results/integr_allcells/css_cluster19_sub_markers.csv")

# create new labels (required for next step)
cl19_macAct = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl19_pc10_res.0.2==0]
cl19_macT = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl19_pc10_res.0.2==1]
cl19_kuend = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl19_pc10_res.0.2==2]

allcell_cl[rownames(allcells_css@meta.data) %in% cl19_macAct] = "19_macAct"
allcell_cl[rownames(allcells_css@meta.data) %in% cl19_macT] = "19_macT"
allcell_cl[rownames(allcells_css@meta.data) %in% cl19_kuend] = "19_kuend"

# save data
saveRDS(sub_srat, file = "data/processed/sub_allcells_css_cl19_srat.RDS")
```

Subclustering cluster 18

```{r}
cl = c(18)
sub_srat = allcells_css[,allcells_css@meta.data$cssAll_res.1.1 %in% cl]
#sub_srat = ScaleData(sub_srat, use.umi = T, vars.to.regress = c("nCount_SCT", "Donor"),
#                     do.scale = F, verbose = FALSE)
#sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, reduction = "css", 
                   dims = 1:ncol(Embeddings(sub_srat, "css")), verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "css", 
                         dims = 1:ncol(Embeddings(sub_srat, "css")), prune.SNN = 1/5,
                         force.recalc = T, graph.name = "cl18_pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "cl18_pc10",
                        resolution = seq(0.1, 1, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "cl18_pc10_res.0.1")

png("results/integr_allcells/css_umap_cluster18_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "cl18_pc10_res.0.1")
DefaultAssay(sub_srat) = "SCT"
mk_cl18 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                     pseudocount.use = 0.1, logfc.threshold = 0.2, 
                     verbose = T)
mk_cl18 = mk_cl18[mk_cl18$p_val_adj<=0.05,]
write.csv(x = mk_cl18, col.names = T, row.names = T, quote = F,
          file = "results/integr_allcells/css_cluster18_sub_markers.csv")

FeaturePlot(allcells_css, reduction = "umap_css",
            features = c("CD36", "VWF", "HAMP", "CYP3A4"))

# not adding anything, cells are a mix of endothelial cells, Kupffer cells, and Hepatocytes, will call doublets
```

Subclustering cluster 17 and 16

```{r}
cl = c(17, 16)
sub_srat = allcells_css[,allcells_css@meta.data$cssAll_res.1.1 %in% cl]
#sub_srat = ScaleData(sub_srat, use.umi = T, vars.to.regress = c("nCount_SCT", "Donor"),
#                     do.scale = F, verbose = FALSE)
#sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, reduction = "css", 
                   dims = 1:ncol(Embeddings(sub_srat, "css")), verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "css", 
                         dims = 1:ncol(Embeddings(sub_srat, "css")), prune.SNN = 1/5,
                         force.recalc = T, graph.name = "cl17_pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "cl17_pc10",
                        resolution = seq(0.1, 1, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "cl17_pc10_res.0.1")

png("results/integr_allcells/css_umap_cluster17_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "cl17_pc10_res.0.4")
DefaultAssay(sub_srat) = "SCT"
mk_cl17 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                     pseudocount.use = 0.1, logfc.threshold = 0.2, 
                     verbose = T)
mk_cl17 = mk_cl17[mk_cl17$p_val_adj<=0.05,]
write.csv(x = mk_cl17, col.names = T, row.names = T, quote = F,
          file = "results/integr_allcells/css_cluster17_sub_markers.csv")

# create new labels (required for next step)
cl17_hep1 = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl17_pc10_res.0.4 %in% c(0,5)]
cl17_hep2 = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl17_pc10_res.0.4 %in% c(6)]
cl16_hep1 = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl17_pc10_res.0.4 %in% c(1,3)]
cl16_myeDou = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl17_pc10_res.0.4 %in% c(2)]
cl16_endDou = rownames(sub_srat@meta.data)[sub_srat@meta.data$cl17_pc10_res.0.4 %in% c(4)]

allcell_cl[rownames(allcells_css@meta.data) %in% cl17_hep1] = "17_hep1"
allcell_cl[rownames(allcells_css@meta.data) %in% cl17_hep2] = "17_hep2"
allcell_cl[rownames(allcells_css@meta.data) %in% cl16_hep1] = "16_hep1"
allcell_cl[rownames(allcells_css@meta.data) %in% cl16_myeDou] = "16_myeDou"
allcell_cl[rownames(allcells_css@meta.data) %in% cl16_endDou] = "16_endDou"

# save data
saveRDS(sub_srat, file = "data/processed/sub_allcells_css_cl17_srat.RDS")
```

Now renaming

```{r}
names_clusters = ifelse(allcell_cl=="0", "Hepatocytes (midzone) 1", 
                        ifelse(allcell_cl=="1", "Hepatocytes (midzone) 2", 
                        ifelse(allcell_cl=="10", "Cholangiocytes 1", 
                        ifelse(allcell_cl=="11", "Hepatocytes (portal) 1", 
                        ifelse(allcell_cl=="12", "Hepatocytes (portal/midzone)", 
                        ifelse(allcell_cl=="13", "Macrophages", 
                        ifelse(allcell_cl=="14", "Hepatocytes (lipid/damage)",
                        ifelse(allcell_cl=="15", "Macrophage-Endothelial interaction",
                        ifelse(allcell_cl=="16_endDou", "Hepatocyte-Endothelial interaction", 
                        ifelse(allcell_cl=="16_myeDou", "Hepatocyte-Myeloid interaction", 
                        ifelse(allcell_cl=="16_hep1", "Hepatocytes (portal) 2", 
                        ifelse(allcell_cl=="17_hep1", "Hepatocytes (midzone) 3", 
                        ifelse(allcell_cl=="17_hep2", "Hepatocytes (central) 1", 
                        ifelse(allcell_cl=="18", "Kupffer-Endothelial interaction 1", 
                        ifelse(allcell_cl=="19_kuend", "Kupffer-Endothelial interaction 2", 
                        ifelse(allcell_cl=="19_macAct", "cDCs 2", 
                        ifelse(allcell_cl=="19_macT", "Macrophage-T cell interaction 1", 
                        ifelse(allcell_cl=="2", "Hepatocytes (portal) 3", 
                        ifelse(allcell_cl=="20", "Lymphoid-Endothelial interaction", 
                        ifelse(allcell_cl=="21", "Endothelial cells (non-LSEC)",
                        ifelse(allcell_cl=="23", "Plasmablasts", 
                        ifelse(allcell_cl=="24", "Cholangiocytes 2", 
                        ifelse(allcell_cl=="25", "pDCs", 
                        ifelse(allcell_cl=="27", "Hepatocytes (central) 2", 
                        ifelse(allcell_cl=="28", "Stellate cells", 
                        ifelse(allcell_cl=="3", "Hepatocytes (midzone) 4", 
                        ifelse(allcell_cl=="4", "Hepatocytes (central/detox)", 
                        ifelse(allcell_cl=="5_central", "LSEC pericentral", 
                        ifelse(allcell_cl=="5_portal", "LSEC periportal", 
                        ifelse(allcell_cl=="6_abT", "ab-T cells", 
                        ifelse(allcell_cl=="6_B", "B cells", 
                        ifelse(allcell_cl=="6_div", "Dividing cells",
                        ifelse(allcell_cl=="6_gdT", "gd-T cells",
                        ifelse(allcell_cl=="6_hepDou", "Hepatocyte-T cell interaction",
                        ifelse(allcell_cl=="6_mac", "Macrophage-T cell interaction 2",
                        ifelse(allcell_cl=="7", "cDCs 1",
                        ifelse(allcell_cl=="8", "Kupffer cells",
                        ifelse(allcell_cl=="9", "Hepatocytes (midzone) 5", "ERROR"
                        ))))))))))))))))))))))))))))))))))))))

names_simp = ifelse(allcell_cl=="0", "Hepatocytes (midzone)", 
                    ifelse(allcell_cl=="1", "Hepatocytes (midzone)", 
                    ifelse(allcell_cl=="10", "Cholangiocytes", 
                    ifelse(allcell_cl=="11", "Hepatocytes (portal)", 
                    ifelse(allcell_cl=="12", "Hepatocytes (portal/midzone)", 
                    ifelse(allcell_cl=="13", "Macrophages", 
                    ifelse(allcell_cl=="14", "Hepatocytes (lipid/damage)",
                    ifelse(allcell_cl=="15", "Macrophage-Endothelial interaction",
                    ifelse(allcell_cl=="16_endDou", "Hepatocyte-Endothelial interaction", 
                    ifelse(allcell_cl=="16_myeDou", "Hepatocyte-Myeloid interaction", 
                    ifelse(allcell_cl=="16_hep1", "Hepatocytes (portal)", 
                    ifelse(allcell_cl=="17_hep1", "Hepatocytes (midzone)", 
                    ifelse(allcell_cl=="17_hep2", "Hepatocytes (central)", 
                    ifelse(allcell_cl=="18", "Kupffer-Endothelial interaction", 
                    ifelse(allcell_cl=="19_kuend", "Kupffer-Endothelial interaction", 
                    ifelse(allcell_cl=="19_macAct", "cDCs", 
                    ifelse(allcell_cl=="19_macT", "Macrophage-T cell interaction", 
                    ifelse(allcell_cl=="2", "Hepatocytes (portal)", 
                    ifelse(allcell_cl=="20", "Lymphoid-Endothelial interaction", 
                    ifelse(allcell_cl=="21", "Endothelial cells (non-LSEC)",
                    ifelse(allcell_cl=="23", "Plasmablasts", 
                    ifelse(allcell_cl=="24", "Cholangiocytes", 
                    ifelse(allcell_cl=="25", "pDCs", 
                    ifelse(allcell_cl=="27", "Hepatocytes (central)", 
                    ifelse(allcell_cl=="28", "Stellate cells", 
                    ifelse(allcell_cl=="3", "Hepatocytes (midzone)", 
                    ifelse(allcell_cl=="4", "Hepatocytes (central/detox)", 
                    ifelse(allcell_cl=="5_central", "LSEC pericentral", 
                    ifelse(allcell_cl=="5_portal", "LSEC periportal", 
                    ifelse(allcell_cl=="6_abT", "ab-T cells", 
                    ifelse(allcell_cl=="6_B", "B cells", 
                    ifelse(allcell_cl=="6_div", "Dividing cells",
                    ifelse(allcell_cl=="6_gdT", "gd-T cells",
                    ifelse(allcell_cl=="6_hepDou", "Hepatocyte-T cell interaction",
                    ifelse(allcell_cl=="6_mac", "Macrophage-T cell interaction",
                    ifelse(allcell_cl=="7", "cDCs",
                    ifelse(allcell_cl=="8", "Kupffer cells",
                    ifelse(allcell_cl=="9", "Hepatocytes (midzone)", "ERROR"
                    ))))))))))))))))))))))))))))))))))))))

names_major = ifelse(allcell_cl=="0", "Hepatocytes", 
                        ifelse(allcell_cl=="1", "Hepatocytes", 
                        ifelse(allcell_cl=="10", "Cholangiocytes", 
                        ifelse(allcell_cl=="11", "Hepatocytes", 
                        ifelse(allcell_cl=="12", "Hepatocytes", 
                        ifelse(allcell_cl=="13", "Macrophages", 
                        ifelse(allcell_cl=="14", "Hepatocytes",
                        ifelse(allcell_cl=="15", "Doublets",
                        ifelse(allcell_cl=="16_endDou", "Doublets", 
                        ifelse(allcell_cl=="16_myeDou", "Doublets", 
                        ifelse(allcell_cl=="16_hep1", "Hepatocytes", 
                        ifelse(allcell_cl=="17_hep1", "Hepatocytes", 
                        ifelse(allcell_cl=="17_hep2", "Hepatocytes", 
                        ifelse(allcell_cl=="18", "Doublets", 
                        ifelse(allcell_cl=="19_kuend", "Doublets", 
                        ifelse(allcell_cl=="19_macAct", "DCs", 
                        ifelse(allcell_cl=="19_macT", "Doublets", 
                        ifelse(allcell_cl=="2", "Hepatocytes", 
                        ifelse(allcell_cl=="20", "Doublets", 
                        ifelse(allcell_cl=="21", "Endothelial cells",
                        ifelse(allcell_cl=="23", "B cells", 
                        ifelse(allcell_cl=="24", "Cholangiocytes", 
                        ifelse(allcell_cl=="25", "DCs", 
                        ifelse(allcell_cl=="27", "Hepatocytes", 
                        ifelse(allcell_cl=="28", "Stellate cells", 
                        ifelse(allcell_cl=="3", "Hepatocytes", 
                        ifelse(allcell_cl=="4", "Hepatocytes", 
                        ifelse(allcell_cl=="5_central", "Endothelial cells", 
                        ifelse(allcell_cl=="5_portal", "Endothelial cells", 
                        ifelse(allcell_cl=="6_abT", "T cells", 
                        ifelse(allcell_cl=="6_B", "B cells", 
                        ifelse(allcell_cl=="6_div", "Dividing cells",
                        ifelse(allcell_cl=="6_gdT", "T cells",
                        ifelse(allcell_cl=="6_hepDou", "Doublets",
                        ifelse(allcell_cl=="6_mac", "Doublets",
                        ifelse(allcell_cl=="7", "DCs",
                        ifelse(allcell_cl=="8", "Macrophages",
                        ifelse(allcell_cl=="9", "Hepatocytes", "ERROR"
                        ))))))))))))))))))))))))))))))))))))))

newmeta = data.frame(row.names = rownames(allcells_css@meta.data),
                     "allcell_clusters" = allcell_cl,
                     "allcells_clusters" = names_clusters,
                     "allcells_simp" = names_simp,
                     "allcells_major" = names_major, 
                     stringsAsFactors = F)

allcells_css = AddMetaData(allcells_css, metadata = newmeta)

# get markers for these clusters
allcells_css = SetIdent(allcells_css, value = "allcells_clusters")
mk_allcells_cl = FindAllMarkers(allcells_css, assay = "SCT", test.use = "wilcox",
                                pseudocount.use = 0.1, logfc.threshold = 0.2,
                                max.cells.per.ident = 10000, min.cells.feature = 10,
                                verbose = T)
write.csv(x = mk_allcells_cl, col.names = T, row.names = T, quote = F,
          file = "results/integr_allcells/css_allPops_markers.csv")
```

Also do a 1v1 DE

```{r}
allcells_css = SetIdent(allcells_css, value = "allcells_clusters")
allcomb = combn(unique(allcells_css@meta.data$allcells_clusters), 2)
mk_1v1_list = list()
for(i in 1:ncol(allcomb)){
  cl1 = allcomb[1,i]
  cl2 = allcomb[2,i]
  mk_1v1_list[[paste0(cl1, "_", cl2)]] = FindMarkers(allcells_css, 
                                                     ident.1 = cl1, ident.2 = cl2)
}

saveRDS(mk_1v1_list, file = "results/integr_allcells/css_1v1_de.RDS")
```

Plot markers for these populations

```{r}
mk_list = list("Hepatocytes (midzone) 1" = c("APOA4","LRG1","NNMT","MANF"), 
                "Hepatocytes (midzone) 2" = c("HAMP","CYP3A4","IL1RAP","PROX1"), 
                "Cholangiocytes 1" = c("KRT7","KRT19","CLDN10","EPCAM"), 
                "Hepatocytes (portal) 1" = c("APOA4","SAA2","SAA1","NNMT"), 
                "Hepatocytes (portal/midzone)" = c("HULC","PLA2G2A","APOC2","SAA4"), 
                "Macrophages" = c("S100A9","LYZ","CD52","APOBEC3A"), 
                "Hepatocytes (lipid/damage)" = c("CCL20","G0S2","SLC20A1","APOC2"),
                "Macrophage-Endothelial interaction" = c("S100A8","IL1B","LYVE1","CD34"),
                "Hepatocyte-Endothelial interaction" = c("CLEC4G","CD36","CYP1A2","APOB"),
                "Hepatocyte-Myeloid interaction" = c("CD74","MS4A6A","APOA4","CD4"), 
                "Hepatocytes (portal) 2" = c("MT-ND1","C3","FN1","MT-CO3"), 
                "Hepatocytes (midzone) 3" = c("BCHE","ALB","ARG1","ANGPTL3"), 
                "Hepatocytes (central) 1" = c("PLA2G2A","HULC","CXCL2","CYP2B6"), 
                "Kupffer-Endothelial interaction 1" = c("MARCO","CD5L","LYVE1","PECAM1"), 
                "Kupffer-Endothelial interaction 2" = c("VCAM1","LYVE1","CD5L","C1QB"), 
                "cDCs 2" = c("CLEC9A","IDO1","XCR1","IRF8"), 
                "Macrophage-T cell interaction 1" = c("S100A8","CD69","CCL5","TRAC"), 
                "Hepatocytes (portal) 3" = c("TFF3","SAA1","ASCL1","HAMP"), 
                "Lymphoid-Endothelial interaction" = c("IGHM","TRAC","LYVE1","CD36"), 
                "Endothelial cells (non-LSEC)" = c("NRP2","RAMP3","EMCN","EPHB4"),
                "Plasmablasts" = c("IGLC3","IGHM","CD79A","CD27"), 
                "Cholangiocytes 2" = c("KRT7","CD24","EPCAM","ANXA4"), 
                "pDCs" = c("CLEC4C","IL3RA","LILRA4","IRF8"), 
                "Hepatocytes (central) 2" = c("ANGPTL8","CYP3A4","CYP1A2","FGF21"), 
                "Stellate cells" = c("SPARC","DCN","COLEC11","ACTA2"), 
                "Hepatocytes (midzone) 4" = c("BCHE","HULC","APOC2","SAA4"), 
                "Hepatocytes (central/detox)" = c("MT1M","MT1F","SAA1","UGT2B17"), 
                "LSEC pericentral" = c("CLEC1B","CD14","CLEC4G","LYVE1"), 
                "LSEC periportal" = c("PECAM1","AQP1","VWF","CD34"), 
                "ab-T cells" = c("TRAC","CD3D","CD8A","ICOS"), 
                "B cells" = c("MS4A1","CD79A","IGHD","CD74"), 
                "Dividing cells" = c("HBB","MKI67","CDK1","TOP2A"),
                "gd-T cells" = c("TRDC","CCL3","GZMB","CD7"),
                "Hepatocyte-T cell interaction" = c("IGFBP2","C3","CD14","LYZ"),
                "Macrophage-T cell interaction 2" = c("CD14","GZMB","C1QB","MRC1"),
                "cDCs 1" = c("HLA-DQA1","FCER1A","CLEC10A","CD1C"),
                "Kupffer cells" = c("MARCO","CD5L","CD163","C1QA"),
                "Hepatocytes (midzone) 5" = c("APOA4","G0S2","FABP1","LRG1"))

plt_list = list()
plt_list[["all_clusters"]] = DimPlot(allcells_css, reduction = "umap_css", label = T,
                                     group.by = "allcells_clusters")+
  labs(title = "All clusters")+
  theme(legend.position = "none")
plt_list[["clusters_simp"]] = DimPlot(allcells_css, reduction = "umap_css", label = T,
                                       group.by = "allcells_simp")+
  labs(title = "Clusters simplified")+
  theme(legend.position = "none")
plt_list[["major_clusters"]] = DimPlot(allcells_css, reduction = "umap_css", label = T,
                                       group.by = "allcells_major")+
  labs(title = "Major clusters")+
  theme(legend.position = "none")

for(n in names(mk_list)){
  plt_list[[n]] = FeaturePlot(allcells_css, reduction = "umap_css", features = mk_list[[n]])
}

for(n in names(plt_list)){
  nn = gsub(" ", ".", gsub("/", ".", n))
  png(paste0("results/integr_allcells/css_markers_plots/", nn, "_umap.png"), 
      height = 1200, width = 1300)
  print(plt_list[[n]])
  dev.off()
}
```

And plot for the subclusters as well

```{r}
list_subs = list("endothelial" = "sub_allcells_css_endo_srat.RDS",
                 "lymphoid" = "sub_allcells_css_cl6_srat.RDS",
                 "macrophages" = "sub_allcells_css_cl19_srat.RDS",
                 "cl1617" = "sub_allcells_css_cl17_srat.RDS")

list_cls = list("endothelial" = c(28,29),
                "lymphoid" = 30:35,
                "macrophages" = 15:17,
                "cl1617" = 9:13)

for(n in names(list_subs)){
  srat_tcell = readRDS(paste0("data/processed/", list_subs[[n]]))
  plt_list = list()
  cls = list_cls[[n]]
  for(nn in names(mk_list)[cls]){
    plt_list[[nn]] = FeaturePlot(srat_tcell, reduction = "umap", features = mk_list[[nn]])
    nnn = gsub(" ", ".", gsub("/", ".", nn))
    png(paste0("results/integr_allcells/css_markers_plots/", n, "_", nnn, "_umap.png"), 
        height = 1200, width = 1300)
    print(plt_list[[nn]])
    dev.off()
  }
}
```

Proportions of annotations

```{r}
# healthy clusters representation
tab_cl = table(allcells_css@meta.data$allcells_clusters, allcells_css@meta.data$unique_name)
class(tab_cl) = "matrix"
tab_cl = t(t(tab_cl)/colSums(tab_cl))
annot_df = unique(allcells_css@meta.data[,c("unique_name", "Condition", "Fraction", "Donor")])
rownames(annot_df) = annot_df[,1]
annot_df = annot_df[,-1]
png(paste0("results/integr_allcells/css_markers_plots/all_vs_samples.png"), 
        height = 600, width = 1100)
pheatmap::pheatmap(t(tab_cl), display_numbers = T, clustering_method = "ward.D2", 
                   fontsize_number = 9, treeheight_row = 20, treeheight_col = 20,
                   annotation_row = annot_df, 
                   annotation_colors = list("Condition" = c("embolised" = "red", 
                                                           "regenerating" = "orange",  
                                                           "healthy" = "blue")))
dev.off()

# healthy clusters representation
tab_cl = table(allcells_css@meta.data$allcells_clusters, allcells_css@meta.data$names_clusters)
class(tab_cl) = "matrix"
tab_cl = t(t(tab_cl)/colSums(tab_cl))
png(paste0("results/integr_allcells/css_markers_plots/all_vs_helathy.png"), 
        height = 600, width = 1000)
pheatmap::pheatmap(t(tab_cl), display_numbers = T, clustering_method = "ward.D2", 
                   fontsize_number = 9, treeheight_row = 20, treeheight_col = 20)
dev.off()
```

Save Seurat object

```{r}
saveRDS(allcells_css, file = "data/processed/allcells_css.RDS")
```













---
title: "Data Integration"
output: html_notebook
---



# General Setup
Setup chunk

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8)
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_knit$get("root.dir")
```

Setup reticulate

```{r}
library(reticulate)
knitr::knit_engines$set(python = reticulate::eng_python)
py_available(initialize = FALSE)
use_python(Sys.which("python"))
py_config()
```

Load libraries

```{r}
library(Seurat)
library(ggplot2)
library(ggridges)
library(mixtools)
library(dplyr)
library(SoupX)
```



# Load data
Load prepared Seurat objects

```{r}
load(file = "data/processed/healthy_srat.RData")
load(file = "data/processed/cond_srat.RData")
load(file = "data/processed/frozen_srat.RData")
```



# Individual analysis
Analysing each dataset individually is important to understand what each contains  
Re-run scTransform, PCA, and nearest-neighbours on filtered data

```{r}
basicSeurat2 = function(obj, npcs = 60){
  # normalise and PCA-UMAP
  obj = suppressWarnings(SCTransform(obj, do.correct.umi = T, verbose = F,
                                     vars.to.regress = "nCount_RNA",
                                     variable.features.rv.th = 1,
                                     return.only.var.genes = F,
                                     variable.features.n = NULL, seed.use = 1))
  obj = RunPCA(obj, npcs = npcs, verbose = F)
  return(obj)
}

healthy_srat = lapply(healthy_srat, basicSeurat2)
cond_srat = lapply(cond_srat, basicSeurat2)
frozen_srat = lapply(frozen_srat, basicSeurat2)

healthy_elb = lapply(names(healthy_srat), 
                     function(x) ElbowPlot(healthy_srat[[x]], ndims = 50)+labs(title=x))
cond_elb = lapply(names(cond_srat), 
                     function(x) ElbowPlot(cond_srat[[x]], ndims = 50)+labs(title=x))
frozen_elb = lapply(names(frozen_srat), 
                     function(x) ElbowPlot(frozen_srat[[x]], ndims = 50)+labs(title=x))

pdf("results/clust_indiv/healthy_elbowplot.pdf", 
    height = 10, width = 8, useDingbats = F)
cowplot::plot_grid(plotlist = healthy_elb, nrow = 4, ncol = 2)
dev.off()

pdf("results/clust_indiv/cond_elbowplot.pdf", 
    height = 16, width = 16, useDingbats = F)
cowplot::plot_grid(plotlist = cond_elb, nrow = 7, ncol = 4)
dev.off()

pdf("results/clust_indiv/frozen_elbowplot.pdf", 
    height = 6, width = 6, useDingbats = F)
cowplot::plot_grid(plotlist = frozen_elb, nrow = 2, ncol = 2)
dev.off()
```

Check association of number of UMI and genes with PCA

```{r}
getPCcor = function(l){
  df_cor = data.frame("PC" = "A", "sample" = "A", "cor_gene" = 0, "cor_umi" = 0)
  for(n in names(l)){
    cor_gene = cor(l[[n]]$nFeature_RNA,
                   l[[n]]@reductions$pca@cell.embeddings)
    cor_umi = cor(l[[n]]$nCount_RNA,
                  l[[n]]@reductions$pca@cell.embeddings)
    df_cor = rbind(df_cor, data.frame("PC" = colnames(cor_gene),
                                      "sample" = n,
                                      "cor_gene" = cor_gene[1,],
                                      "cor_umi" = cor_umi[1,]))
  }
  df_cor = df_cor[-1,]
  df_cor$PC = factor(df_cor$PC, levels = paste0("PC_", 1:60))
  
  return(df_cor)
}
plotCors = function(df, var = "cor_gene", ncol = 7){
  plt = ggplot(df[df$PC %in% paste0("PC_", 1:50),], 
               aes_string(x = "PC", y = var))+
    facet_wrap(~sample, ncol = ncol)+
    geom_point(size = 0.8)+
    scale_y_continuous(labels = round(seq(-.6,.6,.2), 1), breaks = seq(-.6,.6,.2),
                       limits = c(-.65, .65))+
    theme_bw()+
    theme(axis.text.x = element_blank())
  
  return(plt)
}

df_cor_healthy = getPCcor(healthy_srat)
df_cor_cond = getPCcor(cond_srat)
df_cor_frozen = getPCcor(frozen_srat)

pdf("results/clust_indiv/healthy_pc_corNgenes.pdf", 
    height = 4, width = 7, useDingbats = F)
plotCors(df_cor_healthy, ncol = 4)
dev.off()

pdf("results/clust_indiv/cond_pc_corNgenes.pdf", 
    height = 9, width = 15, useDingbats = F)
plotCors(df_cor_cond)
dev.off()

pdf("results/clust_indiv/frozen_pc_corNgenes.pdf", 
    height = 2.5, width = 6, useDingbats = F)
plotCors(df_cor_frozen, ncol = 3)
dev.off()
```

Define number of PCs for each dataset (based on the elbow plot and data exploration)

```{r}
healthy_npcs = ifelse(grepl("hep", tolower(names(healthy_srat))), 15, 25)
names(healthy_npcs) = names(healthy_srat)

cond_npcs = c("sc_E1.HEP.Exp2" = 25, "sc_R1.HEP.Exp2" = 20, "sc_E5.HEP.Exp1" = 15,
              "sc_R5.HEP.Exp1" = 22, "sc_E5.NPC.Exp1" = 25, "sc_R5.NPC.Exp1" = 30,
              "sc_E6.HEP.Exp1" = 15, "sc_R6.HEP.Exp1" = 25, "sc_E6.NPC.Exp1" = 25,
              "sc_R6.NPC.Exp1" = 20, "sc_E7.HEP.Exp1" = 15, "sc_R7.HEP.Exp1" = 15,
              "sc_E7.NPC.Exp1" = 25, "sc_R7.NPC.Exp1" = 25, "sc_E1.HEP.Exp1" = 15, 
              "sc_R1.HEP.Exp1" = 20, "sc_E3.HEP.Exp1" = 15,
              "sc_E2.HEP.Exp1" = 20, "sc_R2.HEP.Exp1" = 20, "sc_R3.HEP.Exp1" = 15, 
              "sc_E3.NPC.Exp1" = 20, "sc_E2.NPC.Exp1" = 25, "sc_R2.NPC.Exp1" = 25,
              "sc_R3.NPC.Exp1" = 25, "sc_E1.NPC.Exp1" = 25, "sc_R1.NPC.Exp1" = 25)

frozen_npcs = rep(20, 3)
names(frozen_npcs) = names(frozen_srat)
```

Run FindNeighbors, UMAP, and FindClusters

```{r}
runSeuratClust = function(obj, npcs){
  obj = FindNeighbors(obj, dims = 1:npcs, force.recalc = T, verbose = F)
  obj = RunUMAP(obj, dims = 1:npcs, verbose = F)
  # resolution 10 is included to update the "very fine" clustering done in QC
  obj = FindClusters(obj, algorithm = 2, verbose = F, 
                     resolution = c(0.2, 0.5, seq(0.7, 1.1, 0.1), 1.5, 2, 10))
  
  return(obj)
}

for(n in names(healthy_srat)){
  healthy_srat[[n]] = runSeuratClust(healthy_srat[[n]], healthy_npcs[n])
}
for(n in names(cond_srat)){
  cond_srat[[n]] = runSeuratClust(cond_srat[[n]], cond_npcs[n])
}
for(n in names(frozen_srat)){
  frozen_srat[[n]] = runSeuratClust(frozen_srat[[n]], frozen_npcs[n])
}
```

Plot all resolutions on UMAP

```{r}
plotUMAPDim = function(obj, s){
  plt_list = list()
  cl_names = colnames(obj@meta.data)[grepl("SCT_snn", colnames(obj@meta.data))][-1]
  # doesn't include res = 10
  for(cl in cl_names){
  plt_list[[cl]] = DimPlot(object = obj, reduction = "umap",
                           group.by = cl, pt.size = 0.7)+
    labs(title = s, subtitle = cl)+
    theme(aspect.ratio = 1,
          title = element_text(size = 9),
          legend.position = "right")
  }
  
  plt = cowplot::plot_grid(plotlist = plt_list, ncol = 3, nrow = 3)
  return(plt)
}

for(n in names(healthy_srat)){
  pdf(paste0("results/clust_indiv/clustExp_UMAP/healthy_", n, "_clustExp_UMAP.pdf"), 
      height = 15, width = 16, useDingbats = F)
  print(plotUMAPDim(healthy_srat[[n]], n))
  dev.off()
}

for(n in names(cond_srat)){
  pdf(paste0("results/clust_indiv/clustExp_UMAP/cond_", n, "_clustExp_UMAP.pdf"), 
      height = 15, width = 16, useDingbats = F)
  print(plotUMAPDim(cond_srat[[n]], n))
  dev.off()
}

for(n in names(frozen_srat)){
  pdf(paste0("results/clust_indiv/clustExp_UMAP/frozen_", n, "_clustExp_UMAP.pdf"), 
      height = 15, width = 16, useDingbats = F)
  print(plotUMAPDim(frozen_srat[[n]], n))
  dev.off()
}
```

Choose the best resolution for each sample

```{r}
healthy_cl_use = c("sc_H1.EKS.Exp1" = 0.7, "sc_H2.HEP.Exp1" = 0.7, "sc_H3.HEP.Exp1" = 0.5,
                   "sc_H1.HEP.Exp1" = 0.5,"sc_H2.NPC.Exp1" = 0.7, "sc_H3.NPC.Exp1" = 0.5,
                   "sc_H1.NPC.Exp1" = 0.7)
cond_cl_use = c("sc_E5.HEP.Exp1" = 0.5, "sc_R5.HEP.Exp1" = 0.5, "sc_E5.NPC.Exp1" = 0.7,
                "sc_R5.NPC.Exp1" = 0.5, "sc_E6.HEP.Exp1" = 0.7, "sc_R6.HEP.Exp1" = 0.5,
                "sc_E6.NPC.Exp1" = 0.7, "sc_R6.NPC.Exp1" = 0.5, "sc_E7.HEP.Exp1" = 0.5,
                "sc_R7.HEP.Exp1" = 0.5, "sc_E7.NPC.Exp1" = 0.8, "sc_R7.NPC.Exp1" = 0.5,
                "sc_E1.HEP.Exp1" = 0.5, "sc_R1.HEP.Exp1" = 0.5, "sc_E3.HEP.Exp1" = 0.5,
                "sc_E2.HEP.Exp1" = 0.5, "sc_R2.HEP.Exp1" = 0.5, "sc_R3.HEP.Exp1" = 0.5,
                "sc_E3.NPC.Exp1" = 0.9, "sc_E2.NPC.Exp1" = 0.5, "sc_R2.NPC.Exp1" = 0.5,
                "sc_R3.NPC.Exp1" = 0.5, "sc_E1.NPC.Exp1" = 0.5, "sc_R1.NPC.Exp1" = 0.7,
                "sc_E1.HEP.Exp2" = 0.5, "sc_R1.HEP.Exp2" = 0.5)
frozen_cl_use = c("sn_H1.all.Exp1" = 0.8, "sn_H3.all.Exp1" = 0.9, "sn_H4.all.Exp1" = 0.7)
```

Get markers for those clusters. Will also be comparing FindMarkers with quickMarkers
(this whole block takes approx. 10h)

```{r}
getMarkersComp = function(l, v_cl){
  for(n in names(v_cl)){
    cat(paste0(n, " "))
    name_cl = paste0("SCT_snn_res.", v_cl[n])
    l[[n]] = SetIdent(l[[n]], value = name_cl)
    
    seurat_mk = FindAllMarkers(l[[n]], test.use = "wilcox", 
                               pseudocount.use = 0.1, logfc.threshold = 0.2, verbose = F)
    write.csv(seurat_mk, file = paste0("results/clust_indiv/clustExp_markers/", 
                                       n, "_", name_cl, "_wilcoxMarkers.csv"), 
              col.names = T, row.names = T, quote = F)
    
    soupx_mk = quickMarkers(l[[n]]@assays$SCT@counts,
                            l[[n]]@meta.data[,name_cl],
                            N = 300, FDR = 0.05)
    write.csv(soupx_mk, file = paste0("results/clust_indiv/clustExp_markers/", 
                                       n, "_", name_cl, "_tfidfMarkers.csv"), 
              col.names = T, row.names = T, quote = F)
  }
}

getMarkersComp(healthy_srat, healthy_cl_use)
getMarkersComp(cond_srat, cond_cl_use)
getMarkersComp(frozen_srat, frozen_cl_use)
```

## Saving final objects
Save objects

```{r}
save(healthy_srat, file = "data/processed/healthy_srat_indivclust.RData")
save(cond_srat, file = "data/processed/cond_srat_indivclust.RData")
save(frozen_srat, file = "data/processed/frozen_srat_indivclust.RData")
```



# Integrate datasets
Integration of large sets of data will be done in batch jobs given the time it takes to run.  

## Integrate all datasets
Integrate all cell datasets using different methods, using batch scripts  

Seurat Anchors CCA
  - Script: `run_SeuratIntegration_allcells.R`
  - Output: `data/processed/scripts_out/SeuratIntegr_allcells.RDS`
  
Seurat Anchors rPCA
  - Script: `run_SeuratIntegrationRPCA_allcells.R`
  - Output: `data/processed/scripts_out/SeuratIntegrRPCA_allcells.RDS`
  
Harmony
  - Script: `run_HarmonyIntegration_allcells.R`
  - Output: `data/processed/scripts_out/HarmIntegr_allcells.RDS`
  


```{r}
allcells_harm = readRDS("data/processed/scripts_out/HarmIntegr_allcells.RDS")
```


```{r}
plt30 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:30")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:10)
plt10 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:10")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:50)
plt50 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:50")
```



```{r}
DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
        split = "Fraction", group.by = "Name")
```



```{r}
FeaturePlot(allcells_harm, reduction = "umap", pt.size = 0.2,
            features = c("FGA", "PTPRC", "ANXA4", "CD34", "EPCAM", "C1QB",
                         "JCHAIN", "APOA1", "nFeature_RNA"))
```



```{r}
FeaturePlot(allcells_harm, reduction = "harmony", pt.size = 0.2,
            features = c("FGA", "PTPRC", "ANXA4", "CD34", "EPCAM", "C1QB",
                         "JCHAIN", "APOA1", "nFeature_RNA"))
```



```{r}
FeaturePlot(allcells_harm, reduction = "harmony", pt.size = 0.15, dims = c(1,2),
            features = c("FGA", "PTPRC", "ANXA4", "CD34"), split = "Fraction")
```



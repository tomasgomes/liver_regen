---
title: "Data Integration"
output: html_notebook
---



# General Setup
Setup chunk

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8)
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_knit$get("root.dir")
```

Setup reticulate

```{r}
library(reticulate)
knitr::knit_engines$set(python = reticulate::eng_python)
py_available(initialize = FALSE)
use_python(Sys.which("python"))
py_config()
```

Load libraries

```{r}
library(Seurat)
library(ggplot2)
library(ggridges)
library(mixtools)
library(dplyr)
library(SoupX)
library(harmony)
```



# Load data
Load prepared Seurat objects

```{r}
load(file = "data/processed/healthy_srat.RData")
load(file = "data/processed/cond_srat.RData")
load(file = "data/processed/frozen_srat.RData")
```



# Individual analysis
Analysing each dataset individually is important to understand what each contains  
Re-run scTransform, PCA, and nearest-neighbours on filtered data

```{r}
basicSeurat2 = function(obj, npcs = 60){
  # normalise and PCA-UMAP
  obj = suppressWarnings(SCTransform(obj, do.correct.umi = T, verbose = F,
                                     vars.to.regress = "nCount_RNA",
                                     variable.features.rv.th = 1, 
                                     return.only.var.genes = F,
                                     variable.features.n = NULL, seed.use = 1))
  obj = RunPCA(obj, npcs = npcs, verbose = F)
  return(obj)
}

healthy_srat = lapply(healthy_srat, basicSeurat2)
cond_srat = lapply(cond_srat, basicSeurat2)
frozen_srat = lapply(frozen_srat, basicSeurat2)

healthy_elb = lapply(names(healthy_srat), 
                     function(x) ElbowPlot(healthy_srat[[x]], ndims = 50)+labs(title=x))
cond_elb = lapply(names(cond_srat), 
                     function(x) ElbowPlot(cond_srat[[x]], ndims = 50)+labs(title=x))
frozen_elb = lapply(names(frozen_srat), 
                     function(x) ElbowPlot(frozen_srat[[x]], ndims = 50)+labs(title=x))

pdf("results/clust_indiv/healthy_elbowplot.pdf", 
    height = 10, width = 8, useDingbats = F)
cowplot::plot_grid(plotlist = healthy_elb, nrow = 4, ncol = 2)
dev.off()

pdf("results/clust_indiv/cond_elbowplot.pdf", 
    height = 16, width = 16, useDingbats = F)
cowplot::plot_grid(plotlist = cond_elb, nrow = 7, ncol = 4)
dev.off()

pdf("results/clust_indiv/frozen_elbowplot.pdf", 
    height = 6, width = 6, useDingbats = F)
cowplot::plot_grid(plotlist = frozen_elb, nrow = 2, ncol = 2)
dev.off()
```

Check association of number of UMI and genes with PCA

```{r}
getPCcor = function(l){
  df_cor = data.frame("PC" = "A", "sample" = "A", "cor_gene" = 0, "cor_umi" = 0)
  for(n in names(l)){
    cor_gene = cor(l[[n]]$nFeature_RNA,
                   l[[n]]@reductions$pca@cell.embeddings)
    cor_umi = cor(l[[n]]$nCount_RNA,
                  l[[n]]@reductions$pca@cell.embeddings)
    df_cor = rbind(df_cor, data.frame("PC" = colnames(cor_gene),
                                      "sample" = n,
                                      "cor_gene" = cor_gene[1,],
                                      "cor_umi" = cor_umi[1,]))
  }
  df_cor = df_cor[-1,]
  df_cor$PC = factor(df_cor$PC, levels = paste0("PC_", 1:60))
  
  return(df_cor)
}
plotCors = function(df, var = "cor_gene", ncol = 7){
  plt = ggplot(df[df$PC %in% paste0("PC_", 1:50),], 
               aes_string(x = "PC", y = var))+
    facet_wrap(~sample, ncol = ncol)+
    geom_point(size = 0.8)+
    scale_y_continuous(labels = round(seq(-.6,.6,.2), 1), breaks = seq(-.6,.6,.2),
                       limits = c(-.65, .65))+
    theme_bw()+
    theme(axis.text.x = element_blank())
  
  return(plt)
}

df_cor_healthy = getPCcor(healthy_srat)
df_cor_cond = getPCcor(cond_srat)
df_cor_frozen = getPCcor(frozen_srat)

pdf("results/clust_indiv/healthy_pc_corNgenes.pdf", 
    height = 4, width = 7, useDingbats = F)
plotCors(df_cor_healthy, ncol = 4)
dev.off()

pdf("results/clust_indiv/cond_pc_corNgenes.pdf", 
    height = 9, width = 15, useDingbats = F)
plotCors(df_cor_cond)
dev.off()

pdf("results/clust_indiv/frozen_pc_corNgenes.pdf", 
    height = 2.5, width = 6, useDingbats = F)
plotCors(df_cor_frozen, ncol = 3)
dev.off()
```

Define number of PCs for each dataset (based on the elbow plot and data exploration)

```{r}
healthy_npcs = ifelse(grepl("hep", tolower(names(healthy_srat))), 15, 25)
names(healthy_npcs) = names(healthy_srat)

cond_npcs = c("sc_E1.HEP.Exp2" = 25, "sc_R1.HEP.Exp2" = 20, "sc_E5.HEP.Exp1" = 15,
              "sc_R5.HEP.Exp1" = 22, "sc_E5.NPC.Exp1" = 25, "sc_R5.NPC.Exp1" = 30,
              "sc_E6.HEP.Exp1" = 15, "sc_R6.HEP.Exp1" = 25, "sc_E6.NPC.Exp1" = 25,
              "sc_R6.NPC.Exp1" = 20, "sc_E7.HEP.Exp1" = 15, "sc_R7.HEP.Exp1" = 15,
              "sc_E7.NPC.Exp1" = 25, "sc_R7.NPC.Exp1" = 25, "sc_E1.HEP.Exp1" = 15, 
              "sc_R1.HEP.Exp1" = 20, "sc_E3.HEP.Exp1" = 15,
              "sc_E2.HEP.Exp1" = 20, "sc_R2.HEP.Exp1" = 20, "sc_R3.HEP.Exp1" = 15, 
              "sc_E3.NPC.Exp1" = 20, "sc_E2.NPC.Exp1" = 25, "sc_R2.NPC.Exp1" = 25,
              "sc_R3.NPC.Exp1" = 25, "sc_E1.NPC.Exp1" = 25, "sc_R1.NPC.Exp1" = 25)

frozen_npcs = rep(20, 3)
names(frozen_npcs) = names(frozen_srat)
```

Run FindNeighbors, UMAP, and FindClusters

```{r}
runSeuratClust = function(obj, npcs){
  obj = FindNeighbors(obj, dims = 1:npcs, force.recalc = T, verbose = F)
  obj = RunUMAP(obj, dims = 1:npcs, verbose = F)
  # resolution 10 is included to update the "very fine" clustering done in QC
  obj = FindClusters(obj, algorithm = 2, verbose = F, 
                     resolution = c(0.2, 0.5, seq(0.7, 1.1, 0.1), 1.5, 2, 10))
  
  return(obj)
}

for(n in names(healthy_srat)){
  healthy_srat[[n]] = runSeuratClust(healthy_srat[[n]], healthy_npcs[n])
}
for(n in names(cond_srat)){
  cond_srat[[n]] = runSeuratClust(cond_srat[[n]], cond_npcs[n])
}
for(n in names(frozen_srat)){
  frozen_srat[[n]] = runSeuratClust(frozen_srat[[n]], frozen_npcs[n])
}
```

Plot all resolutions on UMAP

```{r}
plotUMAPDim = function(obj, s){
  plt_list = list()
  cl_names = colnames(obj@meta.data)[grepl("SCT_snn", colnames(obj@meta.data))][-1]
  # doesn't include res = 10
  for(cl in cl_names){
  plt_list[[cl]] = DimPlot(object = obj, reduction = "umap",
                           group.by = cl, pt.size = 0.7)+
    labs(title = s, subtitle = cl)+
    theme(aspect.ratio = 1,
          title = element_text(size = 9),
          legend.position = "right")
  }
  
  plt = cowplot::plot_grid(plotlist = plt_list, ncol = 3, nrow = 3)
  return(plt)
}

for(n in names(healthy_srat)){
  pdf(paste0("results/clust_indiv/clustExp_UMAP/healthy_", n, "_clustExp_UMAP.pdf"), 
      height = 15, width = 16, useDingbats = F)
  print(plotUMAPDim(healthy_srat[[n]], n))
  dev.off()
}

for(n in names(cond_srat)){
  pdf(paste0("results/clust_indiv/clustExp_UMAP/cond_", n, "_clustExp_UMAP.pdf"), 
      height = 15, width = 16, useDingbats = F)
  print(plotUMAPDim(cond_srat[[n]], n))
  dev.off()
}

for(n in names(frozen_srat)){
  pdf(paste0("results/clust_indiv/clustExp_UMAP/frozen_", n, "_clustExp_UMAP.pdf"), 
      height = 15, width = 16, useDingbats = F)
  print(plotUMAPDim(frozen_srat[[n]], n))
  dev.off()
}
```

Choose the best resolution for each sample

```{r}
healthy_cl_use = c("sc_H1.EKS.Exp1" = 0.7, "sc_H2.HEP.Exp1" = 0.7, "sc_H3.HEP.Exp1" = 0.5,
                   "sc_H1.HEP.Exp1" = 0.5,"sc_H2.NPC.Exp1" = 0.7, "sc_H3.NPC.Exp1" = 0.5,
                   "sc_H1.NPC.Exp1" = 0.7)
cond_cl_use = c("sc_E5.HEP.Exp1" = 0.5, "sc_R5.HEP.Exp1" = 0.5, "sc_E5.NPC.Exp1" = 0.7,
                "sc_R5.NPC.Exp1" = 0.5, "sc_E6.HEP.Exp1" = 0.7, "sc_R6.HEP.Exp1" = 0.5,
                "sc_E6.NPC.Exp1" = 0.7, "sc_R6.NPC.Exp1" = 0.5, "sc_E7.HEP.Exp1" = 0.5,
                "sc_R7.HEP.Exp1" = 0.5, "sc_E7.NPC.Exp1" = 0.8, "sc_R7.NPC.Exp1" = 0.5,
                "sc_E1.HEP.Exp1" = 0.5, "sc_R1.HEP.Exp1" = 0.5, "sc_E3.HEP.Exp1" = 0.5,
                "sc_E2.HEP.Exp1" = 0.5, "sc_R2.HEP.Exp1" = 0.5, "sc_R3.HEP.Exp1" = 0.5,
                "sc_E3.NPC.Exp1" = 0.9, "sc_E2.NPC.Exp1" = 0.5, "sc_R2.NPC.Exp1" = 0.5,
                "sc_R3.NPC.Exp1" = 0.5, "sc_E1.NPC.Exp1" = 0.5, "sc_R1.NPC.Exp1" = 0.7,
                "sc_E1.HEP.Exp2" = 0.5, "sc_R1.HEP.Exp2" = 0.5)
frozen_cl_use = c("sn_H1.all.Exp1" = 0.8, "sn_H3.all.Exp1" = 0.9, "sn_H4.all.Exp1" = 0.7)
```

Get markers for those clusters. Will also be comparing FindMarkers with quickMarkers
(this whole block takes approx. 10h)

```{r}
getMarkersComp = function(l, v_cl){
  for(n in names(v_cl)){
    cat(paste0(n, " "))
    name_cl = paste0("SCT_snn_res.", v_cl[n])
    l[[n]] = SetIdent(l[[n]], value = name_cl)
    
    seurat_mk = FindAllMarkers(l[[n]], test.use = "wilcox", 
                               pseudocount.use = 0.1, logfc.threshold = 0.2, verbose = F)
    write.csv(seurat_mk, file = paste0("results/clust_indiv/clustExp_markers/", 
                                       n, "_", name_cl, "_wilcoxMarkers.csv"), 
              col.names = T, row.names = T, quote = F)
    
    soupx_mk = quickMarkers(l[[n]]@assays$SCT@counts,
                            l[[n]]@meta.data[,name_cl],
                            N = 300, FDR = 0.05)
    write.csv(soupx_mk, file = paste0("results/clust_indiv/clustExp_markers/", 
                                       n, "_", name_cl, "_tfidfMarkers.csv"), 
              col.names = T, row.names = T, quote = F)
  }
}

getMarkersComp(healthy_srat, healthy_cl_use)
getMarkersComp(cond_srat, cond_cl_use)
getMarkersComp(frozen_srat, frozen_cl_use)
```

## Saving final objects
Save objects

```{r}
save(healthy_srat, file = "data/processed/healthy_srat_indivclust.RData")
save(cond_srat, file = "data/processed/cond_srat_indivclust.RData")
save(frozen_srat, file = "data/processed/frozen_srat_indivclust.RData")
```



# Integrate datasets
Integration of large sets of data will be done in batch jobs given the time it takes to run. 

## Integrate healthy datasets
Integrate all cell datasets using different methods, using batch scripts 

Seurat Anchors rPCA
  - Script: `run_SeuratIntegrationRPCA_allhealthy.R`
  - Output: `data/processed/scripts_out/SeuratIntegrRPCA_allhealthy.RDS`
  
Harmony
  - Script: `run_HarmonyIntegration_allhealthy.R`
  - Output: `data/processed/scripts_out/HarmIntegr_allhealthy.RDS`



### Examine Harmony output
Load data

```{r}
hcells_harm = readRDS("data/processed/scripts_out/HarmIntegr_allhealthy.RDS")
```

Checking how using different numbers of dimensions affects UMAP structure

```{r}
plt10 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:10")
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:20, verbose = F)
plt20 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:20")
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:25, verbose = F)
plt25 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:25")
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:30, verbose = F)
plt30 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:30")
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:40, verbose = F)
plt40 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:40")
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:50, verbose = F)
plt50 = DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:50")

png("results/integr_healthy/harmony_umap_dims.png", width = 1200, height = 600)
cowplot::plot_grid(plt10, plt20, plt25, plt30, plt40, plt50, ncol = 3, nrow = 2, align = "h")
dev.off()
```

Run UMAP with chosen number of dimensions

```{r}
hcells_harm = RunUMAP(hcells_harm, reduction = "harmony", dims = 1:25, verbose = F)
DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, group.by = "Fraction")
```

How do the different fractions and donors split in the UMAP

```{r}
png("results/integr_healthy/harmony_umap50_FracDonor.png", width = 900, height = 300)
DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, 
        split = "Fraction", group.by = "Name")
dev.off()
```

Plotting general markers

```{r}
png("results/integr_healthy/harmony_umap50_genMarkers.png", width = 960, height = 900)
FeaturePlot(hcells_harm, reduction = "umap", pt.size = 0.2,
            features = c("FGA", "PTPRC", "ANXA4", "CD34", "EPCAM", "C1QB",
                         "JCHAIN", "APOA1", "nFeature_RNA"))
dev.off()
```

Cluster harmony results

```{r}
hcells_harm = FindNeighbors(hcells_harm, reduction = "harmony", dims = 1:25, force.recalc = T)
hcells_harm = FindClusters(hcells_harm, algorithm = 2, verbose = F,
                           resolution = seq(0.2, 1.1, 0.1))
DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, label = T,
        group.by = "SCT_snn_res.0.9")
```

Harmony seems to put a lot more cells from the HEP fractions together with the NPC fractions. To understand where these cells come from, and whether the same effect can be seen in the Seurat integration, we'll be checking the individual samples and take note which ones would be originally hepatocytes
Load data (if necessary)

```{r}
load(file = "data/processed/healthy_srat_indivclust.RData")
```

For HEP samples, identify cells belonging to the hepatocyte cluster. This is important to understand the merging between fractions

```{r}
healthy_cl_use = c("sc_H1.EKS.Exp1" = 0.7, "sc_H2.HEP.Exp1" = 0.7, "sc_H3.HEP.Exp1" = 0.5,
                   "sc_H1.HEP.Exp1" = 0.5,"sc_H2.NPC.Exp1" = 0.7, "sc_H3.NPC.Exp1" = 0.5,
                   "sc_H1.NPC.Exp1" = 0.7)
cl_hep = list(c(3), c(0:7), c(0:5), c(0:5, 8, 10), c(8), c(6), c(8))
names(cl_hep) = names(healthy_cl_use)

DimPlot(healthy_srat$sc_H2.HEP.Exp1, reduction = "umap", 
        group.by = "SCT_snn_res.0.7", label = T)
#FeaturePlot(healthy_srat$sc_H1.NPC.Exp1, reduction = "umap", features = "FGA")

cells_nothep = list()
for(n in names(cl_hep)){
  cl = paste0("SCT_snn_res.", healthy_cl_use[n])
  ishep = healthy_srat[[n]]@meta.data[,cl] %in% cl_hep[[n]]
  cells_nothep[[n]] = paste0(n, "_", rownames(healthy_srat[[n]]@meta.data)[!ishep])
}
```

Check where non-hepatocytes are

```{r}
df_nothep = data.frame(row.names = colnames(hcells_harm),
                       "nothep" = colnames(hcells_harm) %in% unlist(cells_nothep))

hcells_harm = AddMetaData(hcells_harm, df_nothep)

DimPlot(hcells_harm, reduction = "umap", pt.size = 0.2, label = F,
        group.by = "nothep", split = "Fraction")+geom_hline(yintercept = 3, linetype = "dashed")
```

Lets now examine the cells that are not grouped with the large hepatocyte cluster

```{r}
lower_cells = rownames(hcells_harm@reductions$umap@cell.embeddings)[hcells_harm@reductions$umap@cell.embeddings[,2]<3]

df_lower = data.frame(row.names = colnames(hcells_harm),
                      "lowercells" = colnames(hcells_harm) %in% lower_cells)
df_lower$ds = unlist(lapply(strsplit(rownames(df_lower), "_", fixed = T), 
                            function(x) paste0(x[1:2], collapse = "_")))
n = "sc_H2.HEP.Exp1"
df_lower = df_lower[df_lower$ds==n,]
rownames(df_lower) = unlist(lapply(strsplit(rownames(df_lower), "_"), function(x) x[3]))
test = AddMetaData(healthy_srat[[n]], df_lower)
DimPlot(test, reduction = "umap", pt.size = 0.2, label = F,
        group.by = "lowercells")
```

As can be seen, these cells still come from the hepatocyte cluster. A look at the markers from the corresponding clusters also revealed hepatocyte genes. In sum, this means that harmony is failing at least some of the integration  
Lets see if the same effect can be seen with the Seurat integration. Load data

```{r}
hcells_rpca = readRDS("data/processed/scripts_out/SeuratIntegrRPCA_allhealthy.RDS")
```

Look at fraction distribution

```{r}
DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
        split = "Fraction", group.by = "Name")
```

Look at how the hepatocytes are distributed

```{r}
cc = unlist(cells_nothep)
for(x in 1:length(cc)){
  nn = paste0(unlist(strsplit(cc[x], "_", fixed = T))[1:2], collapse = "_")
  cell = unlist(strsplit(cc[x], "_", fixed = T))[3]
  cc[x] = paste0(cell, "_", which(names(healthy_srat)==nn))
}
df_nothep = data.frame(row.names = colnames(hcells_rpca),
                       "nothep" = colnames(hcells_rpca) %in% cc)

hcells_rpca = AddMetaData(hcells_rpca, df_nothep)

DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, label = F,
        group.by = "nothep", split = "Fraction")
```

And the non-hepatocyte cells in the harmony integration

```{r}
cc = unlist(lower_cells)
for(x in 1:length(cc)){
  nn = paste0(unlist(strsplit(cc[x], "_", fixed = T))[1:2], collapse = "_")
  cell = unlist(strsplit(cc[x], "_", fixed = T))[3]
  cc[x] = paste0(cell, "_", which(names(healthy_srat)==nn))
}
df_nothep = data.frame(row.names = colnames(hcells_rpca),
                       "lowercells" = colnames(hcells_rpca) %in% cc)

hcells_rpca = AddMetaData(hcells_rpca, df_nothep)

DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, label = F,
        group.by = "lowercells", split = "Fraction")
```

So we can see that those cells are separate, but still close to the large hepatocyte cluster, which should make this a better integration.



### Examine Seurat output
Load data

```{r}
hcells_rpca = readRDS("data/processed/scripts_out/SeuratIntegrRPCA_allhealthy.RDS")
```

Checking how using different numbers of dimensions affects UMAP structure

```{r}
hcells_rpca = RunUMAP(hcells_rpca, dims = 1:30, verbose = F)
plt30 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:30")

hcells_rpca = RunUMAP(hcells_rpca, dims = 1:20, verbose = F)
plt20 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:20")

hcells_rpca = RunUMAP(hcells_rpca, dims = 1:25, verbose = F)
plt25 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:25")

hcells_rpca = RunUMAP(hcells_rpca, dims = 1:10, verbose = F)
plt10 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:10")

hcells_rpca = RunUMAP(hcells_rpca, dims = 1:40, verbose = F)
plt40 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:40")

hcells_rpca = RunUMAP(hcells_rpca, dims = 1:50, verbose = F)
plt50 = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with 1:50")

png("results/integr_healthy/seurat_umap_dims.png", width = 1200, height = 600)
cowplot::plot_grid(plt10, plt20, plt25, plt30, plt40, plt50, ncol = 3, nrow = 2, align = "h")
dev.off()
```

Checking how using different numbers of dimensions affects t-SNE structure

```{r}
hcells_rpca = RunTSNE(hcells_rpca, dims = 1:30, verbose = F, perplexity = 25)
plt30 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:30")

hcells_rpca = RunTSNE(hcells_rpca, dims = 1:20, verbose = F, perplexity = 25)
plt20 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:20")

hcells_rpca = RunTSNE(hcells_rpca, dims = 1:25, verbose = F, perplexity = 25)
plt25 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:25")

hcells_rpca = RunTSNE(hcells_rpca, dims = 1:10, verbose = F, perplexity = 25)
plt10 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:10")

hcells_rpca = RunTSNE(hcells_rpca, dims = 1:40, verbose = F, perplexity = 25)
plt40 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:40")

hcells_rpca = RunTSNE(hcells_rpca, dims = 1:50, verbose = F, perplexity = 25)
plt50 = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "t-SNE with 1:50")

png("results/integr_healthy/seurat_tsne_dims.png", width = 1200, height = 600)
cowplot::plot_grid(plt10, plt20, plt25, plt30, plt40, plt50, ncol = 3, nrow = 2, align = "h")
dev.off()
```

Choose final dimensions

```{r}
hcells_rpca = RunUMAP(hcells_rpca, dims = 1:40, verbose = F)
hcells_rpca = RunTSNE(hcells_rpca, dims = 1:40, verbose = F, perplexity = 25)
```

Plot fractions and donors

```{r}
png("results/integr_healthy/seurat_umap50_FracDonor.png", width = 900, height = 300)
DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
        split = "Fraction", group.by = "Name")
dev.off()
```

Cluster Seurat results

```{r}
hcells_rpca = FindNeighbors(hcells_rpca, reduction = "pca", dims = 1:40, 
                            force.recalc = T, graph.name = "pc40")
hcells_rpca = FindClusters(hcells_rpca, algorithm = 2, verbose = F, graph.name = "pc40",
                           resolution = seq(0.1, 1.1, 0.1))

hcells_rpca = FindNeighbors(hcells_rpca, reduction = "pca", dims = 1:25, 
                            force.recalc = T, graph.name = "pc25")
hcells_rpca = FindClusters(hcells_rpca, algorithm = 2, verbose = F, graph.name = "pc25",
                           resolution = seq(0.1, 1.1, 0.1))

umap_list = list()
tsne_list = list()
for(i in seq(0.3, 0.9, 0.1)){
  n = paste0("res.",i)
  umap_list[[n]] = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                           label = T, group.by = paste0("pc40_", n)) + labs(title = n)
  tsne_list[[n]] = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                           label = T, group.by = paste0("pc40_", n)) + labs(title = n)
}
umap_list[["phase"]] = DimPlot(hcells_rpca, reduction = "umap", pt.size = 0.2, 
                               label = T, group.by = "Phase") + labs(title = "CC phase")
tsne_list[["phase"]] = DimPlot(hcells_rpca, reduction = "tsne", pt.size = 0.2, 
                               label = T, group.by = "Phase") + labs(title = "CC phase")


png("results/integr_healthy/seurat_tsne_cluster.png", width = 1600, height = 700)
cowplot::plot_grid(plotlist = tsne_list, ncol = 4, nrow = 2, align = "hv")
dev.off()
png("results/integr_healthy/seurat_umap_cluster.png", width = 1600, height = 700)
cowplot::plot_grid(plotlist = umap_list, ncol = 4, nrow = 2, align = "hv")
dev.off()
```

Get markers for some clusters. We'll be using SCT-normalised data rather than integrated, given that the latter does not include all genes.  
THIS IS VERY SLOW (1 day)

```{r}
markers_sct_list = list()
#markers_int_list = list()
for(i in seq(0.3, 0.9, 0.1)){
  n = paste0("res_", i)
  print(n)
  hcells_rpca = SetIdent(hcells_rpca, value = paste0("pc40_res.", i))
  markers_sct_list[[n]] = FindAllMarkers(hcells_rpca, assay = "SCT", test.use = "wilcox",
                                         pseudocount.use = 0.1, logfc.threshold = 0.2, 
                                         verbose = F)
  #markers_int_list[[n]] = FindAllMarkers(hcells_rpca, assay = "integrated", 
  #                                       test.use = "wilcox", pseudocount.use = 0.1, 
  #                                       logfc.threshold = 0.2, verbose = F)
}
saveRDS(markers_sct_list, file = "results/integr_healthy/mrk_sct_list.RDS")
#saveRDS(markers_int_list, file = "results/integr_healthy/mrk_int_list.RDS")
```

Specific one on one comparisons

```{r}
hcells_rpca = SetIdent(hcells_rpca, value = "pc40_res.0.7")
markers_1v1_list = list()

cl_comb = combn(c("14", "20", "21"), 2)
for(i in 1:ncol(cl_comb)){
  n = paste0(cl_comb[1,i], "vs", cl_comb[2,i])
  markers_1v1_list[[n]] = FindMarkers(hcells_rpca, assay = "SCT", test.use = "wilcox",
                                      ident.1 = cl_comb[1,i], ident.2 = cl_comb[2,i], 
                                      pseudocount.use = 0.1, logfc.threshold = 0.2, 
                                      verbose = F)
}

cl_comb = combn(c("2", "12", "13", "16"), 2)
for(i in 1:ncol(cl_comb)){
  n = paste0(cl_comb[1,i], "vs", cl_comb[2,i])
  markers_1v1_list[[n]] = FindMarkers(hcells_rpca, assay = "SCT", test.use = "wilcox",
                                      ident.1 = cl_comb[1,i], ident.2 = cl_comb[2,i], 
                                      pseudocount.use = 0.1, logfc.threshold = 0.2, 
                                      verbose = F)
}

cl_comb = combn(c("16", "17", "19"), 2)
for(i in 1:ncol(cl_comb)){
  n = paste0(cl_comb[1,i], "vs", cl_comb[2,i])
  markers_1v1_list[[n]] = FindMarkers(hcells_rpca, assay = "SCT", test.use = "wilcox",
                                      ident.1 = cl_comb[1,i], ident.2 = cl_comb[2,i], 
                                      pseudocount.use = 0.1, logfc.threshold = 0.2, 
                                      verbose = F)
}
```

Plotting hepatocyte zonation markers

```{r}
gfresh=c("CYP3A4", "CYP2E1", "GADD45G", "CYP1A2", "GLUL", "HAMP", "SAA2", "SAA1", "CRP", "NNMT", "IGFBP2", "KLF6")
hep_cells = hcells_rpca[,hcells_rpca@meta.data$names_major=="Hepatocytes"]
VlnPlot(hep_cells, features = gfresh, group.by = "names_clusters", 
        pt.size = 0, sort = "increasing")
hep_cells = FindVariableFeatures(hep_cells, verbose = F)
hep_cells = RunPCA(hep_cells, verbose = F)
hep_cells = RunUMAP(hep_cells, dims = 1:20)
DimPlot(hep_cells, reduction = "umap", group.by = "names_clusters")
FeaturePlot(hep_cells, features = gfresh, pt.size = 0.6)
```

We will also do some subclustering.  
Cluster 13 can be split into two clusters - one of actual endothelial cells, and another of T cell-endothelial cell doublets. 

```{r}
# subcluster 13
cl = "13"
sub_srat = hcells_rpca[,hcells_rpca@meta.data$pc40_res.0.7==cl]
sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, dims = 1:20, verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "pca", dims = 1:20, 
                         force.recalc = T, graph.name = "c13pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "c13pc10",
                        resolution = seq(0.1, 0.5, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "c13pc10_res.0.3")

png("results/integr_healthy/seurat_umap_cluster13_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "c13pc10_res.0.3")
DefaultAssay(sub_srat) = "SCT"
mk_sub13 = FindMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                     ident.1 = "0", ident.2 = "1", 
                     pseudocount.use = 0.1, logfc.threshold = 0.2, 
                     verbose = T)
mk_sub13 = mk_sub13[mk_sub13$p_val_adj<=0.05,]
write.csv(x = cbind(rownames(mk_sub13), mk_sub13), col.names = T, row.names = T, quote = F,
          file = "results/integr_healthy/cluster13_sub_markers.csv")

# create new labels (required for next step)
cl13_endo = rownames(sub_srat@meta.data)[sub_srat@meta.data$c13pc10_res.0.3=="0"]
cl13_t = rownames(sub_srat@meta.data)[sub_srat@meta.data$c13pc10_res.0.3=="1"]
healthy_cl = as.character(hcells_rpca@meta.data$pc40_res.0.7)
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl13_endo] = "13_endo"
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl13_t] = "13_t"
```

Cluster 14 can be subclustered into ab T cells and gd T cells.

```{r}
# subcluster 14
cl = "14"
sub_srat = hcells_rpca[,healthy_cl==cl]
sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, dims = 1:20, verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "pca", dims = 1:20, 
                         force.recalc = T, graph.name = "c14pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "c14pc10",
                        resolution = seq(0.1, 0.5, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "c14pc10_res.0.3")
png("results/integr_healthy/seurat_umap_cluster14_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "c14pc10_res.0.3")
DefaultAssay(sub_srat) = "SCT"
mk_sub14 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                          pseudocount.use = 0.1, logfc.threshold = 0.2, 
                          verbose = T)
mk_sub14 = mk_sub14[mk_sub14$p_val_adj<=0.05,]
write.csv(x = mk_sub14, col.names = T, row.names = T, quote = F,
          file = "results/integr_healthy/cluster14_sub_markers.csv")

cl14_ab = rownames(sub_srat@meta.data)[sub_srat@meta.data$c14pc10_res.0.3=="0"]
cl14_gd = rownames(sub_srat@meta.data)[sub_srat@meta.data$c14pc10_res.0.3=="1"]
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl14_ab] = "14_abTcell"
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl14_gd] = "14_gdTcell"
```

Cluster 20 - we can observe dividing monocytes and T cells

```{r}
# subcluster 20
cl = "20"
sub_srat = hcells_rpca[,healthy_cl==cl]
sub_srat = RunPCA(sub_srat, verbose = F)
sub_srat = RunUMAP(sub_srat, dims = 1:10, verbose = F)
pltna = DimPlot(sub_srat, reduction = "umap", group.by = "Name")

sub_srat = FindNeighbors(sub_srat, reduction = "pca", dims = 1:10, 
                         force.recalc = T, graph.name = "c20pc10")
sub_srat = FindClusters(sub_srat, algorithm = 2, verbose = F, graph.name = "c20pc10",
                        resolution = seq(0.1, 0.5, 0.1))
pltcl = DimPlot(sub_srat, reduction = "umap", group.by = "c20pc10_res.0.3")
png("results/integr_healthy/seurat_umap_cluster20_sub.png", width = 800, height = 350)
cowplot::plot_grid(pltna, pltcl, ncol = 2, nrow = 1, align = "hv")
dev.off()

sub_srat = SetIdent(sub_srat, value = "c20pc10_res.0.3")
DefaultAssay(sub_srat) = "SCT"
mk_sub20 = FindAllMarkers(sub_srat, assay = "SCT", test.use = "wilcox",
                          pseudocount.use = 0.1, logfc.threshold = 0.2, 
                          verbose = T)
mk_sub20 = mk_sub20[mk_sub20$p_val_adj<=0.05,]
write.csv(x = mk_sub20, col.names = T, row.names = T, quote = F,
          file = "results/integr_healthy/cluster20_sub_markers.csv")

cl20_t = rownames(sub_srat@meta.data)[sub_srat@meta.data$c20pc10_res.0.3=="0"]
cl20_m = rownames(sub_srat@meta.data)[sub_srat@meta.data$c20pc10_res.0.3=="1"]
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl20_t] = "20_Tcell"
healthy_cl[rownames(hcells_rpca@meta.data) %in% cl20_m] = "20_mono"
```

Add new clusters to metadata along with their names add names

```{r}
names_clusters = ifelse(healthy_cl=="0", "Cholangiocytes", 
                        ifelse(healthy_cl=="1", "Hepatocytes_1", 
                        ifelse(healthy_cl=="2", "LSEC central vein", 
                        ifelse(healthy_cl=="3", "Hepatocytes_2", 
                        ifelse(healthy_cl=="4", "cDCs", 
                        ifelse(healthy_cl=="5", "Kupffer cells", 
                        ifelse(healthy_cl=="6", "Hepatocytes_3", 
                        ifelse(healthy_cl=="7", "Hepatocytes_4", 
                        ifelse(healthy_cl=="8", "Hepatocytes_5", 
                        ifelse(healthy_cl=="9", "Hepatocytes_6", 
                        ifelse(healthy_cl=="10", "Hepatocytes_7", 
                        ifelse(healthy_cl=="11", "Hepatocytes_8", 
                        ifelse(healthy_cl=="12", "Periportal LSEC", 
                        ifelse(healthy_cl=="13_endo", "Portal Endothelial cells", 
                        ifelse(healthy_cl=="13_t", "T cell-Endothelial interaction", 
                        ifelse(healthy_cl=="14_abTcell", "ab-T cells", 
                        ifelse(healthy_cl=="14_gdTcell", "gd-T cells_1", 
                        ifelse(healthy_cl=="15", "Hepatocytes_9", 
                        ifelse(healthy_cl=="16", "Macrophage-Endothelial interaction", 
                        ifelse(healthy_cl=="17", "Macrophages", 
                        ifelse(healthy_cl=="18", "Plasmablasts", 
                        ifelse(healthy_cl=="19", "pDCs", 
                        ifelse(healthy_cl=="20_Tcell", "Dividing T cells",
                        ifelse(healthy_cl=="20_mono", "Dividing monocytes",
                        ifelse(healthy_cl=="21", "gd-T cells_2", 
                        ifelse(healthy_cl=="22", "Stellate cells", "ERROR"
                        ))))))))))))))))))))))))))

names_major = ifelse(healthy_cl=="0", "Cholangiocytes", 
                      ifelse(healthy_cl=="1", "Hepatocytes", 
                      ifelse(healthy_cl=="2", "Endothelial cells", 
                      ifelse(healthy_cl=="3", "Hepatocytes", 
                      ifelse(healthy_cl=="4", "Dendritic cells", 
                      ifelse(healthy_cl=="5", "Myeloid cells", 
                      ifelse(healthy_cl=="6", "Hepatocytes", 
                      ifelse(healthy_cl=="7", "Hepatocytes", 
                      ifelse(healthy_cl=="8", "Hepatocytes", 
                      ifelse(healthy_cl=="9", "Hepatocytes", 
                      ifelse(healthy_cl=="10", "Hepatocytes", 
                      ifelse(healthy_cl=="11", "Hepatocytes", 
                      ifelse(healthy_cl=="12", "Endothelial cells", 
                      ifelse(healthy_cl=="13_endo", "Endothelial cells", 
                      ifelse(healthy_cl=="13_t", "Doublets", 
                      ifelse(healthy_cl=="14_abTcell", "Lymphocytes", 
                      ifelse(healthy_cl=="14_gdTcell", "Lymphocytes", 
                      ifelse(healthy_cl=="15", "Hepatocytes", 
                      ifelse(healthy_cl=="16", "Doublets", 
                      ifelse(healthy_cl=="17", "Myeloid cells", 
                      ifelse(healthy_cl=="18", "Lymphocytes", 
                      ifelse(healthy_cl=="19", "Dendritic cells", 
                      ifelse(healthy_cl=="20_Tcell", "Dividing cells",
                      ifelse(healthy_cl=="20_mono", "Dividing cells",
                      ifelse(healthy_cl=="21", "Lymphocytes", 
                      ifelse(healthy_cl=="22", "Stellate cells", "ERROR"
                      ))))))))))))))))))))))))))

newmeta = data.frame(row.names = rownames(hcells_rpca@meta.data),
                     "clusters" = healthy_cl,
                     "names_clusters" = names_clusters,
                     "names_major" = names_major)

hcells_rpca = AddMetaData(hcells_rpca, metadata = newmeta)
```

Plot distribution of cell types by the different samples

```{r}
for(n in c("names_clusters", "names_major")){
  pdf(paste0("results/integr_healthy/", n, "_distribution_samples.pdf"), useDingbats = F,
      height = 6, width = 10)
  
  ct_dat = table(hcells_rpca@meta.data[,n])
  ct_dat = data.frame(row.names = names(ct_dat),
                      counts = as.numeric(ct_dat))
  s_dat = unique(hcells_rpca@meta.data[,c("unique_name", "Fraction", "Name")])
  rownames(s_dat) = s_dat[,1]
  s_dat = s_dat[,-1]
  
  plot_df = t(table(hcells_rpca@meta.data$unique_name,
                  hcells_rpca@meta.data[,n]))
  plot_df = plot_df/rowSums(plot_df)
  
  pheatmap::pheatmap(t(plot_df), clustering_method = "ward.D2", 
                     display_numbers = round(t(plot_df), 3), fontsize_number = 6.5,
                     annotation_col = ct_dat, annotation_row = s_dat)
  
  plot_df = table(hcells_rpca@meta.data$unique_name,
                  hcells_rpca@meta.data[,n])
  plot_df = plot_df/rowSums(plot_df)
  
  pheatmap::pheatmap(t(plot_df), clustering_method = "ward.D2", 
                     display_numbers = round(t(plot_df), 3), fontsize_number = 6.5,
                     annotation_row = ct_dat, annotation_col = s_dat)
  dev.off()
}
```


```{r}
plt1 = DimPlot(hcells_rpca, reduction = "tsne", group.by = "names_clusters", 
               label = T)+theme(legend.position = "none")
plt2 = DimPlot(hcells_rpca, reduction = "tsne", group.by = "names_major", 
               label = T)+theme(legend.position = "none")
cowplot::plot_grid(plt1, plt2, ncol = 2, align = "h")
```






## Integrate all datasets
Integrate all cell datasets using different methods, using batch scripts  

Seurat Anchors CCA
  - Script: `run_SeuratIntegration_allcells.R`
  - Output: `data/processed/scripts_out/SeuratIntegr_allcells.RDS`
  - Note: This did not work, likely because of too many cells
  
Seurat Anchors rPCA
  - Script: `run_SeuratIntegrationRPCA_allcells.R`
  - Output: `data/processed/scripts_out/SeuratIntegrRPCA_allcells.RDS`
  
Harmony
  - Script: `run_HarmonyIntegration_allcells.R`
  - Output: `data/processed/scripts_out/HarmIntegr_allcells.RDS`


### Examine Harmony output
Load data

```{r}
allcells_harm = readRDS("data/processed/scripts_out/HarmIntegr_allcells.RDS")
```

Checking how using different numbers of dimensions affects UMAP structure

```{r}
plt10 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:10")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:20)
plt20 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:20")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:25)
plt25 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:25")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:30)
plt30 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:30")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:40)
plt40 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:40")
allcells_harm = RunUMAP(allcells_harm, reduction = "harmony", dims = 1:50)
plt50 = DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
                group.by = "Fraction")+labs(title = "UMAP with Harmony 1:50")

png("results/integr_allcells/harmony_umap_dims.png", width = 1200, height = 600)
cowplot::plot_grid(plt10, plt20, plt25, plt30, plt40, plt50, ncol = 3, nrow = 2, align = "h")
dev.off()
```

How do the different fractions and conditions split in the UMAP (50 dims)

```{r}
DimPlot(allcells_harm, reduction = "umap", pt.size = 0.2, 
        split = "Fraction", group.by = "Condition")
```

Plotting general markers

```{r}
FeaturePlot(allcells_harm, reduction = "umap", pt.size = 0.2,
            features = c("FGA", "PTPRC", "ANXA4", "CD34", "EPCAM", "C1QB",
                         "JCHAIN", "APOA1", "nFeature_RNA"))
```


### Examine Seurat output
Load data

```{r}
allcells_rpca = readRDS("data/processed/scripts_out/SeuratIntegrRPCA_allcells.RDS")
```


```{r}
DimPlot(allcells_rpca, reduction = "umap", pt.size = 0.2, 
        split = "Fraction", group.by = "Name")
```



```{r}
FeaturePlot(allcells_rpca, features = c("APOA2", "FGA", "MKI67", "CD34", "ANXA2", "PTPRC"),
            reduction = "umap")
```

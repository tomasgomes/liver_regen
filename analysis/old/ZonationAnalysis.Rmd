---
title: "Zonation analysis"
output: html_notebook
---



# General Setup
Setup chunk

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8)
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_knit$get("root.dir")
```

Setup reticulate

```{r}
library(reticulate)
knitr::knit_engines$set(python = reticulate::eng_python)
py_available(initialize = FALSE)
use_python(Sys.which("python"))
py_config()
```

Load libraries

```{r}
library(Seurat)
library(ggplot2)
library(ggridges)
library(dplyr)
library(destiny)
library(fdrtool)
library(gam)
```



# Healthy
Load data

```{r}
hcells_rpca = readRDS("data/processed/hcells_css.RDS")
```


## Hepatocyte zonation
Subset hepatocytes

```{r}
hep_hcells = hcells_rpca[,hcells_rpca@meta.data$names_major=="Hepatocytes"]
hep_hcells = suppressWarnings(SCTransform(hep_hcells, do.correct.umi = T, verbose = F, 
                                          vars.to.regress = c("unique_name","nCount_RNA"),
                                          variable.features.rv.th = 1, seed.use = 1,
                                          return.only.var.genes = F, 
                                          variable.features.n = NULL))
hep_hcells = RunPCA(hep_hcells, verbose = F)
hep_hcells = RunUMAP(hep_hcells, dims = 1:20, verbose = F)
DimPlot(hep_hcells, reduction = "umap", group.by = "names_clusters")

# the initial dimensionality reduction uncovers a few outlying cells, which will be removed from this zonation analysis
outcells = (hep_hcells@reductions$umap@cell.embeddings[,1]<(-5) &
              hep_hcells@reductions$umap@cell.embeddings[,2]>1.3)
hep_hcells = hep_hcells[,!outcells]
```

### Pseudotime using PCA

```{r}
hep_hcells = suppressWarnings(SCTransform(hep_hcells, do.correct.umi = T, verbose = F, 
                                          vars.to.regress = c("unique_name","nCount_RNA"),
                                          variable.features.rv.th = 1, seed.use = 1,
                                          return.only.var.genes = F, 
                                          variable.features.n = NULL))
#hep_hcells = FindVariableFeatures(hep_hcells, verbose = F)
hep_hcells = RunPCA(hep_hcells, verbose = F)
hep_hcells = RunUMAP(hep_hcells, dims = 1:15, verbose = F)
DimPlot(hep_hcells, reduction = "umap", group.by = "unique_name")
```

Plotting hepatocyte zonation markers

```{r}
gfresh = c("CYP1A2", "CYP2E1", "GLUL", "CYP3A4", "G0S2", "APOC1", "UGT2B17", "BCHE", # central 
           "SAA1", "HAMP", "SAA2", "CPS1", "C3", "C1R", "MT-ND4", "MT-CO2") # portal

png("results/zonation_healthy/healthy_hepatocyte_zonation_markers_violin.png", 
    height = 1400, width = 1400)
VlnPlot(hep_hcells, features = gfresh, group.by = "names_clusters", 
        pt.size = 0, sort = "increasing")
dev.off()
png("results/zonation_healthy/healthy_hepatocyte_zonation_markers_umap.png", 
    height = 1400, width = 1400)
FeaturePlot(hep_hcells, features = gfresh, pt.size = 0.6)
dev.off()
```

Run destiny on hepatocytes

```{r}
dm = DiffusionMap(hep_hcells@reductions$pca@cell.embeddings[,1:5], rotate = T)
#dm = DiffusionMap(Matrix::as.matrix(Matrix::t(hep_hcells@assays$SCT@data)), rotate = T)
#tip_cells = c(which(dm@eigenvectors[,1]==min(dm@eigenvectors[,1])),
#              which(dm@eigenvectors[,1]==max(dm@eigenvectors[,1])))
#dpt = DPT(dm, tips = tip_cells)
dpt = DPT(dm)
plot(dpt)
```

Plotting markers, clusters and sample names

```{r}
df_dc = cbind(hep_hcells@meta.data, data.frame(dpt@dm$DC1,dpt@dm$DC2))
df_dc = cbind(df_dc, Matrix::t(hep_hcells@assays$SCT@data[gfresh,]))
colnames(df_dc) = gsub("-", ".", colnames(df_dc), fixed = T)

plt_list = list()
for(n in c(gsub("-", ".", gfresh, fixed = T), "names_clusters", "unique_name")){
  plt_list[[n]] = ggplot(df_dc, aes_string(x = "dpt.dm.DC1", y = "dpt.dm.DC2", colour = n))+
    geom_point()+
    theme_classic()
}

png("results/zonation_healthy/healthy_hepatocyte_zonation_markers_pca_dc.png", 
    height = 900, width = 2800)
cowplot::plot_grid(plotlist = plt_list, nrow = 3, ncol = 6, align = "hv")
dev.off()
```

Correlation with DCs

```{r}
dat = as.matrix(Matrix::t(hep_hcells@assays$SCT@data))
cor_hep_dc1 = cor(dat, df_dc$dpt.dm.DC1, method = "sp")
cor_hep_dc2 = cor(dat, df_dc$dpt.dm.DC2, method = "sp")
```

### Pseudotime using CSS 
Additional inspection of hepatocytes for filtering 

```{r}
hep_hcells = RunUMAP(hep_hcells, reduction = "css", dims = 1:ncol(Embeddings(hep_hcells, "css")),
                     verbose = F)
DimPlot(hep_hcells, reduction = "umap", group.by = "names_clusters")
hep_hcells_filt = hep_hcells[,!grepl("low counts", hep_hcells@meta.data$names_clusters)]
```

Run destiny

```{r}
dm = DiffusionMap(hep_hcells@reductions$css@cell.embeddings, rotate = T)
dpt = DPT(dm)
plot(dpt)
```

Plotting markers, clusters and sample names

```{r}
df_dc = cbind(hep_hcells@meta.data, data.frame(dpt@dm$DC1,dpt@dm$DC2))
df_dc = cbind(df_dc, Matrix::t(hep_hcells@assays$SCT@data[gfresh,]))
colnames(df_dc) = gsub("-", ".", colnames(df_dc), fixed = T)

plt_list = list()
for(n in c(gsub("-", ".", gfresh, fixed = T), "names_clusters", "unique_name")){
  plt_list[[n]] = ggplot(df_dc, aes_string(x = "dpt.dm.DC1", y = "dpt.dm.DC2", colour = n))+
    geom_point()+
    theme_classic()
}

png("results/zonation_healthy/healthy_hepatocyte_zonation_markers_css_dc.png", 
    height = 900, width = 2800)
cowplot::plot_grid(plotlist = plt_list, nrow = 3, ncol = 6, align = "hv")
dev.off()
```

Correlation

```{r}
df_dc = df_dc[!grepl("low counts", df_dc$names_clusters),]
dat = as.matrix(Matrix::t(hep_hcells@assays$SCT@data[,!grepl("low counts", hep_hcells@meta.data$names_clusters)]))
cor_hepf_dc1 = cor(dat, df_dc$dpt.dm.DC1, method = "sp")
cor_hepf_dc2 = cor(dat, df_dc$dpt.dm.DC2, method = "sp")
```

### Pseudotime using PC1
PC1 seems to reflect very well the liver zonation

```{r}
df_dc = cbind(hep_hcells@meta.data, 
              data.frame(hep_hcells@reductions$pca@cell.embeddings[,1:2]),
              Matrix::t(hep_hcells@assays$SCT@data[gfresh,]))
```


We'll be using DC1 as the pseudotime. This was the best approximation possible to the zonation gradient based on diffusion maps

```{r}
pdf("results/zonation_healthy/hep_distributions_dc1.pdf", useDingbats = F, 
    height = 4, width = 9)
plt1 = ggplot(df_dc, aes(x = PC_1, y = names_clusters, 
                  group = names_clusters, fill = names_clusters))+
  geom_density_ridges2(alpha = 0.4)+
  theme_bw()+
  theme(legend.position = "none")

plt2 = ggplot(df_dc, aes(x = PC_1, y = unique_name, 
                  group = unique_name, fill = unique_name))+
  geom_density_ridges2(alpha = 0.4)+
  theme_bw()+
  theme(legend.position = "none")

cowplot::plot_grid(plt1, plt2, ncol = 2, align = "h")
dev.off()
```

Add pseudotime and save the data

```{r}
ptdf = data.frame(row.names = rownames(df_dc), "healthy_hep_zon_dc1" = df_dc$PC_1)
hep_hcells = AddMetaData(hep_hcells, ptdf)
saveRDS(hep_hcells, file = "data/processed/hep_hcells_zon.RDS")
```

Because correlation might not be enough, we'll use a gam with a 4-degree spline to to model the genes

```{r}
# will only use variable genes
hvg = hep_hcells@assays$SCT@var.features

# Fit GAM for each gene using pseudotime as independent variable.
t = hep_hcells@meta.data$healthy_hep_zon_dc1
gene_fit_p = c()
gene_fit_vals = data.frame(row.names = 1:100)
for(i in 1:length(hvg)){
  g = hvg[i]
  z = hep_hcells@assays$SCT@data[g,]
  
  d = data.frame(z=z, t=t)
  tmp = suppressMessages(gam(z ~ ns(t, df = 3), data=d))
  
  # bins for model fitting
  bb = seq(min(t), max(t), length.out = 100)
  gene_fit_vals[,g] = predict(tmp, 
                              newdata = data.frame(t = bb))
  p = summary(tmp)$parametric.anova$`Pr(>F)`[1]
  gene_fit_p = c(gene_fit_p, p)
  names(gene_fit_p)[length(gene_fit_p)] = g
}
```

Get signifficant genes and cluster some/all

```{r}
gene_fit_vals_filt = t(gene_fit_vals[,names(gene_fit_p)[gene_fit_p<=0.05]])
scale_fit = t(apply(gene_fit_vals_filt, 1, scale))

# using the top 1000 genes because it gives the neatest plots
topgenes = names(head(gene_fit_p[order(gene_fit_p, decreasing = F)], 1000))

# dist and hclust
if(file.exists("results/zonation_healthy/dtw_distance_pc1_sigGenes.RDS")){
  dd = readRDS("results/zonation_healthy/dtw_distance_pc1_sigGenes.RDS")
} else{
  dd = dtw::dtwDist(scale_fit) # TAKES 4.5 HOURS
  saveRDS(dd, "results/zonation_healthy/dtw_distance_pc1_sigGenes.RDS")
}

clust_genes = hclust(as.dist(dd), method = "ward.D2")

cls = cutree(clust_genes, 4)
#ape::plot.phylo(ape::as.phylo(clust_genes), tip.color = rainbow(10)[cls])
plt_list = list()
for(i in unique(cls)){
  sub_df = scale_fit[names(cls)[cls==i],]
  plot_df = reshape2::melt(sub_df)
  plt_list[[paste0("gene_",i)]] = ggplot(plot_df, aes(x = Var2, y = value, group = Var1))+
    geom_hline(yintercept = 0, linetype = "dashed")+
    geom_line(alpha = 0.1, colour = "grey69")+
    stat_summary(aes(y = value, group=1), fun=mean, colour="red", geom="line",group=1)+
    labs(title = paste0("gene_",i))+
    theme_bw()
}

pdf("results/zonation_healthy/hep_gene_expression_profile_clusters1000_dc1.pdf",
    height = 4.5, width = 4.4)
cowplot::plot_grid(plotlist = plt_list, nrow = 2, ncol = 2, align = "hv")
dev.off()

df_pval_cl = merge(data.frame(gene_fit_p), data.frame(cls), by = 0, all = T)
colnames(df_pval_cl) = c("gene", "pval", "cluster")

write.csv(df_pval_cl, file = "results/zonation_healthy/hep_dc1_pval_clust_healthy.csv",
          col.names = T, row.names = F, quote = F)
saveRDS(gene_fit_p, file = "results/zonation_healthy/hep_dc1_pval_clust_healthy.RDS")

write.csv(gene_fit_vals, file = "results/zonation_healthy/hep_dc1_gene_fits_healthy.csv",
          col.names = T, row.names = F, quote = F)
```

We can also test zonation genes for pathway enrichment  
Testing is only done on genes from clusters to avoid bloated non-specific results

```{r}
gprof_list = list()
for(i in 1:4){ # this step does not work in RStudio-server
  genes = df_pval_cl$gene[df_pval_cl$pval<=0.05 & df_pval_cl$cluster==i]
  gprof_list[[i]] = gost(genes, organism = "hsapiens", significant = T, 
                     correction_method = "fdr", sources = c("GO:BP", "GO:CC", "REAC"),
                     custom_bg = hep_hcells@assays$SCT@var.features)
  gprof_list[[i]]$result$f1 = 2*((gprof_list[[i]]$result$precision * gprof_list[[i]]$result$recall)/(gprof_list[[i]]$result$precision + gprof_list[[i]]$result$recall))
  saveRDS(gprof_list[[i]], 
          file = paste0("results/zonation_healthy/gprof_dehep_cl", i, ".RDS"))
}
genes = df_pval_cl$gene[df_pval_cl$pval<=0.05 & !is.na(df_pval_cl$cluster)]
gprof_dehep = gost(genes, organism = "hsapiens", significant = T, 
                   correction_method = "fdr", sources = c("GO:BP", "GO:CC", "REAC"),
                   custom_bg = hep_hcells@assays$SCT@var.features)
gprof_dehep$result$f1 = 2*((gprof_dehep$result$precision * gprof_dehep$result$recall)/(gprof_dehep$result$precision + gprof_dehep$result$recall))
saveRDS(gprof_dehep, file = "results/zonation_healthy/gprof_dehep.RDS")

# read in all results
gprof_list = list()
for(i in 1:4){
  gprof_list[[i]] = readRDS(paste0("results/zonation_healthy/gprof_dehep_cl", i, ".RDS"))
}
gprof_dehep = readRDS("results/zonation_healthy/gprof_dehep.RDS")

gprof_all = c(list("all" = gprof_dehep), gprof_list)
names(gprof_all) = c("all", paste0("cl", 1:4))
```

Get term list to deconvolute the terms

```{r}
all_genes_conv = t(data.frame(gprof_dehep$meta$genes_metadata$query$query_1$mapping))

# get file from here: https://biit.cs.ut.ee/gprofiler/gost
inputFile <- "../../gene_refs/human/gprofiler_full_hsapiens.ENSG.gmt"
con  <- file(inputFile, open = "r")

term_list = list()
term_names = list()
while (length(oneLine <- readLines(con, n = 1, warn = FALSE)) > 0) {
    myVector = (strsplit(oneLine, "\t"))[[1]]
    term_names[[myVector[1]]] = myVector[2]
    term_list[[myVector[1]]] = myVector[3:length(myVector)]
    term_list[[myVector[1]]] = unique(rownames(all_genes_conv)[all_genes_conv[,1] %in% term_list[[myVector[1]]]])
} 
term_list = term_list[unlist(lapply(term_list, length))>0]

close(con)
```

Plot genes from pathway

```{r}
g_sig = names(gene_fit_p)[gene_fit_p<=0.05]
gene_fit_vals_filt = t(gene_fit_vals[,colnames(gene_fit_vals) %in% g_sig])
scale_fit = t(apply(gene_fit_vals_filt, 1, scale))

gprof_plt_list = list()
for(n in names(gprof_all)){
  gprof_df = gprof_all[[n]]$result
  gprof_df = gprof_df[order(gprof_df$f1, decreasing = T),]
  gprof_plt_list[[n]] = list()
  
  for(i in unique(gprof_df$term_id)){
    genes_use = term_list[[i]]
    if(n!="all"){
      genes_use = genes_use[genes_use %in% df_pval_cl$gene[paste0("cl",df_pval_cl$cluster)==n]]
    } else{
      genes_use = genes_use[genes_use %in% rownames(scale_fit)]
    }
    if(length(genes_use>0)){
      sub_df = scale_fit[genes_use,]
      plot_df = reshape2::melt(sub_df)
      gprof_plt_list[[n]][[i]] = ggplot(plot_df, aes(x = Var2, y = value, group = Var1))+
        geom_hline(yintercept = 0, linetype = "dashed")+
        geom_line(alpha = 0.1, colour = "grey69")+
        stat_summary(aes(y = value, group=1), fun.y=mean, colour="red", geom="line",group=1)+
        labs(subtitle = i, title = term_names[[i]])+
        theme_bw()
    }
  }
}
```





## Endothelial zonation
Subset endothelial cells

```{r}
end_hcells = hcells_rpca[,hcells_rpca@meta.data$names_major=="Endothelial cells"]
end_hcells = suppressWarnings(SCTransform(end_hcells, do.correct.umi = T, verbose = F, 
                                          vars.to.regress = c("unique_name","nCount_RNA"),
                                          variable.features.rv.th = 1, seed.use = 1,
                                          return.only.var.genes = F, 
                                          variable.features.n = NULL))
end_hcells = RunPCA(end_hcells, verbose = F)
end_hcells = RunUMAP(end_hcells, dims = 1:15, verbose = F)
DimPlot(end_hcells, reduction = "umap", group.by = "unique_name")
DimPlot(end_hcells, reduction = "umap", group.by = "names_clusters")

end_hcells = FindNeighbors(end_hcells, reduction = "pca", dims = 1:15, 
                           force.recalc = T, graph.name = "endo")
end_hcells = FindClusters(end_hcells, graph.name = "endo", algorithm = 2, 
                          resolution = 0.3, verbose = F)
DimPlot(end_hcells, reduction = "umap", group.by = "endo_res.0.3")

end_hcells = SetIdent(end_hcells, value = "endo_res.0.3")
mk_endo = FindAllMarkers(end_hcells, logfc.threshold = 0.2, min.pct = 0.05)
# markers show some T cells, macrophages and hepatocytes. We remove these, as well as the portal endothelial cells, which should not be part of LSEC zonation

keep_cells = colnames(end_hcells)[end_hcells@meta.data$endo_res.0.3 %in% c(0,1,3) &
                                    end_hcells@meta.data$names_clusters!="Portal Endothelial cells"]
end_hcells = end_hcells[,keep_cells]
end_hcells = suppressWarnings(SCTransform(end_hcells, do.correct.umi = T, verbose = F, 
                                          vars.to.regress = c("unique_name","nCount_RNA"),
                                          variable.features.rv.th = 1, seed.use = 1,
                                          return.only.var.genes = F, 
                                          variable.features.n = NULL))
end_hcells = RunPCA(end_hcells, verbose = F)
end_hcells = RunUMAP(end_hcells, dims = 1:15, verbose = F)
DimPlot(end_hcells, reduction = "umap", group.by = "unique_name")
DimPlot(end_hcells, reduction = "umap", group.by = "names_clusters")
```

Will also first use diffusion maps to filter additional outliers

```{r}
dm = DiffusionMap(end_hcells@reductions$pca@cell.embeddings[,1:15], rotate = T)
dpt = DPT(dm)
plot(dpt, col_by = "DPT1")

keep_cells = colnames(end_hcells)[dpt$DPT1<3]
end_hcells = end_hcells[,keep_cells]
end_hcells = suppressWarnings(SCTransform(end_hcells, do.correct.umi = T, verbose = F, 
                                          vars.to.regress = c("unique_name","nCount_RNA"),
                                          variable.features.rv.th = 1, seed.use = 1,
                                          return.only.var.genes = F, 
                                          variable.features.n = NULL))
end_hcells = RunPCA(end_hcells, verbose = F)
end_hcells = RunUMAP(end_hcells, dims = 1:15, verbose = F)
DimPlot(end_hcells, reduction = "umap", group.by = "unique_name")
DimPlot(end_hcells, reduction = "umap", group.by = "names_clusters")
```

Run destiny on endothelial cells - in this case, we use the calculated diffusion pseudo time by setting the roots as the tips of the curve

```{r}
dm = DiffusionMap(end_hcells@reductions$pca@cell.embeddings[,1:15], rotate = T)
dpt = DPT(dm, tips = c(398, 334)) # tips are top DC2 for each LSEC cluster
plot(dpt)
```

Extract the pseudotime

```{r}
branch_id = min(dpt@branch[,1], na.rm = TRUE)
branch_idx = dpt@branch[, 1L] == 1
tip_cells = which(branch_idx & dpt@tips[, 1L])
dpt_use = dpt[tip_cells,]
```

Distribution of variables along the pseudotime

```{r}
df_dpt = cbind(end_hcells@meta.data, data.frame("dpt" = dpt_use))

pdf("results/zonation_healthy/endo_distributions_dpt.pdf", useDingbats = F, 
    height = 4, width = 9)
plt1 = ggplot(df_dpt, aes(x = dpt, y = names_clusters, 
                  group = names_clusters, fill = names_clusters))+
  geom_density_ridges2(alpha = 0.4)+
  theme_bw()+
  theme(legend.position = "none")

plt2 = ggplot(df_dpt, aes(x = dpt, y = unique_name, 
                  group = unique_name, fill = unique_name))+
  geom_density_ridges2(alpha = 0.4)+
  theme_bw()+
  theme(legend.position = "none")

cowplot::plot_grid(plt1, plt2, ncol = 2, align = "h")
dev.off()
```

Add pseudotime and save the data

```{r}
ptdf = data.frame(row.names = rownames(df_dpt), "healthy_end_zon_dpt" = df_dpt$dpt)
end_hcells = AddMetaData(end_hcells, ptdf)
saveRDS(end_hcells, file = "data/processed/end_hcells_zon.RDS")
```

We'll use a gam with a 4-degree spline to to model the genes

```{r}
# will only use variable genes
hvg = end_hcells@assays$SCT@var.features

# Fit GAM for each gene using pseudotime as independent variable.
t = end_hcells@meta.data$healthy_end_zon_dpt
gene_fit_p = c()
gene_fit_vals = data.frame(row.names = 1:100)
for(i in 1:length(hvg)){
  g = hvg[i]
  z = end_hcells@assays$SCT@data[g,]
  
  d = data.frame(z=z, t=t)
  tmp = suppressMessages(gam(z ~ ns(t, df = 4), data=d))
  
  # bins for model fitting
  bb = seq(min(t), max(t), length.out = 100)
  gene_fit_vals[,g] = predict(tmp, 
                              newdata = data.frame(t = bb))
  p = summary(tmp)$parametric.anova$`Pr(>F)`[1]
  gene_fit_p = c(gene_fit_p, p)
  names(gene_fit_p)[length(gene_fit_p)] = g
}
```

Get signifficant genes and cluster some/all

```{r}
gene_fit_vals_filt = t(gene_fit_vals[,names(gene_fit_p)[gene_fit_p<=0.05]])
scale_fit = t(apply(gene_fit_vals_filt, 1, scale))

# using the top 1000 genes because it gives the neatest plots
topgenes = names(head(gene_fit_p[order(gene_fit_p, decreasing = F)], 1000))

clust_genes = hclust(dist(scale_fit[topgenes,]), method = "ward.D2")

cls = cutree(clust_genes, 4)
plt_list = list()
for(i in unique(cls)){
  sub_df = scale_fit[names(cls)[cls==i],]
  plot_df = reshape2::melt(sub_df)
  plt_list[[paste0("gene_",i)]] = ggplot(plot_df, aes(x = Var2, y = value, group = Var1))+
    geom_hline(yintercept = 0, linetype = "dashed")+
    geom_line(alpha = 0.1, colour = "grey69")+
    stat_summary(aes(y = value, group=1), fun.y=mean, colour="red", geom="line",group=1)+
    labs(title = paste0("gene_",i))+
    theme_bw()
}

pdf("results/zonation_healthy/end_gene_expression_profile_clusters1000_dpt.pdf",
    height = 4.5, width = 4.4)
cowplot::plot_grid(plotlist = plt_list, nrow = 2, ncol = 2, align = "hv")
dev.off()

df_pval_cl = merge(data.frame(gene_fit_p), data.frame(cls), by = 0, all = T)
colnames(df_pval_cl) = c("gene", "pval", "cluster")

write.csv(df_pval_cl, file = "results/zonation_healthy/end_dpt_pval_clust_healthy.csv",
          col.names = T, row.names = F, quote = F)

write.csv(gene_fit_vals, file = "results/zonation_healthy/end_dpt_gene_fits_healthy.csv",
          col.names = T, row.names = F, quote = F)
```

Might need to redo using ranks, which smooths cell orderings more (avoids dense clumps and sparse stretches)



# Embolised/Regenerating
## Hepatocyte zonation
Load data with all cells

```{r}
allcells_css = readRDS(file = "data/processed/allcells_css.RDS")
```

Subset healthy (get healthy pseudotime, determine varying genes, take top 500, use to get PCA and then pseudotime for the others)

```{r}
cond = "healthy"
hep_sub_healthy = allcells_css[,allcells_css@meta.data$allcells_major=="Hepatocytes" &
                                 allcells_css@meta.data$Condition==cond]
hep_sub_healthy = suppressWarnings(SCTransform(hep_cells[[cond]], do.correct.umi = T, 
                                               verbose = F, 
                                               vars.to.regress=c("unique_name","nCount_RNA"),
                                               variable.features.rv.th = 1, seed.use = 1,
                                               return.only.var.genes = F, 
                                               variable.features.n = NULL))
hep_sub_healthy = RunPCA(hep_sub_healthy, verbose = F)
hep_sub_healthy = RunUMAP(hep_sub_healthy, dims = 1:20, verbose = F)

DimPlot(hep_sub_healthy, reduction = "umap", group.by = "allcells_clusters")
outcells = (hep_sub_healthy@reductions$umap@cell.embeddings[,1]>(1) &
              hep_sub_healthy@reductions$umap@cell.embeddings[,2]>5)
hep_sub_healthy = hep_sub_healthy[,!outcells]

hep_sub_healthy = suppressWarnings(SCTransform(hep_sub_healthy, do.correct.umi = T, verbose = F,
                                               vars.to.regress = c("unique_name","nCount_RNA"),
                                               variable.features.rv.th = 1, seed.use = 1,
                                               return.only.var.genes = F, 
                                               variable.features.n = NULL))
hep_sub_healthy = RunPCA(hep_sub_healthy, verbose = F)
hep_sub_healthy = RunUMAP(hep_sub_healthy, dims = 1:15, verbose = F)
DimPlot(hep_sub_healthy, reduction = "umap", group.by = "unique_name")
```

```{r}
dm = DiffusionMap(hep_sub_healthy@reductions$pca@cell.embeddings[,1:15], rotate = T, n_eigs = 5)
dpt = DPT(dm)
plot(dpt)
```

```{r}
df_dc = cbind(hep_sub_healthy@meta.data, 
              data.frame("DC1" = dpt@dm$DC1, "DC2" = dpt@dm$DC2),
              Matrix::t(hep_sub_healthy@assays$SCT@data[gfresh,]))
```

```{r}
# will only use variable genes
hvg = hep_sub_healthy@assays$SCT@var.features

# Fit GAM for each gene using pseudotime as independent variable.
t = df_dc$DC1
gene_fit_p = c()
gene_fit_vals = data.frame(row.names = 1:100)
for(i in 1:length(hvg)){
  g = hvg[i]
  z = hep_sub_healthy@assays$SCT@data[g,]
  
  d = data.frame(z=z, t=t)
  tmp = suppressMessages(gam(z ~ ns(t, df = 4), data=d))
  
  # bins for model fitting
  bb = seq(min(t), max(t), length.out = 100)
  gene_fit_vals[,g] = suppressMessages(predict(tmp,
                                               newdata = data.frame(t = bb)))
  p = summary(tmp)$parametric.anova$`Pr(>F)`[1]
  gene_fit_p = c(gene_fit_p, p)
  names(gene_fit_p)[length(gene_fit_p)] = g
}
```

```{r}
sig_genes = gene_fit_p[gene_fit_p<=0.05]
top_sig_genes = names(sig_genes[order(sig_genes, decreasing = F)][1:500]) 
# using all genes was identical

data_gam_h = cbind(data.frame("DC1" = dpt@dm$DC1),
                   Matrix::t(hep_sub_healthy@assays$SCT@data[top_sig_genes,]))

gam_healthy = gam::gam(DC1 ~ ., data = data_gam_h)

hea_pred = predict(gam_healthy,
                   Matrix::t(hep_sub_healthy@assays$SCT@data[top_sig_genes,]))
reg_pred = predict(gam_healthy,
                   Matrix::t(hep_cells$regenerating@assays$SCT@data[top_sig_genes,]))
emb_pred = predict(gam_healthy,
                   Matrix::t(hep_cells$embolised@assays$SCT@data[top_sig_genes,]))

plot(density(reg_pred), col = "blue")
lines(density(emb_pred), col = "red")
lines(density(data_gam_h$DC1), col = "green")
lines(density(hea_pred), col = "grey50")
legend(-0.073,32, legend = c("healthy (DC1)", "healthy (pred)", 
                         "embolised (pred)", "regenerating (pred)"),
       fill = c("green", "grey50", "red", "blue"))

cor_emb = cor(emb_pred,
              as.matrix(Matrix::t(hep_cells$embolised@assays$SCT@data)),
              method = "sp")
cor_reg = cor(reg_pred,
              as.matrix(Matrix::t(hep_cells$regenerating@assays$SCT@data)),
              method = "sp")

commg = intersect(colnames(cor_emb), colnames(cor_reg))
plot(t(cor_reg[,commg]), t(cor_emb[,commg]))
```


```{r}
sig_genes = gene_fit_p[gene_fit_p<=0.05]
top_sig_genes = names(sig_genes[order(sig_genes, decreasing = F)][1:500])

hep_cells = list()
for(cond in c("embolised", "regenerating")){
  cat(cond)
  hep_cells[[cond]] = allcells_css[,allcells_css@meta.data$allcells_major=="Hepatocytes" &
                                     allcells_css@meta.data$Condition==cond]
  print(dim(hep_cells[[cond]]))
  hep_cells[[cond]] = suppressWarnings(SCTransform(hep_cells[[cond]], do.correct.umi = T, 
                                                   verbose = F, 
                                                   vars.to.regress=c("unique_name","nCount_RNA"),
                                                   variable.features.rv.th = 1, seed.use = 1,
                                                   return.only.var.genes = F, 
                                                   variable.features.n = NULL))
  hep_cells[[cond]] = RunPCA(hep_cells[[cond]], verbose = F, features = top_sig_genes)
  hep_cells[[cond]] = RunUMAP(hep_cells[[cond]], dims = 1:15, verbose = F)
}

dpt_hep_pcacomm_list = list()
for(n in names(hep_cells)){
  dm = DiffusionMap(hep_cells[[n]]@reductions$pca@cell.embeddings[,1:15], 
                    rotate = T, n_eigs = 5)
  dpt_hep_pcacomm_list[[n]] = DPT(dm)
  plot(dpt_hep_pcacomm_list[[n]])
}
```

```{r}
cor_emb = cor(dpt_hep_pcacomm_list$embolised@dm$DC1,
              as.matrix(Matrix::t(hep_cells$embolised@assays$SCT@data)),
              method = "sp")
cor_reg = cor(dpt_hep_pcacomm_list$regenerating@dm$DC2,
              as.matrix(Matrix::t(hep_cells$regenerating@assays$SCT@data)),
              method = "sp")

cor_reg_dc1 = cor(dpt_hep_pcacomm_list$regenerating@dm$DC1,
              as.matrix(Matrix::t(hep_cells$regenerating@assays$SCT@data)),
              method = "sp")

df_emb = cbind(hep_cells$embolised@meta.data,
               data.frame("DC1" = dpt_hep_pcacomm_list$embolised@dm$DC1, 
                          "DC2" = dpt_hep_pcacomm_list$embolised@dm$DC2),
               Matrix::t(hep_cells$embolised@assays$SCT@data[gfresh,]))

df_reg = cbind(hep_cells$regenerating@meta.data,
               data.frame("DC1" = dpt_hep_pcacomm_list$regenerating@dm$DC1, 
                          "DC2" = dpt_hep_pcacomm_list$regenerating@dm$DC2),
               Matrix::t(hep_cells$regenerating@assays$SCT@data[c(gfresh, "APOA4", "APOA5"),]))

ggplot(df_reg, aes(x = DC1, y = DC2, colour = CYP2E1))+
  geom_point()+
  theme_classic()

ggplot(df_emb, aes(x = DC1, y = APOA4))+
  geom_point()+
  theme_classic()
```









Subset and process conditions

```{r}
hep_cells = list()
for(cond in unique(allcells_css@meta.data$Condition)){
  cat(cond)
  hep_cells[[cond]] = allcells_css[,allcells_css@meta.data$allcells_major=="Hepatocytes" &
                                     allcells_css@meta.data$Condition==cond]
  print(dim(hep_cells[[cond]]))
  hep_cells[[cond]] = suppressWarnings(SCTransform(hep_cells[[cond]], do.correct.umi = T, 
                                                   verbose = F, 
                                                   vars.to.regress=c("unique_name","nCount_RNA"),
                                                   variable.features.rv.th = 1, seed.use = 1,
                                                   return.only.var.genes = F, 
                                                   variable.features.n = NULL))
  #hep_cells[[cond]] = RunPCA(hep_cells[[cond]], verbose = F)
  #hep_cells[[cond]] = RunUMAP(hep_cells[[cond]], dims = 1:20, verbose = F)
}

healthy_genes = Seurat::VariableFeatures(hep_cells$healthy)
healthy_genes = healthy_genes[healthy_genes %in% rownames(hep_cells$embolised@assays$SCT@scale.data) & 
                                healthy_genes %in% rownames(hep_cells$regenerating@assays$SCT@scale.data)]
for(cond in unique(allcells_css@meta.data$Condition)){
  hep_cells[[cond]] = RunPCA(hep_cells[[cond]], verbose = F, features = healthy_genes)
  hep_cells[[cond]] = RunUMAP(hep_cells[[cond]], dims = 1:15, verbose = F)
}


hep_cells$healthy = suppressWarnings(SCTransform(hep_cells$healthy, do.correct.umi = T, 
                                                 variable.features.n = 2500,
                                                 vars.to.regress=c("unique_name","nCount_RNA"),
                                                 verbose = F, seed.use = 1,
                                                 return.only.var.genes = F))
healthy_genes = Seurat::VariableFeatures(hep_cells$healthy)
healthy_genes = healthy_genes[healthy_genes %in% rownames(hep_cells$embolised@assays$SCT@scale.data) & 
                                healthy_genes %in% rownames(hep_cells$regenerating@assays$SCT@scale.data)]
hep_cells$healthy = RunPCA(hep_cells$healthy, verbose = F, features = healthy_genes)
hep_cells$healthy = RunUMAP(hep_cells$healthy, dims = 1:15, verbose = F)



DimPlot(hep_cells[[cond]], reduction = "umap", group.by = "allcells_clusters")

hep_cells[[cond]] = FindNeighbors(hep_cells[[cond]], reduction = "pca", dims = 1:20, 
                                  force.recalc = T, graph.name = "pcacond")
hep_cells[[cond]] = FindClusters(hep_cells[[cond]], algorithm = 2, verbose = F, 
                                 graph.name = "pcacond", resolution = seq(0.2, 1.5, 0.1))
hep_cells[[cond]] = SetIdent(hep_cells[[cond]], value = "pcacond_res.0.3")
mk_hep_cond = FindAllMarkers(hep_cells[[cond]], assay = "SCT", 
                                           test.use = "wilcox",
                                           pseudocount.use = 0.1, logfc.threshold = 0.2,
                                           max.cells.per.ident = 5000,
                                           min.cells.feature = 10,
                                           verbose = T)

# the initial dimensionality reduction uncovers a few outlying cells, which will be removed from this zonation analysis
outcells = (hep_hcells@reductions$umap@cell.embeddings[,1]<(-5) &
              hep_hcells@reductions$umap@cell.embeddings[,2]>1.3)
hep_hcells = hep_hcells[,!outcells]
```

Run diffusion pseudotime for all conditions

```{r}
dpt_hep_list = list()
for(n in names(hep_cells)){
  dm = DiffusionMap(hep_cells[[n]]@reductions$pca@cell.embeddings[,1:15], rotate = T)
  dpt_hep_list[[n]] = DPT(dm)
  plot(dpt_hep_list[[n]])
}

dpt_hep_pcacomm_list = list()
for(n in names(hep_cells)){
  dm = DiffusionMap(hep_cells[[n]]@reductions$pca@cell.embeddings[,1:15], rotate = T)
  dpt_hep_pcacomm_list[[n]] = DPT(dm)
  plot(dpt_hep_pcacomm_list[[n]])
}

dpt_hep_css_list = list()
for(n in names(hep_cells)){
  print(n)
  dm = DiffusionMap(hep_cells[[n]]@reductions$css@cell.embeddings, rotate = T)
  dpt_hep_css_list[[n]] = DPT(dm)
  plot(dpt_hep_css_list[[n]])
}
```



```{r}
pred_hr = dm_predict(dpt_hep_css_list$healthy@dm,
                     hep_cells$regenerating@reductions$css@cell.embeddings)
plot(dpt_hep_css_list$healthy@dm, new_dcs = pred_hr, dims = 1:2, col = "blue")
plot(density(pred_hr[,2]))
lines(density(dpt_hep_css_list$healthy@dm$DC2))
```

```{r}
dm = DiffusionMap(as.matrix(Matrix::t(hep_cells[[n]]@assays$SCT@data[healthy_genes,])), 
                  rotate = T, n_eigs = 5, n_pcs = 15)
dpt = DPT(dm)
pred_hr = dm_predict(dm,
                     as.matrix(Matrix::t(hep_cells$regenerating@assays$SCT@data[healthy_genes,])))
plot(dm, new_dcs = pred_hr, dims = 1:2, col = "blue")
plot(density(pred_hr[,2]), col = "blue")
lines(density(dpt_hep_css_list$healthy@dm$DC2), col = "red")
```

```{r}
plot_df = data.frame(as.matrix(pred_hr))
plot_df = cbind(plot_df, Matrix::t(hep_cells$regenerating@assays$SCT@data[gfresh,]))
colnames(plot_df) = gsub("-", ".", colnames(plot_df), fixed = T)

ggplot(plot_df, aes_string(x = "DC2", y = "SAA1"))+
    geom_point()+
    theme_classic()

plot_df2 = data.frame("DC1" = dm$DC1, "DC2" = dm$DC2)
plot_df2 = cbind(plot_df2, Matrix::t(hep_cells$healthy@assays$SCT@data[gfresh,]))
colnames(plot_df2) = gsub("-", ".", colnames(plot_df2), fixed = T)

ggplot(plot_df2, aes_string(x = "DC2", y = "SAA1"))+
    geom_point()+
    theme_classic()
```



Plotting markers, clusters and sample names

```{r}
list_plot_dc = list()
for(n in names(hep_cells)){
  df_dc = cbind(hep_cells[[n]]@meta.data, data.frame("DC1" = dpt_hep_css_list[[n]]@dm$DC1,
                                                     "DC2" = dpt_hep_css_list[[n]]@dm$DC2))
  list_plot_dc[[n]] = cbind(df_dc, Matrix::t(hep_cells[[n]]@assays$SCT@data[gfresh,]))
  colnames(list_plot_dc[[n]]) = gsub("-", ".", colnames(list_plot_dc[[n]]), fixed = T)
}

df_dc = list_plot_dc$embolised

plt_list = list()
for(n in c(gsub("-", ".", gfresh, fixed = T), "allcells_simp", "unique_name")){
  plt_list[[n]] = ggplot(df_dc, aes_string(x = "DC1", y = "DC2", colour = n))+
    geom_point()+
    theme_classic()
}

png("results/zonation_healthy/healthy_hepatocyte_zonation_markers_pca_dc.png", 
    height = 900, width = 2800)
cowplot::plot_grid(plotlist = plt_list, nrow = 3, ncol = 6, align = "hv")
dev.off()
```




## Endothelial zonation





# LEGACY CODE
Which genes correlate with the defined pseudotime? (WARNING: very slow)

```{r}
dat = as.matrix(Matrix::t(hep_hcells@assays$SCT@data))
cor_test_hep = suppressWarnings(suppressMessages(apply(dat, 
                     2, function(x) cor.test(hep_hcells@meta.data$healthy_hep_zon_dc1, 
                                             x, method = "sp"))))

cor_test_hep = data.frame("gene" = names(cor_test_hep),
                          "cor" = unlist(lapply(cor_test_hep, function(x) x$estimate)),
                          "pval" = unlist(lapply(cor_test_hep, function(x) x$p.value)))

cor_test_hep$cor_pval = fdrtool(cor_test_hep$pval, statistic = "pvalue", 
                                plot = F, verbose = F)$qval
rownames(cor_test_hep) = cor_test_hep$gene

write.csv(cor_test_hep, 
          file = "results/zonation_healthy/cor_test_hepatocytes_dc1_healthy.csv",
          col.names = T, row.names = F, quote = F)
```

